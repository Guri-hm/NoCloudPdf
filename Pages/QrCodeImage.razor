@page "/qrcode/image"
@implements IAsyncDisposable
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject MessageService MessageService
@using Microsoft.AspNetCore.Components.Forms
@using NoCloudPdf.Services
@using NoCloudPdf.Components
@using NoCloudPdf.Models

<PageTitle>画像からQRコード読み取り-NoCloudPDF</PageTitle>

@if (string.IsNullOrEmpty(imagePreviewUrl))
{
    <!-- 初期画面: ファイル選択 -->
    <SelectImagePanel OnOpenFileDialog="OpenFileDialog"/>
}
else
{
    <div class="flex flex-col h-screen">
        <!-- ヘッダー -->
        <div class="bg-gray-800 text-white shadow z-50 h-16">
            <div class="h-full px-4 flex items-center justify-between">
                <div class="flex items-center">
                    <ActionButtonGroup T="string" Actions="resetActions" />
                    <h1 class="hidden md:inline text-lg font-bold ml-2">画像からQRコード読み取り</h1>
                </div>
            </div>
        </div>

        <!-- メインコンテンツ -->
        <div class="flex-1 overflow-hidden flex flex-col md:flex-row">
            <!-- 画像プレビュー -->
            <div class="flex-1 bg-gray-100 p-6 overflow-auto flex items-center justify-center">
                <div class="max-w-full max-h-full">
                    <img src="@imagePreviewUrl" alt="アップロードされた画像" class="max-w-full max-h-full object-contain shadow-lg rounded-lg" />
                </div>
            </div>

            <!-- 右側: 読み取り結果（PC表示） -->
            <div class="hidden md:flex md:flex-col md:w-1/2 bg-white p-6 overflow-auto">
                <h2 class="text-lg font-bold mb-4">読み取り結果</h2>
                @RenderResultContent()
            </div>
        </div>

        <!-- 下部スライドアップメニュー（モバイル） -->
        <div class="md:hidden fixed bottom-0 left-0 w-full z-[200]">
            <div class="@($"transition-transform will-change-transform duration-300 bg-white border-t border-gray-300 shadow-lg p-4 {(isMenuOpen ? "translate-y-0" : "translate-y-full")}")">
                <div class="max-h-[70vh] overflow-y-auto">
                    <h2 class="text-lg font-bold mb-4">読み取り結果</h2>
                    @RenderResultContent()
                </div>
                <button class="absolute top-2 right-4 text-2xl text-gray-500" @onclick="() => isMenuOpen = false">
                    <CloseIcon />
                </button>
            </div>

            @if (!isMenuOpen && scanResult != null)
            {
                <button
                    class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[201] bg-white rounded-full shadow px-8 py-3 border border-gray-300 flex items-center gap-3 text-lg font-bold hover:bg-blue-50 transition min-w-[260px]"
                    @onclick="() => isMenuOpen = true">
                    @if (scanResult.Success)
                    {
                        <CheckCircleIcon Class="text-green-600 text-2xl"/>
                        <span class="text-green-600">読み取り成功</span>
                    }
                    else
                    {
                        <InfoIcon Class="text-red-600 text-2xl"/>
                        <span class="text-red-600">読み取り失敗</span>
                    }
                    <ChevronUpIcon/>
                </button>
            }
        </div>

        <!-- メニュー展開時の背景オーバーレイ -->
        @if (isMenuOpen)
        {
            <div class="fixed inset-0 bg-black/30 z-[199] touch-none md:hidden" @onclick="() => isMenuOpen = false"></div>
        }
    </div>
}


<!-- 隠しQRリーダー要素 -->
<div id="qr-reader-hidden" style="display: none;"></div>

<!-- ファイル選択用の隠しinput -->
<InputFile OnChange="HandleFileSelectionAsync" accept="image/*" class="hidden" id="fileInput" />

<!-- ローディング中 -->
<LoadingOverlay />

<!-- メッセージ表示エリア -->
<MessageBar />

@code {
    private string? imagePreviewUrl;
    private bool isScanning = false;
    private ScanResult? scanResult;
    private bool isMenuOpen = false;
    private DotNetObjectReference<QrCodeImage>? _dotNetRef;

    private class ScanResult
    {
        public bool Success { get; set; }
        public string Text { get; set; } = "";
        public string Error { get; set; } = "";
    }

    private RenderFragment RenderResultContent() => builder =>
    {
        if (isScanning)
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "text-center py-12");
            builder.OpenComponent<LoadingSpinnerIcon>(2);
            builder.AddAttribute(3, "Class", "w-12 h-12 mx-auto animate-spin");
            builder.CloseComponent();
            builder.OpenElement(4, "p");
            builder.AddAttribute(5, "class", "text-gray-600 mt-4");
            builder.AddContent(6, "QRコードを読み取り中...");
            builder.CloseElement();
            builder.CloseElement();
        }
        else if (scanResult != null)
        {
            if (scanResult.Success)
            {
                builder.OpenElement(10, "div");
                builder.AddAttribute(11, "class", "bg-green-50 border border-green-200 rounded-lg p-4 mb-4");
                builder.OpenElement(12, "div");
                builder.AddAttribute(13, "class", "flex items-start");
                builder.OpenComponent<CheckCircleIcon>(14);
                builder.AddAttribute(15, "Class", "w-6 h-6 text-green-600 mr-3 flex-shrink-0 mt-0.5");
                builder.CloseComponent();
                builder.OpenElement(16, "div");
                builder.AddAttribute(17, "class", "flex-1");
                builder.OpenElement(18, "h3");
                builder.AddAttribute(19, "class", "font-semibold text-green-800 mb-2");
                builder.AddContent(20, "QRコード検出成功");
                builder.CloseElement();
                builder.OpenElement(21, "div");
                builder.AddAttribute(22, "class", "bg-white rounded p-3 mb-3 break-all");
                if (IsUrl(scanResult.Text))
                {
                    builder.OpenElement(23, "a");
                    builder.AddAttribute(24, "href", scanResult.Text);
                    builder.AddAttribute(25, "target", "_blank");
                    builder.AddAttribute(26, "rel", "noopener noreferrer");
                    builder.AddAttribute(27, "class", "text-blue-600 hover:underline flex items-center");
                    builder.AddContent(28, scanResult.Text);
                    builder.OpenElement(29, "svg");
                    builder.AddAttribute(30, "class", "w-4 h-4 ml-1");
                    builder.AddAttribute(31, "fill", "none");
                    builder.AddAttribute(32, "stroke", "currentColor");
                    builder.AddAttribute(33, "viewBox", "0 0 24 24");
                    builder.OpenElement(34, "path");
                    builder.AddAttribute(35, "stroke-linecap", "round");
                    builder.AddAttribute(36, "stroke-linejoin", "round");
                    builder.AddAttribute(37, "stroke-width", "2");
                    builder.AddAttribute(38, "d", "M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14");
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                }
                else
                {
                    builder.OpenElement(39, "p");
                    builder.AddAttribute(40, "class", "text-gray-800");
                    builder.AddContent(41, scanResult.Text);
                    builder.CloseElement();
                }
                builder.CloseElement();
                builder.OpenElement(42, "button");
                builder.AddAttribute(43, "class", "px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors flex items-center text-sm");
                builder.AddAttribute(44, "onclick", EventCallback.Factory.Create(this, () => CopyToClipboard(scanResult.Text)));
                builder.OpenComponent<CopyIcon>(45);
                builder.AddAttribute(46, "Class", "w-4 h-4 mr-2");
                builder.CloseComponent();
                builder.AddContent(47, "クリップボードにコピー");
                builder.CloseElement();
                builder.CloseElement();
                builder.CloseElement();
                builder.CloseElement();
            }
            else
            {
                builder.OpenElement(50, "div");
                builder.AddAttribute(51, "class", "bg-red-50 border border-red-200 rounded-lg p-4");
                builder.OpenElement(52, "div");
                builder.AddAttribute(53, "class", "flex items-start");
                builder.OpenElement(54, "svg");
                builder.AddAttribute(55, "class", "w-6 h-6 text-red-600 mr-3 flex-shrink-0 mt-0.5");
                builder.AddAttribute(56, "fill", "none");
                builder.AddAttribute(57, "stroke", "currentColor");
                builder.AddAttribute(58, "viewBox", "0 0 24 24");
                builder.OpenElement(59, "path");
                builder.AddAttribute(60, "stroke-linecap", "round");
                builder.AddAttribute(61, "stroke-linejoin", "round");
                builder.AddAttribute(62, "stroke-width", "2");
                builder.AddAttribute(63, "d", "M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z");
                builder.CloseElement();
                builder.CloseElement();
                builder.OpenElement(64, "div");
                builder.OpenElement(65, "h3");
                builder.AddAttribute(66, "class", "font-semibold text-red-800 mb-2");
                builder.AddContent(67, "QRコードが検出できませんでした");
                builder.CloseElement();
                builder.OpenElement(68, "p");
                builder.AddAttribute(69, "class", "text-sm text-red-700");
                builder.AddContent(70, "画像にQRコードが含まれていないか、解像度が不足している可能性があります。より鮮明な画像をお試しください。");
                builder.CloseElement();
                builder.OpenElement(71, "button");
                builder.AddAttribute(72, "class", "mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm");
                builder.AddAttribute(73, "onclick", EventCallback.Factory.Create(this, ClearAndSelectNew));
                builder.AddContent(74, "別の画像を試す");
                builder.CloseElement();
                builder.CloseElement();
                builder.CloseElement();
                builder.CloseElement();
            }
        }
    };

    private List<ActionButtonItem> resetActions => new()
    {
        new ActionButtonItem
        {
            IconFragment = builder =>
            {
                builder.OpenComponent(0, typeof(ArrowLeftIcon));
                builder.AddAttribute(1, "Class", "w-5 h-5"); 
                builder.CloseComponent();
            },
            Title = "最初からやり直す",
            OnClick = EventCallback.Factory.Create(this, GoBack),
            ButtonClass = "bg-amber-200 hover:bg-amber-300 border border-amber-400 font-bold py-2 px-3 rounded",
            TextColor = "text-black"
        }
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("loadHtml5QrcodeLibrary");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to load QR library: {ex.Message}");
            }
        }

        // 画像未選択の初期画面のときのみ登録
        if (string.IsNullOrEmpty(imagePreviewUrl))
        {
            if (_dotNetRef == null)
            {
                _dotNetRef = DotNetObjectReference.Create(this);
                await JSRuntime.InvokeVoidAsync("registerSelectDropArea", _dotNetRef);
            }
        }
        else
        {
            // 画像が読み込まれたらドロップエリアを解除
            if (_dotNetRef != null)
            {
                await JSRuntime.InvokeVoidAsync("unregisterSelectDropArea");
            }
        }
    }

    private async Task OpenFileDialog()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("openFileDialog", "fileInput");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error opening file dialog: {ex.Message}");
            _ = MessageService.ShowAsync($"ファイル選択ダイアログの表示に失敗しました: {ex.Message}", MessageType.Error);
        }
    }


    private async Task HandleFileSelectionAsync(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        try
        {
            await MessageService.ShowLoadingAsync("ファイル読み込み中...");
            await InvokeAsync(StateHasChanged);
            await Task.Yield();

            // ファイルサイズチェック（10MB）
            const long maxFileSize = 10 * 1024 * 1024; // 10MB
            if (file.Size > maxFileSize)
            {
                var fileSizeMB = file.Size / (1024.0 * 1024.0);
                await MessageService.ShowAsync($"ファイルサイズが10MBを超えています（{fileSizeMB:F1}MB）", MessageType.Error);
                return;
            }

            // 画像プレビュー表示
            using var stream = file.OpenReadStream(maxAllowedSize: maxFileSize);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var bytes = ms.ToArray();
            var base64 = Convert.ToBase64String(bytes);

            imagePreviewUrl = $"data:{file.ContentType};base64,{base64}";

            // 共通処理でQRコードスキャン
            await ProcessImageAndScanQrAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Image load error: {ex.Message}");
            await MessageService.ShowAsync("画像の読み込みに失敗しました", MessageType.Error);
        }
        finally
        {
            await MessageService.HideLoadingAsync();
        }
    }

    /// <summary>
    /// 画像プレビューからQRコードをスキャンする共通処理
    /// </summary>
    private async Task ProcessImageAndScanQrAsync()
    {
        isScanning = true;
        scanResult = null;
        StateHasChanged();

        try
        {
            var result = await JSRuntime.InvokeAsync<string>("decodeQrCodeFromImage", imagePreviewUrl);
            scanResult = new ScanResult
            {
                Success = true,
                Text = result
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"QR decode error: {ex.Message}");
            scanResult = new ScanResult
            {
                Success = false,
                Error = "QRコードが見つかりませんでした"
            };
        }
        finally
        {
            isScanning = false;
        }
    }

    private bool IsUrl(string text)
    {
        return Uri.TryCreate(text, UriKind.Absolute, out var uri) &&
               (uri.Scheme == Uri.UriSchemeHttp || uri.Scheme == Uri.UriSchemeHttps);
    }

    private async Task CopyToClipboard(string text)
    {
        try
        {
            var success = await JSRuntime.InvokeAsync<bool>("copyToClipboard", text);
            if (success)
            {
                await MessageService.ShowAsync("クリップボードにコピーしました");
            }
            else
            {
                await MessageService.ShowAsync("クリップボードへのコピーに失敗しました", MessageType.Error);
            }
        }
        catch (Exception ex)
        {
            await MessageService.ShowAsync($"エラー: {ex.Message}", MessageType.Error);
        }
    }

    private void GoBack()
    {
        // ローカル状態をクリア
        imagePreviewUrl = null;
        scanResult = null;
        isScanning = false;
        Navigation.NavigateTo("/qrcode");
    }

    private void ClearAndSelectNew()
    {
        imagePreviewUrl = null;
        scanResult = null;
        isScanning = false;
        StateHasChanged();
    }

    [JSInvokable]
    public async Task OnJsFileDropped(string fileName, string contentType, string base64Data)
    {
        try
        {
            // 画像ファイルのみ受け付ける
            if (!contentType.StartsWith("image/"))
            {
                await MessageService.ShowAsync("画像ファイルのみ対応しています", MessageType.Error);
                return;
            }

            // ファイルサイズチェック（10MB）
            var bytes = Convert.FromBase64String(base64Data);
            if (bytes.Length > 10 * 1024 * 1024)
            {
                var fileSizeMB = bytes.Length / (1024.0 * 1024.0);
                await MessageService.ShowAsync($"ファイルサイズが10MBを超えています（{fileSizeMB:F1}MB）", MessageType.Error);
                return;
            }

            // 画像プレビュー表示
            imagePreviewUrl = $"data:{contentType};base64,{base64Data}";

            // 共通処理でQRコードスキャン
            await ProcessImageAndScanQrAsync();

            StateHasChanged();

        }
        catch (Exception ex)
        {
            Console.WriteLine($"File drop error: {ex.Message}");
            await MessageService.ShowAsync("ファイルの読み込みに失敗しました", MessageType.Error);
        }
        finally
        {
            await MessageService.HideLoadingAsync();
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("unregisterSelectDropArea");
        }
        catch { }
        _dotNetRef?.Dispose();
    }
}
