@page "/qrcode/pdf"
@implements IAsyncDisposable
@inject IJSRuntime JSRuntime
@inject PdfDataService PdfDataService
@inject MessageService MessageService
@inject CompletionStateService CompletionState
@inject NavigationManager Navigation
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using System.IO
@using NoCloudPdf.Models
@using NoCloudPdf.Services
@using NoCloudPdf.Components

<PageTitle>NoCloudPDF-ファイル内のQRコード読み取り</PageTitle>

@if (IsFilesLoaded)
{
    <div id="drop-area" class="relative h-screen flex flex-col">
        <DropCover Message="ここにファイルをドロップ" />
        
        <!-- 上部固定バー -->
        <div class="sticky top-0 left-0 w-full max-w-full bg-gray-800 text-white shadow z-50">
            <div class="flex items-start justify-between px-4 py-2">
                <div class="flex flex-wrap gap-2 items-center">
                    <ActionButtonGroup T="string" Actions="resetActions" />
                    <h1 class="hidden md:inline text-lg font-bold ml-2">ファイル内のQRコード読み取り</h1>
                    <div class="ml-4 flex items-center gap-2">
                        <input type="number"
                            min="1"
                            max="@Math.Max(1, DisplayItems.Count)"
                            value="@displayedPageNumber"
                            @onchange="OnPageInputChanged"
                            class="w-10 px-2 py-1 rounded border border-gray-300 text-sm text-white bg-gray-700" />
                        <span class="text-sm">/ @DisplayItems.Count</span>
                    </div>
                    @if (isScanning)
                    {
                        <div class="px-4 py-2 bg-gray-600 rounded-lg flex items-center">
                            <LoadingSpinnerIcon Class="w-5 h-5 mr-2 animate-spin" />
                            <span>読み取り中...</span>
                        </div>
                    }
                    else
                    {
                        <SplitButton
                            PrimaryLabel="スキャン"
                            OnPrimaryClick="@(EventCallback.Factory.Create(this, ScanCurrentPage))"
                            MenuItems="@scanMenuItems"
                            FullWidth="false" />
                    }
                </div>
                <button @onclick="ClearAllResults" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors">
                    クリア
                </button>
            </div>
        </div>

        <!-- メインコンテンツ -->
        <div class="flex-1 overflow-hidden flex flex-col md:flex-row">
            <!-- PDFプレビュー -->
            <div class="flex-1 bg-gray-100 overflow-auto">
                <div class="p-4">
                    @if (DisplayItems.Any() && displayedPageNumber > 0 && displayedPageNumber <= DisplayItems.Count)
                    {
                        var item = DisplayItems[displayedPageNumber - 1];
                        if (item.RawData is PageItem pageItem)
                        {
                            <div class="bg-white shadow-lg rounded-lg p-4">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-semibold">ページ @displayedPageNumber</h3>
                                    <div class="flex gap-2 items-center">
                                        <SelectBox 
                                            Options="@previewScaleOptions"
                                            @bind-Value="@selectedPreviewScale"
                                            IsHorizontal="true"
                                            Label="解像度"
                                            SelectClass="h-8 px-2 py-1 pr-8 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none"
                                            LabelClass="text-sm font-medium text-gray-700" />
                                        <button @onclick="PrevPage" disabled="@(displayedPageNumber <= 1)"
                                                class="px-3 py-1 bg-gray-300 hover:bg-gray-400 disabled:opacity-50 rounded">
                                            ◀
                                        </button>
                                        <button @onclick="NextPage" disabled="@(displayedPageNumber >= DisplayItems.Count)"
                                                class="px-3 py-1 bg-gray-300 hover:bg-gray-400 disabled:opacity-50 rounded">
                                            ▶
                                        </button>
                                    </div>
                                </div>
                                @{
                                    var previewUrl = GetHighResPreview(displayedPageNumber - 1, pageItem);
                                }
                                @if (!string.IsNullOrEmpty(previewUrl))
                                {
                                    <img src="@previewUrl" 
                                         alt="ページ @displayedPageNumber" 
                                         class="w-full border border-gray-300 rounded" />
                                }
                                else
                                {
                                    <div class="text-center py-12">
                                        <LoadingSpinnerIcon Class="w-12 h-12 mx-auto" />
                                        <p class="text-gray-600">プレビューを読み込み中...</p>
                                    </div>
                                }
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- 右側: 読み取り結果（PC表示） -->
            <div class="hidden md:flex md:flex-col md:w-1/2 bg-white overflow-auto p-6">
                <h2 class="text-lg font-bold mb-4">読み取り結果</h2>
                @RenderResultsContent()
            </div>
        </div>

        <!-- 下部スライドアップメニュー（モバイル） -->
        <div class="md:hidden fixed bottom-0 left-0 w-full z-[200]">
            <div class="@($"transition-transform will-change-transform duration-300 bg-white border-t border-gray-300 shadow-lg p-4 {(isMenuOpen ? "translate-y-0" : "translate-y-full")}")">
                <div class="max-h-[70vh] overflow-y-auto">
                    <h2 class="text-lg font-bold mb-4">読み取り結果</h2>
                    @RenderResultsContent()
                </div>
                <button class="absolute top-2 right-4 text-2xl text-gray-500" @onclick="() => isMenuOpen = false">
                    <CloseIcon />
                </button>
            </div>

            @if (!isMenuOpen && qrResults.Any())
            {
                <button
                    class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[201] bg-white rounded-full shadow px-8 py-3 border border-gray-300 flex items-center gap-3 text-lg font-bold hover:bg-blue-50 transition min-w-[260px]"
                    @onclick="() => isMenuOpen = true">
                    <CheckCircleIcon Class="text-green-600 text-2xl"/>
                    <span class="text-green-600">結果表示</span>
                    <ChevronUpIcon/>
                </button>
            }
        </div>

        <!-- メニュー展開時の背景オーバーレイ -->
        @if (isMenuOpen)
        {
            <div class="fixed inset-0 bg-black/30 z-[199] touch-none md:hidden" @onclick="() => isMenuOpen = false"></div>
        }
    </div>
}
else
{
    <!-- 初期画面: ファイル選択 -->
    <SelectFilePanel OnOpenFileDialog="OpenFileDialog"/>
}

<!-- 隠しQRリーダー要素 -->
<div id="qr-reader-hidden" style="display: none;"></div>

<!-- ファイル選択用の隠しinput -->
<InputFile OnChange="HandleFileSelectionAsync" multiple class="hidden" id="fileInput" />

<!-- メッセージ表示エリア -->
<MessageBar />

<!-- パスワードダイアログ -->
<PasswordInputDialog IsOpen="@isPasswordDialogOpen" FileName="@passwordDialogFileName" OnClose="OnPasswordDialogClose" />

<LoadingOverlay />

@code {
    private List<DisplayItem> DisplayItems => PdfDataService.GetDisplayItems();
    private bool IsFilesLoaded => DisplayItems.Any();
    private int displayedPageNumber = 1;
    private bool isScanning = false;
    private List<QrScanResult> qrResults = new();
    private bool isMenuOpen = false;
    private DotNetObjectReference<QrCodePdf>? _dotNetRef;
    
    // 高解像度プレビュー用キャッシュ（キー: "pageIndex_scale"）
    private Dictionary<string, string> highResPreviewCache = new();
    // プレビュー生成中のページを追跡（無限ループ防止）
    private HashSet<string> previewGenerating = new();

    private bool isPasswordDialogOpen = false;
    private string passwordDialogFileName = "";
    private TaskCompletionSource<string?>? passwordTcs;
    
    // プレビュー解像度選択
    private string selectedPreviewScale = "2.0";
    private List<SelectOption> previewScaleOptions = new()
    {
        new SelectOption { Value = "2.0", Text = "標準（2.0x）" },
        new SelectOption { Value = "2.5", Text = "やや高解像度（2.5x）" },
        new SelectOption { Value = "3.0", Text = "高解像度（3.0x）" }
    };

    private class QrScanResult
    {
        public int PageNumber { get; set; }
        public bool Success { get; set; }
        public string Text { get; set; } = "";
        public string Error { get; set; } = "";
    }

    private RenderFragment RenderResultsContent() => builder =>
    {
        if (qrResults.Any())
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "space-y-3");

            int sequence = 10;
            foreach (var result in qrResults.OrderBy(r => r.PageNumber))
            {
                var capturedResult = result;
                builder.OpenElement(sequence++, "div");
                builder.AddAttribute(sequence++, "class", "bg-gray-50 border border-gray-200 rounded-lg p-4");
                
                // Header
                builder.OpenElement(sequence++, "div");
                builder.AddAttribute(sequence++, "class", "flex items-start justify-between mb-2");
                builder.OpenElement(sequence++, "div");
                builder.AddAttribute(sequence++, "class", "flex items-center gap-2");
                builder.OpenElement(sequence++, "span");
                builder.AddAttribute(sequence++, "class", "text-gray-700 font-bold");
                builder.AddContent(sequence++, $"P.{capturedResult.PageNumber}");
                builder.CloseElement();
                
                if (capturedResult.Success)
                {
                    builder.OpenComponent<CheckCircleIcon>(sequence++);
                    builder.AddAttribute(sequence++, "Class", "w-5 h-5 text-green-600");
                    builder.CloseComponent();
                }
                else
                {
                    builder.OpenElement(sequence++, "svg");
                    builder.AddAttribute(sequence++, "class", "w-5 h-5 text-red-600");
                    builder.AddAttribute(sequence++, "fill", "none");
                    builder.AddAttribute(sequence++, "stroke", "currentColor");
                    builder.AddAttribute(sequence++, "viewBox", "0 0 24 24");
                    builder.OpenElement(sequence++, "path");
                    builder.AddAttribute(sequence++, "stroke-linecap", "round");
                    builder.AddAttribute(sequence++, "stroke-linejoin", "round");
                    builder.AddAttribute(sequence++, "stroke-width", "2");
                    builder.AddAttribute(sequence++, "d", "M6 18L18 6M6 6l12 12");
                    builder.CloseElement();
                    builder.CloseElement();
                }
                builder.CloseElement();
                
                builder.OpenElement(sequence++, "button");
                builder.AddAttribute(sequence++, "class", "text-gray-400 hover:text-red-600");
                builder.AddAttribute(sequence++, "onclick", EventCallback.Factory.Create(this, () => qrResults.Remove(capturedResult)));
                builder.OpenComponent<DeleteIcon>(sequence++);
                builder.AddAttribute(sequence++, "Class", "w-5 h-5");
                builder.CloseComponent();
                builder.CloseElement();
                builder.CloseElement();
                
                // Content
                if (capturedResult.Success)
                {
                    builder.OpenElement(sequence++, "div");
                    builder.AddAttribute(sequence++, "class", "bg-white rounded p-3 mb-2 break-all");
                    if (IsUrl(capturedResult.Text))
                    {
                        builder.OpenElement(sequence++, "a");
                        builder.AddAttribute(sequence++, "href", capturedResult.Text);
                        builder.AddAttribute(sequence++, "target", "_blank");
                        builder.AddAttribute(sequence++, "rel", "noopener noreferrer");
                        builder.AddAttribute(sequence++, "class", "text-blue-600 hover:underline flex items-center");
                        builder.AddContent(sequence++, capturedResult.Text);
                        builder.OpenElement(sequence++, "svg");
                        builder.AddAttribute(sequence++, "class", "w-4 h-4 ml-1 flex-shrink-0");
                        builder.AddAttribute(sequence++, "fill", "none");
                        builder.AddAttribute(sequence++, "stroke", "currentColor");
                        builder.AddAttribute(sequence++, "viewBox", "0 0 24 24");
                        builder.OpenElement(sequence++, "path");
                        builder.AddAttribute(sequence++, "stroke-linecap", "round");
                        builder.AddAttribute(sequence++, "stroke-linejoin", "round");
                        builder.AddAttribute(sequence++, "stroke-width", "2");
                        builder.AddAttribute(sequence++, "d", "M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14");
                        builder.CloseElement();
                        builder.CloseElement();
                        builder.CloseElement();
                    }
                    else
                    {
                        builder.OpenElement(sequence++, "p");
                        builder.AddAttribute(sequence++, "class", "text-gray-800");
                        builder.AddContent(sequence++, capturedResult.Text);
                        builder.CloseElement();
                    }
                    builder.CloseElement();
                    
                    builder.OpenElement(sequence++, "button");
                    builder.AddAttribute(sequence++, "class", "px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm flex items-center");
                    builder.AddAttribute(sequence++, "onclick", EventCallback.Factory.Create(this, () => CopyToClipboard(capturedResult.Text)));
                    builder.OpenComponent<CopyIcon>(sequence++);
                    builder.AddAttribute(sequence++, "Class", "w-4 h-4 mr-1");
                    builder.CloseComponent();
                    builder.AddContent(sequence++, "コピー");
                    builder.CloseElement();
                }
                else
                {
                    builder.OpenElement(sequence++, "p");
                    builder.AddAttribute(sequence++, "class", "text-sm text-red-700");
                    builder.AddContent(sequence++, capturedResult.Error);
                    builder.CloseElement();
                }
                
                builder.CloseElement();
                sequence += 100;
            }
            
            builder.CloseElement();
        }
        else
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "text-center py-12 text-gray-400");
            builder.OpenComponent<QrCodeIcon>(2);
            builder.AddAttribute(3, "Class", "w-16 h-16 mx-auto mb-4");
            builder.CloseComponent();
            builder.OpenElement(4, "p");
            builder.AddContent(5, "「このページをスキャン」または「全ページをスキャン」を押してください");
            builder.CloseElement();
            builder.CloseElement();
        }
    };

    private List<ActionButtonItem> resetActions => new()
    {
        new ActionButtonItem
        {
            IconFragment = builder =>
            {
                builder.OpenComponent(0, typeof(ArrowLeftIcon));
                builder.AddAttribute(1, "Class", "w-5 h-5"); 
                builder.CloseComponent();
            },
            Title = "最初からやり直す",
            OnClick = EventCallback.Factory.Create(this, GoBack),
            ButtonClass = "bg-amber-200 hover:bg-amber-300 border border-amber-400 font-bold py-2 px-3 rounded",
            TextColor = "text-black"
        }
    };

    private List<SplitButton.MenuActionItem> scanMenuItems => new()
    {
        new SplitButton.MenuActionItem
        {
            Label = "このページ",
            OnClick = EventCallback.Factory.Create(this, ScanCurrentPage)
        },
        new SplitButton.MenuActionItem
        {
            Label = "全ページ",
            OnClick = EventCallback.Factory.Create(this, ScanAllPages)
        }
    };

    protected override void OnInitialized()
    {
        PdfDataService.OnChange += OnServiceChanged;
        PdfDataService.PasswordInputDialogFunc = ShowPasswordInputDialogAsync;
        PdfDataService.SwitchDisplayMode(DisplayMode.Page);
    }

    private void OnServiceChanged()
    {
        // プレビューキャッシュをクリア（新しいファイルが読み込まれた可能性）
        highResPreviewCache.Clear();
        previewGenerating.Clear();
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("loadHtml5QrcodeLibrary");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to load QR library: {ex.Message}");
            }
        }
        
        // 初期画面のときのみ登録
        if (!IsFilesLoaded)
        {
            if (_dotNetRef == null)
            {
                _dotNetRef = DotNetObjectReference.Create(this);
                await JSRuntime.InvokeVoidAsync("registerSelectDropArea", _dotNetRef);
            }
        }
        else
        {
            // ファイルが読み込まれたらドロップエリアを解除
            if (_dotNetRef != null)
            {
                await JSRuntime.InvokeVoidAsync("unregisterSelectDropArea");
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        PdfDataService.OnChange -= OnServiceChanged;
        PdfDataService.PasswordInputDialogFunc = null;
        
        try
        {
            await JSRuntime.InvokeVoidAsync("unregisterSelectDropArea");
        }
        catch { }
        _dotNetRef?.Dispose();
    }

    private async Task ScanCurrentPage()
    {
        if (isScanning) return;

        isScanning = true;
        StateHasChanged();

        try
        {
            var item = DisplayItems[displayedPageNumber - 1];
            await ScanPage(item, displayedPageNumber);
        }
        finally
        {
            isScanning = false;
            StateHasChanged();
        }
    }

    private async Task ScanAllPages()
    {
        if (isScanning) return;

        isScanning = true;
        StateHasChanged();

        try
        {
            for (int i = 0; i < DisplayItems.Count; i++)
            {
                var item = DisplayItems[i];
                await ScanPage(item, i + 1);
                StateHasChanged();
            }
        }
        finally
        {
            isScanning = false;
            StateHasChanged();
        }
    }

    private async Task ScanPage(DisplayItem item, int pageNumber)
    {
        try
        {
            if (item.RawData is PageItem pageItem)
            {
                // 高解像度画像を取得（キャッシュまたは生成）
                var highResUrl = await GetOrCreateHighResPreview(pageNumber - 1, pageItem);
                
                if (string.IsNullOrEmpty(highResUrl))
                {
                    qrResults.Add(new QrScanResult
                    {
                        PageNumber = pageNumber,
                        Success = false,
                        Error = "プレビュー画像の生成に失敗しました"
                    });
                    return;
                }
                
                var result = await JSRuntime.InvokeAsync<QrScanJsResult>("scanQrCodeFromImageUrl", highResUrl);
                
                // 既存の結果を削除
                qrResults.RemoveAll(r => r.PageNumber == pageNumber);
                
                // 新しい結果を追加
                qrResults.Add(new QrScanResult
                {
                    PageNumber = pageNumber,
                    Success = result.success,
                    Text = result.text ?? "",
                    Error = result.error ?? "QRコードが見つかりませんでした"
                });
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"QR scan error for page {pageNumber}: {ex.Message}");
            qrResults.Add(new QrScanResult
            {
                PageNumber = pageNumber,
                Success = false,
                Error = "QRコードの読み取りに失敗しました"
            });
        }
    }
    
    /// <summary>
    /// 高解像度プレビューを取得（同期版 - UI表示用）
    /// </summary>
    private string? GetHighResPreview(int pageIndex, PageItem pageItem)
    {
        // キャッシュキーを解像度込みで生成
        var cacheKey = $"{pageIndex}_{selectedPreviewScale}";
        
        // キャッシュにあればそれを返す
        if (highResPreviewCache.TryGetValue(cacheKey, out var cachedUrl))
        {
            return cachedUrl;
        }
        
        // 既に生成中であればnullを返す（無限ループ防止）
        if (previewGenerating.Contains(cacheKey))
        {
            return null;
        }
        
        // 生成中フラグを立てる
        previewGenerating.Add(cacheKey);
        
        // キャッシュになければ非同期で生成開始（バックグラウンド）
        _ = Task.Run(async () =>
        {
            try
            {
                var url = await GetOrCreateHighResPreview(pageIndex, pageItem, cacheKey);
                if (!string.IsNullOrEmpty(url))
                {
                    highResPreviewCache[cacheKey] = url;
                }
                await InvokeAsync(StateHasChanged);
            }
            finally
            {
                // 生成完了したらフラグを解除
                previewGenerating.Remove(cacheKey);
            }
        });
        
        // 即座にnullを返す（読み込み中表示）
        return null;
    }
    
    /// <summary>
    /// 高解像度プレビューを取得または生成（非同期版 - QRスキャン用）
    /// PdfDataService.GetPreviewImageAsync を使用して既存の仕組みを活用
    /// </summary>
    private async Task<string?> GetOrCreateHighResPreview(int pageIndex, PageItem pageItem, string? cacheKey = null)
    {
        // キャッシュキーが指定されていなければデフォルトで生成
        cacheKey ??= $"{pageIndex}_{selectedPreviewScale}";
        
        // キャッシュチェック
        if (highResPreviewCache.TryGetValue(cacheKey, out var cachedUrl))
        {
            return cachedUrl;
        }
        
        try
        {
            // 選択された解像度に応じてスケールキーを決定
            // config.json: qrcode_2x=2.0, qrcode_2_5x=2.5, qrcode_3x=3.0
            string scaleKey = selectedPreviewScale switch
            {
                "2.0" => "qrcode_2x",
                "2.5" => "qrcode_2_5x",
                "3.0" => "qrcode_3x",
                _ => "qrcode_2x"  // デフォルトは 2.0x
            };
            
            var highResUrl = await PdfDataService.GetPreviewImageAsync(pageItem.Id, null, scaleKey);
            
            if (string.IsNullOrEmpty(highResUrl))
            {
                Console.WriteLine($"Failed to generate high-res preview for page {pageIndex + 1} at scale {selectedPreviewScale}x: GetPreviewImageAsync returned null");
                return null;
            }
            
            return highResUrl;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to generate high-res preview for page {pageIndex + 1} at scale {selectedPreviewScale}x: {ex.Message}");
            return null;
        }
    }

    private class QrScanJsResult
    {
        public bool success { get; set; }
        public string? text { get; set; }
        public string? error { get; set; }
    }

    private void ClearAllResults()
    {
        qrResults.Clear();
        StateHasChanged();
    }

    private bool IsUrl(string text)
    {
        return Uri.TryCreate(text, UriKind.Absolute, out var uri) &&
               (uri.Scheme == Uri.UriSchemeHttp || uri.Scheme == Uri.UriSchemeHttps);
    }

    private async Task CopyToClipboard(string text)
    {
        try
        {
            var success = await JSRuntime.InvokeAsync<bool>("copyToClipboard", text);
            if (success)
            {
                await MessageService.ShowAsync("クリップボードにコピーしました");
            }
        }
        catch (Exception ex)
        {
            await MessageService.ShowAsync($"コピー失敗: {ex.Message}", MessageType.Error);
        }
    }

    private void PrevPage() => displayedPageNumber = Math.Max(1, displayedPageNumber - 1);
    private void NextPage() => displayedPageNumber = Math.Min(DisplayItems.Count, displayedPageNumber + 1);

    private Task OnPageInputChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var pageNum))
        {
            displayedPageNumber = Math.Max(1, Math.Min(pageNum, DisplayItems.Count));
        }
        return Task.CompletedTask;
    }

    private async Task OpenFileDialog()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("openFileDialog", "fileInput");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error opening file dialog: {ex.Message}");
            _ = MessageService.ShowAsync($"ファイル選択ダイアログの表示に失敗しました: {ex.Message}", MessageType.Error);
        }
    }

    [JSInvokable]
    public async Task OnJsFileDropped(string fileName, string contentType, string base64Data)
    {
        try
        {
            await PdfDataService.HandleDroppedFileAsync(fileName, base64Data);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"An error occurred: {ex.Message}");
            _ = MessageService.ShowAsync($"ファイルの読み込み中にエラーが発生しました: {ex.Message}", MessageType.Error);
        }
        finally
        {
            await MessageService.HideLoadingAsync();
        }
    }

    private async Task HandleFileSelectionAsync(InputFileChangeEventArgs e)
    {
        try
        {
            await MessageService.ShowLoadingAsync("ファイル読み込み中...");
            await PdfDataService.HandleFileInputAsync(e, null);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"An error occurred: {ex.Message}");
            _ = MessageService.ShowAsync($"ファイルの読み込み中にエラーが発生しました: {ex.Message}", MessageType.Error);
        }
        finally
        {
            await MessageService.HideLoadingAsync();
        }
    }

    private Task<string?> ShowPasswordInputDialogAsync(string fileName)
    {
        passwordDialogFileName = fileName;
        isPasswordDialogOpen = true;
        passwordTcs = new TaskCompletionSource<string?>();
        StateHasChanged();
        return passwordTcs.Task;
    }

    private void OnPasswordDialogClose(string? password)
    {
        isPasswordDialogOpen = false;
        passwordTcs?.SetResult(password);
        StateHasChanged();
    }

    private void GoBack()
    {
        // ファイルをクリア（他の機能ページと同様）
        PdfDataService.Clear();
        Navigation.NavigateTo("/qrcode");
    }

    private Task ReloadPageItem(DisplayItem item)
    {
        // 必要に応じて実装
        return Task.CompletedTask;
    }
}
