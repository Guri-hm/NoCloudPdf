!function(){"use strict";async function t(){window.JSZip||await new Promise((t,e)=>{const o=document.createElement("script");o.src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js",o.onload=t,o.onerror=e,document.head.appendChild(o)})}window.getPageType=function(){return window.location.pathname.includes("/split")?"split":window.location.pathname.includes("/merge")?"merge":"unknown"},window.fadeInOnScroll={observe:function(t){if(!t)return;new IntersectionObserver(t=>{t.forEach(t=>{t.isIntersecting&&(t.target.classList.remove("opacity-0","translate-y-8"),t.target.classList.add("opacity-100","translate-y-0"))})},{threshold:.5}).observe(t)}},window.positionEditorTooltip=function(t,e){const o=document.getElementById(e);if(!o)return;o.style.display="block",o.setAttribute("aria-hidden","false"),o.style.left="-9999px",o.style.top="-9999px",o.style.visibility="hidden";const n=t.getBoundingClientRect(),r=o.getBoundingClientRect(),a=window.innerWidth||document.documentElement.clientWidth,i=window.innerHeight||document.documentElement.clientHeight,s=n.top,d=i-n.bottom,l=n.left,c=a-n.right;let w="top";s<r.height+12&&d>s&&(w="bottom"),("top"===w||"bottom"===w)&&r.width>c&&l>c&&(w="left"),("top"===w||"bottom"===w)&&r.width>l&&c>l&&(w="right");let g=0,u=0;"top"===w?(u=n.top-r.height-8,g=n.left+(n.width-r.width)/2):"bottom"===w?(u=n.bottom+8,g=n.left+(n.width-r.width)/2):"left"===w?(u=n.top+(n.height-r.height)/2,g=n.left-r.width-8):(u=n.top+(n.height-r.height)/2,g=n.right+8),g=Math.max(8,Math.min(g,a-r.width-8)),u=Math.max(8,Math.min(u,i-r.height-8)),o.style.left=Math.round(g)+"px",o.style.top=Math.round(u)+"px",o.setAttribute("data-dir",w),o.style.visibility="visible"},window.hideEditorTooltip=function(t){const e=document.getElementById(t);e&&(e.style.display="none",e.setAttribute("aria-hidden","true"))},window.registerDropArea=function(t,e){const o=document.getElementById(t);if(!o)return;o._dropHandlers&&window.unregisterDropArea(t);let n=0;o._dropHandlers={dragenter:function(t){window.isSorting||(n++,e.invokeMethodAsync("SetDragOver",!0))},dragover:function(t){window.isSorting||t.preventDefault()},dragleave:function(t){window.isSorting||(n--,n<=0&&(n=0,e.invokeMethodAsync("SetDragOver",!1)))},drop:function(t){if(!window.isSorting&&(t.preventDefault(),n=0,e.invokeMethodAsync("SetDragOver",!1),t.dataTransfer&&t.dataTransfer.files&&t.dataTransfer.files.length>0)){Array.from(t.dataTransfer.files).forEach(t=>{const o=new FileReader;o.onload=function(o){e.invokeMethodAsync("OnJsFileDropped",t.name,t.type,o.target.result.split(",")[1])},o.readAsDataURL(t)})}}},o.addEventListener("dragenter",o._dropHandlers.dragenter),o.addEventListener("dragover",o._dropHandlers.dragover),o.addEventListener("dragleave",o._dropHandlers.dragleave),o.addEventListener("drop",o._dropHandlers.drop)},window.unregisterDropArea=function(t){const e=document.getElementById(t);e&&e._dropHandlers&&(e.removeEventListener("dragenter",e._dropHandlers.dragenter),e.removeEventListener("dragover",e._dropHandlers.dragover),e.removeEventListener("dragleave",e._dropHandlers.dragleave),e.removeEventListener("drop",e._dropHandlers.drop),delete e._dropHandlers)},window.registerSelectDropArea=function(t){const e=document.getElementById("select-drop-area");if(!e||!e.firstElementChild)return;window.unregisterSelectDropArea();const o=e.firstElementChild;let n=0;e.ondragenter=t=>{n++,o.classList.remove("bg-white/60"),o.classList.add("bg-blue-100/60","border-solid")},e.ondragover=t=>{t.preventDefault()},e.ondragleave=t=>{n--,n<=0&&(console.log("ondragleave"),n=0,o.classList.remove("bg-blue-100/60","border-solid"),o.classList.add("bg-white/60"))},e.ondrop=e=>{e.preventDefault(),o.classList.remove("bg-blue-100/60","border-solid"),o.classList.add("bg-white/60"),e.dataTransfer&&e.dataTransfer.files.length>0&&Array.from(e.dataTransfer.files).forEach(e=>{const o=new FileReader;o.onload=function(o){const n=o.target.result.split(",")[1];t.invokeMethodAsync("OnJsFileDropped",e.name,e.type,n)},o.readAsDataURL(e)})},e.onpaste=e=>{e.clipboardData&&e.clipboardData.files.length>0&&Array.from(e.clipboardData.files).forEach(e=>{const o=new FileReader;o.onload=function(o){const n=o.target.result.split(",")[1];t.invokeMethodAsync("OnJsFileDropped",e.name,e.type,n)},o.readAsDataURL(e)})}},window.unregisterSelectDropArea=function(){const t=document.getElementById("select-drop-area");t&&(t.ondragenter=null,t.ondragover=null,t.ondragleave=null,t.ondrop=null,t.onpaste=null)},window.getPageSourceInfo=async function(t,e,o){try{if(!o)return null;let t=o;const e=/^data:.*;base64,(.*)$/.exec(o);e&&e[1]&&(t=e[1]);const a=window.devicePixelRatio||1;try{const e=Uint8Array.from(atob(t),t=>t.charCodeAt(0)),o=await window.pdfjsLib.getDocument({data:e,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}).promise,n=(await o.getPage(1)).getViewport({scale:1});return{origW:n.width,origH:n.height,dpr:a}}catch(n){try{const t=o,e=await new Promise((e,o)=>{const n=new Image;n.onload=()=>e(n),n.onerror=o,n.src=t});return{origW:e.naturalWidth,origH:e.naturalHeight,dpr:a}}catch(r){return console.error("getPageSourceInfo: not pdf nor image",r),null}}}catch(a){return console.error("getPageSourceInfo error",a),null}},window.drawPdfPageToCanvas=async function(t,e,o=1,n){try{const a=`#pdf-canvas-${t}`,i=document.querySelector(a);if(!i||!e)return;let s=e;const d=/^data:.*;base64,(.*)$/.exec(e);let l;d&&d[1]&&(s=d[1]);try{l=Uint8Array.from(atob(s),t=>t.charCodeAt(0))}catch(r){return void console.error("drawPdfPageToCanvas: invalid base64",r)}const c=window.pdfjsLib;if(!c)return void console.error("pdfjsLib not loaded");if(window._pdfRenderTask&&window._pdfRenderTask.cancel)try{window._pdfRenderTask.cancel()}catch{}const w=c.getDocument({data:l,standardFontDataUrl:c.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:c.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:c.GlobalWorkerOptions.openjpegJsUrl}),g=await w.promise,u=await g.getPage(1),f=window.devicePixelRatio||1,p=o<1?1:f,h=o*p,m=u.getViewport({scale:h,rotation:n});i.width=Math.round(m.width),i.height=Math.round(m.height);const b=document.createElement("canvas");b.width=Math.max(1,Math.round(m.width)),b.height=Math.max(1,Math.round(m.height));const y=b.getContext("2d");y&&y.setTransform&&y.setTransform(1,0,0,1,0,0),window._pdfRenderTask=u.render({canvasContext:y,viewport:m}),await window._pdfRenderTask.promise;const v=i.getContext("2d");if(!v)return;v.setTransform(1,0,0,1,0,0),v.clearRect(0,0,i.width,i.height);const P=Math.round((i.width-b.width)/2),F=Math.round((i.height-b.height)/2);v.drawImage(b,0,0,b.width,b.height,P,F,b.width,b.height),v.setTransform&&v.setTransform(p,0,0,p,0,0)}catch(a){if(a&&"RenderingCancelledException"===a.name)return;console.error("drawPdfPageToCanvas error",a)}},window.getTagNameFromEvent=function(t){return t&&t.target&&t.target.tagName?t.target.tagName:""},window.getCanvasCoords=function(t,e,o,n,r,a){const i=document.querySelector(t);if(!i)return{x:0,y:0};const s=i.getBoundingClientRect();return{x:(e-s.left)/a,y:(o-s.top)/a}},window.triggerFileInput=t=>{t.click()},window.clearFileInput=function(t){t&&(t.value="")},window.registerGlobalMouseUp=function(t){window._blazorMouseUpHandler=function(e){t.invokeMethodAsync("OnGlobalMouseUp")},window.addEventListener("mouseup",window._blazorMouseUpHandler)},window.unregisterGlobalMouseUp=function(){window._blazorMouseUpHandler&&(window.removeEventListener("mouseup",window._blazorMouseUpHandler),window._blazorMouseUpHandler=null)},window.registerGlobalMouseMove=function(t){window._globalMouseMoveHandler=function(e){t.invokeMethodAsync("OnGlobalMouseMove",{clientX:e.clientX,clientY:e.clientY})},window.addEventListener("mousemove",window._globalMouseMoveHandler)},window.unregisterGlobalMouseMove=function(){window._globalMouseMoveHandler&&(window.removeEventListener("mousemove",window._globalMouseMoveHandler),window._globalMouseMoveHandler=null)},window.getElementRect=function(t){const e=document.querySelector(t);if(!e)return{left:0,top:0,width:0,height:0};const o=e.getBoundingClientRect();return{left:o.left,top:o.top,width:o.width,height:o.height}},window.waitForNextFrame=function(){return new Promise(t=>requestAnimationFrame(t))},window.measureMaxLineWidth=function(t,e,o){const n=(window._measureTextCanvas||(window._measureTextCanvas=document.createElement("canvas"))).getContext("2d");n.font=`${e}px ${o}`;const r=t.split("\n");let a=0;for(const i of r){const t=n.measureText(i).width;t>a&&(a=t)}return a},window.selectAllTextarea=function(t){t&&t.select()},window.autoResizeTextarea=function(t){try{const e=(t=>t?"string"==typeof t?document.getElementById(t):(HTMLElement,t):null)(t);return e&&e.style?new Promise(t=>{requestAnimationFrame(()=>{try{e.style.height="auto",e.getBoundingClientRect();const n=window.getComputedStyle(e),r=parseFloat(n.lineHeight)||parseFloat(n.fontSize)||16,a=Math.max(e.scrollHeight||0,r),i=Math.ceil(a+2);e.style.height=i+"px",e.style.overflow="hidden";let s=0;try{const t=e.closest&&e.closest(".edit-element");if(t){const e=window.getComputedStyle(t);s=(parseFloat(e.borderTopWidth)||0)+(parseFloat(e.borderBottomWidth)||0)}}catch(o){}t(i+s||0)}catch(n){console.error("autoResizeTextarea inner error",n),t(0)}})}):(console.debug("autoResizeTextarea: element not found:",t),0)}catch(e){return console.error("autoResizeTextarea error",e),0}},window.getImageSizeFromBase64=function(t){return new Promise(e=>{const o=new Image;o.onload=function(){e({width:o.width,height:o.height})},o.src=t})},window.openInsertFileDialog=function(t){const e=document.getElementById(t);e&&(e.value=null,e.click())},window.openFileDialog=function(t){const e=document.getElementById(t);e&&e.click()},window.createZipFromUrls=async function(e,o){if(await t(),!window.JSZip)throw new Error("JSZipがロードされていません。");const n=new JSZip;for(let t=0;t<e.length;t++){const r=e[t],i=o[t]||`file${t+1}.pdf`;try{const t=await fetch(r),e=await t.blob(),o=await e.arrayBuffer();n.file(i,o)}catch(a){console.error(`ファイル取得失敗: ${i}`,a)}}const r=await n.generateAsync({type:"blob"});return URL.createObjectURL(r)},window.getZipFileSize=async function(t){try{const e=await fetch(t),o=(await e.blob()).size;return o<1024?`${o} bytes`:o<1048576?`${(o/1024).toFixed(1)} KB`:`${(o/1048576).toFixed(2)} MB`}catch(e){return console.error("zipファイルサイズ取得失敗",e),""}},window.downloadAllPdfsAsPngZip=async function(e,o,n){await t();const r=window.pdfjsLib;if(!r)return void alert("PDF.jsがロードされていません");const a=new window.JSZip;for(let t=0;t<e.length;t++){const n=e[t],i=(o[t]||`file${t+1}.pdf`).replace(/\.pdf$/i,"");try{const t=await fetch(n),e=await t.arrayBuffer(),o=await r.getDocument({data:e,standardFontDataUrl:r.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:r.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:r.GlobalWorkerOptions.openjpegJsUrl}).promise;for(let n=1;n<=o.numPages;n++){const t=await o.getPage(n),e=document.createElement("canvas"),r=t.getViewport({scale:2});e.width=r.width,e.height=r.height,await t.render({canvasContext:e.getContext("2d"),viewport:r}).promise;const s=e.toDataURL("image/png");a.file(`${i}_page${n}.png`,s.split(",")[1],{base64:!0})}}catch(d){console.error(`PDF変換失敗: ${i}`,d)}finally{pdf&&pdf.destroy()}}const i=await a.generateAsync({type:"blob"}),s=document.createElement("a");s.href=URL.createObjectURL(i),s.download=n||"images.zip",document.body.appendChild(s),s.click(),document.body.removeChild(s)};let e=null;window.addEventListener("beforeinstallprompt",t=>{t.preventDefault(),e=t}),window.isInstallPromptAvailable=function(){return null!==e},window.showInstallPrompt=async function(){e&&(e.prompt(),e=null)};let o=null;function n(t){const e=t.replace(/[\r\n\s]/g,""),o=atob(e),n=o.length,r=new Uint8Array(n);for(let a=0;a<n;a++)r[a]=o.charCodeAt(a);return r}window.loadConfig=async function(){if(!o){const t=await fetch("/config.json");o=await t.json()}return o},window.loadConfig(),window.embedImageAsPdf=async function(t,e){const{PDFDocument:o}=PDFLib,r=await o.create();let a;const i=n(t);if(e.endsWith(".png"))a=await r.embedPng(i);else if(e.endsWith(".jpg")||e.endsWith(".jpeg"))a=await r.embedJpg(i);else{if(!(e.endsWith(".gif")||e.endsWith(".bmp")||e.endsWith(".webp")||e.endsWith(".svg")))throw new Error("Unsupported image type");{const o=e.endsWith(".gif")?"image/gif":e.endsWith(".bmp")?"image/bmp":e.endsWith(".webp")?"image/webp":e.endsWith(".svg")?"image/svg+xml":"",{pngBase64:i,width:s,height:d}=await convertImageToPngBase64AndSize(t,o);a=await r.embedPng(n(i.split(",")[1]))}}const s=a.scale(1);r.addPage([s.width,s.height]).drawImage(a,{x:0,y:0,width:s.width,height:s.height});const d=await r.save();let l="";for(let n=0;n<d.length;n++)l+=String.fromCharCode(d[n]);return btoa(l)},window.mergePDFPages=async function(t){const{PDFDocument:e,degrees:o}=PDFLib,r=await e.create();for(let d=0;d<t.length;d++){let a,i=t[d],l=i.pageData;if("string"==typeof l)a=n(l);else if(l instanceof Uint8Array)a=l;else{if(!Array.isArray(l))throw new Error(`Unsupported pageData type at index ${d}: ${typeof l}`);a=new Uint8Array(l)}try{const t=await e.load(a),[n]=await r.copyPages(t,[0]);"object"==typeof i&&i.rotateAngle&&i.rotateAngle%360!=0&&(n.setRotation(o(i.rotateAngle)),console.log(`→ setRotation(${i.rotateAngle}) 実行`)),r.addPage(n)}catch(s){throw console.error(`Error at mergePDFPages index=${d}:`,s,l),s}}const a=await r.save(),i=new Blob([a],{type:"application/pdf"});return URL.createObjectURL(i)},window.renderFirstPDFPage=async function(t,e){try{let i;if(t instanceof Uint8Array)i=t;else if(Array.isArray(t))i=new Uint8Array(t);else if("string"==typeof t){const e=atob(t);i=new Uint8Array(e.length);for(let t=0;t<e.length;t++)i[t]=e.charCodeAt(t)}else i=new Uint8Array(t);if(i.length<8)throw new Error("Data too short to be valid PDF");const s=new Uint8Array(i),d=String.fromCharCode.apply(null,i.slice(0,8));if(!d.startsWith("%PDF-"))throw new Error(`Invalid PDF header: ${d}`);const l=window.pdfjsLib;if(!l)throw new Error("PDF.js library not loaded");if(i.length<1024)throw new Error("PDF file is too small to be valid");let c=!1,w=!1,g="",u="",f=null,p=null;const h=[{data:i,stopAtErrors:!1,maxImageSize:5242880,disableFontFace:!0,disableRange:!0,disableStream:!0,verbosity:1},{data:i,stopAtErrors:!1,maxImageSize:10485760,disableFontFace:!1,disableRange:!0,disableStream:!1,verbosity:1},{data:i,stopAtErrors:!1,verbosity:1}];for(let t=0;t<h.length;t++)try{const o=l.getDocument({...h[t],standardFontDataUrl:l.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:l.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:l.GlobalWorkerOptions.openjpegJsUrl,password:e||void 0});o.onPassword=function(t,e){throw e===l.PasswordResponses.NEED_PASSWORD?new Error("PasswordException"):e===l.PasswordResponses.INCORRECT_PASSWORD?(console.log("パスワードが間違っています。"),new Error("PasswordException")):new Error("PasswordException")},f=await o.promise;break}catch(n){if(p=n,n&&"PasswordException"===n.name){c=!0,g="パスワード付きPDF";break}if(t===h.length-1)throw p}if(c||!f)return{thumbnail:"",isPasswordProtected:c,isOperationRestricted:w,securityInfo:g||"パスワード付きPDF"};f&&f._pdfInfo&&f._pdfInfo.permissions&&(console.log("PDF permissions:",f._pdfInfo.permissions),w=f._pdfInfo.permissions.length>0,g+=w?" 操作制限あり":"");try{const{PDFDocument:t}=PDFLib,e=await t.load(s),o=await t.create(),[n]=await o.copyPages(e,[0]);o.addPage(n)}catch(r){console.warn("PDF extraction failed, likely due to restrictions:",r),w=!0,g+="編集不可PDF（画像PDFに変換）"}try{const t=await f.getPage(1),e=t.getViewport({scale:o.pdfSettings.scales.thumbnail}),n=document.createElement("canvas");n.width=Math.max(1,Math.round(e.width)),n.height=Math.max(1,Math.round(e.height));const r=n.getContext("2d");await t.render({canvasContext:r,viewport:e}).promise,u=n.toDataURL("image/png")}catch(a){console.error("サムネイル生成エラー:",a),u=""}return{thumbnail:u,isPasswordProtected:c,isOperationRestricted:w,securityInfo:g}}catch(n){return console.error("Error in renderFirstPDFPage:",n),{thumbnail:"",isPasswordProtected:n&&"PasswordException"===n.name,isOperationRestricted:!1,securityInfo:n&&"PasswordException"===n.name?"パスワード付きPDF":"解析失敗"}}},window.generatePdfThumbnailFromFileMetaData=async function(t,e){try{let r;if(t instanceof Uint8Array)r=t;else if(Array.isArray(t))r=new Uint8Array(t);else if("string"==typeof t){const e=atob(t);r=new Uint8Array(e.length);for(let t=0;t<e.length;t++)r[t]=e.charCodeAt(t)}else r=new Uint8Array(t);const a=window.pdfjsLib;if(!a)throw new Error("PDF.js library not loaded");let i=await a.getDocument({data:r,standardFontDataUrl:a.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:a.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:a.GlobalWorkerOptions.openjpegJsUrl}).promise,s="";try{const t=await i.getPage(e+1),n=t.getViewport({scale:o.pdfSettings.scales.thumbnail}),r=document.createElement("canvas");r.width=n.width,r.height=n.height;const a=r.getContext("2d");await t.render({canvasContext:a,viewport:n}).promise,s=r.toDataURL("image/png")}catch(n){s=""}return{thumbnail:s,isError:!1,isPasswordProtected:!1,securityInfo:""}}catch(r){return{thumbnail:"",isError:!0,isPasswordProtected:!1,securityInfo:"解析失敗"}}},window.convertImageToPngBase64AndSize=function(t,e){return new Promise((o,n)=>{const r=new Image;r.onload=function(){const t=document.createElement("canvas");t.width=r.width||800,t.height=r.height||600;t.getContext("2d").drawImage(r,0,0);const e=t.toDataURL("image/png");o({pngBase64:e,width:r.width,height:r.height})},r.onerror=n,t.startsWith("data:")?r.src=t:r.src=e?`data:${e};base64,${t}`:`data:image/png;base64,${t}`})},window.getPDFPageCount=async function(t){try{let e;if(t instanceof Uint8Array)e=t;else if(Array.isArray(t))e=new Uint8Array(t);else if("string"==typeof t){const o=atob(t);e=new Uint8Array(o.length);for(let t=0;t<o.length;t++)e[t]=o.charCodeAt(t)}else e=new Uint8Array(t);const o=window.pdfjsLib;if(!o)throw new Error("PDF.js library not loaded");const n=o.getDocument({data:e,stopAtErrors:!1,verbosity:1,standardFontDataUrl:o.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:o.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:o.GlobalWorkerOptions.openjpegJsUrl});return(await n.promise).numPages}catch(e){throw console.error("Error in getPDFPageCount:",e),e}},window.extractPdfPage=async function(t,e){try{const{PDFDocument:n}=PDFLib;if(!n)throw new Error("PDF-lib library not loaded");let r;if(t instanceof Uint8Array)r=t;else if(Array.isArray(t))r=new Uint8Array(t);else if("string"==typeof t){const e=atob(t);r=new Uint8Array(e.length);for(let t=0;t<e.length;t++)r[t]=e.charCodeAt(t)}else r=new Uint8Array(t);const a=await n.load(r),i=await n.create();try{const[t]=await i.copyPages(a,[e]);i.addPage(t)}catch(o){i.addPage([595.28,841.89])}const s=await i.save();let d="";for(let t=0;t<s.length;t++)d+=String.fromCharCode(s[t]);return btoa(d)}catch(n){console.error(`Error extracting PDF page ${e}:`,n);try{const{PDFDocument:t}=PDFLib,e=await t.create();e.addPage([595.28,841.89]);const o=await e.save();let n="";for(let r=0;r<o.length;r++)n+=String.fromCharCode(o[r]);return btoa(n)}catch(r){return""}}},window.createBlankPage=async function(){try{const{PDFDocument:t,rgb:e}=PDFLib,o=await t.create(),n=(o.addPage([595.28,841.89]),await o.save());let r="";for(let a=0;a<n.length;a++)r+=String.fromCharCode(n[a]);return btoa(r)}catch(t){return console.error("Error creating blank page:",t),""}},window.generatePdfThumbnailFromPageData=async function(t){try{const e=window.pdfjsLib,n=atob(t),r=new Uint8Array(n.length);for(let t=0;t<n.length;t++)r[t]=n.charCodeAt(t);const a=e.getDocument({data:r,standardFontDataUrl:e.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:e.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:e.GlobalWorkerOptions.openjpegJsUrl}),i=await a.promise,s=await i.getPage(1),d=s.getViewport({scale:o.pdfSettings.scales.thumbnail}),l=document.createElement("canvas");l.width=d.width,l.height=d.height;const c={canvasContext:l.getContext("2d"),viewport:d};return await s.render(c).promise,l.toDataURL("image/png")}catch(e){return console.error("Error rendering single PDF page:",e),""}},window.generatePreviewImage=async function(t,e){const n=atob(t),r=new Uint8Array(n.length);for(let o=0;o<n.length;o++)r[o]=n.charCodeAt(o);const a=pdfjsLib.getDocument({data:r,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}),i=await a.promise,s=await i.getPage(1),d=s.getViewport({scale:o.pdfSettings.scales.normal,rotation:e||0}),l=document.createElement("canvas");l.width=d.width,l.height=d.height;const c=l.getContext("2d");return await s.render({canvasContext:c,viewport:d}).promise,l.toDataURL("image/jpeg",.85)},window.getPdfFileSize=async function(t){const e=await fetch(t);return((await e.blob()).size/1048576).toFixed(2)+"MB"},window.downloadFileFromUrl=function(t,e,o){const n=document.createElement("a");n.href=t,n.download=e,n.type=o||"application/octet-stream",document.body.appendChild(n),n.click(),document.body.removeChild(n)},window.renderPdfPages=async function(t,e){if(!window.pdfjsLib)return void console.error("pdfjsLib is not loaded");const n=await pdfjsLib.getDocument({url:t,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}).promise;for(let r=0;r<e.length;r++){const t=await n.getPage(r+1),a=document.getElementById(e[r]);if(!a)continue;const i=a.getContext("2d"),s=t.getViewport({scale:o.pdfSettings.scales.normal});a.width=s.width,a.height=s.height,await t.render({canvasContext:i,viewport:s}).promise}},window.checkCanvasExists=function(t){return!!document.getElementById(t)},window._canvasRendering=window._canvasRendering||{},window.renderPdfThumbnailToCanvas=async function(t,e){if(!window.pdfjsLib)throw new Error("pdfjsLib is not loaded.");if(window._canvasRendering[e])return console.warn("render in progress, skipping:",e),!1;window._canvasRendering[e]=!0;try{const n=window.pdfjsLib.getDocument({url:t,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}),r=await n.promise,a=await r.getPage(1),i=a.getViewport({scale:o.pdfSettings.scales.thumbnail}),s=document.getElementById(e);if(!s)return console.warn("canvas not found:",e),!1;const d=s.getContext("2d");return s.width=i.width,s.height=i.height,d.clearRect(0,0,s.width,s.height),await a.render({canvasContext:d,viewport:i}).promise,!0}catch(n){return console.error("renderPdfThumbnailToCanvas error",n,t,e),!1}finally{window._canvasRendering[e]=!1}},window.drawImageToCanvas=function(t,e){const o=document.getElementById(t);if(!o)return;const n=o.getContext("2d"),r=new window.Image;r.onload=function(){n.clearRect(0,0,o.width,o.height);const t=Math.min(o.width/r.width,o.height/r.height),e=r.width*t,a=r.height*t;n.drawImage(r,(o.width-e)/2,(o.height-a)/2,e,a)},r.src=e},window.unlockPdf=async function(t,e){const n=window.pdfjsLib;if(!n)throw new Error("PDF.js library not loaded");let r;if("string"==typeof t){const e=atob(t);r=new Uint8Array(e.length);for(let t=0;t<e.length;t++)r[t]=e.charCodeAt(t)}else r=t;const a=n.getDocument({data:r,password:e,standardFontDataUrl:n.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:n.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:n.GlobalWorkerOptions.openjpegJsUrl}),i=await a.promise,{PDFDocument:s}=PDFLib,d=await s.create();for(let w=1;w<=i.numPages;w++){const t=await i.getPage(w),e=t.getViewport({scale:o.pdfSettings.scales.unlock}),n=document.createElement("canvas");n.width=e.width,n.height=e.height;const r=n.getContext("2d");await t.render({canvasContext:r,viewport:e}).promise;const a=n.toDataURL("image/png"),s=await d.embedPng(a);d.addPage([e.width,e.height]).drawImage(s,{x:0,y:0,width:e.width,height:e.height})}const l=await d.save();let c="";for(let o=0;o<l.length;o++)c+=String.fromCharCode(l[o]);return btoa(c)},window.editPdfPageWithElements=async function(t,e){const{PDFDocument:o,rgb:n,StandardFonts:r}=PDFLib;if(!PDFLib._fontkitRegistered){if(!window.fontkit)throw new Error("fontkitがロードされていません。");PDFLib.PDFDocument.prototype.registerFontkit(window.fontkit),PDFLib._fontkitRegistered=!0}const a=p(t),i=await o.load(a),s=i.getPage(0),d=s.getHeight();let l=[];try{l=JSON.parse(e)}catch(h){console.error("editJson parse error",h,e)}const c={notoSansReg:null,notoSansBold:null,notoSerifReg:null,notoSerifBold:null};async function w(t){const e=(o=t.Text,/[\u3000-\u30FF\u4E00-\u9FFF\uFF01-\uFF60]/.test(o||""));var o;const n=e&&!!((a=t.FontFamily)&&a.toString().toLowerCase().indexOf("notoserif")>=0);var a;const s=!!t.IsBold;try{if(e){if(n){if(s){if(!c.notoSerifBold){const t=await fetch("/fonts/NotoSerifJP-Bold.ttf").then(t=>t.arrayBuffer());c.notoSerifBold=await i.embedFont(t)}return c.notoSerifBold}if(!c.notoSerifReg){const t=await fetch("/fonts/NotoSerifJP-Regular.ttf").then(t=>t.arrayBuffer());c.notoSerifReg=await i.embedFont(t)}return c.notoSerifReg}if(s){if(!c.notoSansBold){const t=await fetch("/fonts/NotoSansJP-Bold.ttf").then(t=>t.arrayBuffer());c.notoSansBold=await i.embedFont(t)}return c.notoSansBold}if(!c.notoSansReg){const t=await fetch("/fonts/NotoSansJP-Regular.ttf").then(t=>t.arrayBuffer());c.notoSansReg=await i.embedFont(t)}return c.notoSansReg}return t.IsBold?await i.embedFont(r.HelveticaBold):await i.embedFont(r.Helvetica)}catch(d){return console.error("font embed error",d),await i.embedFont(r.Helvetica)}}for(const m of l)if(0===m.Type||"Text"===m.Type){let t=function(t,e,o,n){if(!t)return[""];const r=[],a=t.split(/(\s+)/);let i="";for(const s of a){const t=e.widthOfTextAtSize(s,o);if((i?e.widthOfTextAtSize(i,o):0)+t<=n)i+=s;else if(i&&r.push(i),t<=n)i=s;else{let t="";for(let a=0;a<s.length;a++){t+=s[a];e.widthOfTextAtSize(t,o)>n&&(t.length>1?(r.push(t.slice(0,-1)),t=t.slice(-1)):(r.push(t),t=""))}i=t}}return i&&r.push(i),r};const e=await w(m),o=PDFLib.degrees(m.Rotation||0),n=Number(m.FontSize)||16,r=(void 0!==m.LineHeight&&m.LineHeight>0?Number(m.LineHeight):null)||n,a=m.Text||"",i="number"==typeof m.X?m.X:0,l="number"==typeof m.Width&&m.Width>0?Number(m.Width):s.getWidth()-i,c=a.split("\n"),g=[];for(const s of c){const o=t(s,e,n,l);0===o.length?g.push(""):g.push(...o)}const u=d-(m.Y||0)-n;for(let d=0;d<g.length;d++)s.drawText(g[d]||"",{x:i,y:u-d*r,size:n,font:e,color:f(m.Color||"#000000"),rotate:o})}else if(1===m.Type||"Image"===m.Type)if(m.ImageUrl&&(m.ImageUrl.startsWith("data:image/png")||m.ImageUrl.startsWith("data:image/jpeg"))){let t,e=m.ImageUrl.split(",")[1]||m.ImageUrl;m.ImageUrl.startsWith("data:image/png")?t=await i.embedPng(p(e)):m.ImageUrl.startsWith("data:image/jpeg")&&(t=await i.embedJpg(p(e)));const o=PDFLib.degrees(m.Rotation||0);s.drawImage(t,{x:m.X||0,y:d-(m.Y||0)-(m.Height||t.height),width:m.Width||t.width,height:m.Height||t.height,rotate:o})}else console.warn("未対応画像形式: ",m.ImageUrl?m.ImageUrl.substring(0,30):"");const g=await i.save();let u="";for(let m=0;m<g.length;m++)u+=String.fromCharCode(g[m]);return btoa(u);function f(t){3===(t=t.replace("#","")).length&&(t=t.split("").map(t=>t+t).join(""));const e=parseInt(t,16);return n((e>>16&255)/255,(e>>8&255)/255,(255&e)/255)}function p(t){const e=atob(t.replace(/^data:.*;base64,/,"")),o=e.length,n=new Uint8Array(o);for(let r=0;r<o;r++)n[r]=e.charCodeAt(r);return n}},window.addStampsToPdf=async function(t,e){const{PDFDocument:o,rgb:r,StandardFonts:a,degrees:i}=PDFLib;let s;PDFLib._fontkitRegistered||(window.fontkit?(PDFLib.PDFDocument.prototype.registerFontkit(window.fontkit),PDFLib._fontkitRegistered=!0):console.warn("fontkitがロードされていません。日本語フォントは使用できません。")),s="string"==typeof t?n(t):t instanceof Uint8Array?t:(Array.isArray(t),new Uint8Array(t));const d=((e.length>0&&e[0].rotateAngle||0)%360+360)%360,l=await o.load(s),c=l.getPage(0),{width:w,height:g}=c.getSize();let u=null;function f(t){return/[\u3000-\u30FF\u4E00-\u9FFF\uFF01-\uFF60]/.test(t)}function p(t,e,o){const n=t+1;if(!o)return n.toString();const r=e.toString().length;return n.toString().padStart(r,"0")}function h(t,e,o,n,r,a,i,s){let d=0,l=0,c=0;const w=(n%360+360)%360;if(0===w){switch(t){case"TopLeft":d=e,l=a-o-s;break;case"Top":d=r/2-i/2,l=a-o-s;break;case"TopRight":d=r-e-i,l=a-o-s;break;case"BottomLeft":d=e,l=o;break;case"Bottom":d=r/2-i/2,l=o;break;case"BottomRight":d=r-e-i,l=o}c=0}else if(90===w){switch(t){case"TopLeft":d=o,l=e;break;case"Top":d=o,l=a/2-i/2;break;case"TopRight":d=o,l=a-e-i;break;case"BottomLeft":d=r-o,l=e;break;case"Bottom":d=r-o,l=a/2-i/2;break;case"BottomRight":d=r-o,l=a-e-i}c=90}else if(180===w){switch(t){case"TopLeft":d=r-e,l=o;break;case"Top":d=r/2-i/2,l=o;break;case"TopRight":d=e+i,l=o;break;case"BottomLeft":d=r-e,l=a-o;break;case"Bottom":d=r/2-i/2,l=a-o;break;case"BottomRight":d=e+i,l=a-o}c=180}else if(270===w){switch(t){case"TopLeft":d=r-o,l=a-e;break;case"Top":d=r-o,l=a/2-i/2;break;case"TopRight":d=r-o,l=e+i;break;case"BottomLeft":d=o,l=a-e;break;case"Bottom":d=o,l=a/2-i/2;break;case"BottomRight":d=o,l=e+i}c=-90}return{x:d,y:l,textRotation:c}}for(const n of e){let t,e=n.text||"";if(n.isSerial){const t=p(n.currentPageIndex||0,n.totalPages||1,n.isZeroPadded||!1);e=e?`${e}${t}`:t}if(f(e)){if(!u)try{const t="/fonts/NotoSansJP-Regular.ttf",e=await fetch(t).then(t=>t.arrayBuffer());u=await l.embedFont(e)}catch(m){console.warn("日本語フォント読み込み失敗:",m),t=await l.embedFont(a.Helvetica)}t=u||await l.embedFont(a.Helvetica)}else t=await l.embedFont(a.Helvetica);const o=n.fontSize||12,s=t.widthOfTextAtSize(e,o),y=h(n.corner,n.offsetX,n.offsetY,d,w,g,s,o),v=n.color?r(n.color.r||0,n.color.g||0,n.color.b||0):r(0,0,0);try{c.drawText(e,{x:y.x,y:y.y,size:o,font:t,color:v,rotate:i(y.textRotation)})}catch(b){throw console.error("スタンプ描画エラー:",b),b}}return await l.save()},window.scrollToSection=function(t){t&&t.scrollIntoView({behavior:"smooth"})};let r=null;window.isSorting=!1,window.initializeSortable=function(){function t(){return document.getElementById("sortable-container")}function e(){const e=t();e&&(e.classList.remove("is-sorting","dragging-chosen","dragging-ghost"),e.querySelectorAll(".dragging-chosen, .dragging-ghost").forEach(t=>{t.classList.remove("dragging-chosen","dragging-ghost")})),window.isSorting=!1}window.removeEventListener("mouseup",e),window.removeEventListener("touchend",e);const o=t();o&&"none"!==window.getComputedStyle(o).display&&window.Sortable?(r&&(r.destroy(),r=null,o.classList.remove("is-sorting"),window.isSorting=!1),window.addEventListener("mouseup",e),window.addEventListener("touchend",e),r=new Sortable(o,{draggable:".sortable-item-container",handle:window.matchMedia("(min-width: 768px)").matches?".drag-handle":".touch-drag-handle",filter:".non-sortable",animation:150,ghostClass:"dragging-ghost",chosenClass:"dragging-chosen",onStart:function(t){o.classList.add("is-sorting"),window.isSorting=!0},onMove:function(t){const e=t.related,n=t.dragged;if(e&&e.classList.contains("non-sortable")){const t=e,r=t.previousElementSibling;return r&&r.classList.contains("sortable-chosen"),o.insertBefore(n,t),!1}if(e&&e.closest(".non-sortable")){const t=e.closest(".non-sortable");return o.insertBefore(n,t),!1}if(!e||e===o){const t=o.querySelector(".non-sortable");return t&&o.insertBefore(n,t),!1}return!0},onEnd:function(t){e();const n=o.querySelectorAll(".sortable-item-container:not(.non-sortable)").length;let r=t.newIndex;t.newIndex>=n&&(r=n-1),DotNet.invokeMethodAsync("NoCloudPdf","UpdateOrder",getPageType(),t.oldIndex,r)}})):r&&r.el&&(r.destroy(),r=null,e())},function(){const t="ncp_show_tour";function e(){try{const e=document.getElementById("ncp-tour-dontshow");e&&e.checked&&function(e){try{localStorage.setItem(t,e?"true":"false")}catch(o){}}(!1)}catch(e){}}function o(t){if(t)try{"function"==typeof t.on?(t.on("complete",e),t.on("cancel",e)):"function"==typeof t.then&&t.then(e).catch(()=>{})}catch(o){}}function n(){const t=function(){const t=["undefined"!=typeof window&&window.innerWidth<768?{id:"nav-explain",selector:"#nav-hamburger",title:"メニュー表示",text:"機能の切替メニューを表示できます。すぐに利用される方はこちらから。",position:"right"}:{id:"nav-explain",selector:"#nav-main",title:"切替メニュー",text:"機能の切替メニューです。すぐに利用される方は，目的の機能をクリックしてください。",position:"right"},{id:"home-tip",selector:"#home-summary-tip",title:"概要",text:"このページ下部にアプリの概要があります。",position:"top"},{id:"install-pwa",selector:"#install-pwa-btn",title:"インストール",text:'ここから アプリのインストールをおこなえます。<br/><label style="display:inline-flex;align-items:center;margin-top:8px;"><input id="ncp-tour-dontshow" type="checkbox" style="margin-right:8px;"> 次回から表示しない</label>',position:"left"}];try{Array.from(document.querySelectorAll("[data-tg-tour]")).forEach((e,o)=>{e.id||(e.id=`ncp-tg-auto-${Date.now().toString(36)}-${o}`);const n=`#${e.id}`,r=e.getAttribute("data-tg-tour")||"",a=e.getAttribute("data-tg-content")||e.getAttribute("title")||(e.textContent||"").trim().slice(0,300),i=e.getAttribute("data-tg-placement")||"auto";t.push({id:`auto-${o}`,selector:n,title:r,text:a,position:i})})}catch(e){console.debug("tour: buildSteps auto-detect failed",e)}return t}(),n=window.tourguide?.TourGuideClient||window.TourGuideClient||window.tourguide||null;if("function"==typeof n||n&&"object"==typeof n)try{const o=t.map((t,e)=>{const o=document.querySelector(t.selector);return{title:t.title||"",content:t.text||"",target:o||t.selector,order:t.order??e+1,group:t.group??void 0}}),r={nextLabel:"次へ",prevLabel:"戻る",finishLabel:"終了",onAfterExit:e,completeOnFinish:!0};let a=null;if("object"==typeof window.tourguide&&"function"==typeof window.tourguide.TourGuideClient?a=new window.tourguide.TourGuideClient({steps:o,...r}):"function"==typeof window.TourGuideClient?a=new window.TourGuideClient({steps:o,...r}):"function"==typeof n?a=new n({steps:o,...r}):n&&"function"==typeof n.create&&(a=n.create({steps:o,...r})),a&&"function"==typeof a.start){if("function"==typeof a.on)try{a.on("complete",e),a.on("cancel",e)}catch(i){}a.onFinish(async()=>{e()}),a.start()}return console.debug("tour: started via TourGuide client",!!a),!0}catch(i){console.debug("tour: TourGuideClient init failed",i)}const r=[window.tourguide,window.TourGuide,window.TourGuideJS,window.Tour,window.tour,window.TourGuideDefault].filter(Boolean);if(0===r.length)return console.debug("tour: no tour lib found on window"),!1;const a=t=>t.map(t=>{const e=document.querySelector(t.selector);return{id:t.id,target:e||t.selector,title:t.title,text:t.text,content:t.text,placement:t.position,position:t.position}});for(const s of r){const n=a(t);try{if("function"==typeof s.start){console.debug("tour: trying lib.start on",s);return o(s.start(n,{onComplete:e,onCancel:e})),!0}if("function"==typeof s.create){console.debug("tour: trying lib.create");const t=s.create({steps:n});if(t&&"function"==typeof t.start)return"function"==typeof t.on&&(t.on("complete",e),t.on("cancel",e)),t.start(),o(t),!0}if("function"==typeof s.init){console.debug("tour: trying lib.init");const t=s.init({steps:n});if(t&&"function"==typeof t.start)return t.start(),o(t),!0}if("function"==typeof s)try{console.debug("tour: trying new lib(...)");const t=new s({steps:n,onComplete:e,onCancel:e});if(t&&"function"==typeof t.start)return t.start(),o(t),!0}catch(i){}}catch(i){console.debug("tour: mapping/start attempt failed",i)}}return console.debug("tour: no compatible start method found"),!1}window.startTourIfNeeded=async function(e={}){if(!function(){try{const e=localStorage.getItem(t);return null===e||"false"!==e}catch(e){return!0}}())return;if(!function(){const t=(document.querySelector("base")?.getAttribute("href")||"/").replace(/\/$/,""),e=location.pathname.replace(new RegExp("^"+t),"")||"/";return"/"===e||""===e}())return;n()},window._ncpTour={startTourIfNeeded:window.startTourIfNeeded}}()}();
