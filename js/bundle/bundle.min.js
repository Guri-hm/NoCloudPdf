!function(){"use strict";async function t(){window.JSZip||await new Promise((t,e)=>{const n=document.createElement("script");n.src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js",n.onload=t,n.onerror=e,document.head.appendChild(n)})}window.getPageType=function(){return window.location.pathname.includes("/split")?"split":window.location.pathname.includes("/merge")?"merge":"unknown"},window.fadeInOnScroll={observe:function(t){if(!t)return;new IntersectionObserver(t=>{t.forEach(t=>{t.isIntersecting&&(t.target.classList.remove("opacity-0","translate-y-8"),t.target.classList.add("opacity-100","translate-y-0"))})},{threshold:.5}).observe(t)}},window.positionEditorTooltip=function(t,e){const n=document.getElementById(e);if(!n)return;n.style.display="block",n.setAttribute("aria-hidden","false"),n.style.left="-9999px",n.style.top="-9999px",n.style.visibility="hidden";const o=t.getBoundingClientRect(),r=n.getBoundingClientRect(),a=window.innerWidth||document.documentElement.clientWidth,i=window.innerHeight||document.documentElement.clientHeight,s=o.top,l=i-o.bottom,d=o.left,c=a-o.right;let g="top";s<r.height+12&&l>s&&(g="bottom"),("top"===g||"bottom"===g)&&r.width>c&&d>c&&(g="left"),("top"===g||"bottom"===g)&&r.width>d&&c>d&&(g="right");let w=0,u=0;"top"===g?(u=o.top-r.height-8,w=o.left+(o.width-r.width)/2):"bottom"===g?(u=o.bottom+8,w=o.left+(o.width-r.width)/2):"left"===g?(u=o.top+(o.height-r.height)/2,w=o.left-r.width-8):(u=o.top+(o.height-r.height)/2,w=o.right+8),w=Math.max(8,Math.min(w,a-r.width-8)),u=Math.max(8,Math.min(u,i-r.height-8)),n.style.left=Math.round(w)+"px",n.style.top=Math.round(u)+"px",n.setAttribute("data-dir",g),n.style.visibility="visible"},window.hideEditorTooltip=function(t){const e=document.getElementById(t);e&&(e.style.display="none",e.setAttribute("aria-hidden","true"))},window.registerDropArea=function(t,e){const n=document.getElementById(t);if(!n)return;n._dropHandlers&&window.unregisterDropArea(t);let o=0;n._dropHandlers={dragenter:function(t){window.isSorting||(o++,e.invokeMethodAsync("SetDragOver",!0))},dragover:function(t){window.isSorting||t.preventDefault()},dragleave:function(t){window.isSorting||(o--,o<=0&&(o=0,e.invokeMethodAsync("SetDragOver",!1)))},drop:function(t){if(!window.isSorting&&(t.preventDefault(),o=0,e.invokeMethodAsync("SetDragOver",!1),t.dataTransfer&&t.dataTransfer.files&&t.dataTransfer.files.length>0)){Array.from(t.dataTransfer.files).forEach(t=>{const n=new FileReader;n.onload=function(n){e.invokeMethodAsync("OnJsFileDropped",t.name,t.type,n.target.result.split(",")[1])},n.readAsDataURL(t)})}}},n.addEventListener("dragenter",n._dropHandlers.dragenter),n.addEventListener("dragover",n._dropHandlers.dragover),n.addEventListener("dragleave",n._dropHandlers.dragleave),n.addEventListener("drop",n._dropHandlers.drop)},window.unregisterDropArea=function(t){const e=document.getElementById(t);e&&e._dropHandlers&&(e.removeEventListener("dragenter",e._dropHandlers.dragenter),e.removeEventListener("dragover",e._dropHandlers.dragover),e.removeEventListener("dragleave",e._dropHandlers.dragleave),e.removeEventListener("drop",e._dropHandlers.drop),delete e._dropHandlers)},window.registerSelectDropArea=function(t){const e=document.getElementById("select-drop-area");if(!e||!e.firstElementChild)return;window.unregisterSelectDropArea();const n=e.firstElementChild;let o=0;e.ondragenter=t=>{o++,n.classList.remove("bg-white/60"),n.classList.add("bg-blue-100/60","border-solid")},e.ondragover=t=>{t.preventDefault()},e.ondragleave=t=>{o--,o<=0&&(console.log("ondragleave"),o=0,n.classList.remove("bg-blue-100/60","border-solid"),n.classList.add("bg-white/60"))},e.ondrop=e=>{e.preventDefault(),n.classList.remove("bg-blue-100/60","border-solid"),n.classList.add("bg-white/60"),e.dataTransfer&&e.dataTransfer.files.length>0&&Array.from(e.dataTransfer.files).forEach(e=>{const n=new FileReader;n.onload=function(n){const o=n.target.result.split(",")[1];t.invokeMethodAsync("OnJsFileDropped",e.name,e.type,o)},n.readAsDataURL(e)})},e.onpaste=e=>{e.clipboardData&&e.clipboardData.files.length>0&&Array.from(e.clipboardData.files).forEach(e=>{const n=new FileReader;n.onload=function(n){const o=n.target.result.split(",")[1];t.invokeMethodAsync("OnJsFileDropped",e.name,e.type,o)},n.readAsDataURL(e)})}},window.unregisterSelectDropArea=function(){const t=document.getElementById("select-drop-area");t&&(t.ondragenter=null,t.ondragover=null,t.ondragleave=null,t.ondrop=null,t.onpaste=null)},window.getPageSourceInfo=async function(t,e,n){try{if(!n)return null;let t=n;const e=/^data:.*;base64,(.*)$/.exec(n);e&&e[1]&&(t=e[1]);const a=window.devicePixelRatio||1;try{const e=Uint8Array.from(atob(t),t=>t.charCodeAt(0)),n=await window.pdfjsLib.getDocument({data:e,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}).promise,o=(await n.getPage(1)).getViewport({scale:1});return{origW:o.width,origH:o.height,dpr:a}}catch(o){try{const t=n,e=await new Promise((e,n)=>{const o=new Image;o.onload=()=>e(o),o.onerror=n,o.src=t});return{origW:e.naturalWidth,origH:e.naturalHeight,dpr:a}}catch(r){return console.error("getPageSourceInfo: not pdf nor image",r),null}}}catch(a){return console.error("getPageSourceInfo error",a),null}},window.drawPdfPageToCanvas=async function(t,e,n=1,o){try{const a=`#pdf-canvas-${t}`,i=document.querySelector(a);if(!i||!e)return;let s=e;const l=/^data:.*;base64,(.*)$/.exec(e);let d;l&&l[1]&&(s=l[1]);try{d=Uint8Array.from(atob(s),t=>t.charCodeAt(0))}catch(r){return void console.error("drawPdfPageToCanvas: invalid base64",r)}const c=window.pdfjsLib;if(!c)return void console.error("pdfjsLib not loaded");if(window._pdfRenderTask&&window._pdfRenderTask.cancel)try{window._pdfRenderTask.cancel()}catch{}const g=c.getDocument({data:d,standardFontDataUrl:c.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:c.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:c.GlobalWorkerOptions.openjpegJsUrl}),w=await g.promise,u=await w.getPage(1),f=window.devicePixelRatio||1,p=n<1?1:f,h=n*p,m=u.getViewport({scale:h,rotation:o});i.width=Math.round(m.width),i.height=Math.round(m.height);const b=document.createElement("canvas");b.width=Math.max(1,Math.round(m.width)),b.height=Math.max(1,Math.round(m.height));const y=b.getContext("2d");y&&y.setTransform&&y.setTransform(1,0,0,1,0,0),window._pdfRenderTask=u.render({canvasContext:y,viewport:m}),await window._pdfRenderTask.promise;const v=i.getContext("2d");if(!v)return;v.setTransform(1,0,0,1,0,0),v.clearRect(0,0,i.width,i.height);const P=Math.round((i.width-b.width)/2),F=Math.round((i.height-b.height)/2);v.drawImage(b,0,0,b.width,b.height,P,F,b.width,b.height),v.setTransform&&v.setTransform(p,0,0,p,0,0)}catch(a){if(a&&"RenderingCancelledException"===a.name)return;console.error("drawPdfPageToCanvas error",a)}},window.getTagNameFromEvent=function(t){return t&&t.target&&t.target.tagName?t.target.tagName:""},window.getCanvasCoords=function(t,e,n,o,r,a){const i=document.querySelector(t);if(!i)return{x:0,y:0};const s=i.getBoundingClientRect();return{x:(e-s.left)/a,y:(n-s.top)/a}},window.triggerFileInput=t=>{t.click()},window.clearFileInput=function(t){t&&(t.value="")},window.registerGlobalMouseUp=function(t){window._blazorMouseUpHandler=function(e){t.invokeMethodAsync("OnGlobalMouseUp")},window.addEventListener("mouseup",window._blazorMouseUpHandler)},window.unregisterGlobalMouseUp=function(){window._blazorMouseUpHandler&&(window.removeEventListener("mouseup",window._blazorMouseUpHandler),window._blazorMouseUpHandler=null)},window.registerGlobalMouseMove=function(t){window._globalMouseMoveHandler=function(e){t.invokeMethodAsync("OnGlobalMouseMove",{clientX:e.clientX,clientY:e.clientY})},window.addEventListener("mousemove",window._globalMouseMoveHandler)},window.unregisterGlobalMouseMove=function(){window._globalMouseMoveHandler&&(window.removeEventListener("mousemove",window._globalMouseMoveHandler),window._globalMouseMoveHandler=null)},window.getElementRect=function(t){const e=document.querySelector(t);if(!e)return{left:0,top:0,width:0,height:0};const n=e.getBoundingClientRect();return{left:n.left,top:n.top,width:n.width,height:n.height}},window.waitForNextFrame=function(){return new Promise(t=>requestAnimationFrame(t))},window.measureMaxLineWidth=function(t,e,n){const o=(window._measureTextCanvas||(window._measureTextCanvas=document.createElement("canvas"))).getContext("2d");o.font=`${e}px ${n}`;const r=t.split("\n");let a=0;for(const i of r){const t=o.measureText(i).width;t>a&&(a=t)}return a},window.selectAllTextarea=function(t){t&&t.select()},window.autoResizeTextarea=function(t){try{const e=(t=>t?"string"==typeof t?document.getElementById(t):(HTMLElement,t):null)(t);return e&&e.style?new Promise(t=>{requestAnimationFrame(()=>{try{e.style.height="auto",e.getBoundingClientRect();const o=window.getComputedStyle(e),r=parseFloat(o.lineHeight)||parseFloat(o.fontSize)||16,a=Math.max(e.scrollHeight||0,r),i=Math.ceil(a+2);e.style.height=i+"px",e.style.overflow="hidden";let s=0;try{const t=e.closest&&e.closest(".edit-element");if(t){const e=window.getComputedStyle(t);s=(parseFloat(e.borderTopWidth)||0)+(parseFloat(e.borderBottomWidth)||0)}}catch(n){}t(i+s||0)}catch(o){console.error("autoResizeTextarea inner error",o),t(0)}})}):(console.debug("autoResizeTextarea: element not found:",t),0)}catch(e){return console.error("autoResizeTextarea error",e),0}},window.getImageSizeFromBase64=function(t){return new Promise(e=>{const n=new Image;n.onload=function(){e({width:n.width,height:n.height})},n.src=t})},window.openInsertFileDialog=function(t){const e=document.getElementById(t);e&&(e.value=null,e.click())},window.openFileDialog=function(t){const e=document.getElementById(t);e&&e.click()},window.createZipFromUrls=async function(e,n){if(await t(),!window.JSZip)throw new Error("JSZipがロードされていません。");const o=new JSZip;for(let t=0;t<e.length;t++){const r=e[t],i=n[t]||`file${t+1}.pdf`;try{const t=await fetch(r),e=await t.blob(),n=await e.arrayBuffer();o.file(i,n)}catch(a){console.error(`ファイル取得失敗: ${i}`,a)}}const r=await o.generateAsync({type:"blob"});return URL.createObjectURL(r)},window.getZipFileSize=async function(t){try{const e=await fetch(t),n=(await e.blob()).size;return n<1024?`${n} bytes`:n<1048576?`${(n/1024).toFixed(1)} KB`:`${(n/1048576).toFixed(2)} MB`}catch(e){return console.error("zipファイルサイズ取得失敗",e),""}},window.downloadAllPdfsAsPngZip=async function(e,n,o){await t();const r=window.pdfjsLib;if(!r)return void alert("PDF.jsがロードされていません");const a=new window.JSZip;for(let t=0;t<e.length;t++){const o=e[t],i=(n[t]||`file${t+1}.pdf`).replace(/\.pdf$/i,"");try{const t=await fetch(o),e=await t.arrayBuffer(),n=await r.getDocument({data:e,standardFontDataUrl:r.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:r.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:r.GlobalWorkerOptions.openjpegJsUrl}).promise;for(let o=1;o<=n.numPages;o++){const t=await n.getPage(o),e=document.createElement("canvas"),r=t.getViewport({scale:2});e.width=r.width,e.height=r.height,await t.render({canvasContext:e.getContext("2d"),viewport:r}).promise;const s=e.toDataURL("image/png");a.file(`${i}_page${o}.png`,s.split(",")[1],{base64:!0})}}catch(l){console.error(`PDF変換失敗: ${i}`,l)}finally{pdf&&pdf.destroy()}}const i=await a.generateAsync({type:"blob"}),s=document.createElement("a");s.href=URL.createObjectURL(i),s.download=o||"images.zip",document.body.appendChild(s),s.click(),document.body.removeChild(s)};let e=null;window.addEventListener("beforeinstallprompt",t=>{t.preventDefault(),e=t}),window.isInstallPromptAvailable=function(){return null!==e},window.showInstallPrompt=async function(){e&&(e.prompt(),e=null)};let n=null;function o(t){const e=t.replace(/[\r\n\s]/g,""),n=atob(e),o=n.length,r=new Uint8Array(o);for(let a=0;a<o;a++)r[a]=n.charCodeAt(a);return r}window.loadConfig=async function(){if(!n){const t=await fetch("/config.json");n=await t.json()}return n},window.loadConfig(),window.embedImageAsPdf=async function(t,e){const{PDFDocument:n}=PDFLib,r=await n.create();let a;const i=o(t);if(e.endsWith(".png"))a=await r.embedPng(i);else if(e.endsWith(".jpg")||e.endsWith(".jpeg"))a=await r.embedJpg(i);else{if(!(e.endsWith(".gif")||e.endsWith(".bmp")||e.endsWith(".webp")||e.endsWith(".svg")))throw new Error("Unsupported image type");{const n=e.endsWith(".gif")?"image/gif":e.endsWith(".bmp")?"image/bmp":e.endsWith(".webp")?"image/webp":e.endsWith(".svg")?"image/svg+xml":"",{pngBase64:i,width:s,height:l}=await convertImageToPngBase64AndSize(t,n);a=await r.embedPng(o(i.split(",")[1]))}}const s=a.scale(1);r.addPage([s.width,s.height]).drawImage(a,{x:0,y:0,width:s.width,height:s.height});const l=await r.save();let d="";for(let o=0;o<l.length;o++)d+=String.fromCharCode(l[o]);return btoa(d)},window.mergePDFPages=async function(t){const{PDFDocument:e,degrees:n}=PDFLib,r=await e.create();for(let l=0;l<t.length;l++){let a,i=t[l],d=i.pageData;if("string"==typeof d)a=o(d);else if(d instanceof Uint8Array)a=d;else{if(!Array.isArray(d))throw new Error(`Unsupported pageData type at index ${l}: ${typeof d}`);a=new Uint8Array(d)}try{const t=await e.load(a),[o]=await r.copyPages(t,[0]);"object"==typeof i&&i.rotateAngle&&i.rotateAngle%360!=0&&(o.setRotation(n(i.rotateAngle)),console.log(`→ setRotation(${i.rotateAngle}) 実行`)),r.addPage(o)}catch(s){throw console.error(`Error at mergePDFPages index=${l}:`,s,d),s}}const a=await r.save(),i=new Blob([a],{type:"application/pdf"});return URL.createObjectURL(i)},window.renderFirstPDFPage=async function(t,e){try{let s;if(t instanceof Uint8Array)s=t;else if(Array.isArray(t))s=new Uint8Array(t);else if("string"==typeof t){const y=atob(t);s=new Uint8Array(y.length);for(let v=0;v<y.length;v++)s[v]=y.charCodeAt(v)}else s=new Uint8Array(t);if(s.length<8)throw new Error("Data too short to be valid PDF");const l=new Uint8Array(s),d=String.fromCharCode.apply(null,s.slice(0,8));if(!d.startsWith("%PDF-"))throw new Error(`Invalid PDF header: ${d}`);const c=window.pdfjsLib;if(!c)throw new Error("PDF.js library not loaded");if(s.length<1024)throw new Error("PDF file is too small to be valid");let g=!1,w=!1,u="",f="",p=null,h=null;const m=[{data:s,stopAtErrors:!1,maxImageSize:5242880,disableFontFace:!0,disableRange:!0,disableStream:!0,verbosity:1},{data:s,stopAtErrors:!1,maxImageSize:10485760,disableFontFace:!1,disableRange:!0,disableStream:!1,verbosity:1},{data:s,stopAtErrors:!1,verbosity:1}];for(let P=0;P<m.length;P++)try{const F=c.getDocument({...m[P],standardFontDataUrl:c.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:c.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:c.GlobalWorkerOptions.openjpegJsUrl,password:e||void 0});F.onPassword=function(t,e){throw e===c.PasswordResponses.NEED_PASSWORD?new Error("PasswordException"):e===c.PasswordResponses.INCORRECT_PASSWORD?(console.log("パスワードが間違っています。"),new Error("PasswordException")):new Error("PasswordException")},p=await F.promise;break}catch(o){if(h=o,o&&"PasswordException"===o.name){g=!0,u="パスワード付きPDF";break}if(P===m.length-1)throw h}if(g||!p)return{thumbnail:"",isPasswordProtected:g,isOperationRestricted:w,securityInfo:u||"パスワード付きPDF"};p&&p._pdfInfo&&p._pdfInfo.permissions&&(console.log("PDF permissions:",p._pdfInfo.permissions),w=p._pdfInfo.permissions.length>0,u+=w?" 操作制限あり":"");try{const{PDFDocument:D}=PDFLib,U=await D.load(l),x=await D.create(),[S]=await x.copyPages(U,[0]);x.addPage(S)}catch(r){console.warn("PDF extraction failed, likely due to restrictions:",r),w=!0,u+="編集不可PDF（画像PDFに変換）"}try{const A=await p.getPage(1),L=A.getViewport({scale:n.pdfSettings.scales.thumbnail}),E=document.createElement("canvas");E.width=Math.max(1,Math.round(L.width)),E.height=Math.max(1,Math.round(L.height));const k=E.getContext("2d");await A.render({canvasContext:k,viewport:L}).promise,f=E.toDataURL("image/png")}catch(a){console.error("サムネイル生成エラー:",a),f=""}let b=[];try{const C=await p.getOutline();if(C&&C.length){async function T(t){const e=[];for(const o of t){let t=null;try{let e=o.dest;if("string"==typeof e&&(e=await p.getDestination(e)),Array.isArray(e)&&e.length>0)try{t=await p.getPageIndex(e[0])}catch(n){t=null}}catch(n){}const r={title:o.title||"",pageIndex:t,items:[]};o.items&&o.items.length&&(r.items=await T(o.items)),e.push(r)}return e}try{b=await T(C)}catch(i){console.debug("pdf: outline mapping failed",i),b=[]}}}catch(i){console.debug("pdf: getOutline failed or no outline",i),b=[]}return console.log("PDF bookmarks:",b),{thumbnail:f,isPasswordProtected:g,isOperationRestricted:w,securityInfo:u}}catch(o){return console.error("Error in renderFirstPDFPage:",o),{thumbnail:"",isPasswordProtected:o&&"PasswordException"===o.name,isOperationRestricted:!1,securityInfo:o&&"PasswordException"===o.name?"パスワード付きPDF":"解析失敗"}}},window.generatePdfThumbnailFromFileMetaData=async function(t,e){try{let r;if(t instanceof Uint8Array)r=t;else if(Array.isArray(t))r=new Uint8Array(t);else if("string"==typeof t){const e=atob(t);r=new Uint8Array(e.length);for(let t=0;t<e.length;t++)r[t]=e.charCodeAt(t)}else r=new Uint8Array(t);const a=window.pdfjsLib;if(!a)throw new Error("PDF.js library not loaded");let i=await a.getDocument({data:r,standardFontDataUrl:a.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:a.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:a.GlobalWorkerOptions.openjpegJsUrl}).promise,s="";try{const t=await i.getPage(e+1),o=t.getViewport({scale:n.pdfSettings.scales.thumbnail}),r=document.createElement("canvas");r.width=o.width,r.height=o.height;const a=r.getContext("2d");await t.render({canvasContext:a,viewport:o}).promise,s=r.toDataURL("image/png")}catch(o){s=""}return{thumbnail:s,isError:!1,isPasswordProtected:!1,securityInfo:""}}catch(r){return{thumbnail:"",isError:!0,isPasswordProtected:!1,securityInfo:"解析失敗"}}},window.convertImageToPngBase64AndSize=function(t,e){return new Promise((n,o)=>{const r=new Image;r.onload=function(){const t=document.createElement("canvas");t.width=r.width||800,t.height=r.height||600;t.getContext("2d").drawImage(r,0,0);const e=t.toDataURL("image/png");n({pngBase64:e,width:r.width,height:r.height})},r.onerror=o,t.startsWith("data:")?r.src=t:r.src=e?`data:${e};base64,${t}`:`data:image/png;base64,${t}`})},window.getPDFPageCount=async function(t){try{let e;if(t instanceof Uint8Array)e=t;else if(Array.isArray(t))e=new Uint8Array(t);else if("string"==typeof t){const n=atob(t);e=new Uint8Array(n.length);for(let t=0;t<n.length;t++)e[t]=n.charCodeAt(t)}else e=new Uint8Array(t);const n=window.pdfjsLib;if(!n)throw new Error("PDF.js library not loaded");const o=n.getDocument({data:e,stopAtErrors:!1,verbosity:1,standardFontDataUrl:n.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:n.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:n.GlobalWorkerOptions.openjpegJsUrl});return(await o.promise).numPages}catch(e){throw console.error("Error in getPDFPageCount:",e),e}},window.extractPdfPage=async function(t,e){try{const{PDFDocument:o}=PDFLib;if(!o)throw new Error("PDF-lib library not loaded");let r;if(t instanceof Uint8Array)r=t;else if(Array.isArray(t))r=new Uint8Array(t);else if("string"==typeof t){const e=atob(t);r=new Uint8Array(e.length);for(let t=0;t<e.length;t++)r[t]=e.charCodeAt(t)}else r=new Uint8Array(t);const a=await o.load(r),i=await o.create();try{const[t]=await i.copyPages(a,[e]);i.addPage(t)}catch(n){i.addPage([595.28,841.89])}const s=await i.save();let l="";for(let t=0;t<s.length;t++)l+=String.fromCharCode(s[t]);return btoa(l)}catch(o){console.error(`Error extracting PDF page ${e}:`,o);try{const{PDFDocument:t}=PDFLib,e=await t.create();e.addPage([595.28,841.89]);const n=await e.save();let o="";for(let r=0;r<n.length;r++)o+=String.fromCharCode(n[r]);return btoa(o)}catch(r){return""}}},window.createBlankPage=async function(){try{const{PDFDocument:t,rgb:e}=PDFLib,n=await t.create(),o=(n.addPage([595.28,841.89]),await n.save());let r="";for(let a=0;a<o.length;a++)r+=String.fromCharCode(o[a]);return btoa(r)}catch(t){return console.error("Error creating blank page:",t),""}},window.generatePdfThumbnailFromPageData=async function(t){try{const e=window.pdfjsLib,o=atob(t),r=new Uint8Array(o.length);for(let t=0;t<o.length;t++)r[t]=o.charCodeAt(t);const a=e.getDocument({data:r,standardFontDataUrl:e.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:e.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:e.GlobalWorkerOptions.openjpegJsUrl}),i=await a.promise,s=await i.getPage(1),l=s.getViewport({scale:n.pdfSettings.scales.thumbnail}),d=document.createElement("canvas");d.width=l.width,d.height=l.height;const c={canvasContext:d.getContext("2d"),viewport:l};return await s.render(c).promise,d.toDataURL("image/png")}catch(e){return console.error("Error rendering single PDF page:",e),""}},window.generatePreviewImage=async function(t,e){const o=atob(t),r=new Uint8Array(o.length);for(let n=0;n<o.length;n++)r[n]=o.charCodeAt(n);const a=pdfjsLib.getDocument({data:r,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}),i=await a.promise,s=await i.getPage(1),l=s.getViewport({scale:n.pdfSettings.scales.normal,rotation:e||0}),d=document.createElement("canvas");d.width=l.width,d.height=l.height;const c=d.getContext("2d");return await s.render({canvasContext:c,viewport:l}).promise,d.toDataURL("image/jpeg",.85)},window.getPdfFileSize=async function(t){const e=await fetch(t);return((await e.blob()).size/1048576).toFixed(2)+"MB"},window.downloadFileFromUrl=function(t,e,n){const o=document.createElement("a");o.href=t,o.download=e,o.type=n||"application/octet-stream",document.body.appendChild(o),o.click(),document.body.removeChild(o)},window.renderPdfPages=async function(t,e){if(!window.pdfjsLib)return void console.error("pdfjsLib is not loaded");const o=await pdfjsLib.getDocument({url:t,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}).promise;for(let r=0;r<e.length;r++){const t=await o.getPage(r+1),a=document.getElementById(e[r]);if(!a)continue;const i=a.getContext("2d"),s=t.getViewport({scale:n.pdfSettings.scales.normal});a.width=s.width,a.height=s.height,await t.render({canvasContext:i,viewport:s}).promise}},window.checkCanvasExists=function(t){return!!document.getElementById(t)},window._canvasRendering=window._canvasRendering||{},window.renderPdfThumbnailToCanvas=async function(t,e){if(!window.pdfjsLib)throw new Error("pdfjsLib is not loaded.");if(window._canvasRendering[e])return console.warn("render in progress, skipping:",e),!1;window._canvasRendering[e]=!0;try{const o=window.pdfjsLib.getDocument({url:t,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}),r=await o.promise,a=await r.getPage(1),i=a.getViewport({scale:n.pdfSettings.scales.thumbnail}),s=document.getElementById(e);if(!s)return console.warn("canvas not found:",e),!1;const l=s.getContext("2d");return s.width=i.width,s.height=i.height,l.clearRect(0,0,s.width,s.height),await a.render({canvasContext:l,viewport:i}).promise,!0}catch(o){return console.error("renderPdfThumbnailToCanvas error",o,t,e),!1}finally{window._canvasRendering[e]=!1}},window.drawImageToCanvas=function(t,e){const n=document.getElementById(t);if(!n)return;const o=n.getContext("2d"),r=new window.Image;r.onload=function(){o.clearRect(0,0,n.width,n.height);const t=Math.min(n.width/r.width,n.height/r.height),e=r.width*t,a=r.height*t;o.drawImage(r,(n.width-e)/2,(n.height-a)/2,e,a)},r.src=e},window.unlockPdf=async function(t,e){const o=window.pdfjsLib;if(!o)throw new Error("PDF.js library not loaded");let r;if("string"==typeof t){const e=atob(t);r=new Uint8Array(e.length);for(let t=0;t<e.length;t++)r[t]=e.charCodeAt(t)}else r=t;const a=o.getDocument({data:r,password:e,standardFontDataUrl:o.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:o.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:o.GlobalWorkerOptions.openjpegJsUrl}),i=await a.promise,{PDFDocument:s}=PDFLib,l=await s.create();for(let g=1;g<=i.numPages;g++){const t=await i.getPage(g),e=t.getViewport({scale:n.pdfSettings.scales.unlock}),o=document.createElement("canvas");o.width=e.width,o.height=e.height;const r=o.getContext("2d");await t.render({canvasContext:r,viewport:e}).promise;const a=o.toDataURL("image/png"),s=await l.embedPng(a);l.addPage([e.width,e.height]).drawImage(s,{x:0,y:0,width:e.width,height:e.height})}const d=await l.save();let c="";for(let n=0;n<d.length;n++)c+=String.fromCharCode(d[n]);return btoa(c)},window.editPdfPageWithElements=async function(t,e){const{PDFDocument:n,rgb:o,StandardFonts:r}=PDFLib;if(!PDFLib._fontkitRegistered){if(!window.fontkit)throw new Error("fontkitがロードされていません。");PDFLib.PDFDocument.prototype.registerFontkit(window.fontkit),PDFLib._fontkitRegistered=!0}const a=p(t),i=await n.load(a),s=i.getPage(0),l=s.getHeight();let d=[];try{d=JSON.parse(e)}catch(h){console.error("editJson parse error",h,e)}const c={notoSansReg:null,notoSansBold:null,notoSerifReg:null,notoSerifBold:null};async function g(t){const e=(n=t.Text,/[\u3000-\u30FF\u4E00-\u9FFF\uFF01-\uFF60]/.test(n||""));var n;const o=e&&!!((a=t.FontFamily)&&a.toString().toLowerCase().indexOf("notoserif")>=0);var a;const s=!!t.IsBold;try{if(e){if(o){if(s){if(!c.notoSerifBold){const t=await fetch("/fonts/NotoSerifJP-Bold.ttf").then(t=>t.arrayBuffer());c.notoSerifBold=await i.embedFont(t)}return c.notoSerifBold}if(!c.notoSerifReg){const t=await fetch("/fonts/NotoSerifJP-Regular.ttf").then(t=>t.arrayBuffer());c.notoSerifReg=await i.embedFont(t)}return c.notoSerifReg}if(s){if(!c.notoSansBold){const t=await fetch("/fonts/NotoSansJP-Bold.ttf").then(t=>t.arrayBuffer());c.notoSansBold=await i.embedFont(t)}return c.notoSansBold}if(!c.notoSansReg){const t=await fetch("/fonts/NotoSansJP-Regular.ttf").then(t=>t.arrayBuffer());c.notoSansReg=await i.embedFont(t)}return c.notoSansReg}return t.IsBold?await i.embedFont(r.HelveticaBold):await i.embedFont(r.Helvetica)}catch(l){return console.error("font embed error",l),await i.embedFont(r.Helvetica)}}for(const m of d)if(0===m.Type||"Text"===m.Type){let t=function(t,e,n,o){if(!t)return[""];const r=[],a=t.split(/(\s+)/);let i="";for(const s of a){const t=e.widthOfTextAtSize(s,n);if((i?e.widthOfTextAtSize(i,n):0)+t<=o)i+=s;else if(i&&r.push(i),t<=o)i=s;else{let t="";for(let a=0;a<s.length;a++){t+=s[a];e.widthOfTextAtSize(t,n)>o&&(t.length>1?(r.push(t.slice(0,-1)),t=t.slice(-1)):(r.push(t),t=""))}i=t}}return i&&r.push(i),r};const e=await g(m),n=PDFLib.degrees(m.Rotation||0),o=Number(m.FontSize)||16,r=(void 0!==m.LineHeight&&m.LineHeight>0?Number(m.LineHeight):null)||o,a=m.Text||"",i="number"==typeof m.X?m.X:0,d="number"==typeof m.Width&&m.Width>0?Number(m.Width):s.getWidth()-i,c=a.split("\n"),w=[];for(const s of c){const n=t(s,e,o,d);0===n.length?w.push(""):w.push(...n)}const u=l-(m.Y||0)-o;for(let l=0;l<w.length;l++)s.drawText(w[l]||"",{x:i,y:u-l*r,size:o,font:e,color:f(m.Color||"#000000"),rotate:n})}else if(1===m.Type||"Image"===m.Type)if(m.ImageUrl&&(m.ImageUrl.startsWith("data:image/png")||m.ImageUrl.startsWith("data:image/jpeg"))){let t,e=m.ImageUrl.split(",")[1]||m.ImageUrl;m.ImageUrl.startsWith("data:image/png")?t=await i.embedPng(p(e)):m.ImageUrl.startsWith("data:image/jpeg")&&(t=await i.embedJpg(p(e)));const n=PDFLib.degrees(m.Rotation||0);s.drawImage(t,{x:m.X||0,y:l-(m.Y||0)-(m.Height||t.height),width:m.Width||t.width,height:m.Height||t.height,rotate:n})}else console.warn("未対応画像形式: ",m.ImageUrl?m.ImageUrl.substring(0,30):"");const w=await i.save();let u="";for(let m=0;m<w.length;m++)u+=String.fromCharCode(w[m]);return btoa(u);function f(t){3===(t=t.replace("#","")).length&&(t=t.split("").map(t=>t+t).join(""));const e=parseInt(t,16);return o((e>>16&255)/255,(e>>8&255)/255,(255&e)/255)}function p(t){const e=atob(t.replace(/^data:.*;base64,/,"")),n=e.length,o=new Uint8Array(n);for(let r=0;r<n;r++)o[r]=e.charCodeAt(r);return o}},window.addStampsToPdf=async function(t,e){const{PDFDocument:n,rgb:r,StandardFonts:a,degrees:i}=PDFLib;let s;PDFLib._fontkitRegistered||(window.fontkit?(PDFLib.PDFDocument.prototype.registerFontkit(window.fontkit),PDFLib._fontkitRegistered=!0):console.warn("fontkitがロードされていません。日本語フォントは使用できません。")),s="string"==typeof t?o(t):t instanceof Uint8Array?t:(Array.isArray(t),new Uint8Array(t));const l=((e.length>0&&e[0].rotateAngle||0)%360+360)%360,d=await n.load(s),c=d.getPage(0),{width:g,height:w}=c.getSize();let u=null;function f(t){return/[\u3000-\u30FF\u4E00-\u9FFF\uFF01-\uFF60]/.test(t)}function p(t,e,n){const o=t+1;if(!n)return o.toString();const r=e.toString().length;return o.toString().padStart(r,"0")}function h(t,e,n,o,r,a,i,s){let l=0,d=0,c=0;const g=(o%360+360)%360;if(0===g){switch(t){case"TopLeft":l=e,d=a-n-s;break;case"Top":l=r/2-i/2,d=a-n-s;break;case"TopRight":l=r-e-i,d=a-n-s;break;case"BottomLeft":l=e,d=n;break;case"Bottom":l=r/2-i/2,d=n;break;case"BottomRight":l=r-e-i,d=n}c=0}else if(90===g){switch(t){case"TopLeft":l=n,d=e;break;case"Top":l=n,d=a/2-i/2;break;case"TopRight":l=n,d=a-e-i;break;case"BottomLeft":l=r-n,d=e;break;case"Bottom":l=r-n,d=a/2-i/2;break;case"BottomRight":l=r-n,d=a-e-i}c=90}else if(180===g){switch(t){case"TopLeft":l=r-e,d=n;break;case"Top":l=r/2-i/2,d=n;break;case"TopRight":l=e+i,d=n;break;case"BottomLeft":l=r-e,d=a-n;break;case"Bottom":l=r/2-i/2,d=a-n;break;case"BottomRight":l=e+i,d=a-n}c=180}else if(270===g){switch(t){case"TopLeft":l=r-n,d=a-e;break;case"Top":l=r-n,d=a/2-i/2;break;case"TopRight":l=r-n,d=e+i;break;case"BottomLeft":l=n,d=a-e;break;case"Bottom":l=n,d=a/2-i/2;break;case"BottomRight":l=n,d=e+i}c=-90}return{x:l,y:d,textRotation:c}}for(const o of e){let t,e=o.text||"";if(o.isSerial){const t=p(o.currentPageIndex||0,o.totalPages||1,o.isZeroPadded||!1);e=e?`${e}${t}`:t}if(f(e)){if(!u)try{const t="/fonts/NotoSansJP-Regular.ttf",e=await fetch(t).then(t=>t.arrayBuffer());u=await d.embedFont(e)}catch(m){console.warn("日本語フォント読み込み失敗:",m),t=await d.embedFont(a.Helvetica)}t=u||await d.embedFont(a.Helvetica)}else t=await d.embedFont(a.Helvetica);const n=o.fontSize||12,s=t.widthOfTextAtSize(e,n),y=h(o.corner,o.offsetX,o.offsetY,l,g,w,s,n),v=o.color?r(o.color.r||0,o.color.g||0,o.color.b||0):r(0,0,0);try{c.drawText(e,{x:y.x,y:y.y,size:n,font:t,color:v,rotate:i(y.textRotation)})}catch(b){throw console.error("スタンプ描画エラー:",b),b}}return await d.save()},window.scrollToSection=function(t){t&&t.scrollIntoView({behavior:"smooth"})};let r=null;window.isSorting=!1,window.initializeSortable=function(){function t(){return document.getElementById("sortable-container")}function e(){const e=t();e&&(e.classList.remove("is-sorting","dragging-chosen","dragging-ghost"),e.querySelectorAll(".dragging-chosen, .dragging-ghost").forEach(t=>{t.classList.remove("dragging-chosen","dragging-ghost")})),window.isSorting=!1}window.removeEventListener("mouseup",e),window.removeEventListener("touchend",e);const n=t();n&&"none"!==window.getComputedStyle(n).display&&window.Sortable?(r&&(r.destroy(),r=null,n.classList.remove("is-sorting"),window.isSorting=!1),window.addEventListener("mouseup",e),window.addEventListener("touchend",e),r=new Sortable(n,{draggable:".sortable-item-container",handle:window.matchMedia("(min-width: 768px)").matches?".drag-handle":".touch-drag-handle",filter:".non-sortable",animation:150,ghostClass:"dragging-ghost",chosenClass:"dragging-chosen",onStart:function(t){n.classList.add("is-sorting"),window.isSorting=!0},onMove:function(t){const e=t.related,o=t.dragged;if(e&&e.classList.contains("non-sortable")){const t=e,r=t.previousElementSibling;return r&&r.classList.contains("sortable-chosen"),n.insertBefore(o,t),!1}if(e&&e.closest(".non-sortable")){const t=e.closest(".non-sortable");return n.insertBefore(o,t),!1}if(!e||e===n){const t=n.querySelector(".non-sortable");return t&&n.insertBefore(o,t),!1}return!0},onEnd:function(t){e();const o=n.querySelectorAll(".sortable-item-container:not(.non-sortable)").length;let r=t.newIndex;t.newIndex>=o&&(r=o-1),DotNet.invokeMethodAsync("NoCloudPdf","UpdateOrder",getPageType(),t.oldIndex,r)}})):r&&r.el&&(r.destroy(),r=null,e())},function(){const t="ncp_show_tour";function e(){try{const e=document.getElementById("ncp-tour-dontshow");e&&e.checked&&function(e){try{localStorage.setItem(t,e?"true":"false")}catch(n){}}(!1)}catch(e){}}function n(t){if(t)try{"function"==typeof t.on?(t.on("complete",e),t.on("cancel",e)):"function"==typeof t.then&&t.then(e).catch(()=>{})}catch(n){}}function o(){const t=function(){const t=["undefined"!=typeof window&&window.innerWidth<768?{id:"nav-explain",selector:"#nav-hamburger",title:"メニュー表示",text:"機能の切替メニューを表示できます。すぐに利用される方はこちらから。",position:"right"}:{id:"nav-explain",selector:"#nav-main",title:"切替メニュー",text:"機能の切替メニューです。すぐに利用される方は，目的の機能をクリックしてください。",position:"right"},{id:"home-tip",selector:"#home-summary-tip",title:"概要",text:"このページ下部にアプリの概要があります。",position:"top"}];try{Array.from(document.querySelectorAll("[data-tg-tour]")).forEach((e,n)=>{e.id||(e.id=`ncp-tg-auto-${Date.now().toString(36)}-${n}`);const o=`#${e.id}`,r=e.getAttribute("data-tg-tour")||"",a=e.getAttribute("data-tg-content")||e.getAttribute("title")||(e.textContent||"").trim().slice(0,300),i=e.getAttribute("data-tg-placement")||"auto";t.push({id:`auto-${n}`,selector:o,title:r,text:a,position:i})})}catch(e){console.debug("tour: buildSteps auto-detect failed",e)}try{const e=document.querySelector("#install-pwa-btn");e&&isVisible(e)&&t.push({id:"install-pwa",selector:"#install-pwa-btn",title:"インストール",text:"ここから アプリのインストールをおこなえます。",position:"left"})}catch(e){console.debug("tour: check install-pwa failed",e)}try{if(t.length>0){const e='<br/><label style="display:inline-flex;align-items:center;margin-top:8px;"><input id="ncp-tour-dontshow" type="checkbox" style="margin-right:8px;"> 次回から表示しない</label>',n=t[t.length-1];"string"==typeof n.text&&-1===n.text.indexOf("ncp-tour-dontshow")&&(n.text=(n.text||"")+e)}}catch(e){console.debug("tour: append checkbox failed",e)}return t}(),o=window.tourguide?.TourGuideClient||window.TourGuideClient||window.tourguide||null;if("function"==typeof o||o&&"object"==typeof o)try{const n=t.map((t,e)=>{const n=document.querySelector(t.selector);return{title:t.title||"",content:t.text||"",target:n||t.selector,order:t.order??e+1,group:t.group??void 0}}),r={nextLabel:"次へ",prevLabel:"戻る",finishLabel:"終了",onAfterExit:e,completeOnFinish:!0};let a=null;if("object"==typeof window.tourguide&&"function"==typeof window.tourguide.TourGuideClient?a=new window.tourguide.TourGuideClient({steps:n,...r}):"function"==typeof window.TourGuideClient?a=new window.TourGuideClient({steps:n,...r}):"function"==typeof o?a=new o({steps:n,...r}):o&&"function"==typeof o.create&&(a=o.create({steps:n,...r})),a&&"function"==typeof a.start){if("function"==typeof a.on)try{a.on("complete",e),a.on("cancel",e)}catch(i){}a.onFinish(async()=>{e()}),a.start()}return console.debug("tour: started via TourGuide client",!!a),!0}catch(i){console.debug("tour: TourGuideClient init failed",i)}const r=[window.tourguide,window.TourGuide,window.TourGuideJS,window.Tour,window.tour,window.TourGuideDefault].filter(Boolean);if(0===r.length)return console.debug("tour: no tour lib found on window"),!1;const a=t=>t.map(t=>{const e=document.querySelector(t.selector);return{id:t.id,target:e||t.selector,title:t.title,text:t.text,content:t.text,placement:t.position,position:t.position}});for(const s of r){const o=a(t);try{if("function"==typeof s.start){console.debug("tour: trying lib.start on",s);return n(s.start(o,{onComplete:e,onCancel:e})),!0}if("function"==typeof s.create){console.debug("tour: trying lib.create");const t=s.create({steps:o});if(t&&"function"==typeof t.start)return"function"==typeof t.on&&(t.on("complete",e),t.on("cancel",e)),t.start(),n(t),!0}if("function"==typeof s.init){console.debug("tour: trying lib.init");const t=s.init({steps:o});if(t&&"function"==typeof t.start)return t.start(),n(t),!0}if("function"==typeof s)try{console.debug("tour: trying new lib(...)");const t=new s({steps:o,onComplete:e,onCancel:e});if(t&&"function"==typeof t.start)return t.start(),n(t),!0}catch(i){}}catch(i){console.debug("tour: mapping/start attempt failed",i)}}return console.debug("tour: no compatible start method found"),!1}window.startTourIfNeeded=async function(e={}){if(!function(){try{const e=localStorage.getItem(t);return null===e||"false"!==e}catch(e){return!0}}())return;if(!function(){const t=(document.querySelector("base")?.getAttribute("href")||"/").replace(/\/$/,""),e=location.pathname.replace(new RegExp("^"+t),"")||"/";return"/"===e||""===e}())return;o()},window._ncpTour={startTourIfNeeded:window.startTourIfNeeded}}()}();
