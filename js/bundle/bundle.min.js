!function(){"use strict";async function e(){window.JSZip||await new Promise((e,t)=>{const n=document.createElement("script");n.src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js",n.onload=e,n.onerror=t,document.head.appendChild(n)})}window.getPageType=function(){return window.location.pathname.includes("/split")?"split":window.location.pathname.includes("/merge")?"merge":"unknown"},window.fadeInOnScroll={observe:function(e){if(!e)return;new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(e.target.classList.remove("opacity-0","translate-y-8"),e.target.classList.add("opacity-100","translate-y-0"))})},{threshold:.5}).observe(e)}},window.registerDropArea=function(e,t){const n=document.getElementById(e);if(!n)return;n._dropHandlers&&window.unregisterDropArea(e);let o=0;n._dropHandlers={dragenter:function(e){window.isSorting||(o++,t.invokeMethodAsync("SetDragOver",!0))},dragover:function(e){window.isSorting||e.preventDefault()},dragleave:function(e){window.isSorting||(o--,o<=0&&(o=0,t.invokeMethodAsync("SetDragOver",!1)))},drop:function(e){if(!window.isSorting&&(e.preventDefault(),o=0,t.invokeMethodAsync("SetDragOver",!1),e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files.length>0)){Array.from(e.dataTransfer.files).forEach(e=>{const n=new FileReader;n.onload=function(n){t.invokeMethodAsync("OnJsFileDropped",e.name,e.type,n.target.result.split(",")[1])},n.readAsDataURL(e)})}}},n.addEventListener("dragenter",n._dropHandlers.dragenter),n.addEventListener("dragover",n._dropHandlers.dragover),n.addEventListener("dragleave",n._dropHandlers.dragleave),n.addEventListener("drop",n._dropHandlers.drop)},window.unregisterDropArea=function(e){const t=document.getElementById(e);t&&t._dropHandlers&&(t.removeEventListener("dragenter",t._dropHandlers.dragenter),t.removeEventListener("dragover",t._dropHandlers.dragover),t.removeEventListener("dragleave",t._dropHandlers.dragleave),t.removeEventListener("drop",t._dropHandlers.drop),delete t._dropHandlers)},window.registerSelectDropArea=function(e){const t=document.getElementById("select-drop-area");if(!t||!t.firstElementChild)return;window.unregisterSelectDropArea();const n=t.firstElementChild;let o=0;t.ondragenter=e=>{o++,n.classList.remove("bg-white/60"),n.classList.add("bg-blue-100/60","border-solid")},t.ondragover=e=>{e.preventDefault()},t.ondragleave=e=>{o--,o<=0&&(console.log("ondragleave"),o=0,n.classList.remove("bg-blue-100/60","border-solid"),n.classList.add("bg-white/60"))},t.ondrop=t=>{t.preventDefault(),n.classList.remove("bg-blue-100/60","border-solid"),n.classList.add("bg-white/60"),t.dataTransfer&&t.dataTransfer.files.length>0&&Array.from(t.dataTransfer.files).forEach(t=>{const n=new FileReader;n.onload=function(n){const o=n.target.result.split(",")[1];e.invokeMethodAsync("OnJsFileDropped",t.name,t.type,o)},n.readAsDataURL(t)})},t.onpaste=t=>{t.clipboardData&&t.clipboardData.files.length>0&&Array.from(t.clipboardData.files).forEach(t=>{const n=new FileReader;n.onload=function(n){const o=n.target.result.split(",")[1];e.invokeMethodAsync("OnJsFileDropped",t.name,t.type,o)},n.readAsDataURL(t)})}},window.unregisterSelectDropArea=function(){const e=document.getElementById("select-drop-area");e&&(e.ondragenter=null,e.ondragover=null,e.ondragleave=null,e.ondrop=null,e.onpaste=null)},window.getPageSourceInfo=async function(e,t,n){try{if(!n)return null;let e=n;const t=/^data:.*;base64,(.*)$/.exec(n);t&&t[1]&&(e=t[1]);const a=window.devicePixelRatio||1;try{const t=Uint8Array.from(atob(e),e=>e.charCodeAt(0)),n=await window.pdfjsLib.getDocument({data:t,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}).promise,o=(await n.getPage(1)).getViewport({scale:1});return{origW:o.width,origH:o.height,dpr:a}}catch(o){try{const e=n,t=await new Promise((t,n)=>{const o=new Image;o.onload=()=>t(o),o.onerror=n,o.src=e});return{origW:t.naturalWidth,origH:t.naturalHeight,dpr:a}}catch(r){return console.error("getPageSourceInfo: not pdf nor image",r),null}}}catch(a){return console.error("getPageSourceInfo error",a),null}},window.drawPdfPageToCanvas=async function(e,t,n=1,o){try{const a=`#pdf-canvas-${e}`,i=document.querySelector(a);if(!i||!t)return;let s=t;const d=/^data:.*;base64,(.*)$/.exec(t);let l;d&&d[1]&&(s=d[1]);try{l=Uint8Array.from(atob(s),e=>e.charCodeAt(0))}catch(r){return void console.error("drawPdfPageToCanvas: invalid base64",r)}const c=window.pdfjsLib;if(!c)return void console.error("pdfjsLib not loaded");if(window._pdfRenderTask&&window._pdfRenderTask.cancel)try{window._pdfRenderTask.cancel()}catch{}const w=c.getDocument({data:l,standardFontDataUrl:c.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:c.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:c.GlobalWorkerOptions.openjpegJsUrl}),g=await w.promise,p=await g.getPage(1),h=window.devicePixelRatio||1,f=n<1?1:h,u=n*f,m=p.getViewport({scale:u,rotation:o});i.width=Math.round(m.width),i.height=Math.round(m.height);const b=document.createElement("canvas");b.width=Math.max(1,Math.round(m.width)),b.height=Math.max(1,Math.round(m.height));const y=b.getContext("2d");y&&y.setTransform&&y.setTransform(1,0,0,1,0,0),window._pdfRenderTask=p.render({canvasContext:y,viewport:m}),await window._pdfRenderTask.promise;const v=i.getContext("2d");if(!v)return;v.setTransform(1,0,0,1,0,0),v.clearRect(0,0,i.width,i.height);const P=Math.round((i.width-b.width)/2),D=Math.round((i.height-b.height)/2);v.drawImage(b,0,0,b.width,b.height,P,D,b.width,b.height),v.setTransform&&v.setTransform(f,0,0,f,0,0)}catch(a){if(a&&"RenderingCancelledException"===a.name)return;console.error("drawPdfPageToCanvas error",a)}},window.getTagNameFromEvent=function(e){return e&&e.target&&e.target.tagName?e.target.tagName:""},window.getCanvasCoords=function(e,t,n,o,r,a){const i=document.querySelector(e);if(!i)return{x:0,y:0};const s=i.getBoundingClientRect();return{x:(t-s.left)/a,y:(n-s.top)/a}},window.triggerFileInput=e=>{e.click()},window.clearFileInput=function(e){e&&(e.value="")},window.registerGlobalMouseUp=function(e){window._blazorMouseUpHandler=function(t){e.invokeMethodAsync("OnGlobalMouseUp")},window.addEventListener("mouseup",window._blazorMouseUpHandler)},window.unregisterGlobalMouseUp=function(){window._blazorMouseUpHandler&&(window.removeEventListener("mouseup",window._blazorMouseUpHandler),window._blazorMouseUpHandler=null)},window.registerGlobalMouseMove=function(e){window._globalMouseMoveHandler=function(t){e.invokeMethodAsync("OnGlobalMouseMove",{clientX:t.clientX,clientY:t.clientY})},window.addEventListener("mousemove",window._globalMouseMoveHandler)},window.unregisterGlobalMouseMove=function(){window._globalMouseMoveHandler&&(window.removeEventListener("mousemove",window._globalMouseMoveHandler),window._globalMouseMoveHandler=null)},window.getElementRect=function(e){const t=document.querySelector(e);if(!t)return{left:0,top:0,width:0,height:0};const n=t.getBoundingClientRect();return{left:n.left,top:n.top,width:n.width,height:n.height}},window.waitForNextFrame=function(){return new Promise(e=>requestAnimationFrame(e))},window.measureMaxLineWidth=function(e,t,n){const o=(window._measureTextCanvas||(window._measureTextCanvas=document.createElement("canvas"))).getContext("2d");o.font=`${t}px ${n}`;const r=e.split("\n");let a=0;for(const i of r){const e=o.measureText(i).width;e>a&&(a=e)}return a},window.selectAllTextarea=function(e){e&&e.select()},window.autoResizeTextarea=function(e){if(!e)return;e.style.height="1px";const t=parseFloat(window.getComputedStyle(e).fontSize),n=e.value||"",o=n.split("\n");""===n.trim()||1===o.length?e.style.height=t+"px":e.style.height=Math.max(e.scrollHeight,t)+"px"},window.getImageSizeFromBase64=function(e){return new Promise(t=>{const n=new Image;n.onload=function(){t({width:n.width,height:n.height})},n.src=e})},window.convertImageToPngBase64AndSize=function(e){return new Promise(t=>{const n=new Image;n.onload=function(){const e=document.createElement("canvas");e.width=n.width,e.height=n.height;e.getContext("2d").drawImage(n,0,0);const o=e.toDataURL("image/png");t({pngBase64:o,width:n.width,height:n.height})},n.src=e})},window.openInsertFileDialog=function(e){const t=document.getElementById(e);t&&(t.value=null,t.click())},window.openFileDialog=function(e){const t=document.getElementById(e);t&&t.click()},window.createZipFromUrls=async function(t,n){if(await e(),!window.JSZip)throw new Error("JSZipがロードされていません。");const o=new JSZip;for(let e=0;e<t.length;e++){const r=t[e],i=n[e]||`file${e+1}.pdf`;try{const e=await fetch(r),t=await e.blob(),n=await t.arrayBuffer();o.file(i,n)}catch(a){console.error(`ファイル取得失敗: ${i}`,a)}}const r=await o.generateAsync({type:"blob"});return URL.createObjectURL(r)},window.getZipFileSize=async function(e){try{const t=await fetch(e),n=(await t.blob()).size;return n<1024?`${n} bytes`:n<1048576?`${(n/1024).toFixed(1)} KB`:`${(n/1048576).toFixed(2)} MB`}catch(t){return console.error("zipファイルサイズ取得失敗",t),""}},window.downloadAllPdfsAsPngZip=async function(t,n,o){await e();const r=window.pdfjsLib;if(!r)return void alert("PDF.jsがロードされていません");const a=new window.JSZip;for(let e=0;e<t.length;e++){const o=t[e],i=(n[e]||`file${e+1}.pdf`).replace(/\.pdf$/i,"");try{const e=await fetch(o),t=await e.arrayBuffer(),n=await r.getDocument({data:t,standardFontDataUrl:r.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:r.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:r.GlobalWorkerOptions.openjpegJsUrl}).promise;for(let o=1;o<=n.numPages;o++){const e=await n.getPage(o),t=document.createElement("canvas"),r=e.getViewport({scale:2});t.width=r.width,t.height=r.height,await e.render({canvasContext:t.getContext("2d"),viewport:r}).promise;const s=t.toDataURL("image/png");a.file(`${i}_page${o}.png`,s.split(",")[1],{base64:!0})}}catch(d){console.error(`PDF変換失敗: ${i}`,d)}finally{pdf&&pdf.destroy()}}const i=await a.generateAsync({type:"blob"}),s=document.createElement("a");s.href=URL.createObjectURL(i),s.download=o||"images.zip",document.body.appendChild(s),s.click(),document.body.removeChild(s)};let t=null;window.addEventListener("beforeinstallprompt",e=>{console.log("beforeinstallprompt fired!"),e.preventDefault(),t=e}),window.isInstallPromptAvailable=function(){return null!==t},window.showInstallPrompt=async function(){t&&(t.prompt(),t=null)};let n=null;function o(e){const t=e.replace(/[\r\n\s]/g,""),n=atob(t),o=n.length,r=new Uint8Array(o);for(let a=0;a<o;a++)r[a]=n.charCodeAt(a);return r}window.loadConfig=async function(){if(!n){const e=await fetch("/config.json");n=await e.json()}return n},window.loadConfig(),window.embedImageAsPdf=async function(e,t){const{PDFDocument:n}=PDFLib,r=await n.create();let a;const i=o(e);if(t.endsWith(".png"))a=await r.embedPng(i);else{if(!t.endsWith(".jpg")&&!t.endsWith(".jpeg"))throw new Error("Unsupported image type");a=await r.embedJpg(i)}const s=a.scale(1);r.addPage([s.width,s.height]).drawImage(a,{x:0,y:0,width:s.width,height:s.height});const d=await r.save();let l="";for(let o=0;o<d.length;o++)l+=String.fromCharCode(d[o]);return btoa(l)},window.mergePDFPages=async function(e){const{PDFDocument:t,degrees:n}=PDFLib,r=await t.create();for(let d=0;d<e.length;d++){let a,i=e[d],l=i.pageData;if("string"==typeof l)a=o(l);else if(l instanceof Uint8Array)a=l;else{if(!Array.isArray(l))throw new Error(`Unsupported pageData type at index ${d}: ${typeof l}`);a=new Uint8Array(l)}try{const e=await t.load(a),[o]=await r.copyPages(e,[0]);"object"==typeof i&&i.rotateAngle&&i.rotateAngle%360!=0&&(o.setRotation(n(i.rotateAngle)),console.log(`→ setRotation(${i.rotateAngle}) 実行`)),r.addPage(o)}catch(s){throw console.error(`Error at mergePDFPages index=${d}:`,s,l),s}}const a=await r.save(),i=new Blob([a],{type:"application/pdf"});return URL.createObjectURL(i)},window.renderFirstPDFPage=async function(e,t){try{let i;if(e instanceof Uint8Array)i=e;else if(Array.isArray(e))i=new Uint8Array(e);else if("string"==typeof e){const t=atob(e);i=new Uint8Array(t.length);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e)}else i=new Uint8Array(e);if(i.length<8)throw new Error("Data too short to be valid PDF");const s=new Uint8Array(i),d=String.fromCharCode.apply(null,i.slice(0,8));if(!d.startsWith("%PDF-"))throw new Error(`Invalid PDF header: ${d}`);const l=window.pdfjsLib;if(!l)throw new Error("PDF.js library not loaded");if(i.length<1024)throw new Error("PDF file is too small to be valid");let c=!1,w=!1,g="",p="",h=null,f=null;const u=[{data:i,stopAtErrors:!1,maxImageSize:5242880,disableFontFace:!0,disableRange:!0,disableStream:!0,verbosity:1},{data:i,stopAtErrors:!1,maxImageSize:10485760,disableFontFace:!1,disableRange:!0,disableStream:!1,verbosity:1},{data:i,stopAtErrors:!1,verbosity:1}];for(let e=0;e<u.length;e++)try{const n=l.getDocument({...u[e],standardFontDataUrl:l.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:l.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:l.GlobalWorkerOptions.openjpegJsUrl,password:t||void 0});n.onPassword=function(e,t){throw t===l.PasswordResponses.NEED_PASSWORD?new Error("PasswordException"):t===l.PasswordResponses.INCORRECT_PASSWORD?(console.log("パスワードが間違っています。"),new Error("PasswordException")):new Error("PasswordException")},h=await n.promise;break}catch(o){if(f=o,o&&"PasswordException"===o.name){c=!0,g="パスワード付きPDF";break}if(e===u.length-1)throw f}if(c||!h)return{thumbnail:"",isPasswordProtected:c,isOperationRestricted:w,securityInfo:g||"パスワード付きPDF"};h&&h._pdfInfo&&h._pdfInfo.permissions&&(console.log("PDF permissions:",h._pdfInfo.permissions),w=h._pdfInfo.permissions.length>0,g+=w?" 操作制限あり":"");try{const{PDFDocument:e}=PDFLib,t=await e.load(s),n=await e.create(),[o]=await n.copyPages(t,[0]);n.addPage(o)}catch(r){console.warn("PDF extraction failed, likely due to restrictions:",r),w=!0,g+="編集不可PDF（画像PDFに変換）"}try{const e=await h.getPage(1),t=e.getViewport({scale:n.pdfSettings.scales.thumbnail}),o=document.createElement("canvas");o.width=Math.max(1,Math.round(t.width)),o.height=Math.max(1,Math.round(t.height));const r=o.getContext("2d");await e.render({canvasContext:r,viewport:t}).promise,p=o.toDataURL("image/png")}catch(a){console.error("サムネイル生成エラー:",a),p=""}return{thumbnail:p,isPasswordProtected:c,isOperationRestricted:w,securityInfo:g}}catch(o){return console.error("Error in renderFirstPDFPage:",o),{thumbnail:"",isPasswordProtected:o&&"PasswordException"===o.name,isOperationRestricted:!1,securityInfo:o&&"PasswordException"===o.name?"パスワード付きPDF":"解析失敗"}}},window.generatePdfThumbnailFromFileMetaData=async function(e,t){try{let r;if(e instanceof Uint8Array)r=e;else if(Array.isArray(e))r=new Uint8Array(e);else if("string"==typeof e){const t=atob(e);r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e)}else r=new Uint8Array(e);const a=window.pdfjsLib;if(!a)throw new Error("PDF.js library not loaded");let i=await a.getDocument({data:r,standardFontDataUrl:a.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:a.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:a.GlobalWorkerOptions.openjpegJsUrl}).promise,s="";try{const e=await i.getPage(t+1),o=e.getViewport({scale:n.pdfSettings.scales.thumbnail}),r=document.createElement("canvas");r.width=o.width,r.height=o.height;const a=r.getContext("2d");await e.render({canvasContext:a,viewport:o}).promise,s=r.toDataURL("image/png")}catch(o){s=""}return{thumbnail:s,isError:!1,isPasswordProtected:!1,securityInfo:""}}catch(r){return{thumbnail:"",isError:!0,isPasswordProtected:!1,securityInfo:"解析失敗"}}},window.getPDFPageCount=async function(e){try{let t;if(e instanceof Uint8Array)t=e;else if(Array.isArray(e))t=new Uint8Array(e);else if("string"==typeof e){const n=atob(e);t=new Uint8Array(n.length);for(let e=0;e<n.length;e++)t[e]=n.charCodeAt(e)}else t=new Uint8Array(e);const n=window.pdfjsLib;if(!n)throw new Error("PDF.js library not loaded");const o=n.getDocument({data:t,stopAtErrors:!1,verbosity:1,standardFontDataUrl:n.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:n.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:n.GlobalWorkerOptions.openjpegJsUrl});return(await o.promise).numPages}catch(t){throw console.error("Error in getPDFPageCount:",t),t}},window.extractPdfPage=async function(e,t){try{const{PDFDocument:o}=PDFLib;if(!o)throw new Error("PDF-lib library not loaded");let r;if(e instanceof Uint8Array)r=e;else if(Array.isArray(e))r=new Uint8Array(e);else if("string"==typeof e){const t=atob(e);r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e)}else r=new Uint8Array(e);const a=await o.load(r),i=await o.create();try{const[e]=await i.copyPages(a,[t]);i.addPage(e)}catch(n){i.addPage([595.28,841.89])}const s=await i.save();let d="";for(let e=0;e<s.length;e++)d+=String.fromCharCode(s[e]);return btoa(d)}catch(o){console.error(`Error extracting PDF page ${t}:`,o);try{const{PDFDocument:e}=PDFLib,t=await e.create();t.addPage([595.28,841.89]);const n=await t.save();let o="";for(let r=0;r<n.length;r++)o+=String.fromCharCode(n[r]);return btoa(o)}catch(r){return""}}},window.createBlankPage=async function(){try{const{PDFDocument:e,rgb:t}=PDFLib,n=await e.create(),o=(n.addPage([595.28,841.89]),await n.save());let r="";for(let a=0;a<o.length;a++)r+=String.fromCharCode(o[a]);return btoa(r)}catch(e){return console.error("Error creating blank page:",e),""}},window.generatePdfThumbnailFromPageData=async function(e){try{const t=window.pdfjsLib,o=atob(e),r=new Uint8Array(o.length);for(let e=0;e<o.length;e++)r[e]=o.charCodeAt(e);const a=t.getDocument({data:r,standardFontDataUrl:t.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:t.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:t.GlobalWorkerOptions.openjpegJsUrl}),i=await a.promise,s=await i.getPage(1),d=s.getViewport({scale:n.pdfSettings.scales.thumbnail}),l=document.createElement("canvas");l.width=d.width,l.height=d.height;const c={canvasContext:l.getContext("2d"),viewport:d};return await s.render(c).promise,l.toDataURL("image/png")}catch(t){return console.error("Error rendering single PDF page:",t),""}},window.generatePreviewImage=async function(e,t){const o=atob(e),r=new Uint8Array(o.length);for(let n=0;n<o.length;n++)r[n]=o.charCodeAt(n);const a=pdfjsLib.getDocument({data:r,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}),i=await a.promise,s=await i.getPage(1),d=s.getViewport({scale:n.pdfSettings.scales.normal,rotation:t||0}),l=document.createElement("canvas");l.width=d.width,l.height=d.height;const c=l.getContext("2d");return await s.render({canvasContext:c,viewport:d}).promise,l.toDataURL("image/jpeg",.85)},window.getPdfFileSize=async function(e){const t=await fetch(e);return((await t.blob()).size/1048576).toFixed(2)+"MB"},window.downloadFileFromUrl=function(e,t,n){const o=document.createElement("a");o.href=e,o.download=t,o.type=n||"application/octet-stream",document.body.appendChild(o),o.click(),document.body.removeChild(o)},window.renderPdfPages=async function(e,t){if(!window.pdfjsLib)return void console.error("pdfjsLib is not loaded");const o=await pdfjsLib.getDocument({url:e,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}).promise;for(let r=0;r<t.length;r++){const e=await o.getPage(r+1),a=document.getElementById(t[r]);if(!a)continue;const i=a.getContext("2d"),s=e.getViewport({scale:n.pdfSettings.scales.normal});a.width=s.width,a.height=s.height,await e.render({canvasContext:i,viewport:s}).promise}},window.checkCanvasExists=function(e){return!!document.getElementById(e)},window._canvasRendering=window._canvasRendering||{},window.renderPdfThumbnailToCanvas=async function(e,t){if(!window.pdfjsLib)throw new Error("pdfjsLib is not loaded.");if(window._canvasRendering[t])return console.warn("render in progress, skipping:",t),!1;window._canvasRendering[t]=!0;try{const o=window.pdfjsLib.getDocument({url:e,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}),r=await o.promise,a=await r.getPage(1),i=a.getViewport({scale:n.pdfSettings.scales.thumbnail}),s=document.getElementById(t);if(!s)return console.warn("canvas not found:",t),!1;const d=s.getContext("2d");return s.width=i.width,s.height=i.height,d.clearRect(0,0,s.width,s.height),await a.render({canvasContext:d,viewport:i}).promise,!0}catch(o){return console.error("renderPdfThumbnailToCanvas error",o,e,t),!1}finally{window._canvasRendering[t]=!1}},window.drawImageToCanvas=function(e,t){const n=document.getElementById(e);if(!n)return;const o=n.getContext("2d"),r=new window.Image;r.onload=function(){o.clearRect(0,0,n.width,n.height);const e=Math.min(n.width/r.width,n.height/r.height),t=r.width*e,a=r.height*e;o.drawImage(r,(n.width-t)/2,(n.height-a)/2,t,a)},r.src=t},window.unlockPdf=async function(e,t){const o=window.pdfjsLib;if(!o)throw new Error("PDF.js library not loaded");let r;if("string"==typeof e){const t=atob(e);r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e)}else r=e;const a=o.getDocument({data:r,password:t,standardFontDataUrl:o.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:o.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:o.GlobalWorkerOptions.openjpegJsUrl}),i=await a.promise,{PDFDocument:s}=PDFLib,d=await s.create();for(let w=1;w<=i.numPages;w++){const e=await i.getPage(w),t=e.getViewport({scale:n.pdfSettings.scales.unlock}),o=document.createElement("canvas");o.width=t.width,o.height=t.height;const r=o.getContext("2d");await e.render({canvasContext:r,viewport:t}).promise;const a=o.toDataURL("image/png"),s=await d.embedPng(a);d.addPage([t.width,t.height]).drawImage(s,{x:0,y:0,width:t.width,height:t.height})}const l=await d.save();let c="";for(let n=0;n<l.length;n++)c+=String.fromCharCode(l[n]);return btoa(c)},window.editPdfPageWithElements=async function(e,t){const{PDFDocument:n,rgb:o,StandardFonts:r}=PDFLib;if(!PDFLib._fontkitRegistered){if(!window.fontkit)throw new Error("fontkitがロードされていません。");PDFLib.PDFDocument.prototype.registerFontkit(window.fontkit),PDFLib._fontkitRegistered=!0}const a=f(e),i=await n.load(a),s=i.getPage(0),d=s.getHeight();let l=[];try{l=JSON.parse(t)}catch(u){console.error("editJson parse error",u,t)}let c=null,w=null;for(const m of l)if(0===m.Type||"Text"===m.Type){let e;if(function(e){return/[\u3000-\u30FF\u4E00-\u9FFF]/.test(e)}(m.Text||""))if(m.IsBold){if(!w){const e="/fonts/NotoSansJP-Bold.ttf",t=await fetch(e).then(e=>e.arrayBuffer());w=await i.embedFont(t)}e=w}else{if(!c){const e="/fonts/NotoSansJP-Regular.ttf",t=await fetch(e).then(e=>e.arrayBuffer());c=await i.embedFont(t)}e=c}else e=m.IsBold?await i.embedFont(r.HelveticaBold):await i.embedFont(r.Helvetica);const t=PDFLib.degrees(m.Rotation||0);console.log(`rotateDegrees: ${m.Rotation}`),s.drawText(m.Text||"",{x:m.X||0,y:d-(m.Y||0)-(m.FontSize||16),size:m.FontSize||16,font:e,color:h(m.Color||"#000000"),rotate:t})}else if(1===m.Type||"Image"===m.Type)if(m.ImageUrl&&(m.ImageUrl.startsWith("data:image/png")||m.ImageUrl.startsWith("data:image/jpeg"))){let e,t=m.ImageUrl.split(",")[1]||m.ImageUrl;m.ImageUrl.startsWith("data:image/png")?e=await i.embedPng(f(t)):m.ImageUrl.startsWith("data:image/jpeg")&&(e=await i.embedJpg(f(t)));const n=PDFLib.degrees(m.Rotation||0);s.drawImage(e,{x:m.X||0,y:d-(m.Y||0)-(m.Height||e.height),width:m.Width||e.width,height:m.Height||e.height,rotate:n})}else console.warn("未対応画像形式: ",m.ImageUrl?m.ImageUrl.substring(0,30):"");const g=await i.save();let p="";for(let m=0;m<g.length;m++)p+=String.fromCharCode(g[m]);return btoa(p);function h(e){3===(e=e.replace("#","")).length&&(e=e.split("").map(e=>e+e).join(""));const t=parseInt(e,16);return o((t>>16&255)/255,(t>>8&255)/255,(255&t)/255)}function f(e){const t=atob(e.replace(/^data:.*;base64,/,"")),n=t.length,o=new Uint8Array(n);for(let r=0;r<n;r++)o[r]=t.charCodeAt(r);return o}},window.scrollToSection=function(e){e&&e.scrollIntoView({behavior:"smooth"})};let r=null;window.isSorting=!1,window.initializeSortable=function(){function e(){return document.getElementById("sortable-container")}function t(){const t=e();t&&(t.classList.remove("is-sorting","dragging-chosen","dragging-ghost"),t.querySelectorAll(".dragging-chosen, .dragging-ghost").forEach(e=>{e.classList.remove("dragging-chosen","dragging-ghost")})),window.isSorting=!1}window.removeEventListener("mouseup",t),window.removeEventListener("touchend",t);const n=e();n&&"none"!==window.getComputedStyle(n).display&&window.Sortable?(r&&(r.destroy(),r=null,n.classList.remove("is-sorting"),window.isSorting=!1),window.addEventListener("mouseup",t),window.addEventListener("touchend",t),r=new Sortable(n,{draggable:".sortable-item-container",handle:window.matchMedia("(min-width: 768px)").matches?".drag-handle":".touch-drag-handle",filter:".non-sortable",animation:150,ghostClass:"dragging-ghost",chosenClass:"dragging-chosen",onStart:function(e){n.classList.add("is-sorting"),window.isSorting=!0},onMove:function(e){const t=e.related,o=e.dragged;if(t&&t.classList.contains("non-sortable")){const e=t,r=e.previousElementSibling;return r&&r.classList.contains("sortable-chosen"),n.insertBefore(o,e),!1}if(t&&t.closest(".non-sortable")){const e=t.closest(".non-sortable");return n.insertBefore(o,e),!1}if(!t||t===n){const e=n.querySelector(".non-sortable");return e&&n.insertBefore(o,e),!1}return!0},onEnd:function(e){t();const o=n.querySelectorAll(".sortable-item-container:not(.non-sortable)").length;let r=e.newIndex;e.newIndex>=o&&(r=o-1),DotNet.invokeMethodAsync("NoCloudPdf","UpdateOrder",getPageType(),e.oldIndex,r)}})):r&&r.el&&(r.destroy(),r=null,t())}}();
