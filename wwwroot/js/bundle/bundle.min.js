!function(){"use strict";async function e(){window.JSZip||await new Promise((e,t)=>{const n=document.createElement("script");n.src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js",n.onload=e,n.onerror=t,document.head.appendChild(n)})}window.getPageType=function(){return window.location.pathname.includes("/split")?"split":window.location.pathname.includes("/merge")?"merge":"unknown"},window.fadeInOnScroll={observe:function(e){if(!e)return;new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(e.target.classList.remove("opacity-0","translate-y-8"),e.target.classList.add("opacity-100","translate-y-0"))})},{threshold:.5}).observe(e)}},window.positionEditorTooltip=function(e,t){const n=document.getElementById(t);if(!n)return;n.style.display="block",n.setAttribute("aria-hidden","false"),n.style.left="-9999px",n.style.top="-9999px",n.style.visibility="hidden";const o=e.getBoundingClientRect(),r=n.getBoundingClientRect(),a=window.innerWidth||document.documentElement.clientWidth,i=window.innerHeight||document.documentElement.clientHeight,s=o.top,d=i-o.bottom,l=o.left,c=a-o.right;let w="top";s<r.height+12&&d>s&&(w="bottom"),("top"===w||"bottom"===w)&&r.width>c&&l>c&&(w="left"),("top"===w||"bottom"===w)&&r.width>l&&c>l&&(w="right");let g=0,h=0;"top"===w?(h=o.top-r.height-8,g=o.left+(o.width-r.width)/2):"bottom"===w?(h=o.bottom+8,g=o.left+(o.width-r.width)/2):"left"===w?(h=o.top+(o.height-r.height)/2,g=o.left-r.width-8):(h=o.top+(o.height-r.height)/2,g=o.right+8),g=Math.max(8,Math.min(g,a-r.width-8)),h=Math.max(8,Math.min(h,i-r.height-8)),n.style.left=Math.round(g)+"px",n.style.top=Math.round(h)+"px",n.setAttribute("data-dir",w),n.style.visibility="visible"},window.hideEditorTooltip=function(e){const t=document.getElementById(e);t&&(t.style.display="none",t.setAttribute("aria-hidden","true"))},window.registerDropArea=function(e,t){const n=document.getElementById(e);if(!n)return;n._dropHandlers&&window.unregisterDropArea(e);let o=0;n._dropHandlers={dragenter:function(e){window.isSorting||(o++,t.invokeMethodAsync("SetDragOver",!0))},dragover:function(e){window.isSorting||e.preventDefault()},dragleave:function(e){window.isSorting||(o--,o<=0&&(o=0,t.invokeMethodAsync("SetDragOver",!1)))},drop:function(e){if(!window.isSorting&&(e.preventDefault(),o=0,t.invokeMethodAsync("SetDragOver",!1),e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files.length>0)){Array.from(e.dataTransfer.files).forEach(e=>{const n=new FileReader;n.onload=function(n){t.invokeMethodAsync("OnJsFileDropped",e.name,e.type,n.target.result.split(",")[1])},n.readAsDataURL(e)})}}},n.addEventListener("dragenter",n._dropHandlers.dragenter),n.addEventListener("dragover",n._dropHandlers.dragover),n.addEventListener("dragleave",n._dropHandlers.dragleave),n.addEventListener("drop",n._dropHandlers.drop)},window.unregisterDropArea=function(e){const t=document.getElementById(e);t&&t._dropHandlers&&(t.removeEventListener("dragenter",t._dropHandlers.dragenter),t.removeEventListener("dragover",t._dropHandlers.dragover),t.removeEventListener("dragleave",t._dropHandlers.dragleave),t.removeEventListener("drop",t._dropHandlers.drop),delete t._dropHandlers)},window.registerSelectDropArea=function(e){const t=document.getElementById("select-drop-area");if(!t||!t.firstElementChild)return;window.unregisterSelectDropArea();const n=t.firstElementChild;let o=0;t.ondragenter=e=>{o++,n.classList.remove("bg-white/60"),n.classList.add("bg-blue-100/60","border-solid")},t.ondragover=e=>{e.preventDefault()},t.ondragleave=e=>{o--,o<=0&&(console.log("ondragleave"),o=0,n.classList.remove("bg-blue-100/60","border-solid"),n.classList.add("bg-white/60"))},t.ondrop=t=>{t.preventDefault(),n.classList.remove("bg-blue-100/60","border-solid"),n.classList.add("bg-white/60"),t.dataTransfer&&t.dataTransfer.files.length>0&&Array.from(t.dataTransfer.files).forEach(t=>{const n=new FileReader;n.onload=function(n){const o=n.target.result.split(",")[1];e.invokeMethodAsync("OnJsFileDropped",t.name,t.type,o)},n.readAsDataURL(t)})},t.onpaste=t=>{t.clipboardData&&t.clipboardData.files.length>0&&Array.from(t.clipboardData.files).forEach(t=>{const n=new FileReader;n.onload=function(n){const o=n.target.result.split(",")[1];e.invokeMethodAsync("OnJsFileDropped",t.name,t.type,o)},n.readAsDataURL(t)})}},window.unregisterSelectDropArea=function(){const e=document.getElementById("select-drop-area");e&&(e.ondragenter=null,e.ondragover=null,e.ondragleave=null,e.ondrop=null,e.onpaste=null)},window.getPageSourceInfo=async function(e,t,n){try{if(!n)return null;let e=n;const t=/^data:.*;base64,(.*)$/.exec(n);t&&t[1]&&(e=t[1]);const a=window.devicePixelRatio||1;try{const t=Uint8Array.from(atob(e),e=>e.charCodeAt(0)),n=await window.pdfjsLib.getDocument({data:t,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}).promise,o=(await n.getPage(1)).getViewport({scale:1});return{origW:o.width,origH:o.height,dpr:a}}catch(o){try{const e=n,t=await new Promise((t,n)=>{const o=new Image;o.onload=()=>t(o),o.onerror=n,o.src=e});return{origW:t.naturalWidth,origH:t.naturalHeight,dpr:a}}catch(r){return console.error("getPageSourceInfo: not pdf nor image",r),null}}}catch(a){return console.error("getPageSourceInfo error",a),null}},window.drawPdfPageToCanvas=async function(e,t,n=1,o){try{const a=`#pdf-canvas-${e}`,i=document.querySelector(a);if(!i||!t)return;let s=t;const d=/^data:.*;base64,(.*)$/.exec(t);let l;d&&d[1]&&(s=d[1]);try{l=Uint8Array.from(atob(s),e=>e.charCodeAt(0))}catch(r){return void console.error("drawPdfPageToCanvas: invalid base64",r)}const c=window.pdfjsLib;if(!c)return void console.error("pdfjsLib not loaded");if(window._pdfRenderTask&&window._pdfRenderTask.cancel)try{window._pdfRenderTask.cancel()}catch{}const w=c.getDocument({data:l,standardFontDataUrl:c.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:c.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:c.GlobalWorkerOptions.openjpegJsUrl}),g=await w.promise,h=await g.getPage(1),u=window.devicePixelRatio||1,f=n<1?1:u,p=n*f,m=h.getViewport({scale:p,rotation:o});i.width=Math.round(m.width),i.height=Math.round(m.height);const b=document.createElement("canvas");b.width=Math.max(1,Math.round(m.width)),b.height=Math.max(1,Math.round(m.height));const y=b.getContext("2d");y&&y.setTransform&&y.setTransform(1,0,0,1,0,0),window._pdfRenderTask=h.render({canvasContext:y,viewport:m}),await window._pdfRenderTask.promise;const v=i.getContext("2d");if(!v)return;v.setTransform(1,0,0,1,0,0),v.clearRect(0,0,i.width,i.height);const F=Math.round((i.width-b.width)/2),P=Math.round((i.height-b.height)/2);v.drawImage(b,0,0,b.width,b.height,F,P,b.width,b.height),v.setTransform&&v.setTransform(f,0,0,f,0,0)}catch(a){if(a&&"RenderingCancelledException"===a.name)return;console.error("drawPdfPageToCanvas error",a)}},window.getTagNameFromEvent=function(e){return e&&e.target&&e.target.tagName?e.target.tagName:""},window.getCanvasCoords=function(e,t,n,o,r,a){const i=document.querySelector(e);if(!i)return{x:0,y:0};const s=i.getBoundingClientRect();return{x:(t-s.left)/a,y:(n-s.top)/a}},window.triggerFileInput=e=>{e.click()},window.clearFileInput=function(e){e&&(e.value="")},window.registerGlobalMouseUp=function(e){window._blazorMouseUpHandler=function(t){e.invokeMethodAsync("OnGlobalMouseUp")},window.addEventListener("mouseup",window._blazorMouseUpHandler)},window.unregisterGlobalMouseUp=function(){window._blazorMouseUpHandler&&(window.removeEventListener("mouseup",window._blazorMouseUpHandler),window._blazorMouseUpHandler=null)},window.registerGlobalMouseMove=function(e){window._globalMouseMoveHandler=function(t){e.invokeMethodAsync("OnGlobalMouseMove",{clientX:t.clientX,clientY:t.clientY})},window.addEventListener("mousemove",window._globalMouseMoveHandler)},window.unregisterGlobalMouseMove=function(){window._globalMouseMoveHandler&&(window.removeEventListener("mousemove",window._globalMouseMoveHandler),window._globalMouseMoveHandler=null)},window.getElementRect=function(e){const t=document.querySelector(e);if(!t)return{left:0,top:0,width:0,height:0};const n=t.getBoundingClientRect();return{left:n.left,top:n.top,width:n.width,height:n.height}},window.waitForNextFrame=function(){return new Promise(e=>requestAnimationFrame(e))},window.measureMaxLineWidth=function(e,t,n){const o=(window._measureTextCanvas||(window._measureTextCanvas=document.createElement("canvas"))).getContext("2d");o.font=`${t}px ${n}`;const r=e.split("\n");let a=0;for(const i of r){const e=o.measureText(i).width;e>a&&(a=e)}return a},window.selectAllTextarea=function(e){e&&e.select()},window.autoResizeTextarea=function(e){try{const t=(e=>e?"string"==typeof e?document.getElementById(e):(HTMLElement,e):null)(e);return t&&t.style?new Promise(e=>{requestAnimationFrame(()=>{try{t.style.height="auto",t.getBoundingClientRect();const o=window.getComputedStyle(t),r=parseFloat(o.lineHeight)||parseFloat(o.fontSize)||16,a=Math.max(t.scrollHeight||0,r),i=Math.ceil(a+2);t.style.height=i+"px",t.style.overflow="hidden";let s=0;try{const e=t.closest&&t.closest(".edit-element");if(e){const t=window.getComputedStyle(e);s=(parseFloat(t.borderTopWidth)||0)+(parseFloat(t.borderBottomWidth)||0)}}catch(n){}e(i+s||0)}catch(o){console.error("autoResizeTextarea inner error",o),e(0)}})}):(console.debug("autoResizeTextarea: element not found:",e),0)}catch(t){return console.error("autoResizeTextarea error",t),0}},window.getImageSizeFromBase64=function(e){return new Promise(t=>{const n=new Image;n.onload=function(){t({width:n.width,height:n.height})},n.src=e})},window.openInsertFileDialog=function(e){const t=document.getElementById(e);t&&(t.value=null,t.click())},window.openFileDialog=function(e){const t=document.getElementById(e);t&&t.click()},window.createZipFromUrls=async function(t,n){if(await e(),!window.JSZip)throw new Error("JSZipがロードされていません。");const o=new JSZip;for(let e=0;e<t.length;e++){const r=t[e],i=n[e]||`file${e+1}.pdf`;try{const e=await fetch(r),t=await e.blob(),n=await t.arrayBuffer();o.file(i,n)}catch(a){console.error(`ファイル取得失敗: ${i}`,a)}}const r=await o.generateAsync({type:"blob"});return URL.createObjectURL(r)},window.getZipFileSize=async function(e){try{const t=await fetch(e),n=(await t.blob()).size;return n<1024?`${n} bytes`:n<1048576?`${(n/1024).toFixed(1)} KB`:`${(n/1048576).toFixed(2)} MB`}catch(t){return console.error("zipファイルサイズ取得失敗",t),""}},window.downloadAllPdfsAsPngZip=async function(t,n,o){await e();const r=window.pdfjsLib;if(!r)return void alert("PDF.jsがロードされていません");const a=new window.JSZip;for(let e=0;e<t.length;e++){const o=t[e],i=(n[e]||`file${e+1}.pdf`).replace(/\.pdf$/i,"");try{const e=await fetch(o),t=await e.arrayBuffer(),n=await r.getDocument({data:t,standardFontDataUrl:r.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:r.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:r.GlobalWorkerOptions.openjpegJsUrl}).promise;for(let o=1;o<=n.numPages;o++){const e=await n.getPage(o),t=document.createElement("canvas"),r=e.getViewport({scale:2});t.width=r.width,t.height=r.height,await e.render({canvasContext:t.getContext("2d"),viewport:r}).promise;const s=t.toDataURL("image/png");a.file(`${i}_page${o}.png`,s.split(",")[1],{base64:!0})}}catch(d){console.error(`PDF変換失敗: ${i}`,d)}finally{pdf&&pdf.destroy()}}const i=await a.generateAsync({type:"blob"}),s=document.createElement("a");s.href=URL.createObjectURL(i),s.download=o||"images.zip",document.body.appendChild(s),s.click(),document.body.removeChild(s)};let t=null;window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),t=e}),window.isInstallPromptAvailable=function(){return null!==t},window.showInstallPrompt=async function(){t&&(t.prompt(),t=null)};let n=null;function o(e){const t=e.replace(/[\r\n\s]/g,""),n=atob(t),o=n.length,r=new Uint8Array(o);for(let a=0;a<o;a++)r[a]=n.charCodeAt(a);return r}async function r(e,t,r=null){const a=window.pdfjsLib;if(!a)throw new Error("pdfjsLib not loaded for image fallback");if(r&&window._pdfLibFileRestricted)try{window._pdfLibFileRestricted.add(r)}catch(v){}const i=a.getDocument({data:e,standardFontDataUrl:a.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:a.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:a.GlobalWorkerOptions.openjpegJsUrl}),s=await i.promise,d=await s.getPage(t+1),l=n&&n.pdfSettings&&n.pdfSettings.scales&&n.pdfSettings.scales.unlock||1.5,c=d.getViewport({scale:l}),w=document.createElement("canvas");w.width=Math.max(1,Math.round(c.width)),w.height=Math.max(1,Math.round(c.height));const g=w.getContext("2d",{alpha:!1});await d.render({canvasContext:g,viewport:c}).promise;const h=o(w.toDataURL("image/png").split(",")[1]),{PDFDocument:u}=PDFLib,f=await u.create(),p=await f.embedPng(h);f.addPage([w.width,w.height]);const[m]=f.getPages();m.drawImage(p,{x:0,y:0,width:w.width,height:w.height});const b=await f.save();let y="";for(let n=0;n<b.length;n++)y+=String.fromCharCode(b[n]);return btoa(y)}async function a(){try{const{PDFDocument:e}=PDFLib,t=await e.create();t.addPage([595.28,841.89]);const n=await t.save();let o="";for(let r=0;r<n.length;r++)o+=String.fromCharCode(n[r]);return btoa(o)}catch(e){return console.error("Error creating blank page:",e),""}}window.loadConfig=async function(){if(!n){const e=await fetch("/config.json");n=await e.json()}return n},window.loadConfig(),window.embedImageAsPdf=async function(e,t){const{PDFDocument:n}=PDFLib,r=await n.create();let a;const i=o(e);if(t.endsWith(".png"))a=await r.embedPng(i);else if(t.endsWith(".jpg")||t.endsWith(".jpeg"))a=await r.embedJpg(i);else{if(!(t.endsWith(".gif")||t.endsWith(".bmp")||t.endsWith(".webp")||t.endsWith(".svg")))throw new Error("Unsupported image type");{const n=t.endsWith(".gif")?"image/gif":t.endsWith(".bmp")?"image/bmp":t.endsWith(".webp")?"image/webp":t.endsWith(".svg")?"image/svg+xml":"",{pngBase64:i,width:s,height:d}=await convertImageToPngBase64AndSize(e,n);a=await r.embedPng(o(i.split(",")[1]))}}const s=a.scale(1);r.addPage([s.width,s.height]).drawImage(a,{x:0,y:0,width:s.width,height:s.height});const d=await r.save();let l="";for(let o=0;o<d.length;o++)l+=String.fromCharCode(d[o]);return btoa(l)},window.mergePDFPages=async function(e){const{PDFDocument:t,degrees:n}=PDFLib,r=await t.create();for(let d=0;d<e.length;d++){let a,i=e[d],l=i.pageData;if("string"==typeof l)a=o(l);else if(l instanceof Uint8Array)a=l;else{if(!Array.isArray(l))throw new Error(`Unsupported pageData type at index ${d}: ${typeof l}`);a=new Uint8Array(l)}try{const e=await t.load(a),[o]=await r.copyPages(e,[0]);"object"==typeof i&&i.rotateAngle&&i.rotateAngle%360!=0&&o.setRotation(n(i.rotateAngle)),r.addPage(o)}catch(s){throw console.error(`Error at mergePDFPages index=${d}:`,s,l),s}}const a=await r.save(),i=new Blob([a],{type:"application/pdf"});return URL.createObjectURL(i)},window.renderFirstPDFPage=async function(e,t){try{let i;if(e instanceof Uint8Array)i=e;else if(Array.isArray(e))i=new Uint8Array(e);else if("string"==typeof e){const m=atob(e);i=new Uint8Array(m.length);for(let b=0;b<m.length;b++)i[b]=m.charCodeAt(b)}else i=new Uint8Array(e);if(i.length<8)throw new Error("Data too short to be valid PDF");const s=String.fromCharCode.apply(null,i.slice(0,8));if(!s.startsWith("%PDF-"))throw new Error(`Invalid PDF header: ${s}`);const d=window.pdfjsLib;if(!d)throw new Error("PDF.js library not loaded");if(i.length<1024)throw new Error("PDF file is too small to be valid");let l=!1,c=!1,w="",g="",h=null,u=null;const f=[{data:i,stopAtErrors:!1,maxImageSize:5242880,disableFontFace:!0,disableRange:!0,disableStream:!0,verbosity:1},{data:i,stopAtErrors:!1,maxImageSize:10485760,disableFontFace:!1,disableRange:!0,disableStream:!1,verbosity:1},{data:i,stopAtErrors:!1,verbosity:1}];for(let y=0;y<f.length;y++)try{const v=d.getDocument({...f[y],standardFontDataUrl:d.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:d.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:d.GlobalWorkerOptions.openjpegJsUrl,password:t||void 0});v.onPassword=function(e,t){throw t===d.PasswordResponses.NEED_PASSWORD?new Error("PasswordException"):t===d.PasswordResponses.INCORRECT_PASSWORD?(console.log("パスワードが間違っています。"),new Error("PasswordException")):new Error("PasswordException")},h=await v.promise;break}catch(o){if(u=o,o&&"PasswordException"===o.name){l=!0,w="パスワード付きPDF";break}if(y===f.length-1)throw u}if(l||!h)return{thumbnail:"",isPasswordProtected:l,isOperationRestricted:c,securityInfo:w||"パスワード付きPDF"};h&&h._pdfInfo&&h._pdfInfo.permissions&&(c=h._pdfInfo.permissions.length>0,w+=c?" 操作制限あり":"");try{const F=await h.getPage(1),P=F.getViewport({scale:n.pdfSettings.scales.thumbnail}),D=document.createElement("canvas");D.width=Math.max(1,Math.round(P.width)),D.height=Math.max(1,Math.round(P.height));const L=D.getContext("2d");await F.render({canvasContext:L,viewport:P}).promise,g=D.toDataURL("image/png")}catch(r){console.error("サムネイル生成エラー:",r),g=""}let p=[];try{const U=await h.getOutline();if(U&&U.length){async function x(e){const t=[];for(const o of e){let e=null;try{let t=o.dest;if("string"==typeof t&&(t=await h.getDestination(t)),Array.isArray(t)&&t.length>0)try{e=await h.getPageIndex(t[0])}catch(n){e=null}}catch(n){}const r={title:o.title||"",pageIndex:e,items:[]};o.items&&o.items.length&&(r.items=await x(o.items)),t.push(r)}return t}try{p=await x(U)}catch(a){console.error("pdf: outline mapping failed",a),p=[]}}}catch(a){console.error("pdf: getOutline failed or no outline",a),p=[]}return{thumbnail:g,isPasswordProtected:l,isOperationRestricted:c,securityInfo:w,bookmarks:p}}catch(o){return console.error("Error in renderFirstPDFPage:",o),{thumbnail:"",isPasswordProtected:o&&"PasswordException"===o.name,isOperationRestricted:!1,securityInfo:o&&"PasswordException"===o.name?"パスワード付きPDF":"解析失敗",bookmarks:[]}}},window.generatePdfThumbnailFromFileMetaData=async function(e,t){try{let r;if(e instanceof Uint8Array)r=e;else if(Array.isArray(e))r=new Uint8Array(e);else if("string"==typeof e){const t=atob(e);r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e)}else r=new Uint8Array(e);const a=window.pdfjsLib;if(!a)throw new Error("PDF.js library not loaded");let i=await a.getDocument({data:r,standardFontDataUrl:a.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:a.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:a.GlobalWorkerOptions.openjpegJsUrl}).promise,s="";try{const e=await i.getPage(t+1),o=e.getViewport({scale:n.pdfSettings.scales.thumbnail}),r=document.createElement("canvas");r.width=o.width,r.height=o.height;const a=r.getContext("2d");await e.render({canvasContext:a,viewport:o}).promise,s=r.toDataURL("image/png")}catch(o){s=""}return{thumbnail:s,isError:!1,isPasswordProtected:!1,securityInfo:""}}catch(r){return{thumbnail:"",isError:!0,isPasswordProtected:!1,securityInfo:"解析失敗"}}},window.convertImageToPngBase64AndSize=function(e,t){return new Promise((n,o)=>{const r=new Image;r.onload=function(){const e=document.createElement("canvas");e.width=r.width||800,e.height=r.height||600;e.getContext("2d").drawImage(r,0,0);const t=e.toDataURL("image/png");n({pngBase64:t,width:r.width,height:r.height})},r.onerror=o,e.startsWith("data:")?r.src=e:r.src=t?`data:${t};base64,${e}`:`data:image/png;base64,${e}`})},window.getPDFPageCount=async function(e){try{let t;if(e instanceof Uint8Array)t=e;else if(Array.isArray(e))t=new Uint8Array(e);else if("string"==typeof e){const n=atob(e);t=new Uint8Array(n.length);for(let e=0;e<n.length;e++)t[e]=n.charCodeAt(e)}else t=new Uint8Array(e);const n=window.pdfjsLib;if(!n)throw new Error("PDF.js library not loaded");const o=n.getDocument({data:t,stopAtErrors:!1,verbosity:1,standardFontDataUrl:n.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:n.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:n.GlobalWorkerOptions.openjpegJsUrl});return(await o.promise).numPages}catch(t){throw console.error("Error in getPDFPageCount:",t),t}},window._pdfLibCache=window._pdfLibCache||new Map,window._pdfLibFileRestricted=window._pdfLibFileRestricted||new Set,window._pdfLibFileIsRestricted=function(e){try{return!!(e&&window._pdfLibFileRestricted&&window._pdfLibFileRestricted.has(e))}catch(t){return!1}},window._pdfLibCacheClear=function(){try{return window._pdfLibCache&&"function"==typeof window._pdfLibCache.clear?(window._pdfLibCache.clear(),!0):(window._pdfLibCache=new Map,!0)}catch(e){return!1}},window._pdfLibCacheDelete=function(e){try{return!!e&&(!(!window._pdfLibCache||!window._pdfLibCache.has(e))&&(window._pdfLibCache.delete(e),!0))}catch(t){return!1}},window._pdfLibFileRestrictedClear=function(){try{return window._pdfLibFileRestricted&&"function"==typeof window._pdfLibFileRestricted.clear?(window._pdfLibFileRestricted.clear(),!0):(window._pdfLibFileRestricted=new Set,!0)}catch(e){return!1}},window.extractPdfPage=async function(e,t,n=null){try{const{PDFDocument:d}=PDFLib;if(!d)throw new Error("PDF-lib library not loaded");let l;if(e instanceof Uint8Array)l=e;else if(Array.isArray(e))l=new Uint8Array(e);else if("string"==typeof e){const t=atob(e);l=new Uint8Array(t.length);for(let e=0;e<t.length;e++)l[e]=t.charCodeAt(e)}else l=new Uint8Array(e);let c=null;if(n&&window._pdfLibCache.has(n))c=window._pdfLibCache.get(n);else try{c=await d.load(l),n&&window._pdfLibCache.set(n,c)}catch(o){try{return await r(l,t,n)}catch(i){return console.error("extractPdfPage: fallback render failed, returning blank page",i),await a()}}const w=await d.create();try{if(n&&window._pdfLibFileRestricted&&window._pdfLibFileRestricted.has(n))throw new Error("file-restricted-precheck");const[e]=await w.copyPages(c,[t]);w.addPage(e)}catch(s){try{return await r(l,t,n)}catch(i){return console.error("extractPdfPage: image fallback failed",i),await a()}}const g=await w.save();let h="";for(let e=0;e<g.length;e++)h+=String.fromCharCode(g[e]);return btoa(h)}catch(d){return console.error(`Error extracting PDF page ${t}:`,d),await a()}},window.generatePdfThumbnailFromPageData=async function(e){try{const t=window.pdfjsLib,o=atob(e),r=new Uint8Array(o.length);for(let e=0;e<o.length;e++)r[e]=o.charCodeAt(e);const a=t.getDocument({data:r,standardFontDataUrl:t.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:t.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:t.GlobalWorkerOptions.openjpegJsUrl}),i=await a.promise,s=await i.getPage(1),d=s.getViewport({scale:n.pdfSettings.scales.thumbnail}),l=document.createElement("canvas");l.width=d.width,l.height=d.height;const c={canvasContext:l.getContext("2d"),viewport:d};return await s.render(c).promise,l.toDataURL("image/png")}catch(t){return console.error("Error rendering single PDF page:",t),""}},window.generatePreviewImage=async function(e,t){const o=atob(e),r=new Uint8Array(o.length);for(let n=0;n<o.length;n++)r[n]=o.charCodeAt(n);const a=pdfjsLib.getDocument({data:r,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}),i=await a.promise,s=await i.getPage(1),d=s.getViewport({scale:n.pdfSettings.scales.normal,rotation:t||0}),l=document.createElement("canvas");l.width=d.width,l.height=d.height;const c=l.getContext("2d");return await s.render({canvasContext:c,viewport:d}).promise,l.toDataURL("image/jpeg",.85)},window.getPdfFileSize=async function(e){const t=await fetch(e);return((await t.blob()).size/1048576).toFixed(2)+"MB"},window.downloadFileFromUrl=function(e,t,n){const o=document.createElement("a");o.href=e,o.download=t,o.type=n||"application/octet-stream",document.body.appendChild(o),o.click(),document.body.removeChild(o)},window.renderPdfPages=async function(e,t){if(!window.pdfjsLib)return void console.error("pdfjsLib is not loaded");const o=await pdfjsLib.getDocument({url:e,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}).promise;for(let r=0;r<t.length;r++){const e=await o.getPage(r+1),a=document.getElementById(t[r]);if(!a)continue;const i=a.getContext("2d"),s=e.getViewport({scale:n.pdfSettings.scales.normal});a.width=s.width,a.height=s.height,await e.render({canvasContext:i,viewport:s}).promise}},window.checkCanvasExists=function(e){return!!document.getElementById(e)},window._canvasRendering=window._canvasRendering||{},window.renderPdfThumbnailToCanvas=async function(e,t){if(!window.pdfjsLib)throw new Error("pdfjsLib is not loaded.");if(window._canvasRendering[t])return console.warn("render in progress, skipping:",t),!1;window._canvasRendering[t]=!0;try{const o=window.pdfjsLib.getDocument({url:e,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}),r=await o.promise,a=await r.getPage(1),i=a.getViewport({scale:n.pdfSettings.scales.thumbnail}),s=document.getElementById(t);if(!s)return console.warn("canvas not found:",t),!1;const d=s.getContext("2d");return s.width=i.width,s.height=i.height,d.clearRect(0,0,s.width,s.height),await a.render({canvasContext:d,viewport:i}).promise,!0}catch(o){return console.error("renderPdfThumbnailToCanvas error",o,e,t),!1}finally{window._canvasRendering[t]=!1}},window.drawImageToCanvas=function(e,t,n=!0){const o=document.getElementById(e);if(!o)return;const r=o.getContext("2d"),a=new window.Image;a.onload=function(){try{const e=o.getBoundingClientRect(),t=Math.max(1,e.width||o.clientWidth||96),i=Math.max(1,e.height||o.clientHeight||128),s=n&&window.devicePixelRatio||1;o.width=Math.round(t*s),o.height=Math.round(i*s),r.setTransform(s,0,0,s,0,0),r.clearRect(0,0,t,i);const d=Math.min(t/a.width,i/a.height),l=a.width*d,c=a.height*d;r.drawImage(a,(t-l)/2,(i-c)/2,l,c)}catch(e){console.debug("drawImageToCanvas error",e)}},a.onerror=function(e){console.debug("drawImageToCanvas image load error",e,t)},a.src=t},window.drawImageToCanvasForPreview=function(e,t,n=!0){return new Promise(o=>{try{const r=document.getElementById(e);if(!r)return void o(!1);const a=r.getContext("2d");if(!a)return void o(!1);const i=new window.Image;i.crossOrigin="anonymous",i.onload=function(){try{const t=Math.max(1,Math.round(i.naturalWidth)),s=Math.max(1,Math.round(i.naturalHeight)),d=n&&window.devicePixelRatio||1;r.width=Math.round(t*d),r.height=Math.round(s*d),r.style.width=t+"px",r.style.height=s+"px",r.style.display="block",a.setTransform(d,0,0,d,0,0),a.clearRect(0,0,t,s),a.drawImage(i,0,0,t,s),requestAnimationFrame(()=>requestAnimationFrame(()=>{console.log("drawImageToCanvasForPreview: resolved true for",e),o(!0)}))}catch(t){console.error("drawImageToCanvasForPreview draw error",t),o(!1)}},i.onerror=function(e){console.error("drawImageToCanvasForPreview image load error",e,t),o(!1)},i.src=t}catch(r){console.error("drawImageToCanvasForPreview error",r),o(!1)}})},window.unlockPdf=async function(e,t){const o=window.pdfjsLib;if(!o)throw new Error("PDF.js library not loaded");let r;if("string"==typeof e){const t=atob(e);r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e)}else r=e;const a=o.getDocument({data:r,password:t,standardFontDataUrl:o.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:o.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:o.GlobalWorkerOptions.openjpegJsUrl}),i=await a.promise,{PDFDocument:s}=PDFLib,d=await s.create();for(let w=1;w<=i.numPages;w++){const e=await i.getPage(w),t=e.getViewport({scale:n.pdfSettings.scales.unlock}),o=document.createElement("canvas");o.width=t.width,o.height=t.height;const r=o.getContext("2d");await e.render({canvasContext:r,viewport:t}).promise;const a=o.toDataURL("image/png"),s=await d.embedPng(a);d.addPage([t.width,t.height]).drawImage(s,{x:0,y:0,width:t.width,height:t.height})}const l=await d.save();let c="";for(let n=0;n<l.length;n++)c+=String.fromCharCode(l[n]);return btoa(c)},window.editPdfPageWithElements=async function(e,t){const{PDFDocument:n,rgb:o,StandardFonts:r}=PDFLib;if(!PDFLib._fontkitRegistered){if(!window.fontkit)throw new Error("fontkitがロードされていません。");PDFLib.PDFDocument.prototype.registerFontkit(window.fontkit),PDFLib._fontkitRegistered=!0}const a=f(e),i=await n.load(a),s=i.getPage(0),d=s.getHeight();let l=[];try{l=JSON.parse(t)}catch(p){console.error("editJson parse error",p,t)}const c={notoSansReg:null,notoSansBold:null,notoSerifReg:null,notoSerifBold:null};async function w(e){const t=(n=e.Text,/[\u3000-\u30FF\u4E00-\u9FFF\uFF01-\uFF60]/.test(n||""));var n;const o=t&&!!((a=e.FontFamily)&&a.toString().toLowerCase().indexOf("notoserif")>=0);var a;const s=!!e.IsBold;try{if(t){if(o){if(s){if(!c.notoSerifBold){const e=await fetch("/fonts/NotoSerifJP-Bold.ttf").then(e=>e.arrayBuffer());c.notoSerifBold=await i.embedFont(e)}return c.notoSerifBold}if(!c.notoSerifReg){const e=await fetch("/fonts/NotoSerifJP-Regular.ttf").then(e=>e.arrayBuffer());c.notoSerifReg=await i.embedFont(e)}return c.notoSerifReg}if(s){if(!c.notoSansBold){const e=await fetch("/fonts/NotoSansJP-Bold.ttf").then(e=>e.arrayBuffer());c.notoSansBold=await i.embedFont(e)}return c.notoSansBold}if(!c.notoSansReg){const e=await fetch("/fonts/NotoSansJP-Regular.ttf").then(e=>e.arrayBuffer());c.notoSansReg=await i.embedFont(e)}return c.notoSansReg}return e.IsBold?await i.embedFont(r.HelveticaBold):await i.embedFont(r.Helvetica)}catch(d){return console.error("font embed error",d),await i.embedFont(r.Helvetica)}}for(const m of l)if(0===m.Type||"Text"===m.Type){let e=function(e,t,n,o){if(!e)return[""];const r=[],a=e.split(/(\s+)/);let i="";for(const s of a){const e=t.widthOfTextAtSize(s,n);if((i?t.widthOfTextAtSize(i,n):0)+e<=o)i+=s;else if(i&&r.push(i),e<=o)i=s;else{let e="";for(let a=0;a<s.length;a++){e+=s[a];t.widthOfTextAtSize(e,n)>o&&(e.length>1?(r.push(e.slice(0,-1)),e=e.slice(-1)):(r.push(e),e=""))}i=e}}return i&&r.push(i),r};const t=await w(m),n=PDFLib.degrees(m.Rotation||0),o=Number(m.FontSize)||16,r=(void 0!==m.LineHeight&&m.LineHeight>0?Number(m.LineHeight):null)||o,a=m.Text||"",i="number"==typeof m.X?m.X:0,l="number"==typeof m.Width&&m.Width>0?Number(m.Width):s.getWidth()-i,c=a.split("\n"),g=[];for(const s of c){const n=e(s,t,o,l);0===n.length?g.push(""):g.push(...n)}const h=d-(m.Y||0)-o;for(let d=0;d<g.length;d++)s.drawText(g[d]||"",{x:i,y:h-d*r,size:o,font:t,color:u(m.Color||"#000000"),rotate:n})}else if(1===m.Type||"Image"===m.Type)if(m.ImageUrl&&(m.ImageUrl.startsWith("data:image/png")||m.ImageUrl.startsWith("data:image/jpeg"))){let e,t=m.ImageUrl.split(",")[1]||m.ImageUrl;m.ImageUrl.startsWith("data:image/png")?e=await i.embedPng(f(t)):m.ImageUrl.startsWith("data:image/jpeg")&&(e=await i.embedJpg(f(t)));const n=PDFLib.degrees(m.Rotation||0);s.drawImage(e,{x:m.X||0,y:d-(m.Y||0)-(m.Height||e.height),width:m.Width||e.width,height:m.Height||e.height,rotate:n})}else console.warn("未対応画像形式: ",m.ImageUrl?m.ImageUrl.substring(0,30):"");const g=await i.save();let h="";for(let m=0;m<g.length;m++)h+=String.fromCharCode(g[m]);return btoa(h);function u(e){3===(e=e.replace("#","")).length&&(e=e.split("").map(e=>e+e).join(""));const t=parseInt(e,16);return o((t>>16&255)/255,(t>>8&255)/255,(255&t)/255)}function f(e){const t=atob(e.replace(/^data:.*;base64,/,"")),n=t.length,o=new Uint8Array(n);for(let r=0;r<n;r++)o[r]=t.charCodeAt(r);return o}},window.addStampsToPdf=async function(e,t){const{PDFDocument:n,rgb:r,StandardFonts:a,degrees:i}=PDFLib;let s;PDFLib._fontkitRegistered||(window.fontkit?(PDFLib.PDFDocument.prototype.registerFontkit(window.fontkit),PDFLib._fontkitRegistered=!0):console.warn("fontkitがロードされていません。日本語フォントは使用できません。")),s="string"==typeof e?o(e):e instanceof Uint8Array?e:(Array.isArray(e),new Uint8Array(e));const d=((t.length>0&&t[0].rotateAngle||0)%360+360)%360,l=await n.load(s),c=l.getPage(0),{width:w,height:g}=c.getSize();let h=null;function u(e){return/[\u3000-\u30FF\u4E00-\u9FFF\uFF01-\uFF60]/.test(e)}function f(e,t,n){const o=e+1;if(!n)return o.toString();const r=t.toString().length;return o.toString().padStart(r,"0")}function p(e,t,n,o,r,a,i,s){let d=0,l=0,c=0;const w=(o%360+360)%360;if(0===w){switch(e){case"TopLeft":d=t,l=a-n-s;break;case"Top":d=r/2-i/2,l=a-n-s;break;case"TopRight":d=r-t-i,l=a-n-s;break;case"BottomLeft":d=t,l=n;break;case"Bottom":d=r/2-i/2,l=n;break;case"BottomRight":d=r-t-i,l=n}c=0}else if(90===w){switch(e){case"TopLeft":d=n,l=t;break;case"Top":d=n,l=a/2-i/2;break;case"TopRight":d=n,l=a-t-i;break;case"BottomLeft":d=r-n,l=t;break;case"Bottom":d=r-n,l=a/2-i/2;break;case"BottomRight":d=r-n,l=a-t-i}c=90}else if(180===w){switch(e){case"TopLeft":d=r-t,l=n;break;case"Top":d=r/2-i/2,l=n;break;case"TopRight":d=t+i,l=n;break;case"BottomLeft":d=r-t,l=a-n;break;case"Bottom":d=r/2-i/2,l=a-n;break;case"BottomRight":d=t+i,l=a-n}c=180}else if(270===w){switch(e){case"TopLeft":d=r-n,l=a-t;break;case"Top":d=r-n,l=a/2-i/2;break;case"TopRight":d=r-n,l=t+i;break;case"BottomLeft":d=n,l=a-t;break;case"Bottom":d=n,l=a/2-i/2;break;case"BottomRight":d=n,l=t+i}c=-90}return{x:d,y:l,textRotation:c}}for(const o of t){let e,t=o.text||"";if(o.isSerial){const e=f(o.currentPageIndex||0,o.totalPages||1,o.isZeroPadded||!1);t=t?`${t}${e}`:e}if(u(t)){if(!h)try{const e="/fonts/NotoSansJP-Regular.ttf",t=await fetch(e).then(e=>e.arrayBuffer());h=await l.embedFont(t)}catch(m){console.warn("日本語フォント読み込み失敗:",m),e=await l.embedFont(a.Helvetica)}e=h||await l.embedFont(a.Helvetica)}else e=await l.embedFont(a.Helvetica);const n=o.fontSize||12,s=e.widthOfTextAtSize(t,n),y=p(o.corner,o.offsetX,o.offsetY,d,w,g,s,n),v=o.color?r(o.color.r||0,o.color.g||0,o.color.b||0):r(0,0,0);try{c.drawText(t,{x:y.x,y:y.y,size:n,font:e,color:v,rotate:i(y.textRotation)})}catch(b){throw console.error("スタンプ描画エラー:",b),b}}return await l.save()},window.scrollToSection=function(e){e&&e.scrollIntoView({behavior:"smooth"})};let i=null;window.isSorting=!1,window.initializeSortable=function(){function e(){return document.getElementById("sortable-container")}function t(){const t=e();t&&(t.classList.remove("is-sorting","dragging-chosen","dragging-ghost"),t.querySelectorAll(".dragging-chosen, .dragging-ghost").forEach(e=>{e.classList.remove("dragging-chosen","dragging-ghost")})),window.isSorting=!1}window.removeEventListener("mouseup",t),window.removeEventListener("touchend",t);const n=e();n&&"none"!==window.getComputedStyle(n).display&&window.Sortable?(i&&(i.destroy(),i=null,n.classList.remove("is-sorting"),window.isSorting=!1),window.addEventListener("mouseup",t),window.addEventListener("touchend",t),i=new Sortable(n,{draggable:".sortable-item-container",handle:window.matchMedia("(min-width: 768px)").matches?".drag-handle":".touch-drag-handle",filter:".non-sortable",animation:150,ghostClass:"dragging-ghost",chosenClass:"dragging-chosen",onStart:function(e){n.classList.add("is-sorting"),window.isSorting=!0},onMove:function(e){const t=e.related,o=e.dragged;if(t&&t.classList.contains("non-sortable")){const e=t,r=e.previousElementSibling;return r&&r.classList.contains("sortable-chosen"),n.insertBefore(o,e),!1}if(t&&t.closest(".non-sortable")){const e=t.closest(".non-sortable");return n.insertBefore(o,e),!1}if(!t||t===n){const e=n.querySelector(".non-sortable");return e&&n.insertBefore(o,e),!1}return!0},onEnd:function(e){t();const o=n.querySelectorAll(".sortable-item-container:not(.non-sortable)").length;let r=e.newIndex;e.newIndex>=o&&(r=o-1),DotNet.invokeMethodAsync("NoCloudPdf","UpdateOrder",getPageType(),e.oldIndex,r)}})):i&&i.el&&(i.destroy(),i=null,t())},function(){const e="ncp_tour_ran",t="home-intro-v1";function n(){const e=["undefined"!=typeof window&&window.innerWidth<768?{id:"nav-explain",selector:"#nav-hamburger",title:"メニュー表示",text:"機能の切替メニューを表示できます。すぐに利用される方はこちらから。",position:"right",group:t}:{id:"nav-explain",selector:"#nav-main",title:"切替メニュー",text:"機能の切替メニューです。すぐに利用される方は，目的の機能をクリックしてください。",position:"right",group:t},{id:"home-tip",selector:"#home-summary-tip",title:"概要",text:"このページ下部にアプリの概要があります。",position:"top",group:t}];try{const n=document.querySelector("#install-pwa-btn");n&&function(e){try{if(!e)return!1;const t=window.getComputedStyle(e);return t&&"none"!==t.display}catch(t){return!1}}(n)&&e.push({id:"install-pwa",selector:"#install-pwa-btn",title:"インストール",text:"アプリのショートカットを作成できます。",position:"left",group:t})}catch(n){console.debug("tour: check install-pwa failed",n)}return e}function o(){try{const e=document.getElementById("ncp-tour-dontshow");e&&e.checked&&setEnabled(!1)}catch(e){}}async function r(){try{await function(e="#install-pwa-btn-flag",t=1e3,n=100){return new Promise(o=>{const r=Date.now(),a=()=>{try{const t=document.querySelector(e);if(t){const e=(t.value||"").toString().toLowerCase();if("true"===e)return o(!0);if("false"===e)return o(!1)}}catch(i){}if(Date.now()-r>=t)return o(!1);setTimeout(a,n)};a()})}("#install-pwa-btn-flag",1e3,100)}catch(i){}const r=n();!function(){try{document.querySelectorAll(".tg-backdrop, .tg-dialog").forEach(e=>{try{e.remove()}catch(i){}})}catch(i){}window._ncpTour&&(window._ncpTour.client=null)}();const a=window.tourguide?.TourGuideClient||window.TourGuideClient||window.tourguide||null;if("function"==typeof a||a&&"object"==typeof a)try{const n=r.map((e,t)=>{const n=document.querySelector(e.selector);return{title:e.title||"",content:e.text||"",target:n||e.selector,order:e.order??t+1,group:e.group??void 0}}),a={nextLabel:"次へ",prevLabel:"戻る",finishLabel:"終了",onAfterExit:o,completeOnFinish:!0},s=new tourguide.TourGuideClient({steps:n,...a});if(s){s.onFinish(async()=>{o()}),s.isFinished(t)||s.start(t);try{!function(){try{sessionStorage.setItem(e,"true")}catch(i){}}()}catch(i){}}return!0}catch(i){console.debug("tour: TourGuideClient init failed",i)}return console.debug("tour: no compatible start method found"),!1}window.startTourIfNeeded=async function(n={}){if((new tourguide.TourGuideClient).isFinished(t))return;if(!function(){const e=(document.querySelector("base")?.getAttribute("href")||"/").replace(/\/$/,""),t=location.pathname.replace(new RegExp("^"+e),"")||"/";return"/"===t||""===t}())return;if(function(){try{return"true"===sessionStorage.getItem(e)}catch(t){return!1}}())return;await r()},window._ncpTour={startTourIfNeeded:window.startTourIfNeeded}}()}();
