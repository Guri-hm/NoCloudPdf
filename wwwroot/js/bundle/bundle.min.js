!function(){"use strict";async function e(){window.JSZip||await new Promise((e,t)=>{const n=document.createElement("script");n.src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js",n.onload=e,n.onerror=t,document.head.appendChild(n)})}window.getPageType=function(){return window.location.pathname.includes("/split")?"split":window.location.pathname.includes("/merge")?"merge":"unknown"},window.fadeInOnScroll={observe:function(e){if(!e)return;new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(e.target.classList.remove("opacity-0","translate-y-8"),e.target.classList.add("opacity-100","translate-y-0"))})},{threshold:.5}).observe(e)}},window.positionEditorTooltip=function(e,t){const n=document.getElementById(t);if(!n)return;n.style.display="block",n.setAttribute("aria-hidden","false"),n.style.left="-9999px",n.style.top="-9999px",n.style.visibility="hidden";const o=e.getBoundingClientRect(),r=n.getBoundingClientRect(),i=window.innerWidth||document.documentElement.clientWidth,a=window.innerHeight||document.documentElement.clientHeight,s=o.top,c=a-o.bottom,l=o.left,d=i-o.right;let w="top";s<r.height+12&&c>s&&(w="bottom"),("top"===w||"bottom"===w)&&r.width>d&&l>d&&(w="left"),("top"===w||"bottom"===w)&&r.width>l&&d>l&&(w="right");let h=0,u=0;"top"===w?(u=o.top-r.height-8,h=o.left+(o.width-r.width)/2):"bottom"===w?(u=o.bottom+8,h=o.left+(o.width-r.width)/2):"left"===w?(u=o.top+(o.height-r.height)/2,h=o.left-r.width-8):(u=o.top+(o.height-r.height)/2,h=o.right+8),h=Math.max(8,Math.min(h,i-r.width-8)),u=Math.max(8,Math.min(u,a-r.height-8)),n.style.left=Math.round(h)+"px",n.style.top=Math.round(u)+"px",n.setAttribute("data-dir",w),n.style.visibility="visible"},window.hideEditorTooltip=function(e){const t=document.getElementById(e);t&&(t.style.display="none",t.setAttribute("aria-hidden","true"))},window.registerDropArea=function(e,t){const n=document.getElementById(e);if(!n)return;n._dropHandlers&&window.unregisterDropArea(e);let o=0;n._dropHandlers={dragenter:function(e){window.isSorting||(o++,t.invokeMethodAsync("SetDragOver",!0))},dragover:function(e){window.isSorting||e.preventDefault()},dragleave:function(e){window.isSorting||(o--,o<=0&&(o=0,t.invokeMethodAsync("SetDragOver",!1)))},drop:function(e){if(!window.isSorting&&(e.preventDefault(),o=0,t.invokeMethodAsync("SetDragOver",!1),e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files.length>0)){Array.from(e.dataTransfer.files).forEach(e=>{const n=new FileReader;n.onload=function(n){t.invokeMethodAsync("OnJsFileDropped",e.name,e.type,n.target.result.split(",")[1])},n.readAsDataURL(e)})}}},n.addEventListener("dragenter",n._dropHandlers.dragenter),n.addEventListener("dragover",n._dropHandlers.dragover),n.addEventListener("dragleave",n._dropHandlers.dragleave),n.addEventListener("drop",n._dropHandlers.drop)},window.unregisterDropArea=function(e){const t=document.getElementById(e);t&&t._dropHandlers&&(t.removeEventListener("dragenter",t._dropHandlers.dragenter),t.removeEventListener("dragover",t._dropHandlers.dragover),t.removeEventListener("dragleave",t._dropHandlers.dragleave),t.removeEventListener("drop",t._dropHandlers.drop),delete t._dropHandlers)},window.registerSelectDropArea=function(e){const t=document.getElementById("select-drop-area");if(!t||!t.firstElementChild)return;window.unregisterSelectDropArea();const n=t.firstElementChild;let o=0;t.ondragenter=e=>{o++,n.classList.remove("bg-white/60"),n.classList.add("bg-blue-100/60","border-solid")},t.ondragover=e=>{e.preventDefault()},t.ondragleave=e=>{o--,o<=0&&(console.log("ondragleave"),o=0,n.classList.remove("bg-blue-100/60","border-solid"),n.classList.add("bg-white/60"))},t.ondrop=t=>{t.preventDefault(),n.classList.remove("bg-blue-100/60","border-solid"),n.classList.add("bg-white/60"),t.dataTransfer&&t.dataTransfer.files.length>0&&Array.from(t.dataTransfer.files).forEach(t=>{const n=new FileReader;n.onload=function(n){const o=n.target.result.split(",")[1];e.invokeMethodAsync("OnJsFileDropped",t.name,t.type,o)},n.readAsDataURL(t)})},t.onpaste=t=>{t.clipboardData&&t.clipboardData.files.length>0&&Array.from(t.clipboardData.files).forEach(t=>{const n=new FileReader;n.onload=function(n){const o=n.target.result.split(",")[1];e.invokeMethodAsync("OnJsFileDropped",t.name,t.type,o)},n.readAsDataURL(t)})}},window.unregisterSelectDropArea=function(){const e=document.getElementById("select-drop-area");e&&(e.ondragenter=null,e.ondragover=null,e.ondragleave=null,e.ondrop=null,e.onpaste=null)},window.getPageSourceInfo=async function(e,t,n){try{if(!n)return null;let e=n;const t=/^data:.*;base64,(.*)$/.exec(n);t&&t[1]&&(e=t[1]);const i=window.devicePixelRatio||1;try{const t=Uint8Array.from(atob(e),e=>e.charCodeAt(0)),n=await window.pdfjsLib.getDocument({data:t,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}).promise,o=(await n.getPage(1)).getViewport({scale:1});return{origW:o.width,origH:o.height,dpr:i}}catch(o){try{const e=n,t=await new Promise((t,n)=>{const o=new Image;o.onload=()=>t(o),o.onerror=n,o.src=e});return{origW:t.naturalWidth,origH:t.naturalHeight,dpr:i}}catch(r){return console.error("getPageSourceInfo: not pdf nor image",r),null}}}catch(i){return console.error("getPageSourceInfo error",i),null}},window.drawPdfPageToCanvas=async function(e,t,n=1,o){try{const i=`#pdf-canvas-${e}`,a=document.querySelector(i);if(!a||!t)return;let s=t;const c=/^data:.*;base64,(.*)$/.exec(t);let l;c&&c[1]&&(s=c[1]);try{l=Uint8Array.from(atob(s),e=>e.charCodeAt(0))}catch(r){return void console.error("drawPdfPageToCanvas: invalid base64",r)}const d=window.pdfjsLib;if(!d)return void console.error("pdfjsLib not loaded");if(window._pdfRenderTask&&window._pdfRenderTask.cancel)try{window._pdfRenderTask.cancel()}catch{}const w=d.getDocument({data:l,standardFontDataUrl:d.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:d.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:d.GlobalWorkerOptions.openjpegJsUrl}),h=await w.promise,u=await h.getPage(1),m=window.devicePixelRatio||1,g=n<1?1:m,p=n*g,f=u.getViewport({scale:p,rotation:o});a.width=Math.round(f.width),a.height=Math.round(f.height);const y=document.createElement("canvas");y.width=Math.max(1,Math.round(f.width)),y.height=Math.max(1,Math.round(f.height));const v=y.getContext("2d");v&&v.setTransform&&v.setTransform(1,0,0,1,0,0),window._pdfRenderTask=u.render({canvasContext:v,viewport:f}),await window._pdfRenderTask.promise;const b=a.getContext("2d");if(!b)return;b.setTransform(1,0,0,1,0,0),b.clearRect(0,0,a.width,a.height);const x=Math.round((a.width-y.width)/2),R=Math.round((a.height-y.height)/2);b.drawImage(y,0,0,y.width,y.height,x,R,y.width,y.height),b.setTransform&&b.setTransform(g,0,0,g,0,0)}catch(i){if(i&&"RenderingCancelledException"===i.name)return;console.error("drawPdfPageToCanvas error",i)}},window.getTagNameFromEvent=function(e){return e&&e.target&&e.target.tagName?e.target.tagName:""},window.getCanvasCoords=function(e,t,n,o,r,i){const a=document.querySelector(e);if(!a)return{x:0,y:0};const s=a.getBoundingClientRect();return{x:(t-s.left)/i,y:(n-s.top)/i}},window.triggerFileInput=e=>{e.click()},window.clearFileInput=function(e){e&&(e.value="")},window.registerGlobalMouseUp=function(e){window._blazorMouseUpHandler=function(t){e.invokeMethodAsync("OnGlobalMouseUp")},window.addEventListener("mouseup",window._blazorMouseUpHandler)},window.unregisterGlobalMouseUp=function(){window._blazorMouseUpHandler&&(window.removeEventListener("mouseup",window._blazorMouseUpHandler),window._blazorMouseUpHandler=null)},window.registerGlobalMouseMove=function(e){window._globalMouseMoveHandler=function(t){e.invokeMethodAsync("OnGlobalMouseMove",{clientX:t.clientX,clientY:t.clientY})},window.addEventListener("mousemove",window._globalMouseMoveHandler)},window.unregisterGlobalMouseMove=function(){window._globalMouseMoveHandler&&(window.removeEventListener("mousemove",window._globalMouseMoveHandler),window._globalMouseMoveHandler=null)},window.getElementRect=function(e){const t=document.querySelector(e);if(!t)return{left:0,top:0,width:0,height:0};const n=t.getBoundingClientRect();return{left:n.left,top:n.top,width:n.width,height:n.height}},window.waitForNextFrame=function(){return new Promise(e=>requestAnimationFrame(e))},window.measureMaxLineWidth=function(e,t,n){const o=(window._measureTextCanvas||(window._measureTextCanvas=document.createElement("canvas"))).getContext("2d");o.font=`${t}px ${n}`;const r=e.split("\n");let i=0;for(const a of r){const e=o.measureText(a).width;e>i&&(i=e)}return i},window.selectAllTextarea=function(e){e&&e.select()},window.autoResizeTextarea=function(e){try{const t=(e=>e?"string"==typeof e?document.getElementById(e):(HTMLElement,e):null)(e);return t&&t.style?new Promise(e=>{requestAnimationFrame(()=>{try{t.style.height="auto",t.getBoundingClientRect();const o=window.getComputedStyle(t),r=parseFloat(o.lineHeight)||parseFloat(o.fontSize)||16,i=Math.max(t.scrollHeight||0,r),a=Math.ceil(i+2);t.style.height=a+"px",t.style.overflow="hidden";let s=0;try{const e=t.closest&&t.closest(".edit-element");if(e){const t=window.getComputedStyle(e);s=(parseFloat(t.borderTopWidth)||0)+(parseFloat(t.borderBottomWidth)||0)}}catch(n){}e(a+s||0)}catch(o){console.error("autoResizeTextarea inner error",o),e(0)}})}):(console.debug("autoResizeTextarea: element not found:",e),0)}catch(t){return console.error("autoResizeTextarea error",t),0}},window.getImageSizeFromBase64=function(e){return new Promise(t=>{const n=new Image;n.onload=function(){t({width:n.width,height:n.height})},n.src=e})},window.openInsertFileDialog=function(e){const t=document.getElementById(e);t&&(t.value=null,t.click())},window.openFileDialog=function(e){const t=document.getElementById(e);t&&t.click()},window.createZipFromUrls=async function(t,n){if(await e(),!window.JSZip)throw new Error("JSZipがロードされていません。");const o=new JSZip;for(let e=0;e<t.length;e++){const r=t[e],a=n[e]||`file${e+1}.pdf`;try{const e=await fetch(r),t=await e.blob(),n=await t.arrayBuffer();o.file(a,n)}catch(i){console.error(`ファイル取得失敗: ${a}`,i)}}const r=await o.generateAsync({type:"blob"});return URL.createObjectURL(r)},window.getZipFileSize=async function(e){try{const t=await fetch(e),n=(await t.blob()).size;return n<1024?`${n} bytes`:n<1048576?`${(n/1024).toFixed(1)} KB`:`${(n/1048576).toFixed(2)} MB`}catch(t){return console.error("zipファイルサイズ取得失敗",t),""}},window.downloadImagesAsZip=async function(t,n){await e();const o=new JSZip;for(const e of t){const t=e.dataUrl.split(",")[1];o.file(e.fileName,t,{base64:!0})}const r=await o.generateAsync({type:"blob"}),i=URL.createObjectURL(r),a=document.createElement("a");a.href=i,a.download=n,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i)},window.downloadAllPdfsAsPngZip=async function(t,n,o){await e();const r=window.pdfjsLib;if(!r)return void alert("PDF.jsがロードされていません");const i=new window.JSZip;for(let e=0;e<t.length;e++){const o=t[e],a=(n[e]||`file${e+1}.pdf`).replace(/\.pdf$/i,"");let s=null;try{const e=await fetch(o),t=await e.arrayBuffer();s=await r.getDocument({data:t,standardFontDataUrl:r.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:r.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:r.GlobalWorkerOptions.openjpegJsUrl}).promise;for(let n=1;n<=s.numPages;n++){const e=await s.getPage(n),t=document.createElement("canvas"),o=e.getViewport({scale:2});t.width=o.width,t.height=o.height,await e.render({canvasContext:t.getContext("2d"),viewport:o}).promise;const r=t.toDataURL("image/png");i.file(`${a}_page${n}.png`,r.split(",")[1],{base64:!0})}}catch(c){console.error(`PDF変換失敗: ${a}`,c)}finally{try{s&&"function"==typeof s.destroy&&s.destroy()}catch(c){console.warn("pdf.destroy() error",c)}}}const a=await i.generateAsync({type:"blob"}),s=document.createElement("a");s.href=URL.createObjectURL(a),s.download=o||"images.zip",document.body.appendChild(s),s.click(),document.body.removeChild(s)};let t=null;window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),t=e}),window.isInstallPromptAvailable=function(){return null!==t},window.showInstallPrompt=async function(){t&&(t.prompt(),t=null)};let n=null;function o(e){const t=e.replace(/[\r\n\s]/g,""),n=atob(t),o=n.length,r=new Uint8Array(o);for(let i=0;i<o;i++)r[i]=n.charCodeAt(i);return r}function r(e){return e instanceof Uint8Array?e:Array.isArray(e)?new Uint8Array(e):"string"==typeof e?o(e):new Uint8Array(e)}function i(e){let t="";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return btoa(t)}async function a(e,t={}){const n=window.pdfjsLib;if(!n)throw new Error("PDF.js library not loaded");const o={data:e,standardFontDataUrl:n.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:n.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:n.GlobalWorkerOptions.openjpegJsUrl},r=n.getDocument({...o,...t});return await r.promise}async function s(e,t,n=0,o={}){const r=e.getViewport({scale:t,rotation:n}),i=document.createElement("canvas");i.width=Math.max(1,Math.round(r.width)),i.height=Math.max(1,Math.round(r.height));const a=i.getContext("2d",{alpha:!1});return o.fillWhite&&(a.fillStyle="#FFFFFF",a.fillRect(0,0,i.width,i.height)),await e.render({canvasContext:a,viewport:r}).promise,i}function c(e){const{rgb:t}=PDFLib;3===(e=e.replace("#","")).length&&(e=e.split("").map(e=>e+e).join(""));const n=parseInt(e,16);return t((n>>16&255)/255,(n>>8&255)/255,(255&n)/255)}function l(e){const t=((Number(e)||0)%360+360)%360;return 90*Math.round(t/90)%360}function d(e,t){return console.error(`${t} error:`,e),e&&"PasswordException"===e.name?{thumbnail:"",isPasswordProtected:!0,securityInfo:"パスワード付きPDF"}:{thumbnail:"",isError:!0,securityInfo:"解析失敗"}}function w(e){return/[\u3000-\u30FF\u4E00-\u9FFF\uFF01-\uFF60]/.test(e||"")}class h{constructor(e){this.pdfDoc=e,this.cache={}}async getFont(e,t={}){const{isBold:n=!1,isSerif:o=!1}=t;if(w(e)){const e=o?n?"notoSerifBold":"notoSerifReg":n?"notoSansBold":"notoSansReg";if(!this.cache[e]){const t={notoSerifBold:"/fonts/NotoSerifJP-Bold.ttf",notoSerifReg:"/fonts/NotoSerifJP-Regular.ttf",notoSansBold:"/fonts/NotoSansJP-Bold.ttf",notoSansReg:"/fonts/NotoSansJP-Regular.ttf"},n=await fetch(t[e]).then(e=>e.arrayBuffer());this.cache[e]=await this.pdfDoc.embedFont(n)}return this.cache[e]}{const{StandardFonts:e}=PDFLib;return n?await this.pdfDoc.embedFont(e.HelveticaBold):await this.pdfDoc.embedFont(e.Helvetica)}}}async function u(e,t,r=null){r&&window._pdfCache.markRestricted(r);const c=await a(e),l=await c.getPage(t+1),d=n?.pdfSettings?.scales?.unlock||1.5,w=await s(l,d,0,{fillWhite:!0}),h=o(w.toDataURL("image/png").split(",")[1]),{PDFDocument:u}=PDFLib,m=await u.create(),g=await m.embedPng(h);m.addPage([w.width,w.height]);const[p]=m.getPages();p.drawImage(g,{x:0,y:0,width:w.width,height:w.height});return i(await m.save())}window._pdfCache=new class{constructor(){this.libCache=new Map,this.restrictedFiles=new Set,this.renderingFlags={}}set(e,t){this.libCache.set(e,t)}get(e){return this.libCache.get(e)}has(e){return this.libCache.has(e)}delete(e){this.libCache.delete(e),this.restrictedFiles.delete(e)}clear(){this.libCache.clear(),this.restrictedFiles.clear()}markRestricted(e){this.restrictedFiles.add(e)}isRestricted(e){return this.restrictedFiles.has(e)}clearRestricted(){this.restrictedFiles.clear()}setRendering(e,t){this.renderingFlags[e]=t}isRendering(e){return!!this.renderingFlags[e]}},window._pdfLibCache=window._pdfCache.libCache,window._pdfLibFileRestricted=window._pdfCache.restrictedFiles,window._canvasRendering=window._pdfCache.renderingFlags,window._pdfLibFileIsRestricted=function(e){return window._pdfCache.isRestricted(e)},window._pdfLibCacheClear=function(){return window._pdfCache.clear(),!0},window._pdfLibCacheDelete=function(e){return!!e&&(window._pdfCache.delete(e),!0)},window._pdfLibFileRestrictedClear=function(){return window._pdfCache.clearRestricted(),!0},window.loadConfig=async function(){if(!n){const e=await fetch("/config.json");n=await e.json()}return n},window.loadConfig(),window.embedImageAsPdf=async function(e,t){const{PDFDocument:n}=PDFLib,r=await n.create();let a;const s=o(e);if(t.endsWith(".png"))a=await r.embedPng(s);else if(t.endsWith(".jpg")||t.endsWith(".jpeg"))a=await r.embedJpg(s);else{if(!(t.endsWith(".gif")||t.endsWith(".bmp")||t.endsWith(".webp")||t.endsWith(".svg")))throw new Error("Unsupported image type");{const n=t.endsWith(".gif")?"image/gif":t.endsWith(".bmp")?"image/bmp":t.endsWith(".webp")?"image/webp":t.endsWith(".svg")?"image/svg+xml":"",{pngBase64:i}=await window.convertImageToPngBase64AndSize(e,n);a=await r.embedPng(o(i.split(",")[1]))}}const c=a.scale(1);r.addPage([c.width,c.height]).drawImage(a,{x:0,y:0,width:c.width,height:c.height});return i(await r.save())},window.mergePDFPages=async function(e){const{PDFDocument:t,degrees:n}=PDFLib,o=await t.create();for(let c=0;c<e.length;c++){let i=e[c];const a=r(i.pageData);try{const e=await t.load(a),[r]=await o.copyPages(e,[0]);"object"==typeof i&&i.rotateAngle&&i.rotateAngle%360!=0&&r.setRotation(n(i.rotateAngle)),o.addPage(r)}catch(s){throw console.error(`Error at mergePDFPages index=${c}:`,s),s}}const i=await o.save(),a=new Blob([i],{type:"application/pdf"});return URL.createObjectURL(a)},window.renderFirstPDFPage=async function(e,t){try{const c=r(e);if(c.length<8)throw new Error("Data too short to be valid PDF");const l=String.fromCharCode.apply(null,c.slice(0,8));if(!l.startsWith("%PDF-"))throw new Error(`Invalid PDF header: ${l}`);let w=null,h=!1,u=null;const m=[{stopAtErrors:!1,maxImageSize:5242880,disableFontFace:!0,disableRange:!0,disableStream:!0,verbosity:1},{stopAtErrors:!1,maxImageSize:10485760,disableFontFace:!1,disableRange:!0,disableStream:!1,verbosity:1},{stopAtErrors:!1,verbosity:1}];for(let v=0;v<m.length;v++)try{w=await a(c,{...m[v],password:t||void 0});break}catch(o){if(u=o,o&&"PasswordException"===o.name){h=!0;break}if(v===m.length-1)throw u}if(h||!w)return{thumbnail:"",isPasswordProtected:!0,securityInfo:"パスワード付きPDF"};const g=await w.getPage(1);let p=0;try{"function"==typeof g.getRotation?p=g.getRotation():void 0!==g.rotate&&(p=g.rotate)}catch(i){p=0}p=((Number(p)||0)%360+360)%360;const f=(await s(g,n.pdfSettings.scales.thumbnail,0)).toDataURL("image/png");let y=[];try{const b=await w.getOutline();if(b&&b.length){async function x(e){const t=[];for(const n of e){let e=null;try{let t=n.dest;if("string"==typeof t&&(t=await w.getDestination(t)),Array.isArray(t)&&t.length>0)try{e=await w.getPageIndex(t[0])}catch(i){e=null}}catch(i){}const o={title:n.title||"",pageIndex:e,items:[]};n.items&&n.items.length&&(o.items=await x(n.items)),t.push(o)}return t}y=await x(b)}}catch(i){console.error("pdf: outline extraction failed",i)}return{thumbnail:f,isPasswordProtected:!1,securityInfo:"",bookmarks:y,pageRotation:p}}catch(o){return d(o,"renderFirstPDFPage")}},window.generatePdfThumbnailFromFileMetaData=async function(e,t){try{const o=r(e),i=await a(o),c=await i.getPage(t+1),l=await s(c,n.pdfSettings.scales.thumbnail,0);return{thumbnail:l.toDataURL("image/png"),isError:!1,isPasswordProtected:!1,securityInfo:""}}catch(o){return d(o,"generatePdfThumbnailFromFileMetaData")}},window.convertImageToPngBase64AndSize=function(e,t){return new Promise((n,o)=>{const r=new Image;r.onload=function(){const e=document.createElement("canvas");e.width=r.width||800,e.height=r.height||600;e.getContext("2d").drawImage(r,0,0);const t=e.toDataURL("image/png");n({pngBase64:t,width:r.width,height:r.height})},r.onerror=o,e.startsWith("data:")?r.src=e:r.src=t?`data:${t};base64,${e}`:`data:image/png;base64,${e}`})},window.getPDFPageCount=async function(e){try{const t=r(e);return(await a(t,{stopAtErrors:!1,verbosity:1})).numPages}catch(t){throw console.error("Error in getPDFPageCount:",t),t}},window.createBlankPage=async function(){try{const{PDFDocument:e}=PDFLib,t=await e.create();t.addPage([595.28,841.89]);return i(await t.save())}catch(e){return console.error("Error creating blank page:",e),""}},window.extractPdfPage=async function(e,t,n=null){try{const{PDFDocument:s}=PDFLib,c=r(e);let l=null;if(n&&window._pdfCache.has(n))l=window._pdfCache.get(n);else try{l=await s.load(c),n&&window._pdfCache.set(n,l)}catch(o){return await u(c,t,n)}const d=await s.create();try{if(n&&window._pdfCache.isRestricted(n))throw new Error("file-restricted-precheck");const[e]=await d.copyPages(l,[t]);d.addPage(e)}catch(a){return await u(c,t,n)}return i(await d.save())}catch(s){return console.error(`Error extracting PDF page ${t}:`,s),await window.createBlankPage()}},window.generatePdfThumbnailFromPageData=async function(e){try{const t=o(e),r=await a(t),i=await r.getPage(1);return(await s(i,n.pdfSettings.scales.thumbnail)).toDataURL("image/png")}catch(t){return console.error("Error rendering single PDF page:",t),""}},window.generatePreviewImage=async function(e,t){const r=o(e),i=await a(r),c=await i.getPage(1);return(await s(c,n.pdfSettings.scales.normal,t||0)).toDataURL("image/jpeg",.85)},window.getPdfFileSize=async function(e){const t=await fetch(e);return((await t.blob()).size/1048576).toFixed(2)+"MB"},window.downloadFileFromUrl=function(e,t,n){const o=document.createElement("a");o.href=e,o.download=t,o.type=n||"application/octet-stream",document.body.appendChild(o),o.click(),document.body.removeChild(o)},window.renderPdfPages=async function(e,t){if(!window.pdfjsLib)return void console.error("pdfjsLib is not loaded");const o=await a(await fetch(e).then(e=>e.arrayBuffer()).then(e=>new Uint8Array(e)));for(let r=0;r<t.length;r++){const e=await o.getPage(r+1),i=document.getElementById(t[r]);if(!i)continue;const a=e.getViewport({scale:n.pdfSettings.scales.normal});i.width=a.width,i.height=a.height;const s=i.getContext("2d");await e.render({canvasContext:s,viewport:a}).promise}},window.checkCanvasExists=function(e){return!!document.getElementById(e)},window.renderPdfThumbnailToCanvas=async function(e,t){if(!window.pdfjsLib)throw new Error("pdfjsLib is not loaded.");if(window._pdfCache.isRendering(t))return console.warn("render in progress, skipping:",t),!1;window._pdfCache.setRendering(t,!0);try{const o=await fetch(e),r=await o.arrayBuffer(),i=new Uint8Array(r),s=await a(i),c=await s.getPage(1),l=c.getViewport({scale:n.pdfSettings.scales.thumbnail}),d=document.getElementById(t);if(!d)return console.warn("canvas not found:",t),!1;const w=d.getContext("2d");return d.width=l.width,d.height=l.height,w.clearRect(0,0,d.width,d.height),await c.render({canvasContext:w,viewport:l}).promise,!0}catch(o){return console.error("renderPdfThumbnailToCanvas error",o,e,t),!1}finally{window._pdfCache.setRendering(t,!1)}},window.drawImageToCanvas=function(e,t,n=!0){const o=document.getElementById(e);if(!o)return;const r=o.getContext("2d"),i=new window.Image;i.onload=function(){try{const e=o.getBoundingClientRect(),t=Math.max(1,e.width||o.clientWidth||96),a=Math.max(1,e.height||o.clientHeight||128),s=n&&window.devicePixelRatio||1;o.width=Math.round(t*s),o.height=Math.round(a*s),r.setTransform(s,0,0,s,0,0),r.clearRect(0,0,t,a);const c=Math.min(t/i.width,a/i.height),l=i.width*c,d=i.height*c;r.drawImage(i,(t-l)/2,(a-d)/2,l,d)}catch(e){console.debug("drawImageToCanvas error",e)}},i.onerror=function(e){console.debug("drawImageToCanvas image load error",e,t)},i.src=t},window.unlockPdf=async function(e,t){const o=r(e),c=await a(o,{password:t}),{PDFDocument:l}=PDFLib,d=await l.create();for(let r=1;r<=c.numPages;r++){const e=await c.getPage(r),t=await s(e,n.pdfSettings.scales.unlock,0,{fillWhite:!0}),o=t.toDataURL("image/png"),i=await d.embedPng(o);d.addPage([t.width,t.height]).drawImage(i,{x:0,y:0,width:t.width,height:t.height})}return i(await d.save())},window.editPdfPageWithElements=async function(e,t){const{PDFDocument:n,rgb:r,StandardFonts:a}=PDFLib;if(!PDFLib._fontkitRegistered){if(!window.fontkit)throw new Error("fontkitがロードされていません。");PDFLib.PDFDocument.prototype.registerFontkit(window.fontkit),PDFLib._fontkitRegistered=!0}const s=o(e),l=await n.load(s),d=l.getPage(0),w=d.getHeight();let u=[];try{u=JSON.parse(t)}catch(g){console.error("editJson parse error",g,t)}const m=new h(l);for(const i of u)if(0===i.Type||"Text"===i.Type){let e=function(e,t,n,o){if(!e)return[""];const r=[],i=e.split(/(\s+)/);let a="";for(const s of i){const e=t.widthOfTextAtSize(s,n);if((a?t.widthOfTextAtSize(a,n):0)+e<=o)a+=s;else if(a&&r.push(a),e<=o)a=s;else{let e="";for(let i=0;i<s.length;i++){e+=s[i];t.widthOfTextAtSize(e,n)>o&&(e.length>1?(r.push(e.slice(0,-1)),e=e.slice(-1)):(r.push(e),e=""))}a=e}}return a&&r.push(a),r};const t=await m.getFont(i.Text,{isBold:i.IsBold,isSerif:(i.FontFamily||"").toLowerCase().includes("notoserif")}),n=PDFLib.degrees(i.Rotation||0),o=Number(i.FontSize)||16,r=(void 0!==i.LineHeight&&i.LineHeight>0?Number(i.LineHeight):null)||o,a=i.Text||"",s="number"==typeof i.X?i.X:0,l="number"==typeof i.Width&&i.Width>0?Number(i.Width):d.getWidth()-s,h=a.split("\n"),u=[];for(const i of h){const n=e(i,t,o,l);0===n.length?u.push(""):u.push(...n)}const g=w-(i.Y||0)-o;for(let w=0;w<u.length;w++)d.drawText(u[w]||"",{x:s,y:g-w*r,size:o,font:t,color:c(i.Color||"#000000"),rotate:n})}else if(1===i.Type||"Image"===i.Type)if(i.ImageUrl&&(i.ImageUrl.startsWith("data:image/png")||i.ImageUrl.startsWith("data:image/jpeg"))){let e,t=i.ImageUrl.split(",")[1]||i.ImageUrl;i.ImageUrl.startsWith("data:image/png")?e=await l.embedPng(o(t)):i.ImageUrl.startsWith("data:image/jpeg")&&(e=await l.embedJpg(o(t)));const n=PDFLib.degrees(i.Rotation||0);d.drawImage(e,{x:i.X||0,y:w-(i.Y||0)-(i.Height||e.height),width:i.Width||e.width,height:i.Height||e.height,rotate:n})}else console.warn("未対応画像形式: ",i.ImageUrl?i.ImageUrl.substring(0,30):"");return i(await l.save())},window.addStampsToPdf=async function(e,t){const{PDFDocument:n,rgb:o,StandardFonts:i,degrees:a}=PDFLib;PDFLib._fontkitRegistered||(window.fontkit?(PDFLib.PDFDocument.prototype.registerFontkit(window.fontkit),PDFLib._fontkitRegistered=!0):console.warn("fontkitがロードされていません。日本語フォントは使用できません。"));const s=r(e),c=((t.length>0&&t[0].rotateAngle||0)%360+360)%360,l=await n.load(s),d=l.getPage(0),{width:h,height:u}=d.getSize();let m=null;function g(e,t,n){const o=e+1;if(!n)return o.toString();const r=t.toString().length;return o.toString().padStart(r,"0")}function p(e,t,n,o,r,i,a,s){let c=0,l=0,d=0;const w=(o%360+360)%360;if(0===w){switch(e){case"TopLeft":c=t,l=i-n-s;break;case"Top":c=r/2-a/2,l=i-n-s;break;case"TopRight":c=r-t-a,l=i-n-s;break;case"BottomLeft":c=t,l=n;break;case"Bottom":c=r/2-a/2,l=n;break;case"BottomRight":c=r-t-a,l=n}d=0}else if(90===w){switch(e){case"TopLeft":c=n,l=t;break;case"Top":c=n,l=i/2-a/2;break;case"TopRight":c=n,l=i-t-a;break;case"BottomLeft":c=r-n,l=t;break;case"Bottom":c=r-n,l=i/2-a/2;break;case"BottomRight":c=r-n,l=i-t-a}d=90}else if(180===w){switch(e){case"TopLeft":c=r-t,l=n;break;case"Top":c=r/2-a/2,l=n;break;case"TopRight":c=t+a,l=n;break;case"BottomLeft":c=r-t,l=i-n;break;case"Bottom":c=r/2-a/2,l=i-n;break;case"BottomRight":c=t+a,l=i-n}d=180}else if(270===w){switch(e){case"TopLeft":c=r-n,l=i-t;break;case"Top":c=r-n,l=i/2-a/2;break;case"TopRight":c=r-n,l=t+a;break;case"BottomLeft":c=n,l=i-t;break;case"Bottom":c=n,l=i/2-a/2;break;case"BottomRight":c=n,l=t+a}d=-90}return{x:c,y:l,textRotation:d}}for(const r of t){let e,t=r.text||"";if(r.isSerial){const e=g(r.currentPageIndex||0,r.totalPages||1,r.isZeroPadded||!1);t=t?`${t}${e}`:e}if(w(t)){if(!m)try{const e="/fonts/NotoSansJP-Regular.ttf",t=await fetch(e).then(e=>e.arrayBuffer());m=await l.embedFont(t)}catch(f){console.warn("日本語フォント読み込み失敗:",f),e=await l.embedFont(i.Helvetica)}e=m||await l.embedFont(i.Helvetica)}else e=await l.embedFont(i.Helvetica);const n=r.fontSize||12,s=e.widthOfTextAtSize(t,n),v=p(r.corner,r.offsetX,r.offsetY,c,h,u,s,n),b=r.color?o(r.color.r||0,r.color.g||0,r.color.b||0):o(0,0,0);try{d.drawText(t,{x:v.x,y:v.y,size:n,font:e,color:b,rotate:a(v.textRotation)})}catch(y){throw console.error("スタンプ描画エラー:",y),y}}return await l.save()},window.cropPdfPageRasterized=async function(e,t,r,s,c,d=0){try{const w=o(e),h=await a(w),u=await h.getPage(1),m=u.getViewport({scale:1,rotation:0}),g=m.width,p=m.height,f=l(d),y=n?.pdfSettings?.scales?.unlock||1.5,v=Math.max(0,Math.min(1,Number(t)||0)),b=Math.max(0,Math.min(1,Number(r)||0)),x=Math.max(0,Math.min(1,Number(s)||0)),R=Math.max(0,Math.min(1,Number(c)||0)),P=v*g,M=p*(1-b-R),A=P+x*g,S=M+R*p,E=u.getViewport({scale:y,rotation:f}),C=document.createElement("canvas");C.width=Math.max(1,Math.round(E.width)),C.height=Math.max(1,Math.round(E.height));const L=C.getContext("2d",{alpha:!1});await u.render({canvasContext:L,viewport:E}).promise;const F=C.width/g,T=C.height/p,_=Math.round(P*F),D=Math.round((p-S)*T),I=Math.max(1,Math.round((A-P)*F)),z=Math.max(1,Math.round((S-M)*T)),k=document.createElement("canvas");k.width=I,k.height=z;k.getContext("2d",{alpha:!1}).drawImage(C,_,D,I,z,0,0,I,z);const B=k.toDataURL("image/png"),W=o(B.split(",")[1]),{PDFDocument:H}=PDFLib,N=await H.create(),O=await N.embedPng(W);N.addPage([I,z]).drawImage(O,{x:0,y:0,width:I,height:z});return i(await N.save())}catch(w){return console.error("cropPdfPageRasterized error",w),e||""}},window.cropPdfPageToTrimVector=async function(e,t,n,r,a,s=0){try{const c=o(e),{PDFDocument:d,PDFName:w}=PDFLib,h=await d.load(c),u=h.getPages()[0],m=u.getWidth(),g=u.getHeight(),p=Math.max(0,Math.min(1,Number(t)||0)),f=Math.max(0,Math.min(1,Number(n)||0)),y=Math.max(0,Math.min(1,Number(r)||0)),v=Math.max(0,Math.min(1,Number(a)||0)),b=l(s);let x,R,P,M;if(0===b)x=p*m,R=g*(1-f-v),P=x+y*m,M=R+v*g;else{let e=function(e,t){const n=e-s,o=c-t;return{x:n*h-o*u+l,y:n*u+o*h+d}};const t=b%180==0?m:g,n=b%180==0?g:m,o=p*t,r=f*n,i=Math.max(1,y*t),a=Math.max(1,v*n),s=t/2,c=n/2,l=m/2,d=g/2,w=-b*Math.PI/180,h=Math.cos(w),u=Math.sin(w),A=e(o,r),S=e(o+i,r),E=e(o,r+a),C=e(o+i,r+a),L=[A.x,S.x,E.x,C.x],F=[A.y,S.y,E.y,C.y];x=Math.min(...L),R=Math.min(...F),P=Math.max(...L),M=Math.max(...F)}const A=Math.max(0,Math.min(m,Math.round(x))),S=Math.max(0,Math.min(g,Math.round(R))),E=Math.max(0,Math.min(m,Math.round(P))),C=Math.max(0,Math.min(g,Math.round(M))),L=await d.create(),[F]=await L.copyPages(h,[0]);L.addPage(F),F.node.set(w.of("CropBox"),L.context.obj([A,S,E,C]));return i(await L.save())}catch(c){return console.error("cropPdfPageToTrimVector error",c),e||""}},window.getImageSizeFromDataUrl=function(e){return new Promise(t=>{try{if(!e)return void t([0,0]);const n=new Image;n.onload=function(){t([n.naturalWidth||0,n.naturalHeight||0])},n.onerror=function(){t([0,0])},n.src=e,setTimeout(()=>{n.complete||t([0,0])},2e3)}catch(n){t([0,0])}})},window.cropPdfPageToImage=async function(e,t,n,r,i,s=0,c=150){try{const d=o(e),w=await a(d),h=await w.getPage(1),u=h.getViewport({scale:1,rotation:0}),m=u.width,g=u.height,p=l(s),f=c/72,y=Math.max(0,Math.min(1,Number(t)||0)),v=Math.max(0,Math.min(1,Number(n)||0)),b=Math.max(0,Math.min(1,Number(r)||0)),x=Math.max(0,Math.min(1,Number(i)||0)),R=y*m,P=g*(1-v-x),M=R+b*m,A=P+x*g,S=h.getViewport({scale:f,rotation:p}),E=document.createElement("canvas");E.width=Math.max(1,Math.round(S.width)),E.height=Math.max(1,Math.round(S.height));const C=E.getContext("2d",{alpha:!1});C.fillStyle="#FFFFFF",C.fillRect(0,0,E.width,E.height),await h.render({canvasContext:C,viewport:S}).promise;const L=E.width/m,F=E.height/g,T=Math.round(R*L),_=Math.round((g-A)*F),D=Math.max(1,Math.round((M-R)*L)),I=Math.max(1,Math.round((A-P)*F)),z=document.createElement("canvas");z.width=D,z.height=I;const k=z.getContext("2d",{alpha:!1});return k.fillStyle="#FFFFFF",k.fillRect(0,0,D,I),k.drawImage(E,T,_,D,I,0,0,D,I),z.toDataURL("image/png")}catch(d){throw console.error("cropPdfPageToImage error:",d),d}},window.scrollToSection=function(e){e&&e.scrollIntoView({behavior:"smooth"})};let m=null;function g(){try{if(window._trimShared&&window._trimShared.resizeHandler)return;const e=function(){try{window._trimShared.timer&&clearTimeout(window._trimShared.timer),window._trimShared.timer=setTimeout(()=>{try{Object.keys(window._simpleTrim||{}).forEach(e=>{try{const n=(window._simpleTrim||{})[e];if(n&&n.internal&&"function"==typeof n.internal.onAnyScrollOrResize)try{n.internal.onAnyScrollOrResize()}catch(t){}else if(n&&n.internal&&"function"==typeof n.internal.resize)try{n.internal.resize()}catch(t){}}catch(t){}});try{if(window._trimResize&&"function"==typeof window._trimResize.windowResizeCallback)try{window._trimResize.windowResizeCallback()}catch(e){}}catch(e){}}catch(e){}},window._trimShared.debounceMs)}catch(e){}};window._trimShared.resizeHandler=e,window.addEventListener("resize",e,{passive:!0}),window.visualViewport&&window.visualViewport.addEventListener&&(window.visualViewport.addEventListener("resize",e,{passive:!0}),window.visualViewport.addEventListener("scroll",e,{passive:!0}))}catch(e){console.error("ensureSharedTrimResizeHandler error",e)}}function p(e,t){let n=0,o=0,r=e;for(;r&&r!==t&&r!==document.body;)n+=r.offsetLeft||0,o+=r.offsetTop||0,r=r.offsetParent;return{x:n,y:o}}window.isSorting=!1,window.initializeSortable=function(){function e(){return document.getElementById("sortable-container")}function t(){const t=e();t&&(t.classList.remove("is-sorting","dragging-chosen","dragging-ghost"),t.querySelectorAll(".dragging-chosen, .dragging-ghost").forEach(e=>{e.classList.remove("dragging-chosen","dragging-ghost")})),window.isSorting=!1}window.removeEventListener("mouseup",t),window.removeEventListener("touchend",t);const n=e();n&&"none"!==window.getComputedStyle(n).display&&window.Sortable?(m&&(m.destroy(),m=null,n.classList.remove("is-sorting"),window.isSorting=!1),window.addEventListener("mouseup",t),window.addEventListener("touchend",t),m=new Sortable(n,{draggable:".sortable-item-container",handle:window.matchMedia("(min-width: 768px)").matches?".drag-handle":".touch-drag-handle",filter:".non-sortable",animation:150,ghostClass:"dragging-ghost",chosenClass:"dragging-chosen",onStart:function(e){n.classList.add("is-sorting"),window.isSorting=!0},onMove:function(e){const t=e.related,o=e.dragged;if(t&&t.classList.contains("non-sortable")){const e=t,r=e.previousElementSibling;return r&&r.classList.contains("sortable-chosen"),n.insertBefore(o,e),!1}if(t&&t.closest(".non-sortable")){const e=t.closest(".non-sortable");return n.insertBefore(o,e),!1}if(!t||t===n){const e=n.querySelector(".non-sortable");return e&&n.insertBefore(o,e),!1}return!0},onEnd:function(e){t();const o=n.querySelectorAll(".sortable-item-container:not(.non-sortable)").length;let r=e.newIndex;e.newIndex>=o&&(r=o-1),DotNet.invokeMethodAsync("NoCloudPdf","UpdateOrder",getPageType(),e.oldIndex,r)}})):m&&m.el&&(m.destroy(),m=null,t())},function(){const e="ncp_tour_ran",t="home-intro-v1";function n(){const e=["undefined"!=typeof window&&window.innerWidth<768?{id:"nav-explain",selector:"#nav-hamburger",title:"メニュー表示",text:"機能の切替メニューを表示できます。すぐに利用される方はこちらから。",position:"right",group:t}:{id:"nav-explain",selector:"#nav-main",title:"切替メニュー",text:"機能の切替メニューです。すぐに利用される方は，目的の機能をクリックしてください。",position:"right",group:t},{id:"home-tip",selector:"#home-summary-tip",title:"概要",text:"このページ下部にアプリの概要があります。",position:"top",group:t}];try{const n=document.querySelector("#install-pwa-btn");n&&function(e){try{if(!e)return!1;const t=window.getComputedStyle(e);return t&&"none"!==t.display}catch(t){return!1}}(n)&&e.push({id:"install-pwa",selector:"#install-pwa-btn",title:"インストール",text:"アプリのショートカットを作成できます。",position:"left",group:t})}catch(n){console.debug("tour: check install-pwa failed",n)}return e}function o(){try{const e=document.getElementById("ncp-tour-dontshow");e&&e.checked&&setEnabled(!1)}catch(e){}}async function r(){try{await function(e="#install-pwa-btn-flag",t=1e3,n=100){return new Promise(o=>{const r=Date.now(),i=()=>{try{const t=document.querySelector(e);if(t){const e=(t.value||"").toString().toLowerCase();if("true"===e)return o(!0);if("false"===e)return o(!1)}}catch(a){}if(Date.now()-r>=t)return o(!1);setTimeout(i,n)};i()})}("#install-pwa-btn-flag",1e3,100)}catch(a){}const r=n();!function(){try{document.querySelectorAll(".tg-backdrop, .tg-dialog").forEach(e=>{try{e.remove()}catch(a){}})}catch(a){}window._ncpTour&&(window._ncpTour.client=null)}();const i=window.tourguide?.TourGuideClient||window.TourGuideClient||window.tourguide||null;if("function"==typeof i||i&&"object"==typeof i)try{const n=r.map((e,t)=>{const n=document.querySelector(e.selector);return{title:e.title||"",content:e.text||"",target:n||e.selector,order:e.order??t+1,group:e.group??void 0}}),i={nextLabel:"次へ",prevLabel:"戻る",finishLabel:"終了",onAfterExit:o,completeOnFinish:!0},s=new tourguide.TourGuideClient({steps:n,...i});if(s){s.onFinish(async()=>{o()}),s.isFinished(t)||s.start(t);try{!function(){try{sessionStorage.setItem(e,"true")}catch(a){}}()}catch(a){}}return!0}catch(a){console.debug("tour: TourGuideClient init failed",a)}return console.debug("tour: no compatible start method found"),!1}window.startTourIfNeeded=async function(n={}){if((new tourguide.TourGuideClient).isFinished(t))return;if(!function(){const e=(document.querySelector("base")?.getAttribute("href")||"/").replace(/\/$/,""),t=location.pathname.replace(new RegExp("^"+e),"")||"/";return"/"===t||""===t}())return;if(function(){try{return"true"===sessionStorage.getItem(e)}catch(t){return!1}}())return;await r()},window._ncpTour={startTourIfNeeded:window.startTourIfNeeded}}(),window.registerPanelResize=function(e,t,n=1500){function o(e){try{const n=document.getElementById("loading-indicator");if(!n)return;try{n.__fadeTimeout&&(clearTimeout(n.__fadeTimeout),n.__fadeTimeout=null)}catch(t){}const o=220;if(n.style.transition&&-1!==n.style.transition.indexOf("opacity")||(n.style.transition=`opacity ${o}ms ease`),e)n.style.display="flex",n.style.opacity=n.style.opacity?n.style.opacity:"0",requestAnimationFrame(()=>{try{n.style.opacity="1"}catch(t){}});else{if("none"===getComputedStyle(n).display)return;requestAnimationFrame(()=>{try{n.style.opacity="0"}catch(t){}}),n.__fadeTimeout=setTimeout(()=>{try{n.style.display="none",n.style.opacity="0"}catch(t){}n.__fadeTimeout=null},o+20)}}catch(t){}}try{let i=function(){const e=window.innerWidth||document.documentElement.clientWidth,t=e<768,n=document.querySelector(".sidebar"),o=n&&!t?Math.round(n.getBoundingClientRect().width):0;return{vw:e,sidebarW:o,isMobileHeaderSidebar:t,avail:Math.max(0,e-o)}},a=function(e){return e.sidebarW||0},s=function(e){y=e;const t=Date.now();if(!p||t-p>=g){if(p=t,window._trimResize&&window._trimResize.dotNetRef&&window._trimResize.dotNetRef.invokeMethodAsync)try{window._trimResize.dotNetRef.invokeMethodAsync("OnPanelMouseMove",e).catch(()=>{})}catch(n){}}else{const e=g-(t-p);f&&clearTimeout(f),f=setTimeout(()=>{if(p=Date.now(),window._trimResize&&window._trimResize.dotNetRef&&window._trimResize.dotNetRef.invokeMethodAsync)try{window._trimResize.dotNetRef.invokeMethodAsync("OnPanelMouseMove",y).catch(()=>{})}catch(n){}f=null,y=null},e)}},c=function(e){try{const n=i().avail,o=l.getBoundingClientRect().width||8,r=Math.max(w,Math.round(n-h-o));let a=Math.max(w,Math.min(r,Math.round(e)));a=Math.min(a,r);const s=Math.max(h,Math.round(n-a-o));d&&(d.style.setProperty("--thumbnail-width",a+"px"),d.style.width=a+"px",d.style.flex=`0 0 ${a}px`);const c=document.getElementById("split-container"),u=c?c.querySelector(":scope > .flex-1"):l.nextElementSibling||null;u&&(u.style.width=s+"px",u.style.flex="0 0 auto",u.style.minWidth="0",u.style.maxWidth=s+"px"),c&&c.offsetHeight;try{window._trimResize&&window._trimResize.updateAllTrimOverlays&&window._trimResize.updateAllTrimOverlays()}catch(t){}window._trimResize.lastAppliedLeft=a,window._trimResize.lastAvail=n}catch(t){console.error("applyWidthsUsingAvail error",t)}};if(window._trimResize&&window._trimResize.cleanupForHandle){try{window._trimResize.cleanupForHandle()}catch(r){}window._trimResize.cleanupForHandle=null}window._trimResize.dotNetRef=e;const l=document.getElementById(t),d=document.getElementById("thumbnail-area");if(!l)return void console.warn("registerPanelResize: handle element not found:",t);const w=150,h=260;let u=!1,m=0;const g=Number(n)||500;let p=0,f=null,y=null;const v=function(e){try{try{o(!0)}catch(t){}try{window._trimResize.suspendFitZoom=!0}catch(t){}l.setPointerCapture?.(e.pointerId);const n=function(e){m=e.clientX,u||(u=!0,requestAnimationFrame(function(){u=!1;try{const e=i(),t=a(e),n=Math.round(m-t);c(n),s(m)}catch(e){console.error("onPointerMove error",e)}}))},r=function(e){try{if(l.releasePointerCapture?.(e.pointerId),f&&(clearTimeout(f),f=null),null!=y&&window._trimResize&&window._trimResize.dotNetRef&&window._trimResize.dotNetRef.invokeMethodAsync){try{window._trimResize.dotNetRef.invokeMethodAsync("OnPanelMouseMove",y).catch(()=>{})}catch(s){}y=null}const t=i(),n=a(t),o=l.getBoundingClientRect().width||8,r=t.avail,d=Math.max(w,Math.round(r-h-o)),u=Math.round(e.clientX-n),m=Math.max(w,Math.min(d,u));if(window._trimResize&&window._trimResize.dotNetRef&&window._trimResize.dotNetRef.invokeMethodAsync)try{window._trimResize.dotNetRef.invokeMethodAsync("CommitPanelWidth",m).catch(()=>{})}catch(s){}c(m),requestAnimationFrame(function(){window._trimResize&&window._trimResize.updateAllTrimOverlays&&window._trimResize.updateAllTrimOverlays()})}catch(d){console.error("onPointerUp error",d)}finally{try{window._trimResize.suspendFitZoom=!1}catch(t){}try{o(!1)}catch(s){}l.removeEventListener("pointermove",n),l.removeEventListener("pointerup",r)}};l.addEventListener("pointermove",n),l.addEventListener("pointerup",r)}catch(n){console.error("onPointerDown error",n)}};l.addEventListener("pointerdown",v),window._trimResize.cleanupForHandle=function(){try{l.removeEventListener("pointerdown",v)}catch(r){}window._trimResize.dotNetRef=null}}catch(r){console.error("registerPanelResize error",r)}},window.unregisterPanelResize=function(){try{window._trimResize.cleanupForHandle&&(window._trimResize.cleanupForHandle(),window._trimResize.cleanupForHandle=null),window._trimResize.dotNetRef=null}catch(e){console.error("unregisterPanelResize error",e)}},window._trimResize=window._trimResize||{dotNetRef:null,cleanupForHandle:null,windowResizeDotNetRef:null,windowResizeCallback:null,updateAllTrimOverlays:null,lastAppliedLeft:null,lastAvail:null,suspendFitZoom:!1},window.trimPreviewArea={dotNetRef:null,handlers:null,initialize:function(e){try{this.unregister&&this.unregister(),this.dotNetRef=e;const t=e=>{try{this.dotNetRef&&this.dotNetRef.invokeMethodAsync("OnPanelMouseMove",e.clientX).catch(()=>{})}catch(t){}},n=e=>{try{this.dotNetRef&&this.dotNetRef.invokeMethodAsync("OnPanelMouseUp").catch(()=>{})}catch(t){}};this.handlers={onMouseMove:t,onMouseUp:n},document.addEventListener("mousemove",t,{passive:!0}),document.addEventListener("mouseup",n,{passive:!0})}catch(t){console.error("trimPreviewArea.initialize error",t)}},unregister:function(){try{this.handlers&&(document.removeEventListener("mousemove",this.handlers.onMouseMove),document.removeEventListener("mouseup",this.handlers.onMouseUp),this.handlers=null),this.dotNetRef=null}catch(e){console.error("trimPreviewArea.unregister error",e)}},getImageDimensions:function(e){const t=document.getElementById(e);return t?[t.offsetWidth,t.offsetHeight]:[0,0]},scrollToPage:function(e){const t=document.getElementById(`preview-container-${e}`);t&&t.scrollIntoView({behavior:"smooth",block:"start"})}},window.getAvailableWidth=function(){try{const e=document.querySelector(".sidebar"),t=window.innerWidth||document.documentElement.clientWidth,n=e?Math.round(e.getBoundingClientRect().width):0;return{avail:Math.max(0,t-n),sidebarW:n,vw:t}}catch(e){return{avail:window.innerWidth||document.documentElement.clientWidth,sidebarW:0,vw:window.innerWidth||document.documentElement.clientWidth}}},window.applyThumbnailWidth=function(e){try{const t=document.getElementById("thumbnail-area"),n=document.getElementById("splitter-handle");if(!t)return;n&&n.getBoundingClientRect().width;return t.style.setProperty("--thumbnail-width",Math.round(e)+"px"),t.style.width=Math.round(e)+"px",!0}catch(t){return console.error("applyThumbnailWidth error",t),!1}},window.registerWindowResize=function(e,t=500){try{let t=function(){try{const t=window.innerWidth||document.documentElement.clientWidth,n=t<768,o=document.querySelector(".sidebar"),r=o&&!n?Math.round(o.getBoundingClientRect().width):0,i=Math.max(0,t-r);try{const t=200,n=600,o=260,a=document.getElementById("splitter-handle"),s=a&&a.getBoundingClientRect().width||8;let c=Math.round(.25*i);c=Math.max(t,Math.min(n,c)),c=Math.min(c,Math.max(t,Math.round(i-o-s)));const l=Math.max(0,Math.round(i-c-s)),d=document.getElementById("thumbnail-area");d&&(d.style.setProperty("--thumbnail-width",c+"px"),d.style.width=c+"px",d.style.flex=`0 0 ${c}px`);const w=document.getElementById("split-container"),h=w?w.querySelector(":scope > .flex-1"):document.getElementById("trim-preview-container")?.closest(".flex-1")||null;if(h&&(h.style.width="",h.style.flex="1 1 0%",h.style.minWidth="0",h.style.maxWidth=l+"px"),window._trimResize&&window._trimResize.windowResizeDotNetRef)try{window._trimResize.windowResizeDotNetRef.invokeMethodAsync("OnWindowResizedFromJs",i,r).catch(()=>{})}catch(e){}try{w&&w.offsetHeight}catch(e){}if(window._trimResize?.updateAllTrimOverlays)try{window._trimResize.updateAllTrimOverlays()}catch(e){console.error(e)}try{"function"==typeof window.computeAndApplyFitZoom&&window.computeAndApplyFitZoom()}catch(e){}}catch(e){console.error("measureAndNotify inner error",e)}}catch(e){console.error("measureAndNotify error",e)}};if(!e)return;window._trimResize.windowResizeCallback=null,window._trimResize.windowResizeDotNetRef=e,window._trimResize.windowResizeCallback=t,g();try{t()}catch(n){}window._trimResize.unregisterWindowResize=function(){try{window._trimResize&&(window._trimResize.windowResizeCallback=null,window._trimResize.windowResizeDotNetRef=null)}catch(n){}}}catch(n){console.error("registerWindowResize error",n)}},window.unregisterWindowResize=function(){try{window._trimResize&&window._trimResize.unregisterWindowResize&&(window._trimResize.unregisterWindowResize(),window._trimResize.unregisterWindowResize=null)}catch(e){console.error("unregisterWindowResize error",e)}},window._trimShared=window._trimShared||{resizeHandler:null,timer:null,debounceMs:120},window.setPreviewZoom=function(e,t="contain"){try{e=Math.max(.25,Math.min(3,Number(e)||1));const t=document.querySelector(".preview-zoom-viewport"),n=document.getElementById("preview-zoom-inner");if(!n||!t)return;const o=window._previewZoomState&&window._previewZoomState.lastZoom?window._previewZoomState.lastZoom:1,r=t.getBoundingClientRect(),i=n.getBoundingClientRect(),a=r.left+r.width/2,s=r.top+r.height/2,c=a-i.left,l=s-i.top,d=c/o,w=l/o;n.style.setProperty("--preview-zoom",String(e)),n.style.transform=`scale(${e})`,n.style.transformOrigin="0 0";const h=r.width,u=r.height,m=(n.scrollWidth||i.width)*e,g=(n.scrollHeight||i.height)*e;let p=d*e-h/2,f=w*e-u/2;p=Math.max(0,Math.min(m-h,p)),f=Math.max(0,Math.min(g-u,f)),t.scrollLeft=Math.round(p),t.scrollTop=Math.round(f),window._previewZoomState=window._previewZoomState||{},window._previewZoomState.lastZoom=e}catch(n){console.error("setPreviewZoom error",n)}},window.computeAndApplyFitZoom=function(){try{const e=document.getElementById("trim-preview-container"),t=document.getElementById("preview-zoom-inner");if(!e||!t)return;const n=e.clientWidth||1,o=window._previewZoomState&&window._previewZoomState.lastZoom?window._previewZoomState.lastZoom:1;let r=0;const i=t.querySelectorAll("canvas");if(i&&i.length>0&&i.forEach((e,t)=>{try{const t=(e.getBoundingClientRect().width||e.clientWidth||0)/o;t>r&&(r=t)}catch(n){console.warn("computeAndApplyFitZoom: canvas measurement error",n)}}),r<=0){const e=t.getBoundingClientRect();r=(t.scrollWidth||e.width||t.clientWidth||1)/o}(!r||r<=0)&&(r=1);const a=n/r,s=Math.max(.25,Math.min(3,a));"function"==typeof window.setPreviewZoom&&window.setPreviewZoom(s)}catch(e){console.error("computeAndApplyFitZoom error",e)}},window.setPreviewPanEnabled=function(e){try{const n=document.querySelector(".preview-zoom-viewport");if(!n)return;if(window._previewPan.handlers){try{const e=window._previewPan.handlers;n.removeEventListener("pointerdown",e.down),n.removeEventListener("pointermove",e.move),n.removeEventListener("pointerup",e.up),n.removeEventListener("pointercancel",e.up)}catch(t){}window._previewPan.handlers=null,window._previewPan.state=null,n.classList.remove("pan-active"),n.style.touchAction=""}if(!e)return window._previewPan.enabled=!1,void(n.style.cursor="");window._previewPan.enabled=!0,n.style.touchAction="none",n.classList.add("pan-active");const o={active:!1,startX:0,startY:0,scrollLeft:0,scrollTop:0,pointerId:null};window._previewPan.state=o;const r=function(e){try{if(0!==e.button)return;o.active=!0,o.pointerId=e.pointerId,o.startX=e.clientX,o.startY=e.clientY,o.scrollLeft=n.scrollLeft,o.scrollTop=n.scrollTop,n.setPointerCapture&&n.setPointerCapture(e.pointerId),n.classList.add("panning")}catch(t){console.error("pan down error",t)}},i=function(e){try{if(!o.active||o.pointerId!==e.pointerId)return;const t=e.clientX-o.startX,r=e.clientY-o.startY;n.scrollLeft=o.scrollLeft-t,n.scrollTop=o.scrollTop-r}catch(t){}},a=function(e){try{if(o.active&&o.pointerId===e.pointerId){o.active=!1;try{n.releasePointerCapture&&n.releasePointerCapture(e.pointerId)}catch{}n.classList.remove("panning")}}catch(t){}};n.addEventListener("pointerdown",r),n.addEventListener("pointermove",i),n.addEventListener("pointerup",a),n.addEventListener("pointercancel",a),window._previewPan.handlers={down:r,move:i,up:a}}catch(t){console.error("setPreviewPanEnabled error",t)}},window.setPreviewInteractionMode=function(e){try{return"pan"===(e=(e||"").toString().toLowerCase())?window.setPreviewPanEnabled(!0):window.setPreviewPanEnabled(!1),!0}catch(t){return console.error(t),!1}},window._previewPan=window._previewPan||{enabled:!1,handlers:null,state:null},window.waitForCanvasReady=async function(e,t=120){try{if(!e)return!1;const n=performance.now(),o=document.getElementById(e);if(!o)return!1;const r=o.clientWidth,i=o.clientHeight;if(r>0&&i>0){await new Promise(e=>requestAnimationFrame(e));const e=o.clientWidth,t=o.clientHeight;if(r===e&&i===t)return!0}for(;performance.now()-n<(t||120);){await new Promise(e=>requestAnimationFrame(e));const e=o.clientWidth,t=o.clientHeight;if(e>0&&t>0){await new Promise(e=>requestAnimationFrame(e));const n=o.clientWidth,r=o.clientHeight;if(e===n&&t===r)return!0}}return!1}catch(n){return console.error("waitForCanvasReady error",n),!1}},window.drawTrimOverlayAsSvg=function(e,t){try{let n=function(t){try{if(m.allowMultipleRects){t>=0&&t<m.currentRectsPx.length&&m.currentRectsPx.splice(t,1),m.selectedRectIndex=-1;const n=Math.max(1,Math.round(o.clientWidth||1)),r=Math.max(1,Math.round(o.clientHeight||1)),i=(m.currentRectsPx||[]).map(e=>({X:e.x/n,Y:e.y/r,Width:e.w/n,Height:e.h/r}));window.drawTrimOverlayAsSvg&&window.drawTrimOverlayAsSvg(e,i),m.dotNetRef?.invokeMethodAsync&&m.dotNetRef.invokeMethodAsync("CommitMultipleRectsFromJs",i).catch(()=>{})}else m.selected=!1,m.currentRectPx=null,m.currentRectsPx=[],m.dotNetRef?.invokeMethodAsync&&m.dotNetRef.invokeMethodAsync("ClearTrimRectFromJs").catch(()=>{}),window.drawTrimOverlayAsSvg&&window.drawTrimOverlayAsSvg(e,[])}catch(n){console.error("removeRectAt error",n)}};if(!e)return!1;const o=document.getElementById(e);if(!o)return!1;const r=o.parentElement||o.closest(".tp-preview-page")||o.closest(".preview-zoom-inner")||document.body,i=e+"-overlay-svg";let a=document.getElementById(i);a||(a=document.createElement("div"),a.id=i,a.style.position="absolute",a.style.left="0px",a.style.top="0px",a.style.pointerEvents="none",a.style.zIndex="45",r.appendChild(a));const s=o.getBoundingClientRect(),c=p(o,r),l=Math.round(c.x),d=Math.round(c.y),w=Math.max(1,Math.round(o.clientWidth||s.width||0)),h=Math.max(1,Math.round(o.clientHeight||s.height||0));a.style.left=l+"px",a.style.top=d+"px",a.style.width=w+"px",a.style.height=h+"px";let u=a.querySelector("svg");for(u||(u=document.createElementNS("http://www.w3.org/2000/svg","svg"),u.setAttribute("width","100%"),u.setAttribute("height","100%"),u.setAttribute("viewBox",`0 0 ${w} ${h}`),u.setAttribute("preserveAspectRatio","none"),u.style.pointerEvents="none",a.appendChild(u));u.firstChild;)u.removeChild(u.firstChild);window._simpleTrim=window._simpleTrim||{},window._simpleTrim[e]||(window._simpleTrim[e]={});const m=window._simpleTrim[e];if(!Array.isArray(t)||0===t.length)return m.overlayDom=a,m.currentRectPx=null,m.currentRectsPx=[],a.style.pointerEvents="none",u.style.pointerEvents="none",!0;if(a.style.pointerEvents="auto",u.style.pointerEvents="auto",t.forEach((e,t)=>{const o=Number(e.X??e.x??0),r=Number(e.Y??e.y??0),i=Number(e.Width??e.width??0),a=Number(e.Height??e.height??0),s=Math.round(o*w),c=Math.round(r*h),l=Math.round(i*w),d=Math.round(a*h),g=document.createElementNS("http://www.w3.org/2000/svg","g");g.setAttribute("data-rect-index",String(t));const p=document.createElementNS("http://www.w3.org/2000/svg","rect");p.setAttribute("x","0"),p.setAttribute("y","0"),p.setAttribute("width",String(w)),p.setAttribute("height",String(h)),p.setAttribute("fill","transparent"),p.style.pointerEvents="none",g.appendChild(p);const f=document.createElementNS("http://www.w3.org/2000/svg","rect");f.setAttribute("x",String(s)),f.setAttribute("y",String(c)),f.setAttribute("width",String(Math.max(0,l))),f.setAttribute("height",String(Math.max(0,d))),f.setAttribute("fill","rgba(59,130,246,0.12)");const y=m.allowMultipleRects?m.selectedRectIndex===t:Boolean(m.selected);if(f.setAttribute("stroke",y?"rgba(37,99,235,1)":"rgba(59,130,246,0.95)"),f.setAttribute("stroke-width",y?"3":"2"),f.setAttribute("data-rect","true"),f.setAttribute("data-rect-index",String(t)),f.style.pointerEvents="auto",g.appendChild(f),y){const e=12,o=Math.round(e/2),r=["nw","n","ne","e","se","s","sw","w"],i={nw:"nwse-resize",se:"nwse-resize",ne:"nesw-resize",sw:"nesw-resize",n:"ns-resize",s:"ns-resize",e:"ew-resize",w:"ew-resize"};[[s,c],[s+l/2,c],[s+l,c],[s+l,c+d/2],[s+l,c+d],[s+l/2,c+d],[s,c+d],[s,c+d/2]].forEach(([n,a],s)=>{const c=document.createElementNS("http://www.w3.org/2000/svg","rect");c.setAttribute("x",String(Math.round(n-o))),c.setAttribute("y",String(Math.round(a-o))),c.setAttribute("width",String(e)),c.setAttribute("height",String(e)),c.setAttribute("fill","rgba(59,130,246,0.95)"),c.setAttribute("data-handle",String(s)),c.setAttribute("data-rect-index",String(t)),c.style.pointerEvents="auto",c.style.cursor=i[r[s]]||"default",g.appendChild(c)});let a=s+l+10,u=c-10;a=Math.min(w-12,Math.max(12,a)),u=Math.min(h-12,Math.max(12,u));const m=document.createElementNS("http://www.w3.org/2000/svg","g");m.style.pointerEvents="auto";const p=document.createElementNS("http://www.w3.org/2000/svg","circle");p.setAttribute("cx",String(a)),p.setAttribute("cy",String(u)),p.setAttribute("r","10"),p.setAttribute("fill","rgba(0,0,0,0.6)"),p.setAttribute("data-close","true"),p.setAttribute("data-rect-index",String(t)),p.style.cursor="pointer",m.appendChild(p);const f=document.createElementNS("http://www.w3.org/2000/svg","text");f.setAttribute("x",String(a)),f.setAttribute("y",String(u+4)),f.setAttribute("fill","#fff"),f.setAttribute("font-size","12"),f.setAttribute("text-anchor","middle"),f.setAttribute("data-close","true"),f.setAttribute("data-rect-index",String(t)),f.style.pointerEvents="none",f.textContent="×",m.appendChild(f),m.addEventListener("pointerdown",function(e){try{e.stopPropagation(),n(t)}catch(o){console.error(o)}},{passive:!1}),g.appendChild(m)}u.appendChild(g)}),m.active||(m.overlayDom=a,m.currentRectsPx=t.map(e=>({x:Number(e.X??e.x??0)*w,y:Number(e.Y??e.y??0)*h,w:Number(e.Width??e.width??0)*w,h:Number(e.Height??e.height??0)*h})),m.currentRectPx=m.currentRectsPx.length>0?{...m.currentRectsPx[m.currentRectsPx.length-1]}:null),m.internal||(m.internal={}),m.internal.keydown||(m.internal.keydown=function(e){"Delete"!==e.key&&"Del"!==e.key||(m.allowMultipleRects&&m.selectedRectIndex>=0?n(m.selectedRectIndex):!m.allowMultipleRects&&m.selected&&n(0))},document.addEventListener("keydown",m.internal.keydown)),m.handlers&&!a.__trimHooked){const e=(e,t)=>{try{e(t)}catch(n){}};m.internal.overlayPointerDown=t=>e(m.handlers.pointerDown,t),m.internal.overlayMove=t=>e(m.handlers.overlayMove,t),a.addEventListener("pointerdown",m.internal.overlayPointerDown,{passive:!1,capture:!0}),a.addEventListener("touchstart",m.internal.overlayPointerDown,{passive:!1,capture:!0}),a.addEventListener("pointermove",m.internal.overlayMove,{passive:!0,capture:!0}),a.__trimHooked=!0}return!0}catch(n){return console.error("drawTrimOverlayAsSvg error",n),!1}},function(){function e(e,t,n){return Math.max(t,Math.min(n,e))}function t(e,t){try{const n=document.getElementById(e+"-overlay-svg");if(!n)return;let o=n.querySelector(".snap-guide-svg");o||(o=document.createElementNS("http://www.w3.org/2000/svg","svg"),o.classList.add("snap-guide-svg"),o.setAttribute("width","100%"),o.setAttribute("height","100%"),o.style.pointerEvents="none",o.style.position="absolute",o.style.left="0",o.style.top="0",o.style.zIndex="44",n.appendChild(o));const r=document.getElementById(e);if(!r)return;const i=Math.max(1,Math.round(r.clientWidth||1)),a=Math.max(1,Math.round(r.clientHeight||1));for(o.setAttribute("viewBox",`0 0 ${i} ${a}`),o.setAttribute("preserveAspectRatio","none");o.firstChild;)o.removeChild(o.firstChild);if(!t||0===t.length)return;t.forEach(e=>{const t=document.createElementNS("http://www.w3.org/2000/svg","line");"vertical"===e.type?(t.setAttribute("x1",String(e.position)),t.setAttribute("y1","0"),t.setAttribute("x2",String(e.position)),t.setAttribute("y2",String(a))):(t.setAttribute("x1","0"),t.setAttribute("y1",String(e.position)),t.setAttribute("x2",String(i)),t.setAttribute("y2",String(e.position))),t.setAttribute("stroke","rgba(59,130,246,0.8)"),t.setAttribute("stroke-width","2"),t.setAttribute("stroke-dasharray","5 5"),t.setAttribute("vector-effect","non-scaling-stroke"),t.style.pointerEvents="none",o.appendChild(t)})}catch(n){console.error("drawSnapGuides error",n)}}function n(e,t,n){const o={snapped:e,hasSnap:!1,snapTarget:null};if(!window._trimSnapSettings.enabled||!t||0===t.length)return o;let r=1/0;for(const i of t){const t=Math.abs(e-i);t<n&&t<r&&(r=t,o.snapped=i,o.hasSnap=!0,o.snapTarget=i)}return o}function o(e){const t={removeListener(e,t,n,o){try{e&&n&&e.removeEventListener(t,n,o)}catch(r){}},removeWindowListener(e,t,n){try{t&&window.removeEventListener(e,t,n)}catch(o){}},removeDocumentListener(e,t,n){try{t&&document.removeEventListener(e,t,n)}catch(o){}},removeElement(e){try{if(!e)return;e.style&&(e.style.pointerEvents="none"),"function"==typeof e.remove&&e.remove(),void 0!==e.width&&(e.width=0,e.height=0)}catch(t){}}};try{const n=window._simpleTrim?.[e];if(!n)return;t.removeListener(n.base,"pointerdown",n.handlers?.pointerDown,{passive:!1}),t.removeListener(n.base,"touchstart",n.handlers?.touchStart,{passive:!1}),t.removeWindowListener("pointermove",n.handlers?.move,{passive:!1}),t.removeWindowListener("pointerup",n.handlers?.up,{passive:!1}),t.removeElement(n.overlay||document.getElementById(e+"-overlay"));const o=n.overlayDom||document.getElementById(e+"-overlay-svg");o&&(t.removeListener(o,"pointerdown",n.internal?.overlayPointerDown,!0),t.removeListener(o,"touchstart",n.internal?.overlayPointerDown,!0),t.removeListener(o,"pointermove",n.internal?.overlayMove,!0),t.removeElement(o)),t.removeDocumentListener("keydown",n.internal?.keydown),t.removeListener(n.host,"scroll",n.internal?.hostScroll,{passive:!0}),n.handlers&&Object.keys(n.handlers).forEach(e=>n.handlers[e]=null),n.internal&&Object.keys(n.internal).forEach(e=>n.internal[e]=null),delete window._simpleTrim[e]}catch(n){console.error("cleanupTrimEntry error",n)}}window._simpleTrim=window._simpleTrim||{},window._trimSnapSettings={enabled:!1,threshold:10},window.attachTrimListeners=function(r,i,a="single",s=!1){try{let c=function(e,t){try{const n=x.logicalWAtDown&&x.active?x.logicalWAtDown:Math.max(1,Math.round(u.clientWidth||u.getBoundingClientRect().width||1)),o=x.logicalHAtDown&&x.active?x.logicalHAtDown:Math.max(1,Math.round(u.clientHeight||u.getBoundingClientRect().height||1)),r=u.getBoundingClientRect(),i=r.width&&n?r.width/n:1,a=window._previewZoomState?.lastZoom||i||1,s=p(u,f),c=f.getBoundingClientRect(),l=c.left+s.x*a,d=c.top+s.y*a;return{x:(e-l)/a,y:(t-d)/a,cssW:n,cssH:o}}catch(n){const o=u.getBoundingClientRect(),r=Math.max(1,Math.round(u.clientWidth||o.width||1)),i=Math.max(1,Math.round(u.clientHeight||o.height||1)),a=window._previewZoomState?.lastZoom||1;return{x:(e-o.left)/a,y:(t-o.top)/a,cssW:r,cssH:i}}},l=function(t){const n=Math.max(1,Math.round(u.clientWidth||1)),o=Math.max(1,Math.round(u.clientHeight||1)),r=Number(t.x||0),i=Number(t.y||0),a=r+Number(t.w||0),s=i+Number(t.h||0),c=e(r,0,n),l=e(i,0,o),d=e(a,0,n),w=e(s,0,o);return{X:c/n,Y:l/o,Width:Math.max(0,d-c)/n,Height:Math.max(0,w-l)/o}},d=function(o){x.lastMoveEv=o,x.pendingMove||(x.pendingMove=!0,requestAnimationFrame(()=>{if(x.pendingMove=!1,!x.active)return;const o=c(x.lastMoveEv.clientX,x.lastMoveEv.clientY),{cssW:i,cssH:a}=o,s=x.currentRectPx?{...x.currentRectPx}:null,d=function(e){const t={x:[],y:[]};try{const n=window._simpleTrim[e];if(!n||!n.currentRectsPx)return t;n.currentRectsPx.forEach(e=>{t.x.push(e.x,e.x+e.w),t.y.push(e.y,e.y+e.h)})}catch(n){console.error("collectSnapTargets error",n)}return t}(r),w=window._trimSnapSettings.threshold||10,h=[];if("maybe-draw"===x.mode){const e=o.x-x.startClientLocal.x,t=o.y-x.startClientLocal.y,n=8;if(!(e*e+t*t>=n*n))return;x.mode="draw",x.currentRectPx={x:x.startClientLocal.x,y:x.startClientLocal.y,w:0,h:0}}if("draw"===x.mode){let e=Math.min(o.x,x.startClientLocal.x),t=Math.min(o.y,x.startClientLocal.y),r=Math.abs(o.x-x.startClientLocal.x),i=Math.abs(o.y-x.startClientLocal.y);const a=n(e,d.x,w),c=n(t,d.y,w),l=n(e+r,d.x,w),u=n(t+i,d.y,w);a.hasSnap&&h.push({type:"vertical",position:a.snapTarget}),c.hasSnap&&h.push({type:"horizontal",position:c.snapTarget}),l.hasSnap&&h.push({type:"vertical",position:l.snapTarget}),u.hasSnap&&h.push({type:"horizontal",position:u.snapTarget}),e=a.snapped,t=c.snapped,r=l.snapped-a.snapped,i=u.snapped-c.snapped;let m=e<0?0:e,g=t<0?0:t,p=e<0?Math.max(0,Math.min(x.startClientLocal.x-m,r)):r,f=t<0?Math.max(0,Math.min(x.startClientLocal.y-g,i)):i;if(x.currentRectPx={x:Math.round(m),y:Math.round(g),w:Math.round(p),h:Math.round(f)},!x.didDrag&&s){(s.x!==x.currentRectPx.x||s.y!==x.currentRectPx.y||s.w!==x.currentRectPx.w||s.h!==x.currentRectPx.h)&&(x.didDrag=!0)}}else if("move"===x.mode&&x.startRectPx){const e=o.x-x.startClientLocal.x,t=o.y-x.startClientLocal.y;let r=x.startRectPx.x+e,s=x.startRectPx.y+t;const c=n(r,d.x,w),l=n(s,d.y,w),u=n(r+x.startRectPx.w,d.x,w),m=n(s+x.startRectPx.h,d.y,w);r=c.snapped,s=l.snapped;const g=Math.abs(r-c.snapped);Math.abs(r+x.startRectPx.w-u.snapped)<g&&u.hasSnap?(r=u.snapped-x.startRectPx.w,h.push({type:"vertical",position:u.snapTarget})):c.hasSnap&&h.push({type:"vertical",position:c.snapTarget});const p=Math.abs(s-l.snapped);Math.abs(s+x.startRectPx.h-m.snapped)<p&&m.hasSnap?(s=m.snapped-x.startRectPx.h,h.push({type:"horizontal",position:m.snapTarget})):l.hasSnap&&h.push({type:"horizontal",position:l.snapTarget}),r=Math.max(0,Math.min(i-x.startRectPx.w,r)),s=Math.max(0,Math.min(a-x.startRectPx.h,s)),x.currentRectPx={x:Math.round(r),y:Math.round(s),w:Math.round(x.startRectPx.w),h:Math.round(x.startRectPx.h)},x.didDrag=!0}else if("resize"===x.mode&&x.startRectPx){const t=o.x-x.startClientLocal.x,r=o.y-x.startClientLocal.y,{x:s,y:c,w:l,h:u}=x.startRectPx,m=s+l,g=c+u,p=x.resizeHandle;let f=s,y=m,v=c,b=g;if(["nw","w","sw"].includes(p)&&(f=e(s+t,0,i)),["ne","e","se"].includes(p)&&(y=e(m+t,0,i)),["nw","n","ne"].includes(p)&&(v=e(c+r,0,a)),["sw","s","se"].includes(p)&&(b=e(g+r,0,a)),["nw","w","sw"].includes(p)){const e=n(f,d.x,w);f=e.snapped,e.hasSnap&&h.push({type:"vertical",position:e.snapTarget})}if(["ne","e","se"].includes(p)){const e=n(y,d.x,w);y=e.snapped,e.hasSnap&&h.push({type:"vertical",position:e.snapTarget})}if(["nw","n","ne"].includes(p)){const e=n(v,d.y,w);v=e.snapped,e.hasSnap&&h.push({type:"horizontal",position:e.snapTarget})}if(["sw","s","se"].includes(p)){const e=n(b,d.y,w);b=e.snapped,e.hasSnap&&h.push({type:"horizontal",position:e.snapTarget})}let R=Math.min(f,y),P=Math.max(f,y),M=Math.min(v,b),A=Math.max(v,b);const S=1;P-R<S&&(P=y>=f?Math.min(i,R+S):R,R=y<f?Math.max(0,P-S):R),A-M<S&&(A=b>=v?Math.min(a,M+S):M,M=b<v?Math.max(0,A-S):M),x.currentRectPx={x:Math.round(R),y:Math.round(M),w:Math.round(P-R),h:Math.round(A-M)},x.didDrag=!0}if(t(r,h),x.currentRectPx){if((!s||s.x!==x.currentRectPx.x||s.y!==x.currentRectPx.y||s.w!==x.currentRectPx.w||s.h!==x.currentRectPx.h)&&x.overlayDom&&window.drawTrimOverlayAsSvg)if(!x.allowMultipleRects||"move"!==x.mode&&"resize"!==x.mode&&"draw"!==x.mode){const e=l(x.currentRectPx);window.drawTrimOverlayAsSvg(r,[e])}else if("draw"===x.mode){const e=[...x.currentRectsPx.map(e=>({X:e.x/i,Y:e.y/a,Width:e.w/i,Height:e.h/a})),{X:x.currentRectPx.x/i,Y:x.currentRectPx.y/a,Width:x.currentRectPx.w/i,Height:x.currentRectPx.h/a}];window.drawTrimOverlayAsSvg(r,e)}else{x.selectedRectIndex>=0&&x.selectedRectIndex<x.currentRectsPx.length&&(x.currentRectsPx[x.selectedRectIndex]={...x.currentRectPx});const e=x.currentRectsPx.map(e=>({X:e.x/i,Y:e.y/a,Width:e.w/i,Height:e.h/a}));window.drawTrimOverlayAsSvg(r,e)}}}))},w=function(){x.mode="maybe-draw";let e=[];if(x.allowMultipleRects){x.selectedRectIndex=-1;const t=x.logicalWAtDown||Math.max(1,Math.round(u.clientWidth||1)),n=x.logicalHAtDown||Math.max(1,Math.round(u.clientHeight||1));e=x.currentRectsPx.map(e=>({X:e.x/t,Y:e.y/n,Width:e.w/t,Height:e.h/n}))}else x.selected=!1,x.currentRectPx&&(e=[l(x.currentRectPx)]);window.drawTrimOverlayAsSvg&&window.drawTrimOverlayAsSvg(r,e)},h=function(){x.active||S||(S=!0,requestAnimationFrame(()=>{S=!1}))};if(window._previewPan.enabled=!1,!r)return!1;const u=document.getElementById(r);if(!u)return console.warn(`attachTrimListeners: canvas not found: ${r}`),!1;let m=!1;const g=window._simpleTrim[r];g?.selected&&(m=!0),o(r);const f=u.parentElement||u.closest(".tp-preview-page")||u.closest(".preview-zoom-inner")||document.body;"static"===getComputedStyle(f).position&&(f.style.position="relative");const y=r+"-overlay";let v=document.getElementById(y);v||(v=document.createElement("canvas"),v.id=y,v.style.position="absolute",v.style.pointerEvents="none",v.style.zIndex="40",f.appendChild(v));const b=document.getElementById(r+"-overlay-svg")||null,x={base:u,host:f,overlay:v,overlayDom:b,dotNetRef:i,selectionMode:"multi"===a?"multi":"single",allowMultipleRects:Boolean(s),active:!1,mode:null,pointerId:null,startClientX:0,startClientY:0,startClientLocal:null,startRectPx:null,currentRectPx:null,currentRectsPx:[],selectedRectIndex:-1,pendingMove:!1,handlers:{},internal:{},resizeHandle:null,baseRectAtDown:null,logicalWAtDown:null,logicalHAtDown:null,didDrag:!1,selected:m};x.internal.lastAttachedAt=performance.now(),window._simpleTrim[r]=x;const R=["nw","n","ne","e","se","s","sw","w"],P={nw:"nwse-resize",se:"nwse-resize",ne:"nesw-resize",sw:"nesw-resize",n:"ns-resize",s:"ns-resize",e:"ew-resize",w:"ew-resize"},M=function(e){try{if(window._previewPan.enabled)return;if(void 0!==e.button&&0!==e.button)return;x.active=!0,x.pointerId=e.pointerId??"mouse",x.startClientX=e.clientX,x.startClientY=e.clientY,x.didDrag=!1,x.baseRectAtDown=u.getBoundingClientRect(),x.logicalWAtDown=Math.max(1,Math.round(u.clientWidth||x.baseRectAtDown.width||1)),x.logicalHAtDown=Math.max(1,Math.round(u.clientHeight||x.baseRectAtDown.height||1)),x.startClientLocal=c(e.clientX,e.clientY),u.setPointerCapture&&u.setPointerCapture(e.pointerId);const o=e.target||e.srcElement;if(o?.setPointerCapture&&o!==u)try{o.setPointerCapture(e.pointerId)}catch(n){}if(x.resizeHandle=null,x.overlayDom&&o){const e=o.getAttribute?.("data-handle"),t=o.getAttribute?.("data-rect"),n=o.getAttribute?.("data-rect-index"),i=null!==n?Number(n):-1;if(null!==e){const t=Number(e);x.resizeHandle=Number.isFinite(t)&&t>=0&&t<R.length?R[t]:null,x.mode="resize",x.allowMultipleRects&&i>=0&&i<x.currentRectsPx.length?(x.selectedRectIndex=i,x.startRectPx={...x.currentRectsPx[i]},x.currentRectPx={...x.currentRectsPx[i]}):x.startRectPx=x.currentRectPx?{...x.currentRectPx}:{x:x.startClientLocal.x,y:x.startClientLocal.y,w:0,h:0}}else if(null!==t)if(x.mode="move",x.allowMultipleRects&&i>=0&&i<x.currentRectsPx.length){x.selectedRectIndex=i,x.startRectPx={...x.currentRectsPx[i]},x.currentRectPx={...x.currentRectsPx[i]};"single"===(x.selectionMode||window._simpleTrimSettings?.selectionMode||"single")&&Object.keys(window._simpleTrim).forEach(e=>{e!==r&&window._simpleTrim[e]&&(window._simpleTrim[e].selectedRectIndex=-1,window._simpleTrim[e].selected=!1)});const e=x.currentRectsPx.map(e=>({X:e.x/x.logicalWAtDown,Y:e.y/x.logicalHAtDown,Width:e.w/x.logicalWAtDown,Height:e.h/x.logicalHAtDown}));window.drawTrimOverlayAsSvg(r,e)}else{x.startRectPx=x.currentRectPx?{...x.currentRectPx}:{x:x.startClientLocal.x,y:x.startClientLocal.y,w:0,h:0};"single"===(x.selectionMode||window._simpleTrimSettings?.selectionMode||"single")&&Object.keys(window._simpleTrim).forEach(e=>{e!==r&&window._simpleTrim[e]?.selected&&(window._simpleTrim[e].selected=!1)}),x.selected=!0,x.overlayDom&&window.drawTrimOverlayAsSvg&&window.drawTrimOverlayAsSvg(r,[l(x.currentRectPx)])}else w()}else w();x.overlayDom&&(x.resizeHandle?x.overlayDom.style.cursor=P[x.resizeHandle]||"":"draw"===x.mode?x.overlayDom.style.cursor="crosshair":"move"===x.mode?x.overlayDom.style.cursor="move":"maybe-draw"===x.mode&&(x.overlayDom.style.cursor="")),x.handlers.move=e=>d(e),x.handlers.up=function(e){if(!x.active)return;t(r,[]),x.active=!1;try{u.releasePointerCapture&&u.releasePointerCapture(x.pointerId)}catch(n){}if(x.baseRectAtDown=null,x.logicalWAtDown=null,x.logicalHAtDown=null,x.overlayDom&&(x.overlayDom.style.cursor=""),"maybe-draw"===x.mode)return x.mode=null,x.didDrag=!1,window.removeEventListener("pointermove",x.handlers.move,{passive:!1}),void window.removeEventListener("pointerup",x.handlers.up,{passive:!1});const o=x.currentRectPx||{x:0,y:0,w:0,h:0};if(o.w>0&&o.h>0){const e=l(o);if(x.allowMultipleRects){"draw"===x.mode?(x.currentRectsPx.push(o),x.selectedRectIndex=x.currentRectsPx.length-1):"move"!==x.mode&&"resize"!==x.mode||x.selectedRectIndex>=0&&x.selectedRectIndex<x.currentRectsPx.length&&(x.currentRectsPx[x.selectedRectIndex]=o);const e=x.currentRectsPx.map(e=>({X:e.x/(u.clientWidth||1),Y:e.y/(u.clientHeight||1),Width:e.w/(u.clientWidth||1),Height:e.h/(u.clientHeight||1)}));x.dotNetRef?.invokeMethodAsync&&x.dotNetRef.invokeMethodAsync("CommitMultipleRectsFromJs",e).catch(()=>{})}else x.lastRawRect=o,x.currentRectsPx=[o],x.dotNetRef?.invokeMethodAsync&&x.dotNetRef.invokeMethodAsync("CommitTrimRectFromJs",e.X,e.Y,e.Width,e.Height).catch(()=>{}),x.didDrag&&(x.selected=!1,x.overlayDom&&window.drawTrimOverlayAsSvg&&window.drawTrimOverlayAsSvg(r,[l(o)]))}else x.overlayDom&&window.drawTrimOverlayAsSvg&&window.drawTrimOverlayAsSvg(r,[]);window.removeEventListener("pointermove",x.handlers.move,{passive:!1}),window.removeEventListener("pointerup",x.handlers.up,{passive:!1})},window.addEventListener("pointermove",x.handlers.move,{passive:!1}),window.addEventListener("pointerup",x.handlers.up,{passive:!1}),e.preventDefault?.()}catch(n){console.error("onPointerDown error",n)}},A=function(e){try{if(!e.touches||0===e.touches.length)return;const t=e.touches[0];M({clientX:t.clientX,clientY:t.clientY,pointerId:"touch",button:0,target:t.target,preventDefault:()=>e.preventDefault()}),e.preventDefault()}catch(t){console.error("onTouchStart error",t)}};if(x.handlers.pointerDown=M,x.handlers.touchStart=A,u.addEventListener("pointerdown",M,{passive:!1}),u.addEventListener("touchstart",A,{passive:!1}),b?.style&&(b.style.cursor="crosshair"),b){b.style.pointerEvents="auto",b.addEventListener("pointerdown",M,{passive:!1,capture:!0}),b.addEventListener("touchstart",A,{passive:!1,capture:!0});const e=function(e){const t=e.target,n=t?.getAttribute?.("data-handle"),o=t?.getAttribute?.("data-rect");if(null!==n){const e=Number(n),t=Number.isFinite(e)&&e>=0&&e<R.length?R[e]:null;b.style.cursor=t&&P[t]||""}else b.style.cursor=null!==o?"move":""};x.handlers.overlayMove=e,b.addEventListener("pointermove",e,{passive:!0,capture:!0})}let S=!1;x.internal.hostScroll=h,f.addEventListener("scroll",x.internal.hostScroll,{passive:!0});const E=document.getElementById("trim-preview-container")||f.closest(".preview-zoom-viewport");return E&&(x.internal.containerScroll=h,E.addEventListener("scroll",x.internal.containerScroll,{passive:!0})),!0}catch(c){return console.error("attachTrimListeners error",c),!1}},window.detachTrimListeners=function(e){try{const t=window._simpleTrim?.[e];return t?(o(e),!0):(o(e),!1)}catch(t){return console.error("detachTrimListeners error",t),!1}}}(),window.setTrimSnapEnabled=function(e){try{return window._trimSnapSettings=window._trimSnapSettings||{},window._trimSnapSettings.enabled=Boolean(e),!0}catch(t){return console.error("setTrimSnapEnabled error",t),!1}},window.drawImageToCanvasForPreview=function(e,t,n=!0){return new Promise(o=>{try{const r=document.getElementById(e);if(!r)return void o(!1);const i=r.getContext("2d");if(!i)return void o(!1);const a=new window.Image;a.crossOrigin="anonymous",a.onload=function(){try{const e=Math.max(1,Math.round(a.naturalWidth)),t=Math.max(1,Math.round(a.naturalHeight)),s=n&&window.devicePixelRatio||1;r.width=Math.round(e*s),r.height=Math.round(t*s),r.style.width=e+"px",r.style.height=t+"px",r.style.display="block",i.setTransform(s,0,0,s,0,0),i.clearRect(0,0,e,t),i.drawImage(a,0,0,e,t),requestAnimationFrame(()=>o(!0))}catch(e){console.error("drawImageToCanvasForPreview draw error",e),o(!1)}},a.onerror=function(e){console.error("drawImageToCanvasForPreview image load error",e,t),o(!1)},a.src=t}catch(r){console.error("drawImageToCanvasForPreview error",r),o(!1)}})},window._visiblePageObserver=window._visiblePageObserver||{},window.registerVisiblePageObserver=function(e,t,n=500){try{try{window.unregisterVisiblePageObserver(t)}catch(o){}const r=document.getElementById(t);if(!r)return;const i=Array.from(r.querySelectorAll('[id^="preview-container-"]'));if(!i||0===i.length)return;const a={pendingBest:-1,timer:null,lastIdx:-1,debounceMs:Number(n)||500},s=new IntersectionObserver(function(t){try{const n=r.getBoundingClientRect(),i=n.top+n.height/2;let s=-1,c=1/0,l=0;const d=.2;t.forEach(e=>{const t=e.intersectionRatio||0;if(t<d)return;const n=e.target?.id;if(!n)return;const o=n.split("-"),r=Number(o[o.length-1]);if(!Number.isFinite(r))return;const a=e.target.getBoundingClientRect(),w=a.top+a.height/2,h=Math.abs(w-i),u=.1*a.height,m=h<c-u,g=Math.abs(h-c)<=u&&t>l;(m||g)&&(c=h,l=t,s=r)}),s>=0&&s!==a.lastIdx&&(a.pendingBest=s,a.timer&&clearTimeout(a.timer),a.timer=setTimeout(()=>{try{if(a.lastIdx!==a.pendingBest){a.lastIdx=a.pendingBest;try{const e=document.getElementById("topbar-page-input");e&&(e.value=String(a.pendingBest+1))}catch(o){}try{e&&"function"==typeof e.invokeMethodAsync&&e.invokeMethodAsync("SetVisiblePageFromJs",a.pendingBest).catch(()=>{})}catch(o){}}}catch(o){}a.timer=null},a.debounceMs))}catch(o){console.error("visible page observer callback error",o)}},{root:r,threshold:[0,.2,.5,.8,1]});i.forEach(e=>s.observe(e)),window._visiblePageObserver=window._visiblePageObserver||{},window._visiblePageObserver[t]={observer:s,items:i,dotNetRef:e,state:a}}catch(o){console.error("registerVisiblePageObserver error",o)}},window.unregisterVisiblePageObserver=function(e){try{const n=window._visiblePageObserver&&window._visiblePageObserver[e];if(!n)return;try{n.state&&n.state.timer&&clearTimeout(n.state.timer)}catch(t){}try{n.observer&&n.observer.disconnect()}catch(t){}try{delete window._visiblePageObserver[e]}catch(t){}}catch(t){console.error("unregisterVisiblePageObserver error",t)}},window.tooltipHelper=window.tooltipHelper||{},function(){const e=12;window.tooltipHelper.show=function(t,n){try{const o=document.getElementById(t),r=document.getElementById(n);if(!o||!r)return void console.warn("tooltipHelper.show: element not found",{wrapperId:t,tooltipId:n});!function(t,n){const o=t.getBoundingClientRect(),r=n.getBoundingClientRect(),i=window.innerWidth,a=window.innerHeight,s=[{name:"top",x:o.left+o.width/2-r.width/2,y:o.top-r.height-e},{name:"bottom",x:o.left+o.width/2-r.width/2,y:o.bottom+e},{name:"left",x:o.left-r.width-e,y:o.top+o.height/2-r.height/2},{name:"right",x:o.right+e,y:o.top+o.height/2-r.height/2}];let c=null;for(const e of s){const t=e.x>=8&&e.x+r.width<=i-8,n=e.y>=8&&e.y+r.height<=a-8;if(t&&n){c=e;break}}c||(c=s[0]);let l=Math.max(8,Math.min(c.x,i-r.width-8)),d=Math.max(8,Math.min(c.y,a-r.height-8));n.style.left=l+"px",n.style.top=d+"px",n.setAttribute("data-placement",c.name)}(o,r),requestAnimationFrame(()=>{r.style.opacity="1",r.style.visibility="visible"})}catch(o){console.error("tooltipHelper.show error",o)}},window.tooltipHelper.hide=function(e){try{const t=document.getElementById(e);t&&(t.style.opacity="0",t.style.visibility="hidden")}catch(t){console.error("tooltipHelper.hide error",t)}}}(),window.messageBar=window.messageBar||{},function(){let e=null,t=null;const n={success:{bar:"bg-green-500",box:"bg-green-100 text-green-900 border border-green-400"},warn:{bar:"bg-yellow-400",box:"bg-yellow-100 text-yellow-900 border border-yellow-400"},error:{bar:"bg-red-500",box:"bg-red-400 text-white"}};window.messageBar.show=function(o,r="success",i=5e3){try{const a=document.getElementById("message-bar-container"),s=document.getElementById("message-bar-text"),c=document.getElementById("message-bar-box"),l=document.getElementById("message-bar-progress"),d=document.getElementById("message-bar-close");if(!(a&&s&&c&&l))return void console.warn("messageBar: required elements not found");e&&(clearTimeout(e),e=null),t&&(clearInterval(t),t=null),s.textContent=o;const w=n[r]||n.success;l.className=`h-full transition-all ${w.bar}`,c.className=`px-4 py-2 rounded-b-lg shadow transition-all duration-300 ${w.box}`,l.style.width="100%",l.style.transition="none",a.style.display="block",requestAnimationFrame(()=>{l.style.transition=`width ${i}ms linear`,l.style.width="0%"});const h=()=>{l.removeEventListener("transitionend",h),window.messageBar.hide()};l.addEventListener("transitionend",h),e=setTimeout(()=>{l.removeEventListener("transitionend",h),window.messageBar.hide(),e=null},i+100);const u=d.cloneNode(!0);d.parentNode.replaceChild(u,d),u.addEventListener("click",()=>{l.removeEventListener("transitionend",h),window.messageBar.hide()})}catch(a){console.error("messageBar.show error",a)}},window.messageBar.hide=function(){try{const n=document.getElementById("message-bar-container");n&&(n.style.display="none"),e&&(clearTimeout(e),e=null),t&&(clearInterval(t),t=null)}catch(n){console.error("messageBar.hide error",n)}}}(),window.loadingOverlay={show:function(e){const t=document.getElementById("loading-overlay"),n=document.getElementById("loading-message");t&&(t.classList.remove("hidden"),n&&e&&(n.textContent=e))},hide:function(){const e=document.getElementById("loading-overlay");e&&e.classList.add("hidden")}},window.ocrHelper={worker:null,isLibraryLoaded:!1,loadingPromise:null,async loadLibrary(){return!!this.isLibraryLoaded||(this.loadingPromise||(this.loadingPromise=new Promise((e,t)=>{const n=document.createElement("script");n.src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js",n.async=!0,n.onload=()=>{console.log("[OCR] Tesseract.js loaded"),this.isLibraryLoaded=!0,e(!0)},n.onerror=e=>{console.error("[OCR] Failed to load Tesseract.js",e),this.loadingPromise=null,t(e)},document.head.appendChild(n)})),this.loadingPromise)},async initialize(e="eng+jpn"){try{return this.isLibraryLoaded||await this.loadLibrary(),this.worker||(console.log("[OCR] Initializing worker with language:",e),this.worker=await Tesseract.createWorker(e,1,{logger:e=>{"recognizing text"===e.status&&console.log(`[OCR] Progress: ${(100*e.progress).toFixed(1)}%`)}}),console.log("[OCR] Worker initialized")),!0}catch(t){return console.error("[OCR] Initialization error:",t),!1}},rotateImage:async(e,t)=>new Promise((n,o)=>{const r=new Image;r.onload=()=>{try{const e=document.createElement("canvas"),o=e.getContext("2d"),i=t*Math.PI/180,a=Math.abs(Math.cos(i)),s=Math.abs(Math.sin(i));e.width=Math.ceil(r.width*a+r.height*s),e.height=Math.ceil(r.width*s+r.height*a),o.fillStyle="#FFFFFF",o.fillRect(0,0,e.width,e.height),o.translate(e.width/2,e.height/2),o.rotate(i),o.drawImage(r,-r.width/2,-r.height/2),console.log("[OCR] Image rotated:",{originalSize:`${r.width}x${r.height}`,rotatedSize:`${e.width}x${e.height}`,angle:t.toFixed(2)}),n(e.toDataURL("image/png"))}catch(e){console.error("[OCR] Rotation error:",e),o(e)}},r.onerror=()=>{console.error("[OCR] Failed to load image for rotation"),o(new Error("Failed to load image for rotation"))},r.src=e}),async recognize(e,t={}){try{if(!this.worker){if(!(await this.initialize()))throw new Error("OCR worker initialization failed")}const{psmMode:n=3,autoRotate:o=!1}=t;console.log("[OCR] Recognition options:",{psmMode:n,autoRotate:o});let r=e;await this.worker.setParameters({tessedit_pageseg_mode:n}),console.log("[OCR] Starting recognition...");const i=await this.worker.recognize(r);return console.log("[OCR] Recognition complete. Text length:",i.data.text.length),console.log("[OCR] Confidence:",i.data.confidence),{text:i.data.text,confidence:i.data.confidence,lines:i.data.lines?.map(e=>({text:e.text,confidence:e.confidence,bbox:e.bbox}))||[]}}catch(n){throw console.error("[OCR] Recognition error:",n),n}},async terminate(){this.worker&&(console.log("[OCR] Terminating main worker"),await this.worker.terminate(),this.worker=null)},async reset(){await this.terminate()}},window.copyToClipboard=async function(e){if(navigator.clipboard&&navigator.clipboard.writeText)try{return await navigator.clipboard.writeText(e),!0}catch(t){console.error("Clipboard API error:",t)}try{const t=document.createElement("textarea");if(t.value=e,t.style.position="fixed",t.style.left="-999999px",t.style.top="-999999px",t.setAttribute("readonly",""),document.body.appendChild(t),navigator.userAgent.match(/ipad|iphone/i)){const n=document.createRange();n.selectNodeContents(t);const o=window.getSelection();o.removeAllRanges(),o.addRange(n),t.setSelectionRange(0,e.length)}else t.select();let o=!1;try{o=document.execCommand("copy")}catch(n){console.error("execCommand fallback failed:",n)}return document.body.removeChild(t),o}catch(t){return console.error("Fallback copy error:",t),!1}}}();
