!function(){"use strict";function e(e,t){if(!e)return;const n=e.querySelector("[data-drop-cover]"),r=e.querySelector("[data-drop-cover-inner]");n&&(t?(n.classList.remove("opacity-0","pointer-events-none"),n.classList.add("opacity-60","pointer-events-auto"),r&&(r.classList.remove("scale-70"),r.classList.add("scale-100"))):(n.classList.remove("opacity-60","pointer-events-auto"),n.classList.add("opacity-0","pointer-events-none"),r&&(r.classList.remove("scale-100"),r.classList.add("scale-70"))))}async function t(){window.JSZip||await new Promise((e,t)=>{const n=document.createElement("script");n.src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js",n.onload=e,n.onerror=t,document.head.appendChild(n)})}window.getPageType=function(){return window.location.pathname.includes("/split")?"split":window.location.pathname.includes("/merge")?"merge":"unknown"},window.fadeInOnScroll={observe:function(e){if(!e)return;new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(e.target.classList.remove("opacity-0","translate-y-8"),e.target.classList.add("opacity-100","translate-y-0"))})},{threshold:.5}).observe(e)}},window.positionEditorTooltip=function(e,t){const n=document.getElementById(t);if(!n)return;n.style.display="block",n.setAttribute("aria-hidden","false"),n.style.left="-9999px",n.style.top="-9999px",n.style.visibility="hidden";const r=e.getBoundingClientRect(),o=n.getBoundingClientRect(),i=window.innerWidth||document.documentElement.clientWidth,a=window.innerHeight||document.documentElement.clientHeight,s=r.top,c=a-r.bottom,l=r.left,d=i-r.right;let w="top";s<o.height+12&&c>s&&(w="bottom"),("top"===w||"bottom"===w)&&o.width>d&&l>d&&(w="left"),("top"===w||"bottom"===w)&&o.width>l&&d>l&&(w="right");let u=0,h=0;"top"===w?(h=r.top-o.height-8,u=r.left+(r.width-o.width)/2):"bottom"===w?(h=r.bottom+8,u=r.left+(r.width-o.width)/2):"left"===w?(h=r.top+(r.height-o.height)/2,u=r.left-o.width-8):(h=r.top+(r.height-o.height)/2,u=r.right+8),u=Math.max(8,Math.min(u,i-o.width-8)),h=Math.max(8,Math.min(h,a-o.height-8)),n.style.left=Math.round(u)+"px",n.style.top=Math.round(h)+"px",n.setAttribute("data-dir",w),n.style.visibility="visible"},window.hideEditorTooltip=function(e){const t=document.getElementById(e);t&&(t.style.display="none",t.setAttribute("aria-hidden","true"))},window.registerDropArea=function(t,n){const r=document.getElementById(t);if(!r)return;r._dropHandlers&&window.unregisterDropArea(t);let o=0;r._dropHandlers={dragenter:function(t){window.isSorting||(o++,e(r,!0))},dragover:function(e){window.isSorting||e.preventDefault()},dragleave:function(t){window.isSorting||(o--,o<=0&&(o=0,e(r,!1)))},drop:function(t){if(!window.isSorting&&(t.preventDefault(),o=0,e(r,!1),t.dataTransfer&&t.dataTransfer.files&&t.dataTransfer.files.length>0)){Array.from(t.dataTransfer.files).forEach(e=>{const t=new FileReader;t.onload=function(t){n.invokeMethodAsync("OnJsFileDropped",e.name,e.type,t.target.result.split(",")[1])},t.readAsDataURL(e)})}}},r.addEventListener("dragenter",r._dropHandlers.dragenter),r.addEventListener("dragover",r._dropHandlers.dragover),r.addEventListener("dragleave",r._dropHandlers.dragleave),r.addEventListener("drop",r._dropHandlers.drop)},window.unregisterDropArea=function(e){const t=document.getElementById(e);t&&t._dropHandlers&&(t.removeEventListener("dragenter",t._dropHandlers.dragenter),t.removeEventListener("dragover",t._dropHandlers.dragover),t.removeEventListener("dragleave",t._dropHandlers.dragleave),t.removeEventListener("drop",t._dropHandlers.drop),delete t._dropHandlers)},window.registerSelectDropArea=function(e){const t=document.getElementById("select-drop-area");if(!t||!t.firstElementChild)return;window.unregisterSelectDropArea();const n=t.firstElementChild;let r=0;t.ondragenter=e=>{r++,n.classList.remove("bg-white/60"),n.classList.add("bg-blue-100/60","border-solid")},t.ondragover=e=>{e.preventDefault()},t.ondragleave=e=>{r--,r<=0&&(console.log("ondragleave"),r=0,n.classList.remove("bg-blue-100/60","border-solid"),n.classList.add("bg-white/60"))},t.ondrop=t=>{t.preventDefault(),n.classList.remove("bg-blue-100/60","border-solid"),n.classList.add("bg-white/60"),t.dataTransfer&&t.dataTransfer.files.length>0&&(window.loadingOverlay&&window.loadingOverlay.show("ファイル読み込み中..."),Array.from(t.dataTransfer.files).forEach(t=>{const n=new FileReader;n.onload=function(n){const r=n.target.result.split(",")[1];e.invokeMethodAsync("OnJsFileDropped",t.name,t.type,r)},n.readAsDataURL(t)}))},t.onpaste=t=>{t.clipboardData&&t.clipboardData.files.length>0&&(window.loadingOverlay&&window.loadingOverlay.show("ファイル読み込み中..."),Array.from(t.clipboardData.files).forEach(t=>{const n=new FileReader;n.onload=function(n){const r=n.target.result.split(",")[1];e.invokeMethodAsync("OnJsFileDropped",t.name,t.type,r)},n.readAsDataURL(t)}))}},window.unregisterSelectDropArea=function(){const e=document.getElementById("select-drop-area");e&&(e.ondragenter=null,e.ondragover=null,e.ondragleave=null,e.ondrop=null,e.onpaste=null)},window.getPageSourceInfo=async function(e,t,n){try{if(!n)return null;let e=n;const t=/^data:.*;base64,(.*)$/.exec(n);t&&t[1]&&(e=t[1]);const i=window.devicePixelRatio||1;try{const t=Uint8Array.from(atob(e),e=>e.charCodeAt(0)),n=await window.pdfjsLib.getDocument({data:t,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}).promise,r=(await n.getPage(1)).getViewport({scale:1});return{origW:r.width,origH:r.height,dpr:i}}catch(r){try{const e=n,t=await new Promise((t,n)=>{const r=new Image;r.onload=()=>t(r),r.onerror=n,r.src=e});return{origW:t.naturalWidth,origH:t.naturalHeight,dpr:i}}catch(o){return console.error("getPageSourceInfo: not pdf nor image",o),null}}}catch(i){return console.error("getPageSourceInfo error",i),null}},window.drawPdfPageToCanvas=async function(e,t,n=1,r){try{const i=`#pdf-canvas-${e}`,a=document.querySelector(i);if(!a||!t)return;let s=t;const c=/^data:.*;base64,(.*)$/.exec(t);let l;c&&c[1]&&(s=c[1]);try{l=Uint8Array.from(atob(s),e=>e.charCodeAt(0))}catch(o){return void console.error("drawPdfPageToCanvas: invalid base64",o)}const d=window.pdfjsLib;if(!d)return void console.error("pdfjsLib not loaded");if(window._pdfRenderTask&&window._pdfRenderTask.cancel)try{window._pdfRenderTask.cancel()}catch{}const w=d.getDocument({data:l,cMapUrl:d.GlobalWorkerOptions.cMapUrl,cMapPacked:d.GlobalWorkerOptions.cMapPacked,standardFontDataUrl:d.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:d.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:d.GlobalWorkerOptions.openjpegJsUrl}),u=await w.promise,h=await u.getPage(1),m=window.devicePixelRatio||1,g=n<1?1:m,p=n*g,f=h.getViewport({scale:p,rotation:r});a.width=Math.round(f.width),a.height=Math.round(f.height);const y=document.createElement("canvas");y.width=Math.max(1,Math.round(f.width)),y.height=Math.max(1,Math.round(f.height));const v=y.getContext("2d");v&&v.setTransform&&v.setTransform(1,0,0,1,0,0),window._pdfRenderTask=h.render({canvasContext:v,viewport:f}),await window._pdfRenderTask.promise;const b=a.getContext("2d");if(!b)return;b.setTransform(1,0,0,1,0,0),b.clearRect(0,0,a.width,a.height);const x=Math.round((a.width-y.width)/2),P=Math.round((a.height-y.height)/2);b.drawImage(y,0,0,y.width,y.height,x,P,y.width,y.height),b.setTransform&&b.setTransform(g,0,0,g,0,0)}catch(i){if(i&&"RenderingCancelledException"===i.name)return;console.error("drawPdfPageToCanvas error",i)}},window.getTagNameFromEvent=function(e){return e&&e.target&&e.target.tagName?e.target.tagName:""},window.getCanvasCoords=function(e,t,n,r,o,i){const a=document.querySelector(e);if(!a)return{x:0,y:0};const s=a.getBoundingClientRect();return{x:(t-s.left)/i,y:(n-s.top)/i}},window.triggerFileInput=e=>{e.click()},window.clearFileInput=function(e){e&&(e.value="")},window.registerGlobalMouseUp=function(e){window._blazorMouseUpHandler=function(t){e.invokeMethodAsync("OnGlobalMouseUp")},window.addEventListener("mouseup",window._blazorMouseUpHandler)},window.unregisterGlobalMouseUp=function(){window._blazorMouseUpHandler&&(window.removeEventListener("mouseup",window._blazorMouseUpHandler),window._blazorMouseUpHandler=null)},window.registerGlobalMouseMove=function(e){window._globalMouseMoveHandler=function(t){e.invokeMethodAsync("OnGlobalMouseMove",{clientX:t.clientX,clientY:t.clientY})},window.addEventListener("mousemove",window._globalMouseMoveHandler)},window.unregisterGlobalMouseMove=function(){window._globalMouseMoveHandler&&(window.removeEventListener("mousemove",window._globalMouseMoveHandler),window._globalMouseMoveHandler=null)},window.getElementRect=function(e){const t=document.querySelector(e);if(!t)return{left:0,top:0,width:0,height:0};const n=t.getBoundingClientRect();return{left:n.left,top:n.top,width:n.width,height:n.height}},window.waitForNextFrame=function(){return new Promise(e=>requestAnimationFrame(e))},window.measureMaxLineWidth=function(e,t,n){const r=(window._measureTextCanvas||(window._measureTextCanvas=document.createElement("canvas"))).getContext("2d");r.font=`${t}px ${n}`;const o=e.split("\n");let i=0;for(const a of o){const e=r.measureText(a).width;e>i&&(i=e)}return i},window.selectAllTextarea=function(e){e&&e.select()},window.autoResizeTextarea=function(e){try{const t=(e=>e?"string"==typeof e?document.getElementById(e):(HTMLElement,e):null)(e);return t&&t.style?new Promise(e=>{requestAnimationFrame(()=>{try{t.style.height="auto",t.getBoundingClientRect();const r=window.getComputedStyle(t),o=parseFloat(r.lineHeight)||parseFloat(r.fontSize)||16,i=Math.max(t.scrollHeight||0,o),a=Math.ceil(i+2);t.style.height=a+"px",t.style.overflow="hidden";let s=0;try{const e=t.closest&&t.closest(".edit-element");if(e){const t=window.getComputedStyle(e);s=(parseFloat(t.borderTopWidth)||0)+(parseFloat(t.borderBottomWidth)||0)}}catch(n){}e(a+s||0)}catch(r){console.error("autoResizeTextarea inner error",r),e(0)}})}):(console.debug("autoResizeTextarea: element not found:",e),0)}catch(t){return console.error("autoResizeTextarea error",t),0}},window.getImageSizeFromBase64=function(e){return new Promise(t=>{const n=new Image;n.onload=function(){t({width:n.width,height:n.height})},n.src=e})},window.openInsertFileDialog=function(e){const t=document.getElementById(e);t&&(t.value=null,t.click())},window.openFileDialog=function(e){const t=document.getElementById(e);t&&t.click()},window.createZipFromUrls=async function(e,n){if(await t(),!window.JSZip)throw new Error("JSZipがロードされていません。");const r=new JSZip;for(let t=0;t<e.length;t++){const o=e[t],a=n[t]||`file${t+1}.pdf`;try{const e=await fetch(o),t=await e.blob(),n=await t.arrayBuffer();r.file(a,n)}catch(i){console.error(`ファイル取得失敗: ${a}`,i)}}const o=await r.generateAsync({type:"blob"});return URL.createObjectURL(o)},window.getZipFileSize=async function(e){try{const t=await fetch(e),n=(await t.blob()).size;return n<1024?`${n} bytes`:n<1048576?`${(n/1024).toFixed(1)} KB`:`${(n/1048576).toFixed(2)} MB`}catch(t){return console.error("zipファイルサイズ取得失敗",t),""}},window.downloadImagesAsZip=async function(e,n){await t();const r=new JSZip;for(const t of e){const e=t.dataUrl.split(",")[1];r.file(t.fileName,e,{base64:!0})}const o=await r.generateAsync({type:"blob"}),i=URL.createObjectURL(o),a=document.createElement("a");a.href=i,a.download=n,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i)},window.downloadAllPdfsAsPngZip=async function(e,n,r){await t();const o=window.pdfjsLib;if(!o)return void alert("PDF.jsがロードされていません");const i=new window.JSZip;for(let t=0;t<e.length;t++){const r=e[t],a=(n[t]||`file${t+1}.pdf`).replace(/\.pdf$/i,"");let s=null;try{const e=await fetch(r),t=await e.arrayBuffer();s=await o.getDocument({data:t,standardFontDataUrl:o.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:o.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:o.GlobalWorkerOptions.openjpegJsUrl}).promise;for(let n=1;n<=s.numPages;n++){const e=await s.getPage(n),t=document.createElement("canvas"),r=e.getViewport({scale:2});t.width=r.width,t.height=r.height,await e.render({canvasContext:t.getContext("2d"),viewport:r}).promise;const o=t.toDataURL("image/png");i.file(`${a}_page${n}.png`,o.split(",")[1],{base64:!0})}}catch(c){console.error(`PDF変換失敗: ${a}`,c)}finally{try{s&&"function"==typeof s.destroy&&s.destroy()}catch(c){console.warn("pdf.destroy() error",c)}}}const a=await i.generateAsync({type:"blob"}),s=document.createElement("a");s.href=URL.createObjectURL(a),s.download=r||"images.zip",document.body.appendChild(s),s.click(),document.body.removeChild(s)};let n=null;window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),n=e}),window.isInstallPromptAvailable=function(){return null!==n},window.showInstallPrompt=async function(){n&&(n.prompt(),n=null)};let r=null;function o(e){const t=e.replace(/[\r\n\s]/g,""),n=atob(t),r=n.length,o=new Uint8Array(r);for(let i=0;i<r;i++)o[i]=n.charCodeAt(i);return o}function i(e){return e instanceof Uint8Array?e:Array.isArray(e)?new Uint8Array(e):"string"==typeof e?o(e):new Uint8Array(e)}function a(e){let t="";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return btoa(t)}async function s(e,t={}){const n=window.pdfjsLib;if(!n)throw new Error("PDF.js library not loaded");const r={data:e,cMapUrl:n.GlobalWorkerOptions.cMapUrl,cMapPacked:n.GlobalWorkerOptions.cMapPacked,standardFontDataUrl:n.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:n.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:n.GlobalWorkerOptions.openjpegJsUrl,verbosity:0},o=n.getDocument({...r,...t});return await o.promise}async function c(e,t,n=0,r={}){const o=e.getViewport({scale:t,rotation:n}),i=2048;let a=Math.round(o.width),s=Math.round(o.height);if(a>i||s>i){const e=Math.min(i/a,i/s);a=Math.round(a*e),s=Math.round(s*e)}const c=document.createElement("canvas");c.width=Math.max(1,a),c.height=Math.max(1,s);const l=c.getContext("2d",{alpha:!1,willReadFrequently:!1});r.fillWhite&&(l.fillStyle="#FFFFFF",l.fillRect(0,0,c.width,c.height));const d={canvasContext:l,viewport:e.getViewport({scale:t*(a/o.width),rotation:n}),intent:"display"};return await e.render(d).promise,c}function l(e){const{rgb:t}=PDFLib;3===(e=e.replace("#","")).length&&(e=e.split("").map(e=>e+e).join(""));const n=parseInt(e,16);return t((n>>16&255)/255,(n>>8&255)/255,(255&n)/255)}function d(e){const t=((Number(e)||0)%360+360)%360;return 90*Math.round(t/90)%360}function w(e,t){return console.error(`${t} error:`,e),e&&"PasswordException"===e.name?{thumbnail:"",isPasswordProtected:!0,securityInfo:"パスワード付きPDF"}:{thumbnail:"",isError:!0,securityInfo:"解析失敗"}}function u(e){return/[\u3000-\u30FF\u4E00-\u9FFF\uFF01-\uFF60]/.test(e||"")}class h{constructor(e){this.pdfDoc=e,this.cache={}}async getFont(e,t={}){const{isBold:n=!1,isSerif:r=!1}=t;if(u(e)){const e=r?n?"notoSerifBold":"notoSerifReg":n?"notoSansBold":"notoSansReg";if(!this.cache[e]){const t={notoSerifBold:"/fonts/NotoSerifJP-Bold.ttf",notoSerifReg:"/fonts/NotoSerifJP-Regular.ttf",notoSansBold:"/fonts/NotoSansJP-Bold.ttf",notoSansReg:"/fonts/NotoSansJP-Regular.ttf"},n=await fetch(t[e]).then(e=>e.arrayBuffer());this.cache[e]=await this.pdfDoc.embedFont(n)}return this.cache[e]}{const{StandardFonts:e}=PDFLib;return n?await this.pdfDoc.embedFont(e.HelveticaBold):await this.pdfDoc.embedFont(e.Helvetica)}}}async function m(e,t,n=null){n&&window._pdfCache.markRestricted(n);const i=await s(e),l=await i.getPage(t+1),d=r?.pdfSettings?.scales?.unlock||1.5,w=await c(l,d,0,{fillWhite:!0}),u=o(w.toDataURL("image/png").split(",")[1]),{PDFDocument:h}=PDFLib,m=await h.create(),g=await m.embedPng(u);m.addPage([w.width,w.height]);const[p]=m.getPages();p.drawImage(g,{x:0,y:0,width:w.width,height:w.height});return a(await m.save())}function g(e,t,n,r,o,i){let a,s;switch(i){case"forward":default:a=Math.floor(e/n),s=e%n;break;case"forward-vertical":s=Math.floor(e/t),a=e%t;break;case"reverse-horizontal":a=Math.floor(e/n),s=n-1-e%n;break;case"reverse-vertical":s=n-1-Math.floor(e/t),a=e%t;break;case"reverse":a=t-1-Math.floor(e/n),s=n-1-e%n}return{x:s*r,y:(t-1-a)*o}}async function p(e,t,n,r,o){try{const{PDFDocument:i,PDFName:a}=PDFLib,s=await i.create(),[c]=await s.copyPages(e,[0]);s.addPage(c),c.node.set(a.of("CropBox"),s.context.obj([Math.round(t),Math.round(n),Math.round(t+r),Math.round(n+o)]));const l=await s.save(),d=new Blob([l],{type:"application/pdf"});return URL.createObjectURL(d)}catch(i){return console.error("createVectorTile error:",i),null}}async function f(e,t,n,r,i,a,c){try{const l=await s(e),d=await l.getPage(1),w=2,u=d.getViewport({scale:w,rotation:0}),h=document.createElement("canvas");h.width=Math.max(1,Math.round(u.width)),h.height=Math.max(1,Math.round(u.height));const m=h.getContext("2d",{alpha:!1});m.fillStyle="#FFFFFF",m.fillRect(0,0,h.width,h.height),await d.render({canvasContext:m,viewport:u}).promise;const g=h.width/a,p=h.height/c,f=Math.round(t*g),y=Math.round((c-n-i)*p),v=Math.max(1,Math.round(r*g)),b=Math.max(1,Math.round(i*p)),x=document.createElement("canvas");x.width=v,x.height=b;x.getContext("2d",{alpha:!1}).drawImage(h,f,y,v,b,0,0,v,b);const P=o(x.toDataURL("image/png").split(",")[1]),{PDFDocument:R}=PDFLib,M=await R.create(),S=await M.embedPng(P);M.addPage([v,b]).drawImage(S,{x:0,y:0,width:v,height:b});const F=await M.save(),C=new Blob([F],{type:"application/pdf"});return URL.createObjectURL(C)}catch(l){return console.error("createRasterizedTile error:",l),null}}async function y(e,t,n=0){return new Promise((r,o)=>{const i=new Image;i.onload=function(){const t=e.getContext("2d");if(!t)return void o(new Error("Canvas context not available"));const a=90===n||270===n,s=a?i.height:i.width,c=a?i.width:i.height;e.width=s,e.height=c,t.clearRect(0,0,s,c),t.save(),t.translate(s/2,c/2),t.rotate(n*Math.PI/180),t.translate(-i.width/2,-i.height/2),t.drawImage(i,0,0,i.width,i.height),t.restore(),r()},i.onerror=function(e){console.error("[drawThumbnailToCanvasWithRotation] Image load error:",e),o(new Error("Failed to load image"))},i.src=t.startsWith("data:")?t:`data:image/png;base64,${t}`})}window._pdfCache=new class{constructor(){this.libCache=new Map,this.restrictedFiles=new Set,this.renderingFlags={}}set(e,t){this.libCache.set(e,t)}get(e){return this.libCache.get(e)}has(e){return this.libCache.has(e)}delete(e){this.libCache.delete(e),this.restrictedFiles.delete(e)}clear(){this.libCache.clear(),this.restrictedFiles.clear()}markRestricted(e){this.restrictedFiles.add(e)}isRestricted(e){return this.restrictedFiles.has(e)}clearRestricted(){this.restrictedFiles.clear()}setRendering(e,t){this.renderingFlags[e]=t}isRendering(e){return!!this.renderingFlags[e]}},window._pdfLibCache=window._pdfCache.libCache,window._pdfLibFileRestricted=window._pdfCache.restrictedFiles,window._canvasRendering=window._pdfCache.renderingFlags,window._pdfLibFileIsRestricted=function(e){return window._pdfCache.isRestricted(e)},window._pdfLibCacheClear=function(){return window._pdfCache.clear(),!0},window._pdfLibCacheDelete=function(e){return!!e&&(window._pdfCache.delete(e),!0)},window._pdfLibFileRestrictedClear=function(){return window._pdfCache.clearRestricted(),!0},window.loadConfig=async function(){if(!r){const e=await fetch("/config.json");r=await e.json()}return r},window.loadConfig(),window.embedImageAsPdf=async function(e,t){const{PDFDocument:n}=PDFLib,r=await n.create();let i;const s=o(e);if(t.endsWith(".png"))i=await r.embedPng(s);else if(t.endsWith(".jpg")||t.endsWith(".jpeg"))i=await r.embedJpg(s);else{if(!(t.endsWith(".gif")||t.endsWith(".bmp")||t.endsWith(".webp")||t.endsWith(".svg")))throw new Error("Unsupported image type");{const n=t.endsWith(".gif")?"image/gif":t.endsWith(".bmp")?"image/bmp":t.endsWith(".webp")?"image/webp":t.endsWith(".svg")?"image/svg+xml":"",{pngBase64:a}=await window.convertImageToPngBase64AndSize(e,n);i=await r.embedPng(o(a.split(",")[1]))}}const c=i.scale(1);r.addPage([c.width,c.height]).drawImage(i,{x:0,y:0,width:c.width,height:c.height});return a(await r.save())},window.mergePDFPages=async function(e){const{PDFDocument:t,degrees:n}=PDFLib,r=await t.create();for(let c=0;c<e.length;c++){let o=e[c];const a=i(o.pageData);try{const e=await t.load(a),[i]=await r.copyPages(e,[0]);"object"==typeof o&&o.rotateAngle&&o.rotateAngle%360!=0&&i.setRotation(n(o.rotateAngle)),r.addPage(i)}catch(s){throw console.error(`Error at mergePDFPages index=${c}:`,s),s}}const o=await r.save(),a=new Blob([o],{type:"application/pdf"});return URL.createObjectURL(a)},window.renderFirstPDFPage=async function(e,t){try{const l=i(e);if(l.length<8)throw new Error("Data too short to be valid PDF");const d=String.fromCharCode.apply(null,l.slice(0,8));if(!d.startsWith("%PDF-"))throw new Error(`Invalid PDF header: ${d}`);let u=null,h=!1,m=null;const g=[{stopAtErrors:!1,maxImageSize:-1,disableFontFace:!0,disableRange:!0,disableStream:!0,verbosity:0},{stopAtErrors:!1,maxImageSize:-1,disableFontFace:!1,disableRange:!0,disableStream:!1,verbosity:0},{stopAtErrors:!1,maxImageSize:-1,verbosity:0}];for(let R=0;R<g.length;R++)try{u=await s(l,{...g[R],password:t||void 0});break}catch(n){if(m=n,n&&"PasswordException"===n.name){h=!0;break}if(R===g.length-1)throw m}if(h||!u)return{thumbnail:"",isPasswordProtected:!0,securityInfo:"パスワード付きPDF"};const p=await u.getPage(1);let f=0;try{"function"==typeof p.getRotation?f=p.getRotation():void 0!==p.rotate&&(f=p.rotate)}catch(r){f=0}f=((Number(f)||0)%360+360)%360;const y=p.getViewport({scale:1,rotation:0}),v=200,b=v/y.width;let x="";try{const M=c(p,b,0),S=new Promise((e,t)=>setTimeout(()=>t(new Error("Thumbnail rendering timeout")),1e4));x=(await Promise.race([M,S])).toDataURL("image/png")}catch(o){console.error("Thumbnail rendering failed:",o);try{const F=v/2/y.width;x=(await c(p,F,0)).toDataURL("image/png")}catch(a){console.error("Fallback thumbnail rendering also failed:",a),x=""}}let P=[];try{const C=await u.getOutline();if(C&&C.length){async function L(e){const t=[];for(const n of e){let e=null;try{let t=n.dest;if("string"==typeof t&&(t=await u.getDestination(t)),Array.isArray(t)&&t.length>0)try{e=await u.getPageIndex(t[0])}catch(r){e=null}}catch(r){}const o={title:n.title||"",pageIndex:null!==e?e:-1,items:[]};n.items&&n.items.length&&(o.items=await L(n.items)),t.push(o)}return t}P=await L(C)}}catch(r){console.error("pdf: outline extraction failed",r)}return{thumbnail:x,isPasswordProtected:!1,securityInfo:"",bookmarks:P,pageRotation:f}}catch(n){return console.error("renderFirstPDFPage error:",n),w(n,"renderFirstPDFPage")}},window.generatePdfThumbnailFromFileMetaData=async function(e,t){try{const n=i(e),o=await s(n),a=await o.getPage(t+1),l=await c(a,r.pdfSettings.scales.thumbnail,0);return{thumbnail:l.toDataURL("image/png"),isError:!1,isPasswordProtected:!1,securityInfo:""}}catch(n){return w(n,"generatePdfThumbnailFromFileMetaData")}},window.convertImageToPngBase64AndSize=function(e,t){return new Promise((n,r)=>{const o=new Image;o.onload=function(){const e=document.createElement("canvas");e.width=o.width||800,e.height=o.height||600;e.getContext("2d").drawImage(o,0,0);const t=e.toDataURL("image/png");n({pngBase64:t,width:o.width,height:o.height})},o.onerror=r,e.startsWith("data:")?o.src=e:o.src=t?`data:${t};base64,${e}`:`data:image/png;base64,${e}`})},window.getPDFPageCount=async function(e){try{const t=i(e);return(await s(t,{stopAtErrors:!1,verbosity:1})).numPages}catch(t){throw console.error("Error in getPDFPageCount:",t),t}},window.createBlankPage=async function(){try{const{PDFDocument:e}=PDFLib,t=await e.create();t.addPage([595.28,841.89]);return a(await t.save())}catch(e){return console.error("Error creating blank page:",e),""}},window.extractPdfPage=async function(e,t,n=null){try{const{PDFDocument:s}=PDFLib,c=i(e);let l=null;if(n&&window._pdfCache.has(n))l=window._pdfCache.get(n);else try{l=await s.load(c),n&&window._pdfCache.set(n,l)}catch(r){return await m(c,t,n)}const d=await s.create();try{if(n&&window._pdfCache.isRestricted(n))throw new Error("file-restricted-precheck");const[e]=await d.copyPages(l,[t]);d.addPage(e)}catch(o){return await m(c,t,n)}return a(await d.save())}catch(s){return console.error(`Error extracting PDF page ${t}:`,s),await window.createBlankPage()}},window.generatePdfThumbnailFromPageData=async function(e){try{const t=o(e),n=await s(t),i=await n.getPage(1);return(await c(i,r.pdfSettings.scales.thumbnail)).toDataURL("image/png")}catch(t){return console.error("Error rendering single PDF page:",t),""}},window.generatePreviewImage=async function(e,t){const n=o(e),i=await s(n,{maxImageSize:-1,verbosity:0}),a=await i.getPage(1);return(await c(a,r.pdfSettings.scales.normal,t||0)).toDataURL("image/jpeg",.85)},window.getPdfFileSize=async function(e){const t=await fetch(e);return((await t.blob()).size/1048576).toFixed(2)+"MB"},window.downloadFileFromUrl=function(e,t,n){const r=document.createElement("a");r.href=e,r.download=t,r.type=n||"application/octet-stream",document.body.appendChild(r),r.click(),document.body.removeChild(r)},window.renderPdfPages=async function(e,t){if(!window.pdfjsLib)return void console.error("pdfjsLib is not loaded");const n=await s(await fetch(e).then(e=>e.arrayBuffer()).then(e=>new Uint8Array(e)));for(let o=0;o<t.length;o++){const e=await n.getPage(o+1),i=document.getElementById(t[o]);if(!i)continue;const a=e.getViewport({scale:r.pdfSettings.scales.normal});i.width=a.width,i.height=a.height;const s=i.getContext("2d");await e.render({canvasContext:s,viewport:a}).promise}},window.checkCanvasExists=function(e){return!!document.getElementById(e)},window.renderPdfThumbnailToCanvas=async function(e,t){if(!window.pdfjsLib)throw new Error("pdfjsLib is not loaded.");if(window._pdfCache.isRendering(t))return console.warn("render in progress, skipping:",t),!1;window._pdfCache.setRendering(t,!0);try{const n=await fetch(e),o=await n.arrayBuffer(),i=new Uint8Array(o),a=await s(i),c=await a.getPage(1),l=c.getViewport({scale:r.pdfSettings.scales.thumbnail}),d=document.getElementById(t);if(!d)return console.warn("canvas not found:",t),!1;const w=d.getContext("2d");return d.width=l.width,d.height=l.height,w.clearRect(0,0,d.width,d.height),await c.render({canvasContext:w,viewport:l}).promise,!0}catch(n){return console.error("renderPdfThumbnailToCanvas error",n,e,t),!1}finally{window._pdfCache.setRendering(t,!1)}},window.drawImageToCanvas=function(e,t,n=!0){const r=document.getElementById(e);if(!r)return;const o=r.getContext("2d"),i=new window.Image;i.crossOrigin="anonymous",i.onload=function(){try{const e=r.parentElement||document.body,t=window.getComputedStyle(e),a=parseFloat(t.paddingLeft)||0,s=parseFloat(t.paddingRight)||0,c=parseFloat(t.paddingTop)||0,l=parseFloat(t.paddingBottom)||0,d=Math.max(1,e.clientWidth-a-s),w=Math.max(1,e.clientHeight-c-l),u=Math.max(1,i.width||1),h=Math.max(1,i.height||1),m=u/h;let g,p;m>d/w?(g=d,p=Math.max(1,Math.round(d/m))):(p=w,g=Math.max(1,Math.round(w*m)));const f=n&&window.devicePixelRatio||1;r.style.width=g+"px",r.style.height=p+"px",r.width=Math.max(1,Math.round(g*f)),r.height=Math.max(1,Math.round(p*f)),o.setTransform(f,0,0,f,0,0),o.imageSmoothingEnabled=!0,o.imageSmoothingQuality="high",o.clearRect(0,0,g,p);const y=Math.min(g/u,p/h),v=u*y,b=h*y,x=Math.round((g-v)/2),P=Math.round((p-b)/2);o.drawImage(i,0,0,u,h,x,P,v,b)}catch(e){console.debug("drawImageToCanvas error",e)}},i.onerror=function(e){console.debug("drawImageToCanvas image load error",e,t)},i.src=t},window.unlockPdf=async function(e,t){const n=i(e),o=await s(n,{password:t}),{PDFDocument:l}=PDFLib,d=await l.create();for(let i=1;i<=o.numPages;i++){const e=await o.getPage(i),t=await c(e,r.pdfSettings.scales.unlock,0,{fillWhite:!0}),n=t.toDataURL("image/png"),a=await d.embedPng(n);d.addPage([t.width,t.height]).drawImage(a,{x:0,y:0,width:t.width,height:t.height})}return a(await d.save())},window.editPdfPageWithElements=async function(e,t){const{PDFDocument:n,rgb:r,StandardFonts:i}=PDFLib;if(!PDFLib._fontkitRegistered){if(!window.fontkit)throw new Error("fontkitがロードされていません。");PDFLib.PDFDocument.prototype.registerFontkit(window.fontkit),PDFLib._fontkitRegistered=!0}const s=o(e),c=await n.load(s),d=c.getPage(0),w=d.getHeight();let u=[];try{u=JSON.parse(t)}catch(g){console.error("editJson parse error",g,t)}const m=new h(c);for(const a of u)if(0===a.Type||"Text"===a.Type){let e=function(e,t,n,r){if(!e)return[""];const o=[],i=e.split(/(\s+)/);let a="";for(const s of i){const e=t.widthOfTextAtSize(s,n);if((a?t.widthOfTextAtSize(a,n):0)+e<=r)a+=s;else if(a&&o.push(a),e<=r)a=s;else{let e="";for(let i=0;i<s.length;i++){e+=s[i];t.widthOfTextAtSize(e,n)>r&&(e.length>1?(o.push(e.slice(0,-1)),e=e.slice(-1)):(o.push(e),e=""))}a=e}}return a&&o.push(a),o};const t=await m.getFont(a.Text,{isBold:a.IsBold,isSerif:(a.FontFamily||"").toLowerCase().includes("notoserif")}),n=PDFLib.degrees(a.Rotation||0),r=Number(a.FontSize)||16,o=(void 0!==a.LineHeight&&a.LineHeight>0?Number(a.LineHeight):null)||r,i=a.Text||"",s="number"==typeof a.X?a.X:0,c="number"==typeof a.Width&&a.Width>0?Number(a.Width):d.getWidth()-s,u=i.split("\n"),h=[];for(const a of u){const n=e(a,t,r,c);0===n.length?h.push(""):h.push(...n)}const g=w-(a.Y||0)-r;for(let w=0;w<h.length;w++)d.drawText(h[w]||"",{x:s,y:g-w*o,size:r,font:t,color:l(a.Color||"#000000"),rotate:n})}else if(1===a.Type||"Image"===a.Type)if(a.ImageUrl&&(a.ImageUrl.startsWith("data:image/png")||a.ImageUrl.startsWith("data:image/jpeg"))){let e,t=a.ImageUrl.split(",")[1]||a.ImageUrl;a.ImageUrl.startsWith("data:image/png")?e=await c.embedPng(o(t)):a.ImageUrl.startsWith("data:image/jpeg")&&(e=await c.embedJpg(o(t)));const n=PDFLib.degrees(a.Rotation||0);d.drawImage(e,{x:a.X||0,y:w-(a.Y||0)-(a.Height||e.height),width:a.Width||e.width,height:a.Height||e.height,rotate:n})}else console.warn("未対応画像形式: ",a.ImageUrl?a.ImageUrl.substring(0,30):"");return a(await c.save())},window.getPdfPageSize=async function(e){try{const t=o(e),n=(await PDFLib.PDFDocument.load(t)).getPage(0),{width:r,height:i}=n.getSize();return{width:r,height:i}}catch(t){return console.error("Error getting PDF page size:",t),{width:595,height:842}}},window.addStampsToPdf=async function(e,t){const{PDFDocument:n,rgb:r,StandardFonts:o,degrees:i}=PDFLib;PDFLib._fontkitRegistered||(window.fontkit?(PDFLib.PDFDocument.prototype.registerFontkit(window.fontkit),PDFLib._fontkitRegistered=!0):console.warn("fontkitがロードされていません。日本語フォントは使用できません。"));const a=((t.length>0&&t[0].rotateAngle||0)%360+360)%360,s=await n.load(e),c=s.getPage(0),{width:l,height:d}=c.getSize();function w(e,t,n,r,o,i,a,s){let c=0,l=0,d=0;const w=(r%360+360)%360;if(0===w){switch(e){case"TopLeft":c=t,l=i-n-s;break;case"Top":c=o/2-a/2,l=i-n-s;break;case"TopRight":c=o-t-a,l=i-n-s;break;case"BottomLeft":c=t,l=n;break;case"Bottom":c=o/2-a/2,l=n;break;case"BottomRight":c=o-t-a,l=n}d=0}else if(90===w){switch(e){case"TopLeft":c=n,l=t;break;case"Top":c=n,l=i/2-a/2;break;case"TopRight":c=n,l=i-t-a;break;case"BottomLeft":c=o-n,l=t;break;case"Bottom":c=o-n,l=i/2-a/2;break;case"BottomRight":c=o-n,l=i-t-a}d=90}else if(180===w){switch(e){case"TopLeft":c=o-t,l=n;break;case"Top":c=o/2-a/2,l=n;break;case"TopRight":c=t+a,l=n;break;case"BottomLeft":c=o-t,l=i-n;break;case"Bottom":c=o/2-a/2,l=i-n;break;case"BottomRight":c=t+a,l=i-n}d=180}else if(270===w){switch(e){case"TopLeft":c=o-n,l=i-t;break;case"Top":c=o-n,l=i/2-a/2;break;case"TopRight":c=o-n,l=t+a;break;case"BottomLeft":c=n,l=i-t;break;case"Bottom":c=n,l=i/2-a/2;break;case"BottomRight":c=n,l=t+a}d=-90}return{x:c,y:l,textRotation:d}}const h=new Set;for(const f of t){const e=f.text||"",t=f.fontFamily||"NotoSansJP",n=f.isBold||!1;u(e)?t.includes("Serif")?h.add(n?"NotoSerifJP-Bold":"NotoSerifJP-Regular"):h.add(n?"NotoSansJP-Bold":"NotoSansJP-Regular"):"NotoSansJP"===t?h.add(n?"NotoSansJP-Bold":"NotoSansJP-Regular"):"NotoSerifJP"===t&&h.add(n?"NotoSerifJP-Bold":"NotoSerifJP-Regular")}const m={};for(const u of h)try{const e=`/fonts/${u}.ttf`,t=await fetch(e).then(e=>e.arrayBuffer());m[u]=await s.embedFont(t,{subset:!1})}catch(g){console.warn(`フォント読み込み失敗: ${u}`,g)}for(const f of t){let e=f.text||"";if(!e){console.warn("Empty text, skipping stamp");continue}const t=f.fontFamily||"NotoSansJP",n=f.isBold||!1;let h;if(u(e)){let e;e=t.includes("Serif")?n?"NotoSerifJP-Bold":"NotoSerifJP-Regular":n?"NotoSansJP-Bold":"NotoSansJP-Regular",h=m[e],h||(console.error("日本語フォントが読み込まれていません"),h=await s.embedFont(o.Helvetica))}else if("NotoSansJP"===t){h=m[n?"NotoSansJP-Bold":"NotoSansJP-Regular"]||await s.embedFont(n?o.HelveticaBold:o.Helvetica)}else if("NotoSerifJP"===t){h=m[n?"NotoSerifJP-Bold":"NotoSerifJP-Regular"]||await s.embedFont(n?o.TimesRomanBold:o.TimesRoman)}else h="Helvetica"===t?await s.embedFont(n?o.HelveticaBold:o.Helvetica):"TimesRoman"===t?await s.embedFont(n?o.TimesRomanBold:o.TimesRoman):"monospace"===t?await s.embedFont(n?o.CourierBold:o.Courier):"serif"===t?await s.embedFont(n?o.TimesRomanBold:o.TimesRoman):await s.embedFont(n?o.HelveticaBold:o.Helvetica);const g=f.fontSize||12,y=h.widthOfTextAtSize(e,g),v=g*.2,b=w(f.corner,f.offsetX,f.offsetY+v,a,l,d,y,g),x=f.color?r(f.color.r||0,f.color.g||0,f.color.b||0):r(0,0,0);try{c.drawText(e,{x:b.x,y:b.y,size:g,font:h,color:x,rotate:i(b.textRotation)})}catch(p){throw console.error("スタンプ描画エラー:",p),p}}return await s.save({useObjectStreams:!0})},window.cropPdfPageRasterized=async function(e,t,n,i,c,l=0){try{const w=o(e),u=await s(w),h=await u.getPage(1),m=h.getViewport({scale:1,rotation:0}),g=m.width,p=m.height,f=d(l),y=r?.pdfSettings?.scales?.unlock||1.5,v=Math.max(0,Math.min(1,Number(t)||0)),b=Math.max(0,Math.min(1,Number(n)||0)),x=Math.max(0,Math.min(1,Number(i)||0)),P=Math.max(0,Math.min(1,Number(c)||0)),R=v*g,M=p*(1-b-P),S=R+x*g,F=M+P*p,C=h.getViewport({scale:y,rotation:f}),L=document.createElement("canvas");L.width=Math.max(1,Math.round(C.width)),L.height=Math.max(1,Math.round(C.height));const A=L.getContext("2d",{alpha:!1});await h.render({canvasContext:A,viewport:C}).promise;const E=L.width/g,T=L.height/p,I=Math.round(R*E),_=Math.round((p-F)*T),D=Math.max(1,Math.round((S-R)*E)),k=Math.max(1,Math.round((F-M)*T)),z=document.createElement("canvas");z.width=D,z.height=k;z.getContext("2d",{alpha:!1}).drawImage(L,I,_,D,k,0,0,D,k);const B=z.toDataURL("image/png"),N=o(B.split(",")[1]),{PDFDocument:O}=PDFLib,H=await O.create(),W=await H.embedPng(N);H.addPage([D,k]).drawImage(W,{x:0,y:0,width:D,height:k});return a(await H.save())}catch(w){return console.error("cropPdfPageRasterized error",w),e||""}},window.cropPdfPageToTrimVector=async function(e,t,n,r,i,s=0){try{const c=o(e),{PDFDocument:l,PDFName:w}=PDFLib,u=await l.load(c),h=u.getPages()[0],m=h.getWidth(),g=h.getHeight(),p=Math.max(0,Math.min(1,Number(t)||0)),f=Math.max(0,Math.min(1,Number(n)||0)),y=Math.max(0,Math.min(1,Number(r)||0)),v=Math.max(0,Math.min(1,Number(i)||0)),b=d(s);let x,P,R,M;if(0===b)x=p*m,P=g*(1-f-v),R=x+y*m,M=P+v*g;else{let e=function(e,t){const n=e-s,r=c-t;return{x:n*u-r*h+l,y:n*h+r*u+d}};const t=b%180==0?m:g,n=b%180==0?g:m,r=p*t,o=f*n,i=Math.max(1,y*t),a=Math.max(1,v*n),s=t/2,c=n/2,l=m/2,d=g/2,w=-b*Math.PI/180,u=Math.cos(w),h=Math.sin(w),S=e(r,o),F=e(r+i,o),C=e(r,o+a),L=e(r+i,o+a),A=[S.x,F.x,C.x,L.x],E=[S.y,F.y,C.y,L.y];x=Math.min(...A),P=Math.min(...E),R=Math.max(...A),M=Math.max(...E)}const S=Math.max(0,Math.min(m,Math.round(x))),F=Math.max(0,Math.min(g,Math.round(P))),C=Math.max(0,Math.min(m,Math.round(R))),L=Math.max(0,Math.min(g,Math.round(M))),A=await l.create(),[E]=await A.copyPages(u,[0]);A.addPage(E),E.node.set(w.of("CropBox"),A.context.obj([S,F,C,L]));return a(await A.save())}catch(c){return console.error("cropPdfPageToTrimVector error",c),e||""}},window.getImageSizeFromDataUrl=function(e){return new Promise(t=>{try{if(!e)return void t([0,0]);const n=new Image;n.onload=function(){t([n.naturalWidth||0,n.naturalHeight||0])},n.onerror=function(){t([0,0])},n.src=e,setTimeout(()=>{n.complete||t([0,0])},2e3)}catch(n){t([0,0])}})},window.cropPdfPageToImage=async function(e,t,n,r,i,a=0,c=150){try{const l=o(e),w=await s(l),u=await w.getPage(1),h=u.getViewport({scale:1,rotation:0}),m=h.width,g=h.height,p=d(a),f=c/72,y=Math.max(0,Math.min(1,Number(t)||0)),v=Math.max(0,Math.min(1,Number(n)||0)),b=Math.max(0,Math.min(1,Number(r)||0)),x=Math.max(0,Math.min(1,Number(i)||0)),P=y*m,R=g*(1-v-x),M=P+b*m,S=R+x*g,F=u.getViewport({scale:f,rotation:p}),C=document.createElement("canvas");C.width=Math.max(1,Math.round(F.width)),C.height=Math.max(1,Math.round(F.height));const L=C.getContext("2d",{alpha:!1});L.fillStyle="#FFFFFF",L.fillRect(0,0,C.width,C.height),await u.render({canvasContext:L,viewport:F}).promise;const A=C.width/m,E=C.height/g,T=Math.round(P*A),I=Math.round((g-S)*E),_=Math.max(1,Math.round((M-P)*A)),D=Math.max(1,Math.round((S-R)*E)),k=document.createElement("canvas");k.width=_,k.height=D;const z=k.getContext("2d",{alpha:!1});return z.fillStyle="#FFFFFF",z.fillRect(0,0,_,D),z.drawImage(C,T,I,_,D,0,0,_,D),k.toDataURL("image/png")}catch(l){throw console.error("cropPdfPageToImage error:",l),l}},window.drawVisibleCanvases=function(e){const t=document.getElementById(e);if(!t)return;const n=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const t=e.target;t.dataset.itemId;const r=t.dataset.thumbnail;r&&!t.dataset.drawn&&(window.drawImageToCanvas(t.id,r),t.dataset.drawn="true",n.unobserve(t))}})},{rootMargin:"200px"});t.querySelectorAll("canvas[data-thumbnail]").forEach(e=>{n.observe(e)})},window.createNUpPdf=async function(e,t,n,r,i=!1){try{const{PDFDocument:c,rgb:l,degrees:d,PDFName:w,PDFArray:u,PDFNumber:h}=PDFLib,m=[];for(let t=0;t<e.length;t++){const n=e[t];try{const e=o(n.pageData),r=await c.load(e),i=r.getPage(0),a=i.node;if(a.lookup(w.of("Contents")))m.push({pdf:r,rotateAngle:n.rotateAngle||0,isBlank:!1});else{console.warn(`[createNUpPdf] Page ${t+1} has no Contents, creating blank page with content`);const{width:e,height:r}=i.getSize(),o=await c.create();o.addPage([e,r]).drawRectangle({x:0,y:0,width:e,height:r,color:l(1,1,1),opacity:1}),m.push({pdf:o,rotateAngle:n.rotateAngle||0,isBlank:!0})}}catch(a){console.error(`[createNUpPdf] Error loading page ${t+1}:`,a),m.push(null)}}const{rows:p,cols:f}=function(e,t){const n="landscape"===t;switch(e){case 2:return n?{rows:1,cols:2}:{rows:2,cols:1};case 4:return{rows:2,cols:2};case 8:return n?{rows:2,cols:4}:{rows:4,cols:2};case 16:return{rows:4,cols:4};default:return{rows:2,cols:1}}}(t,r),y=m.filter(e=>null!==e);if(0===y.length)throw new Error("No valid pages to process");let v=0,b=0;y.forEach(e=>{const t=e.pdf.getPage(0),{width:n,height:r}=t.getSize();v+=n,b+=r});const x=v/y.length,P=b/y.length,R=x*f,M=P*p,S=R/f,F=M/p,C=function(e,t,n,r){const o=[];for(let i=0;i<t;i++)for(let a=0;a<n;a++){let s;switch(r){case"forward":default:s=i*n+a;break;case"forward-vertical":s=a*t+i;break;case"reverse-horizontal":s=i*n+(n-1-a);break;case"reverse-vertical":s=(n-1-a)*t+i;break;case"reverse":s=(t-1-i)*n+(n-1-a)}s<e&&o.push(s)}return o}(m.length,p,f,n),L=await c.create(),A=L.addPage([R,M]);A.drawRectangle({x:0,y:0,width:R,height:M,color:l(1,1,1)});for(let e=0;e<C.length;e++){const t=C[e];if(t>=m.length||null===m[t])continue;const r=m[t];try{const[t]=await L.embedPdf(r.pdf,[0]),{width:o,height:i}=t,{x:a,y:s}=g(e,p,f,S,F,n),c=S/o,l=F/i,d=Math.min(c,l),w=(S-o*d)/2,u=(F-i*d)/2;A.drawPage(t,{x:a+w,y:s+u,width:o*d,height:i*d})}catch(s){throw console.error(`[createNUpPdf] Error embedding page ${t+1}:`,s),s}}if(i){for(let e=1;e<f;e++){const t=e*S;A.drawLine({start:{x:t,y:0},end:{x:t,y:M},thickness:1,color:l(.7,.7,.7),opacity:.5})}for(let e=1;e<p;e++){const t=e*F;A.drawLine({start:{x:0,y:t},end:{x:R,y:t},thickness:1,color:l(.7,.7,.7),opacity:.5})}}const E=await L.save(),T=new Blob([E],{type:"application/pdf"});return URL.createObjectURL(T)}catch(a){throw console.error("[createNUpPdf] Fatal error:",a),console.error("[createNUpPdf] Stack trace:",a.stack),a}},window.splitPdfPageIntoTiles=async function(e,t,n,r=!1){try{const{PDFDocument:i}=PDFLib,a=o(e),s=await i.load(a),c=s.getPage(0),{width:l,height:d}=c.getSize(),{rows:w,cols:u}=function(e,t){const n="horizontal"===t;switch(e){case 2:return n?{rows:2,cols:1}:{rows:1,cols:2};case 4:default:return{rows:2,cols:2};case 8:return n?{rows:4,cols:2}:{rows:2,cols:4};case 16:return{rows:4,cols:4}}}(t,n),h=l/u,m=d/w,g=[];for(let e=0;e<w;e++)for(let t=0;t<u;t++){const n=t*h,o=d-(e+1)*m;let i;i=r?await f(a,n,o,h,m,l,d):await p(s,n,o,h,m),i&&g.push(i)}return g}catch(i){throw console.error("splitPdfPageIntoTiles error:",i),i}},window.drawNUpCanvases=async function(e){const t=document.getElementById(e);if(!t)return void console.warn("[drawNUpCanvases] Container not found:",e);const n=t.querySelectorAll("canvas[data-thumbnail]");for(const o of n){const e=o.getAttribute("data-thumbnail"),t=parseInt(o.getAttribute("data-rotate-angle")||"0",10);if(e)try{o.classList.remove("thumbnail-loaded"),await y(o,e,t),o.classList.add("thumbnail-loaded")}catch(r){console.error("[drawNUpCanvases] Failed to draw thumbnail:",r,o.id)}}},window.getCanvasNaturalSize=function(e){try{const t=document.getElementById(e);return t?[t.width,t.height]:[0,0]}catch(t){return console.error("getCanvasNaturalSize error",t),[0,0]}},window.setCanvasSize=function(e,t,n){try{const r=document.getElementById(e);return!!r&&(r.naturalWidth=t,r.naturalHeight=n,r.style.width=t+"px",r.style.height=n+"px",!0)}catch(r){return console.error("setCanvasSize error",r),!1}},window.scrollToSection=function(e){e&&e.scrollIntoView({behavior:"smooth"})};let v=null;window.isSorting=!1;let b=null;window.initializeSortable=function(e){function t(){return document.getElementById("sortable-container")}function n(){const e=t();e&&(e.classList.remove("is-sorting","dragging-chosen","dragging-ghost"),e.querySelectorAll(".dragging-chosen, .dragging-ghost").forEach(e=>{e.classList.remove("dragging-chosen","dragging-ghost")})),window.isSorting=!1}b=e,window.removeEventListener("mouseup",n),window.removeEventListener("touchend",n);const r=t();r&&"none"!==window.getComputedStyle(r).display&&window.Sortable?(v&&(v.destroy(),v=null,r.classList.remove("is-sorting"),window.isSorting=!1),window.addEventListener("mouseup",n),window.addEventListener("touchend",n),v=new Sortable(r,{draggable:".sortable-item-container",handle:window.matchMedia("(min-width: 768px)").matches?".drag-handle":".touch-drag-handle",filter:".non-sortable",animation:150,ghostClass:"dragging-ghost",chosenClass:"dragging-chosen",onStart:function(e){r.classList.add("is-sorting"),window.isSorting=!0},onMove:function(e){const t=e.related,n=e.dragged;if(t&&t.classList.contains("non-sortable")){const e=t,o=e.previousElementSibling;return o&&o.classList.contains("sortable-chosen"),r.insertBefore(n,e),!1}if(t&&t.closest(".non-sortable")){const e=t.closest(".non-sortable");return r.insertBefore(n,e),!1}if(!t||t===r){const e=r.querySelector(".non-sortable");return e&&r.insertBefore(n,e),!1}return!0},onEnd:function(e){n();const t=r.querySelectorAll(".sortable-item-container:not(.non-sortable)").length;let o=e.newIndex;e.newIndex>=t&&(o=t-1),b&&b.invokeMethodAsync("UpdateOrder",e.oldIndex,o)}})):v&&v.el&&(v.destroy(),v=null,n())},function(){const e="ncp_tour_ran",t="home-intro-v1";function n(){const e=["undefined"!=typeof window&&window.innerWidth<768?{id:"nav-explain",selector:"#nav-hamburger",title:"メニュー表示",text:"機能の切替メニューを表示できます。すぐに利用される方はこちらから。",position:"right",group:t}:{id:"nav-explain",selector:"#nav-main",title:"切替メニュー",text:"機能の切替メニューです。すぐに利用される方は，目的の機能をクリックしてください。",position:"right",group:t},{id:"home-tip",selector:"#home-summary-tip",title:"概要",text:"このページ下部にアプリの概要があります。",position:"top",group:t}];try{const n=document.querySelector("#install-pwa-btn");n&&function(e){try{if(!e)return!1;const t=window.getComputedStyle(e);return t&&"none"!==t.display}catch(t){return!1}}(n)&&e.push({id:"install-pwa",selector:"#install-pwa-btn",title:"インストール",text:"アプリのショートカットを作成できます。",position:"left",group:t})}catch(n){console.debug("tour: check install-pwa failed",n)}return e}function r(){try{const e=document.getElementById("ncp-tour-dontshow");e&&e.checked&&setEnabled(!1)}catch(e){}}async function o(){try{await function(e="#install-pwa-btn-flag",t=1e3,n=100){return new Promise(r=>{const o=Date.now(),i=()=>{try{const t=document.querySelector(e);if(t){const e=(t.value||"").toString().toLowerCase();if("true"===e)return r(!0);if("false"===e)return r(!1)}}catch(a){}if(Date.now()-o>=t)return r(!1);setTimeout(i,n)};i()})}("#install-pwa-btn-flag",1e3,100)}catch(a){}const o=n();!function(){try{document.querySelectorAll(".tg-backdrop, .tg-dialog").forEach(e=>{try{e.remove()}catch(a){}})}catch(a){}window._ncpTour&&(window._ncpTour.client=null)}();const i=window.tourguide?.TourGuideClient||window.TourGuideClient||window.tourguide||null;if("function"==typeof i||i&&"object"==typeof i)try{const n=o.map((e,t)=>{const n=document.querySelector(e.selector);return{title:e.title||"",content:e.text||"",target:n||e.selector,order:e.order??t+1,group:e.group??void 0}}),i={nextLabel:"次へ",prevLabel:"戻る",finishLabel:"終了",onAfterExit:r,completeOnFinish:!0},s=new tourguide.TourGuideClient({steps:n,...i});if(s){s.onFinish(async()=>{r()}),s.isFinished(t)||s.start(t);try{!function(){try{sessionStorage.setItem(e,"true")}catch(a){}}()}catch(a){}}return!0}catch(a){console.debug("tour: TourGuideClient init failed",a)}return console.debug("tour: no compatible start method found"),!1}window.startTourIfNeeded=async function(n={}){if((new tourguide.TourGuideClient).isFinished(t))return;if(!function(){const e=(document.querySelector("base")?.getAttribute("href")||"/").replace(/\/$/,""),t=location.pathname.replace(new RegExp("^"+e),"")||"/";return"/"===t||""===t}())return;if(function(){try{return"true"===sessionStorage.getItem(e)}catch(t){return!1}}())return;await o()},window._ncpTour={startTourIfNeeded:window.startTourIfNeeded}}();function x(){const e=window.innerWidth||document.documentElement.clientWidth,t=e<768,n=document.querySelector(".sidebar"),r=n&&!t?Math.round(n.getBoundingClientRect().width):0;return{vw:e,sidebarW:r,avail:Math.max(0,e-r)}}function P(e,t){const n=Math.max(150,Math.round(t-260)),r=Math.min(n,600);return Math.max(150,Math.min(r,Math.round(e)))}function R(e,t){try{const n=document.getElementById("thumbnail-area"),r=n?.parentElement?.querySelector(".overflow-auto");if(!n)return;if(n.style.width=e+"px",n.style.flex="none",r){const n=Math.max(260,t-e-4);r.style.width=n+"px",r.style.flex="none"}window._trimResize&&(window._trimResize.lastAppliedLeft=e,window._trimResize.lastAvail=t),requestAnimationFrame(()=>{try{"function"==typeof window.adjustAutoFitIfNeeded&&window.adjustAutoFitIfNeeded()}catch(e){}})}catch(n){console.error("applyLeftPanelWidth error",n)}}function M(){try{if(window._trimShared||(window._trimShared={}),window._trimShared._handlerRegistered)return;window._trimShared.debounceMs=Math.max(150,Number(window._trimShared.debounceMs)||350);let e=null;const t=function(){try{e&&clearTimeout(e),e=setTimeout(()=>{try{const e=window._simpleTrim||{};if(Object.keys(e).forEach(t=>{try{const n=e[t];n&&n.internal&&"function"==typeof n.internal.onAnyScrollOrResize&&n.internal.onAnyScrollOrResize()}catch(n){}}),window._trimResize&&"function"==typeof window._trimResize.windowResizeCallback)try{window._trimResize.windowResizeCallback()}catch(t){console.error("windowResizeCallback error",t)}}catch(t){console.error("shared resize handler inner error",t)}finally{e=null}},window._trimShared.debounceMs),window._trimShared.timer=e}catch(t){console.error("shared resize handler schedule error",t)}};window.addEventListener("resize",t,{passive:!0}),window.visualViewport&&window.visualViewport.addEventListener&&(window.visualViewport.addEventListener("resize",t,{passive:!0}),window.visualViewport.addEventListener("scroll",t,{passive:!0})),window._trimShared._handlerRegistered=!0,window._trimShared._onResizeHandler=t}catch(e){console.error("ensureSharedTrimResizeHandler error",e)}}window.registerPanelResize=function(e,t){try{let r=function(e){return e.sidebarW||0};if(window._trimResize&&window._trimResize.cleanupForHandle){try{window._trimResize.cleanupForHandle()}catch(n){}window._trimResize.cleanupForHandle=null}window._trimResize.dotNetRef=e;const o=document.getElementById(t);if(!o)return void console.warn("registerPanelResize: handle element not found:",t);let i=!1,a=0;const s=function(e){try{try{window._trimResize.suspendFitZoom=!0}catch(t){}o.setPointerCapture?.(e.pointerId);const n=function(e){a=e.clientX,i||(i=!0,requestAnimationFrame(function(){i=!1;try{const e=x(),t=r(e),n=Math.round(a-t);R(P(n,e.avail),e.avail)}catch(e){console.error("onPointerMove error",e)}}))},s=function(e){try{o.releasePointerCapture?.(e.pointerId);const t=x(),n=r(t),a=P(Math.round(e.clientX-n),t.avail);if(window._trimResize&&window._trimResize.dotNetRef&&window._trimResize.dotNetRef.invokeMethodAsync)try{window._trimResize.dotNetRef.invokeMethodAsync("CommitPanelWidth",a).catch(()=>{})}catch(i){}R(a,t.avail)}catch(a){console.error("onPointerUp error",a)}finally{try{window._trimResize.suspendFitZoom=!1}catch(t){}o.removeEventListener("pointermove",n),o.removeEventListener("pointerup",s)}};o.addEventListener("pointermove",n),o.addEventListener("pointerup",s)}catch(n){console.error("onPointerDown error",n)}};o.addEventListener("pointerdown",s),window._trimResize.cleanupForHandle=function(){try{o.removeEventListener("pointerdown",s)}catch(n){}window._trimResize.dotNetRef=null}}catch(n){console.error("registerPanelResize error",n)}},window.unregisterPanelResize=function(){try{window._trimResize.cleanupForHandle&&(window._trimResize.cleanupForHandle(),window._trimResize.cleanupForHandle=null),window._trimResize.dotNetRef=null}catch(e){console.error("unregisterPanelResize error",e)}},window.registerWindowResize=function(e,t=350,n=!1){try{let o=function(){try{const t=x(),n=Math.round(.25*t.avail);R(P(n,t.avail),t.avail),requestAnimationFrame(()=>{try{"function"==typeof window.adjustAutoFitIfNeeded&&window.adjustAutoFitIfNeeded()}catch(e){}});const r=window._trimResize&&window._trimResize.windowResizeDotNetRef;if(r&&"function"==typeof r.invokeMethodAsync)try{r.invokeMethodAsync("OnWindowResizedFromJs",t.avail,t.sidebarW).catch(()=>{})}catch(e){}}catch(e){console.error("measureAndNotify error",e)}};if(!e)return!1;if(window._trimResize||(window._trimResize={}),window._trimResize.windowResizeDotNetRef=e,window._trimShared=window._trimShared||{},window._trimShared.debounceMs=Math.max(150,Number(t)||window._trimShared.debounceMs||350),window._trimResize.windowResizeCallback=o,M(),!0===n)try{o()}catch(r){}return!0}catch(r){return console.error("registerWindowResize error",r),!1}},window.unregisterWindowResize=function(){try{return!!window._trimResize&&(window._trimResize.windowResizeCallback=null,window._trimResize.windowResizeDotNetRef=null,!0)}catch(e){return console.error("unregisterWindowResize error",e),!1}},window._trimResize=window._trimResize||{dotNetRef:null,cleanupForHandle:null,windowResizeDotNetRef:null,windowResizeCallback:null,updateAllTrimOverlays:null,lastAppliedLeft:null,lastAvail:null,suspendFitZoom:!1},window.getAvailableWidth=function(){try{const e=x();return{avail:e.avail,sidebarW:e.sidebarW,vw:e.vw}}catch(e){const t=window.innerWidth||document.documentElement.clientWidth;return{avail:t,sidebarW:0,vw:t}}},window.applyThumbnailWidth=function(e){try{return R(e,x().avail),!0}catch(t){return console.error("applyThumbnailWidth error",t),!1}},window._trimShared=window._trimShared||{resizeHandler:null,timer:null,debounceMs:350},window.setPreviewZoom=function(e,t="contain"){try{e=Math.max(.25,Math.min(3,Number(e)||1));const t=document.getElementById("preview-zoom-viewport"),n=t?.querySelector("canvas");if(!t||!n)return void console.warn("setPreviewZoom: required elements not found");const r=n.naturalWidth||n.width||1,o=n.naturalHeight||n.height||1,i=Math.round(r*e),a=Math.round(o*e),s=t.clientWidth,c=t.clientHeight,l=n.parentElement;l&&(i>s?(l.classList.remove("justify-center"),l.classList.add("justify-start")):(l.classList.remove("justify-start"),l.classList.add("justify-center")));const d=t.scrollLeft,w=t.scrollTop,u=parseFloat(n.style.width)||r,h=parseFloat(n.style.height)||o,m=(d+s/2)/u,g=(w+c/2)/h;n.style.width=i+"px",n.style.height=a+"px";let p=m*i-s/2,f=g*a-c/2;const y=Math.max(0,i-s),v=Math.max(0,a-c);p=Math.max(0,Math.min(y,p)),f=Math.max(0,Math.min(v,f)),t.scrollLeft=Math.round(p),t.scrollTop=Math.round(f),window._previewZoomState=window._previewZoomState||{},window._previewZoomState.lastZoom=e;const b=n.id;if(b&&window._simpleTrim&&window._simpleTrim[b]){const e=window._simpleTrim[b];if(e.currentRectsPx&&e.currentRectsPx.length>0){const t=e.currentRectsPx.map(e=>({X:e.x/u,Y:e.y/h,Width:e.w/u,Height:e.h/h}));requestAnimationFrame(()=>{window.drawTrimOverlayAsSvg&&window.drawTrimOverlayAsSvg(b,t)})}}return e}catch(n){return console.error("setPreviewZoom error",n),1}},window.setPreviewPanEnabled=function(e){try{const n=document.getElementById("preview-zoom-viewport");if(!n)return;if(window._previewPan.handlers){try{const e=window._previewPan.handlers;n.removeEventListener("pointerdown",e.down),n.removeEventListener("pointermove",e.move),n.removeEventListener("pointerup",e.up),n.removeEventListener("pointercancel",e.up)}catch(t){}window._previewPan.handlers=null,window._previewPan.state=null,n.classList.remove("pan-active"),n.style.touchAction=""}if(!e)return window._previewPan.enabled=!1,void(n.style.cursor="");window._previewPan.enabled=!0,n.style.touchAction="none",n.classList.add("pan-active");const r={active:!1,startX:0,startY:0,scrollLeft:0,scrollTop:0,pointerId:null};window._previewPan.state=r;const o=function(e){try{if(0!==e.button)return;r.active=!0,r.pointerId=e.pointerId,r.startX=e.clientX,r.startY=e.clientY,r.scrollLeft=n.scrollLeft,r.scrollTop=n.scrollTop,n.setPointerCapture&&n.setPointerCapture(e.pointerId),n.classList.add("panning")}catch(t){console.error("pan down error",t)}},i=function(e){try{if(!r.active||r.pointerId!==e.pointerId)return;const t=e.clientX-r.startX,o=e.clientY-r.startY;n.scrollLeft=r.scrollLeft-t,n.scrollTop=r.scrollTop-o}catch(t){}},a=function(e){try{if(r.active&&r.pointerId===e.pointerId){r.active=!1;try{n.releasePointerCapture&&n.releasePointerCapture(e.pointerId)}catch{}n.classList.remove("panning")}}catch(t){}};n.addEventListener("pointerdown",o),n.addEventListener("pointermove",i),n.addEventListener("pointerup",a),n.addEventListener("pointercancel",a),window._previewPan.handlers={down:o,move:i,up:a}}catch(t){console.error("setPreviewPanEnabled error",t)}},window.setPreviewInteractionMode=function(e){try{return"pan"===(e=(e||"").toString().toLowerCase())?window.setPreviewPanEnabled(!0):window.setPreviewPanEnabled(!1),!0}catch(t){return console.error(t),!1}},window._previewPan=window._previewPan||{enabled:!1,handlers:null,state:null},window._previewZoomState=window._previewZoomState||{lastZoom:1,autoFitWidth:!1,autoFitHeight:!1},window.setAutoFitMode=function(e){try{const t=window._previewZoomState;return"width"===(e=(e||"").toString().toLowerCase())?(t.autoFitWidth=!0,t.autoFitHeight=!1):"height"===e?(t.autoFitWidth=!1,t.autoFitHeight=!0):"both"===e?(t.autoFitWidth=!0,t.autoFitHeight=!0):(t.autoFitWidth=!1,t.autoFitHeight=!1),!0}catch(t){return console.error("setAutoFitMode error",t),!1}},window.clearAutoFitMode=function(){try{return window._previewZoomState.autoFitWidth=!1,window._previewZoomState.autoFitHeight=!1,!0}catch(e){return console.error("clearAutoFitMode error",e),!1}},window.adjustAutoFitIfNeeded=function(){try{const t=window._previewZoomState;if(!t.autoFitWidth&&!t.autoFitHeight)return!1;const n=document.getElementById("preview-zoom-viewport"),r=n?.querySelector("canvas");if(!r)return!1;const o=r.id;if(!o)return!1;let i="fit-width";if(t.autoFitWidth&&t.autoFitHeight?i="fit-both":t.autoFitHeight&&(i="fit-height"),"function"==typeof window.fitPreviewToViewport){try{window.fitPreviewToViewport(o,i)}catch(e){console.error("adjustAutoFitIfNeeded fitPreviewToViewport error",e)}return!0}return!1}catch(e){return console.error("adjustAutoFitIfNeeded error",e),!1}},window.getCurrentPreviewZoom=function(e){try{const t=document.getElementById(e);if(!t)return 1;const n=t.width||1;return(parseFloat(t.style.width)||n)/n}catch(t){return console.error("getCurrentPreviewZoom error",t),1}},window.fitPreviewToViewport=function(e,t="fit-width"){try{const n=document.getElementById(e);if(!n)return console.warn("fitPreviewToViewport: canvas not found",e),1;const r=document.getElementById("preview-zoom-viewport");if(!r)return console.warn("fitPreviewToViewport: viewport not found"),1;const o=r.clientWidth,i=r.clientHeight,a=n.width||1,s=n.height||1;if(0===a||0===s)return console.warn("fitPreviewToViewport: canvas size is 0"),1;let c=1;const l=1;if("fit-width"===t)c=o*l/a;else if("fit-height"===t)c=i*l/s;else if("fit-both"===t){const e=o/a,t=i/s;c=Math.min(e,t)*l}else"actual-size"===t&&(c=1);return"function"==typeof window.setPreviewZoom&&window.setPreviewZoom(c),c}catch(n){return console.error("fitPreviewToViewport error",n),1}},window._trimPreview=window._trimPreview||{previewCacheObservers:new Map,visibilityObservers:new Map},window._trimPreview.safeInvoke=function(e,t,...n){if(e&&"function"==typeof e.invokeMethodAsync)try{e.invokeMethodAsync(t,...n).catch(()=>{})}catch(r){}},window.waitForCanvasReady=async function(e,t=120){try{if(!e)return!1;const n=performance.now(),r=document.getElementById(e);if(!r)return!1;const o=r.clientWidth,i=r.clientHeight;if(o>0&&i>0){await new Promise(e=>requestAnimationFrame(e));const e=r.clientWidth,t=r.clientHeight;if(o===e&&i===t)return!0}for(;performance.now()-n<(t||120);){await new Promise(e=>requestAnimationFrame(e));const e=r.clientWidth,t=r.clientHeight;if(e>0&&t>0){await new Promise(e=>requestAnimationFrame(e));const n=r.clientWidth,o=r.clientHeight;if(e===n&&t===o)return!0}}return!1}catch(n){return console.error("waitForCanvasReady error",n),!1}},window.drawTrimOverlayAsSvg=function(e,t){try{let n=function(t){try{if(i.allowMultipleRects){t>=0&&t<i.currentRectsPx.length&&i.currentRectsPx.splice(t,1),i.selectedRectIndex=-1;const n=Math.max(1,Math.round(r.clientWidth||1)),o=Math.max(1,Math.round(r.clientHeight||1)),a=(i.currentRectsPx||[]).map(e=>({X:e.x/n,Y:e.y/o,Width:e.w/n,Height:e.h/o}));window.drawTrimOverlayAsSvg&&window.drawTrimOverlayAsSvg(e,a),i.dotNetRef?.invokeMethodAsync&&i.dotNetRef.invokeMethodAsync("CommitMultipleRectsFromJs",a).catch(()=>{})}else i.selected=!1,i.currentRectPx=null,i.currentRectsPx=[],i.dotNetRef?.invokeMethodAsync&&i.dotNetRef.invokeMethodAsync("ClearTrimRectFromJs").catch(()=>{}),window.drawTrimOverlayAsSvg&&window.drawTrimOverlayAsSvg(e,[])}catch(n){console.error("removeRectAt error",n)}};if(!e)return!1;const r=document.getElementById(e);if(!r)return!1;const o=r.parentElement||r.closest(".tp-preview-page")||r.closest(".preview-zoom-inner")||document.body;window._simpleTrim=window._simpleTrim||{},window._simpleTrim[e]||(window._simpleTrim[e]={});const i=window._simpleTrim[e],a=i.active&&("draw"===i.mode||"move"===i.mode||"resize"===i.mode),s=a&&Array.isArray(i.currentRectsPx)?[...i.currentRectsPx]:[],c=e+"-overlay-svg";let l=document.getElementById(c);l||(l=document.createElement("div"),l.id=c,l.style.position="absolute",l.style.left="0px",l.style.top="0px",l.style.pointerEvents="none",l.style.zIndex="45",o.appendChild(l));const d=r.getBoundingClientRect(),w=function(e,t){let n=0,r=0,o=e;for(;o&&o!==t&&o!==document.body;)n+=o.offsetLeft||0,r+=o.offsetTop||0,o=o.offsetParent;return{x:n,y:r}}(r,o),u=Math.round(w.x),h=Math.round(w.y),m=Math.max(1,Math.round(r.clientWidth||d.width||0)),g=Math.max(1,Math.round(r.clientHeight||d.height||0));l.style.left=u+"px",l.style.top=h+"px",l.style.width=m+"px",l.style.height=g+"px";let p=l.querySelector("svg");p||(p=document.createElementNS("http://www.w3.org/2000/svg","svg"),p.setAttribute("width","100%"),p.setAttribute("height","100%"),p.setAttribute("viewBox",`0 0 ${m} ${g}`),p.setAttribute("preserveAspectRatio","none"),p.style.pointerEvents="none",p.style.touchAction="none",l.appendChild(p)),p.setAttribute("viewBox",`0 0 ${m} ${g}`);const f=l.style.visibility;for(l.style.visibility="hidden";p.firstChild;)p.removeChild(p.firstChild);if(l.style.visibility=f||"visible",!Array.isArray(t)||0===t.length)return i.overlayDom=l,!a&&i.currentRectsPx&&0===i.currentRectsPx.length?(i.currentRectPx=null,i.currentRectsPx=[]):a&&s.length>0&&(i.currentRectsPx=s),l.style.pointerEvents="none",p.style.pointerEvents="none",!0;if(l.style.pointerEvents="auto",p.style.pointerEvents="auto",t.forEach((e,t)=>{const r=Number(e.X??e.x??0),o=Number(e.Y??e.y??0),a=Number(e.Width??e.width??0),s=Number(e.Height??e.height??0),c=Math.round(r*m),l=Math.round(o*g),d=Math.round(a*m),w=Math.round(s*g),u=document.createElementNS("http://www.w3.org/2000/svg","g");u.setAttribute("data-rect-index",String(t));const h=document.createElementNS("http://www.w3.org/2000/svg","rect");h.setAttribute("x","0"),h.setAttribute("y","0"),h.setAttribute("width",String(m)),h.setAttribute("height",String(g)),h.setAttribute("fill","transparent"),h.style.pointerEvents="none",u.appendChild(h);const f=document.createElementNS("http://www.w3.org/2000/svg","rect");f.setAttribute("x",String(c)),f.setAttribute("y",String(l)),f.setAttribute("width",String(Math.max(0,d))),f.setAttribute("height",String(Math.max(0,w))),f.setAttribute("fill","rgba(59,130,246,0.12)");const y=i.allowMultipleRects?i.selectedRectIndex===t:Boolean(i.selected);if(f.setAttribute("stroke",y?"rgba(37,99,235,1)":"rgba(59,130,246,0.95)"),f.setAttribute("stroke-width",y?"3":"2"),f.setAttribute("data-rect","true"),f.setAttribute("data-rect-index",String(t)),f.style.pointerEvents="auto",u.appendChild(f),y){const e=12,r=Math.round(e/2),o=["nw","n","ne","e","se","s","sw","w"],i={nw:"nwse-resize",se:"nwse-resize",ne:"nesw-resize",sw:"nesw-resize",n:"ns-resize",s:"ns-resize",e:"ew-resize",w:"ew-resize"};[[c,l],[c+d/2,l],[c+d,l],[c+d,l+w/2],[c+d,l+w],[c+d/2,l+w],[c,l+w],[c,l+w/2]].forEach(([n,a],s)=>{const c=document.createElementNS("http://www.w3.org/2000/svg","rect");c.setAttribute("x",String(Math.round(n-r))),c.setAttribute("y",String(Math.round(a-r))),c.setAttribute("width",String(e)),c.setAttribute("height",String(e)),c.setAttribute("fill","rgba(59,130,246,0.95)"),c.setAttribute("data-handle",String(s)),c.setAttribute("data-rect-index",String(t)),c.style.pointerEvents="auto",c.style.cursor=i[o[s]]||"default",u.appendChild(c)});let a=c+d+10,s=l-10;a=Math.min(m-12,Math.max(12,a)),s=Math.min(g-12,Math.max(12,s));const h=document.createElementNS("http://www.w3.org/2000/svg","g");h.style.pointerEvents="auto";const p=document.createElementNS("http://www.w3.org/2000/svg","circle");p.setAttribute("cx",String(a)),p.setAttribute("cy",String(s)),p.setAttribute("r","10"),p.setAttribute("fill","rgba(0,0,0,0.6)"),p.setAttribute("data-close","true"),p.setAttribute("data-rect-index",String(t)),p.style.cursor="pointer",h.appendChild(p);const f=document.createElementNS("http://www.w3.org/2000/svg","text");f.setAttribute("x",String(a)),f.setAttribute("y",String(s+4)),f.setAttribute("fill","#fff"),f.setAttribute("font-size","12"),f.setAttribute("text-anchor","middle"),f.setAttribute("data-close","true"),f.setAttribute("data-rect-index",String(t)),f.style.pointerEvents="none",f.textContent="×",h.appendChild(f),h.addEventListener("pointerdown",function(e){try{e.stopPropagation(),n(t)}catch(r){console.error(r)}},{passive:!1}),u.appendChild(h)}p.appendChild(u)}),a?s.length>0&&(!i.currentRectsPx||0===i.currentRectsPx.length)&&(i.currentRectsPx=s):(i.overlayDom=l,i.currentRectsPx=t.map(e=>({x:Number(e.X??e.x??0)*m,y:Number(e.Y??e.y??0)*g,w:Number(e.Width??e.width??0)*m,h:Number(e.Height??e.height??0)*g})),i.currentRectPx=i.currentRectsPx.length>0?{...i.currentRectsPx[i.currentRectsPx.length-1]}:null),i.internal||(i.internal={}),i.internal.keydown||(i.internal.keydown=function(e){"Delete"!==e.key&&"Del"!==e.key||(i.allowMultipleRects&&i.selectedRectIndex>=0?n(i.selectedRectIndex):!i.allowMultipleRects&&i.selected&&n(0))},document.addEventListener("keydown",i.internal.keydown)),i.handlers&&!l.__trimHooked){const e=(e,t)=>{try{e(t)}catch(n){}};i.internal.overlayPointerDown=t=>e(i.handlers.pointerDown,t),i.internal.overlayMove=t=>e(i.handlers.overlayMove,t),l.addEventListener("pointerdown",i.internal.overlayPointerDown,{passive:!1,capture:!0}),l.addEventListener("pointermove",i.internal.overlayMove,{passive:!0,capture:!0}),l.__trimHooked=!0}return!0}catch(n){return console.error("drawTrimOverlayAsSvg error",n),!1}},function(){function e(e,t,n){return Math.max(t,Math.min(n,e))}function t(e,t){try{const n=document.getElementById(e+"-overlay-svg");if(!n)return;let r=n.querySelector(".snap-guide-svg");r||(r=document.createElementNS("http://www.w3.org/2000/svg","svg"),r.classList.add("snap-guide-svg"),r.setAttribute("width","100%"),r.setAttribute("height","100%"),r.style.pointerEvents="none",r.style.position="absolute",r.style.left="0",r.style.top="0",r.style.zIndex="44",n.appendChild(r));const o=document.getElementById(e);if(!o)return;const i=Math.max(1,Math.round(o.clientWidth||1)),a=Math.max(1,Math.round(o.clientHeight||1));for(r.setAttribute("viewBox",`0 0 ${i} ${a}`),r.setAttribute("preserveAspectRatio","none");r.firstChild;)r.removeChild(r.firstChild);if(!t||0===t.length)return;t.forEach(e=>{const t=document.createElementNS("http://www.w3.org/2000/svg","line");"vertical"===e.type?(t.setAttribute("x1",String(e.position)),t.setAttribute("y1","0"),t.setAttribute("x2",String(e.position)),t.setAttribute("y2",String(a))):(t.setAttribute("x1","0"),t.setAttribute("y1",String(e.position)),t.setAttribute("x2",String(i)),t.setAttribute("y2",String(e.position))),t.setAttribute("stroke","rgba(59,130,246,0.8)"),t.setAttribute("stroke-width","2"),t.setAttribute("stroke-dasharray","5 5"),t.setAttribute("vector-effect","non-scaling-stroke"),t.style.pointerEvents="none",r.appendChild(t)})}catch(n){console.error("drawSnapGuides error",n)}}function n(e,t,n){const r={snapped:e,hasSnap:!1,snapTarget:null};if(!window._trimSnapSettings.enabled||!t||0===t.length)return r;let o=1/0;for(const i of t){const t=Math.abs(e-i);t<n&&t<o&&(o=t,r.snapped=i,r.hasSnap=!0,r.snapTarget=i)}return r}function r(e){const t={removeListener(e,t,n,r){try{e&&n&&e.removeEventListener(t,n,r)}catch(o){}},removeWindowListener(e,t,n){try{t&&window.removeEventListener(e,t,n)}catch(r){}},removeDocumentListener(e,t,n){try{t&&document.removeEventListener(e,t,n)}catch(r){}},removeElement(e){try{if(!e)return;e.style&&(e.style.pointerEvents="none"),"function"==typeof e.remove&&e.remove(),void 0!==e.width&&(e.width=0,e.height=0)}catch(t){}}};try{const n=window._simpleTrim?.[e];if(!n)return;t.removeListener(n.base,"pointerdown",n.handlers?.pointerDown,{passive:!1}),t.removeListener(n.base,"touchstart",n.handlers?.touchStart,{passive:!1}),t.removeWindowListener("pointermove",n.handlers?.move,{passive:!1}),t.removeWindowListener("pointerup",n.handlers?.up,{passive:!1}),t.removeElement(n.overlay||document.getElementById(e+"-overlay"));const r=n.overlayDom||document.getElementById(e+"-overlay-svg");r&&(t.removeListener(r,"pointerdown",n.internal?.overlayPointerDown,!0),t.removeListener(r,"pointermove",n.internal?.overlayMove,!0),t.removeElement(r)),t.removeDocumentListener("keydown",n.internal?.keydown),t.removeListener(n.host,"scroll",n.internal?.hostScroll,{passive:!0}),n.handlers&&Object.keys(n.handlers).forEach(e=>n.handlers[e]=null),n.internal&&Object.keys(n.internal).forEach(e=>n.internal[e]=null),delete window._simpleTrim[e]}catch(n){console.error("cleanupTrimEntry error",n)}}window._simpleTrim=window._simpleTrim||{},window._trimSnapSettings={enabled:!1,threshold:10},window.attachTrimListeners=function(o,i,a="single",s=!1){try{let c=function(e,t){try{const n=v.logicalWAtDown&&v.active?v.logicalWAtDown:Math.max(1,Math.round(h.clientWidth||h.getBoundingClientRect().width||1)),r=v.logicalHAtDown&&v.active?v.logicalHAtDown:Math.max(1,Math.round(h.clientHeight||h.getBoundingClientRect().height||1)),o=h.getBoundingClientRect(),i=o.width&&n?o.width/n:1,a=window._previewZoomState?.lastZoom||i||1,s=document.querySelector(".preview-zoom-viewport"),c=s.getBoundingClientRect(),l=o.left-c.left+s.scrollLeft,d=o.top-c.top+s.scrollTop,w=e-(c.left+l-s.scrollLeft);return{x:w/a,y:(t-(c.top+d-s.scrollTop))/a,cssW:n,cssH:r}}catch(n){const r=h.getBoundingClientRect(),o=Math.max(1,Math.round(h.clientWidth||r.width||1)),i=Math.max(1,Math.round(h.clientHeight||r.height||1)),a=window._previewZoomState?.lastZoom||1;return{x:(e-r.left)/a,y:(t-r.top)/a,cssW:o,cssH:i}}},l=function(t){const n=Math.max(1,Math.round(h.clientWidth||1)),r=Math.max(1,Math.round(h.clientHeight||1)),o=Number(t.x||0),i=Number(t.y||0),a=o+Number(t.w||0),s=i+Number(t.h||0),c=e(o,0,n),l=e(i,0,r),d=e(a,0,n),w=e(s,0,r);return{X:c/n,Y:l/r,Width:Math.max(0,d-c)/n,Height:Math.max(0,w-l)/r}},d=function(r){v.lastMoveEv=r,v.pendingMove||(v.pendingMove=!0,requestAnimationFrame(()=>{if(v.pendingMove=!1,!v.active)return;const r=c(v.lastMoveEv.clientX,v.lastMoveEv.clientY),{cssW:i,cssH:a}=r,s=v.currentRectPx?{...v.currentRectPx}:null,d=function(e){const t={x:[],y:[]};try{const n=window._simpleTrim[e];if(!n||!n.currentRectsPx)return t;n.currentRectsPx.forEach(e=>{t.x.push(e.x,e.x+e.w),t.y.push(e.y,e.y+e.h)})}catch(n){console.error("collectSnapTargets error",n)}return t}(o),w=window._trimSnapSettings.threshold||10,u=[];if("maybe-draw"===v.mode){const e=r.x-v.startClientLocal.x,t=r.y-v.startClientLocal.y,n=8;if(!(e*e+t*t>=n*n))return;v.mode="draw",v.currentRectPx={x:v.startClientLocal.x,y:v.startClientLocal.y,w:0,h:0}}if("draw"===v.mode){let e=Math.min(r.x,v.startClientLocal.x),t=Math.min(r.y,v.startClientLocal.y),o=Math.abs(r.x-v.startClientLocal.x),i=Math.abs(r.y-v.startClientLocal.y);if(window._trimAspectRatio&&window._trimAspectRatio>0){const n=window._trimAspectRatio,a=o/Math.max(1,i),s=r.x>=v.startClientLocal.x,c=r.y>=v.startClientLocal.y;if(a>n){const t=i*n;s?(e=v.startClientLocal.x,o=t):(e=v.startClientLocal.x-t,o=t)}else{const e=o/n;c?(t=v.startClientLocal.y,i=e):(t=v.startClientLocal.y-e,i=e)}}const a=n(e,d.x,w),c=n(t,d.y,w),l=n(e+o,d.x,w),h=n(t+i,d.y,w);a.hasSnap&&u.push({type:"vertical",position:a.snapTarget}),c.hasSnap&&u.push({type:"horizontal",position:c.snapTarget}),l.hasSnap&&u.push({type:"vertical",position:l.snapTarget}),h.hasSnap&&u.push({type:"horizontal",position:h.snapTarget}),e=a.snapped,t=c.snapped,o=l.snapped-a.snapped,i=h.snapped-c.snapped;let m=e<0?0:e,g=t<0?0:t,p=e<0?Math.max(0,Math.min(v.startClientLocal.x-m,o)):o,f=t<0?Math.max(0,Math.min(v.startClientLocal.y-g,i)):i;if(v.currentRectPx={x:Math.round(m),y:Math.round(g),w:Math.round(p),h:Math.round(f)},!v.didDrag&&s){(s.x!==v.currentRectPx.x||s.y!==v.currentRectPx.y||s.w!==v.currentRectPx.w||s.h!==v.currentRectPx.h)&&(v.didDrag=!0)}}else if("move"===v.mode&&v.startRectPx){const e=r.x-v.startClientLocal.x,t=r.y-v.startClientLocal.y;let o=v.startRectPx.x+e,s=v.startRectPx.y+t;const c=n(o,d.x,w),l=n(s,d.y,w),h=n(o+v.startRectPx.w,d.x,w),m=n(s+v.startRectPx.h,d.y,w),g=Math.abs(o-c.snapped);Math.abs(o+v.startRectPx.w-h.snapped)<g&&h.hasSnap?(o=h.snapped-v.startRectPx.w,u.push({type:"vertical",position:h.snapTarget})):c.hasSnap&&(o=c.snapped,u.push({type:"vertical",position:c.snapTarget}));const p=Math.abs(s-l.snapped);Math.abs(s+v.startRectPx.h-m.snapped)<p&&m.hasSnap?(s=m.snapped-v.startRectPx.h,u.push({type:"horizontal",position:m.snapTarget})):l.hasSnap&&(s=l.snapped,u.push({type:"horizontal",position:l.snapTarget})),o=Math.max(0,Math.min(i-v.startRectPx.w,o)),s=Math.max(0,Math.min(a-v.startRectPx.h,s)),v.currentRectPx={x:Math.round(o),y:Math.round(s),w:Math.round(v.startRectPx.w),h:Math.round(v.startRectPx.h)},v.didDrag=!0}else if("resize"===v.mode&&v.startRectPx){const t=r.x-v.startClientLocal.x,o=r.y-v.startClientLocal.y,{x:s,y:c,w:l,h:h}=v.startRectPx,m=s+l,g=c+h,p=v.resizeHandle;let f=s,y=m,b=c,x=g;if(["nw","w","sw"].includes(p)&&(f=e(s+t,0,i)),["ne","e","se"].includes(p)&&(y=e(m+t,0,i)),["nw","n","ne"].includes(p)&&(b=e(c+o,0,a)),["sw","s","se"].includes(p)&&(x=e(g+o,0,a)),["nw","w","sw"].includes(p)){const e=n(f,d.x,w);f=e.snapped,e.hasSnap&&u.push({type:"vertical",position:e.snapTarget})}if(["ne","e","se"].includes(p)){const e=n(y,d.x,w);y=e.snapped,e.hasSnap&&u.push({type:"vertical",position:e.snapTarget})}if(["nw","n","ne"].includes(p)){const e=n(b,d.y,w);b=e.snapped,e.hasSnap&&u.push({type:"horizontal",position:e.snapTarget})}if(["sw","s","se"].includes(p)){const e=n(x,d.y,w);x=e.snapped,e.hasSnap&&u.push({type:"horizontal",position:e.snapTarget})}let P=Math.min(f,y),R=Math.max(f,y),M=Math.min(b,x),S=Math.max(b,x);const F=1;R-P<F&&(R=y>=f?Math.min(i,P+F):P,P=y<f?Math.max(0,R-F):P),S-M<F&&(S=x>=b?Math.min(a,M+F):M,M=x<b?Math.max(0,S-F):M),v.currentRectPx={x:Math.round(P),y:Math.round(M),w:Math.round(R-P),h:Math.round(S-M)},v.didDrag=!0}if(t(o,u),v.currentRectPx){if((!s||s.x!==v.currentRectPx.x||s.y!==v.currentRectPx.y||s.w!==v.currentRectPx.w||s.h!==v.currentRectPx.h)&&v.overlayDom&&window.drawTrimOverlayAsSvg){let e=[];v.allowMultipleRects?"draw"===v.mode?e=v.currentRectPx&&v.currentRectPx.w>0&&v.currentRectPx.h>0?[...v.currentRectsPx.map(e=>({X:e.x/i,Y:e.y/a,Width:e.w/i,Height:e.h/a})),{X:v.currentRectPx.x/i,Y:v.currentRectPx.y/a,Width:v.currentRectPx.w/i,Height:v.currentRectPx.h/a}]:v.currentRectsPx.map(e=>({X:e.x/i,Y:e.y/a,Width:e.w/i,Height:e.h/a})):(v.selectedRectIndex>=0&&v.selectedRectIndex<v.currentRectsPx.length&&(v.currentRectsPx[v.selectedRectIndex]={...v.currentRectPx}),e=v.currentRectsPx.map(e=>({X:e.x/i,Y:e.y/a,Width:e.w/i,Height:e.h/a}))):e=[l(v.currentRectPx)],e.length>0&&window.drawTrimOverlayAsSvg(o,e)}}}))},w=function(){v.mode="maybe-draw";let e=[];if(v.allowMultipleRects){v.selectedRectIndex=-1;const t=v.logicalWAtDown||Math.max(1,Math.round(h.clientWidth||1)),n=v.logicalHAtDown||Math.max(1,Math.round(h.clientHeight||1));e=v.currentRectsPx.map(e=>({X:e.x/t,Y:e.y/n,Width:e.w/t,Height:e.h/n}))}else v.selected=!1,v.currentRectPx&&(e=[l(v.currentRectPx)]);e.length>0&&window.drawTrimOverlayAsSvg&&window.drawTrimOverlayAsSvg(o,e)},u=function(){v.active||M||(M=!0,requestAnimationFrame(()=>{M=!1}))};if(!o)return!1;const h=document.getElementById(o);if(!h)return console.warn(`attachTrimListeners: canvas not found: ${o}`),!1;let m=!1;const g=window._simpleTrim[o];g?.selected&&(m=!0),r(o);const p=h.parentElement||h.closest(".tp-preview-page")||h.closest(".preview-zoom-inner")||document.body;"static"===getComputedStyle(p).position&&(p.style.position="relative");const f=o+"-overlay";let y=document.getElementById(f);y||(y=document.createElement("canvas"),y.id=f,y.style.position="absolute",y.style.pointerEvents="none",y.style.zIndex="40",p.appendChild(y));const v={base:h,host:p,overlay:y,overlayDom:null,dotNetRef:i,selectionMode:"multi"===a?"multi":"single",allowMultipleRects:Boolean(s),active:!1,mode:null,pointerId:null,startClientX:0,startClientY:0,startClientLocal:null,startRectPx:null,currentRectPx:null,currentRectsPx:[],selectedRectIndex:-1,pendingMove:!1,handlers:{},internal:{},resizeHandle:null,baseRectAtDown:null,logicalWAtDown:null,logicalHAtDown:null,didDrag:!1,selected:m};v.internal.lastAttachedAt=performance.now(),window._simpleTrim[o]=v;const b=["nw","n","ne","e","se","s","sw","w"],x={nw:"nwse-resize",se:"nwse-resize",ne:"nesw-resize",sw:"nesw-resize",n:"ns-resize",s:"ns-resize",e:"ew-resize",w:"ew-resize"},P=function(e){try{if(e.preventDefault&&e.preventDefault(),window._previewPan.enabled)return;if(void 0!==e.button&&0!==e.button)return;v.active=!0,v.pointerId=e.pointerId??"mouse",v.startClientX=e.clientX,v.startClientY=e.clientY,v.didDrag=!1,v.baseRectAtDown=h.getBoundingClientRect(),v.logicalWAtDown=Math.max(1,Math.round(h.clientWidth||v.baseRectAtDown.width||1)),v.logicalHAtDown=Math.max(1,Math.round(h.clientHeight||v.baseRectAtDown.height||1)),v.startClientLocal=c(e.clientX,e.clientY),h.setPointerCapture&&h.setPointerCapture(e.pointerId);const r=e.target||e.srcElement;if(r?.setPointerCapture&&r!==h)try{r.setPointerCapture(e.pointerId)}catch(n){}if(v.resizeHandle=null,v.overlayDom&&r){const e=r.getAttribute?.("data-handle"),t=r.getAttribute?.("data-rect"),n=r.getAttribute?.("data-rect-index"),i=null!==n?Number(n):-1;if(null!==e){const t=Number(e);v.resizeHandle=Number.isFinite(t)&&t>=0&&t<b.length?b[t]:null,v.mode="resize",v.allowMultipleRects&&i>=0&&i<v.currentRectsPx.length?(v.selectedRectIndex=i,v.startRectPx={...v.currentRectsPx[i]},v.currentRectPx={...v.currentRectsPx[i]}):v.startRectPx=v.currentRectPx?{...v.currentRectPx}:{x:v.startClientLocal.x,y:v.startClientLocal.y,w:0,h:0}}else if(null!==t)if(v.mode="move",v.allowMultipleRects&&i>=0&&i<v.currentRectsPx.length){v.selectedRectIndex=i,v.startRectPx={...v.currentRectsPx[i]},v.currentRectPx={...v.currentRectsPx[i]};"single"===(v.selectionMode||window._simpleTrimSettings?.selectionMode||"single")&&Object.keys(window._simpleTrim).forEach(e=>{e!==o&&window._simpleTrim[e]&&(window._simpleTrim[e].selectedRectIndex=-1,window._simpleTrim[e].selected=!1)});const e=v.currentRectsPx.map(e=>({X:e.x/v.logicalWAtDown,Y:e.y/v.logicalHAtDown,Width:e.w/v.logicalWAtDown,Height:e.h/v.logicalHAtDown}));window.drawTrimOverlayAsSvg(o,e)}else{v.startRectPx=v.currentRectPx?{...v.currentRectPx}:{x:v.startClientLocal.x,y:v.startClientLocal.y,w:0,h:0};"single"===(v.selectionMode||window._simpleTrimSettings?.selectionMode||"single")&&Object.keys(window._simpleTrim).forEach(e=>{e!==o&&window._simpleTrim[e]?.selected&&(window._simpleTrim[e].selected=!1)}),v.selected=!0,v.overlayDom&&window.drawTrimOverlayAsSvg&&window.drawTrimOverlayAsSvg(o,[l(v.currentRectPx)])}else w()}else w();v.overlayDom&&(v.resizeHandle?v.overlayDom.style.cursor=x[v.resizeHandle]||"":"draw"===v.mode?v.overlayDom.style.cursor="crosshair":"move"===v.mode?v.overlayDom.style.cursor="move":"maybe-draw"===v.mode&&(v.overlayDom.style.cursor="")),v.handlers.move=e=>d(e),v.handlers.up=function(e){if(!v.active)return;t(o,[]),v.active=!1;try{h.releasePointerCapture&&h.releasePointerCapture(v.pointerId)}catch(n){}if(v.baseRectAtDown=null,v.logicalWAtDown=null,v.logicalHAtDown=null,v.overlayDom&&(v.overlayDom.style.cursor=""),"maybe-draw"===v.mode)return v.mode=null,v.didDrag=!1,window.removeEventListener("pointermove",v.handlers.move,{passive:!1}),void window.removeEventListener("pointerup",v.handlers.up,{passive:!1});const r=v.currentRectPx||{x:0,y:0,w:0,h:0};if(r.w>0&&r.h>0){const e=l(r);if(v.allowMultipleRects){if("draw"===v.mode){const e=window._trimGridDivision||{cols:1,rows:1},t=Math.max(1,e.cols),n=Math.max(1,e.rows);if(t>1||n>1){const e=r.w/t,i=r.h/n;for(let o=0;o<n;o++)for(let n=0;n<t;n++)v.currentRectsPx.push({x:r.x+e*n,y:r.y+i*o,w:e,h:i});v.selectedRectIndex=v.currentRectsPx.length-1;const a=v.currentRectsPx.map(e=>({X:e.x/(h.clientWidth||1),Y:e.y/(h.clientHeight||1),Width:e.w/(h.clientWidth||1),Height:e.h/(h.clientHeight||1)}));window.drawTrimOverlayAsSvg&&window.drawTrimOverlayAsSvg(o,a)}else v.currentRectsPx.push(r),v.selectedRectIndex=v.currentRectsPx.length-1}else"move"!==v.mode&&"resize"!==v.mode||v.selectedRectIndex>=0&&v.selectedRectIndex<v.currentRectsPx.length&&(v.currentRectsPx[v.selectedRectIndex]=r);const e=v.currentRectsPx.map(e=>({X:e.x/(h.clientWidth||1),Y:e.y/(h.clientHeight||1),Width:e.w/(h.clientWidth||1),Height:e.h/(h.clientHeight||1)}));v.dotNetRef?.invokeMethodAsync&&v.dotNetRef.invokeMethodAsync("CommitMultipleRectsFromJs",e).catch(()=>{})}else v.lastRawRect=r,v.currentRectsPx=[r],v.dotNetRef?.invokeMethodAsync&&v.dotNetRef.invokeMethodAsync("CommitTrimRectFromJs",e.X,e.Y,e.Width,e.Height).catch(()=>{}),v.didDrag&&(v.selected=!1,v.overlayDom&&window.drawTrimOverlayAsSvg&&window.drawTrimOverlayAsSvg(o,[l(r)]))}else v.overlayDom&&window.drawTrimOverlayAsSvg&&window.drawTrimOverlayAsSvg(o,[]);window.removeEventListener("pointermove",v.handlers.move,{passive:!1}),window.removeEventListener("pointerup",v.handlers.up,{passive:!1})},window.addEventListener("pointermove",v.handlers.move,{passive:!1}),window.addEventListener("pointerup",v.handlers.up,{passive:!1})}catch(n){console.error("onPointerDown error",n)}},R=function(e){try{if(!e.touches||0===e.touches.length)return;if(e.preventDefault(),window._previewPan.enabled)return;const t=e.touches[0];P({clientX:t.clientX,clientY:t.clientY,pointerId:"touch",button:0,target:t.target,preventDefault:()=>{}})}catch(t){console.error("onTouchStart error",t)}};v.handlers.pointerDown=P,v.handlers.touchStart=R,h.addEventListener("pointerdown",P,{passive:!1}),h.addEventListener("touchstart",R,{passive:!1});let M=!1;v.internal.hostScroll=u,p.addEventListener("scroll",v.internal.hostScroll,{passive:!0});const S=document.getElementById("trim-preview-container")||p.closest(".preview-zoom-viewport");return S&&(v.internal.containerScroll=u,S.addEventListener("scroll",v.internal.containerScroll,{passive:!0})),!0}catch(c){return console.error("attachTrimListeners error",c),!1}},window.detachTrimListeners=function(e){try{const t=window._simpleTrim?.[e];return t?(r(e),!0):(r(e),!1)}catch(t){return console.error("detachTrimListeners error",t),!1}}}(),window.setTrimSnapEnabled=function(e){try{return window._trimSnapSettings=window._trimSnapSettings||{},window._trimSnapSettings.enabled=Boolean(e),!0}catch(t){return console.error("setTrimSnapEnabled error",t),!1}},window.drawImageToCanvasForPreview=function(e,t,n=!0){return new Promise(r=>{try{const o=document.getElementById(e);if(!o)return void r(!1);const i=o.getContext("2d");if(!i)return void r(!1);const a=new window.Image;a.crossOrigin="anonymous",a.onload=function(){try{const e=Math.max(1,Math.round(a.naturalWidth)),t=Math.max(1,Math.round(a.naturalHeight)),s=n&&window.devicePixelRatio||1;o.width=Math.round(e*s),o.height=Math.round(t*s),o.style.width=e+"px",o.style.height=t+"px",o.style.display="block",i.setTransform(s,0,0,s,0,0),i.clearRect(0,0,e,t),i.drawImage(a,0,0,e,t),requestAnimationFrame(()=>r(!0))}catch(e){console.error("drawImageToCanvasForPreview draw error",e),r(!1)}},a.onerror=function(e){console.error("drawImageToCanvasForPreview image load error",e,t),r(!1)},a.src=t}catch(o){console.error("drawImageToCanvasForPreview error",o),r(!1)}})},window.setTrimRectAspectRatio=function(e){try{return window._trimAspectRatio="number"==typeof e&&e>0?e:null,!0}catch(t){return console.error("setTrimRectAspectRatio error",t),!1}},window.setTrimRectGridDivision=function(e,t){try{return window._trimGridDivision={cols:Math.max(1,Math.min(5,Math.round(e)||1)),rows:Math.max(1,Math.min(5,Math.round(t)||1))},!0}catch(n){return console.error("setTrimRectGridDivision error",n),!1}},window.registerPreviewCacheCleanup=function(e,t){try{const r=document.getElementById(e);if(!r)return console.warn(`registerPreviewCacheCleanup: container not found: ${e}`),!1;const o=window._trimPreview.previewCacheObservers.get(e);if(o&&o.observer)try{o.observer.disconnect()}catch(n){}const i=new IntersectionObserver(t=>{t.forEach(t=>{const n=t.target,r=n?.dataset?.itemId;if(!t.isIntersecting&&r){const t=window._trimPreview.previewCacheObservers.get(e);t&&t.dotNetRef&&window._trimPreview.safeInvoke(t.dotNetRef,"OnPreviewOutOfView",r)}})},{rootMargin:"400px"});return r.querySelectorAll("canvas[data-item-id]").forEach(e=>i.observe(e)),window._trimPreview.previewCacheObservers.set(e,{observer:i,dotNetRef:t}),!0}catch(n){return console.error("registerPreviewCacheCleanup error",n),!1}},window.unregisterPreviewCacheCleanup=function(e){try{const n=window._trimPreview.previewCacheObservers.get(e);if(n){try{n.observer&&n.observer.disconnect()}catch(t){}n.dotNetRef=null,window._trimPreview.previewCacheObservers.delete(e)}return!0}catch(t){return console.error("unregisterPreviewCacheCleanup error",t),!1}},window.unregisterAllTrimPreview=function(){try{let e=0;return window._trimPreview.previewCacheObservers.forEach((t,n)=>{try{t.observer&&t.observer.disconnect()}catch(r){}t&&(t.dotNetRef=null),e++}),window._trimPreview.previewCacheObservers.clear(),window._trimPreview.visibilityObservers.forEach((t,n)=>{try{t.observer&&t.observer.disconnect()}catch(r){}t&&(t.dotNetRef=null),e++}),window._trimPreview.visibilityObservers.clear(),!0}catch(e){return console.error("unregisterAllTrimPreview error",e),!1}},window.trimPreviewArea=window.trimPreviewArea||{dotNetRef:null,handlers:null,initialize:function(e){try{this.unregister&&this.unregister(),this.dotNetRef=e;const t=e=>{try{this.dotNetRef&&this.dotNetRef.invokeMethodAsync("OnPanelMouseMove",e.clientX).catch(()=>{})}catch(t){}},n=e=>{try{this.dotNetRef&&this.dotNetRef.invokeMethodAsync("OnPanelMouseUp").catch(()=>{})}catch(t){}};this.handlers={onMouseMove:t,onMouseUp:n},document.addEventListener("mousemove",t,{passive:!0}),document.addEventListener("mouseup",n,{passive:!0})}catch(t){console.error("trimPreviewArea.initialize error",t)}},unregister:function(){try{this.handlers&&(document.removeEventListener("mousemove",this.handlers.onMouseMove),document.removeEventListener("mouseup",this.handlers.onMouseUp),this.handlers=null),this.dotNetRef=null}catch(e){console.error("trimPreviewArea.unregister error",e)}},getImageDimensions:function(e){try{const t=document.getElementById(e);return t?[t.offsetWidth,t.offsetHeight]:[0,0]}catch(t){return console.error("getImageDimensions error",t),[0,0]}},scrollToPage:function(e){try{const t=document.getElementById("preview-zoom-viewport");if(!t)return console.warn("scrollToPage: container not found"),!1;const n=document.getElementById(`preview-container-${e}`);if(!n)return console.warn(`scrollToPage: element not found for index ${e}`),!1;"function"==typeof window.pauseVisiblePageObserver&&window.pauseVisiblePageObserver();const r=()=>{"function"==typeof window.resumeVisiblePageObserver&&window.resumeVisiblePageObserver(),"function"==typeof window.selectThumbnailByIndex&&window.selectThumbnailByIndex(e),t.removeEventListener("scrollend",r)};return t.addEventListener("scrollend",r,{once:!0}),setTimeout(()=>{t.removeEventListener("scrollend",r),r()},1e3),n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),!0}catch(t){return console.error("scrollToPage error",t),"function"==typeof window.resumeVisiblePageObserver&&window.resumeVisiblePageObserver(),!1}}},window.selectThumbnailByIndex=function(e){try{const t=document.getElementById("thumbnail-container");if(!t)return void console.warn("selectThumbnailByIndex: thumbnail-container not found");t.querySelectorAll(".trim-thumbnail-card").forEach(e=>{const t=e.querySelector(".flex.flex-col");t&&t.classList.remove("selected","ring-2","ring-blue-500","bg-blue-50/40")});const n=t.querySelector(`[data-thumb-index="${e}"]`);if(n){const e=n.querySelector(".flex.flex-col");e&&e.classList.add("selected","ring-2","ring-blue-500","bg-blue-50/40")}}catch(t){console.error("selectThumbnailByIndex error",t)}},window.clearTrimState=function(e){try{if(!e||!window._simpleTrim||!window._simpleTrim[e])return!1;const t=window._simpleTrim[e];return t.currentRectsPx=[],t.currentRectPx=null,t.active=!1,t.selected=!1,t.selectedRectIndex=-1,!0}catch(t){return console.error("clearTrimState error",t),!1}},window._visiblePageObserver=window._visiblePageObserver||{},window._visiblePageObserver.isPaused=!1,window.pauseVisiblePageObserver=function(){try{window._visiblePageObserver.isPaused=!0}catch(e){console.error("pauseVisiblePageObserver error",e)}},window.resumeVisiblePageObserver=function(){try{window._visiblePageObserver.isPaused=!1}catch(e){console.error("resumeVisiblePageObserver error",e)}},window.registerVisiblePageObserver=function(e,t,n=200,r={}){try{let i=function(e){const t=e&&e.match(/-(\d+)$/);return t?Number(t[1]):NaN},a=function(e,t){const n=Math.max(e.left,t.left),r=Math.max(e.top,t.top),o=Math.min(e.right,t.right),i=Math.min(e.bottom,t.bottom);return Math.max(0,o-n)*Math.max(0,i-r)},s=function(){u.timer&&(clearTimeout(u.timer),u.timer=null);const t=u.pendingBest;if(t<0||t===u.lastIdx)return;u.lastIdx=t;try{const e=document.getElementById("topbar-page-input");e&&(e.value=String(t+1))}catch(r){}try{"function"==typeof window.selectThumbnailByIndex&&window.selectThumbnailByIndex(t)}catch(r){}const n=()=>{try{e&&"function"==typeof e.invokeMethodAsync&&e.invokeMethodAsync("SetVisiblePageFromJs",t).catch(()=>{})}catch(r){}};if(window.requestIdleCallback)try{if(u.idleHandle){try{window.cancelIdleCallback(u.idleHandle)}catch{}u.idleHandle=null}u.idleHandle=window.requestIdleCallback(()=>{n(),u.idleHandle=null},{timeout:1e3})}catch(r){setTimeout(n,0)}else setTimeout(n,0)};try{window.unregisterVisiblePageObserver(t)}catch(o){}const c=document.getElementById(t);if(!c)return;const l=Array.from(c.querySelectorAll('[id^="preview-container-"]'));if(!l||0===l.length)return;const d={rootMargin:r.rootMargin??"0px",debounceMs:Number(n)||200,minAreaRatio:r.minAreaRatio??.01,minAreaPx:r.minAreaPx??100,requiredStreak:r.requiredStreak??1},w=new Map,u={pendingBest:-1,timer:null,lastIdx:-1,streaks:{},lastCandidate:-1,idleHandle:null};l.forEach(e=>{const t=i(e.id);if(!Number.isFinite(t))return;const n=e.getBoundingClientRect(),r=Math.max(1,n.width*n.height);w.set(t,{area:0,ratio:0,elArea:r,lastSeenAt:0})});const h=new IntersectionObserver(function(e){if(!window._visiblePageObserver.isPaused)try{const t=performance.now(),n=c.getBoundingClientRect();e.forEach(e=>{const r=e.target;if(!r||!r.id)return;const o=i(r.id);if(!Number.isFinite(o))return;const s=e.boundingClientRect||r.getBoundingClientRect(),c=Math.max(1,s.width*s.height);let l=0;if(e.intersectionRect&&e.intersectionRect.width&&e.intersectionRect.height)l=e.intersectionRect.width*e.intersectionRect.height;else{const t={left:Math.max(n.left,s.left),top:Math.max(n.top,s.top),right:Math.min(n.right,s.right),bottom:Math.min(n.bottom,s.bottom)};l=a(t,s),0===l&&(l=(e.intersectionRatio||0)*c)}const d=Math.max(0,Math.min(1,l/Math.max(1,c)));w.set(o,{area:l,ratio:d,elArea:c,lastSeenAt:t})});let r=-1,l=-1,h=-1,m=-1;if(w.forEach((e,t)=>{const n=e.area||0;n>l&&(l=n,r=t),n>m&&(m=n,h=t)}),r>=0){const e=w.get(r);e.area>=Math.max(d.minAreaPx,e.elArea*d.minAreaRatio)||(r=-1)}if(r<0&&h>=0){const e=w.get(h);e&&e.area>0&&(r=h)}r>=0&&r!==u.pendingBest?(u.lastCandidate===r?u.streaks[r]=(u.streaks[r]||0)+1:(u.streaks[r]=(u.streaks[r]||0)+1,Object.keys(u.streaks).forEach(e=>{const t=Number(e);t!==r&&(u.streaks[t]=Math.max(0,(u.streaks[t]||0)-1))})),u.lastCandidate=r,(u.streaks[r]||0)>=d.requiredStreak&&(u.pendingBest=r,u.timer&&clearTimeout(u.timer),u.timer=setTimeout(()=>{try{s()}catch(o){}},d.debounceMs))):(Object.keys(u.streaks).forEach(e=>{u.streaks[e]=Math.max(0,(u.streaks[e]||0)-1),0===u.streaks[e]&&delete u.streaks[e]}),u.lastCandidate=-1)}catch(o){console.error("visible page observer callback error",o)}},{root:c,rootMargin:d.rootMargin,threshold:[0,.01,.05,.1,.25,.5,.75,1]});l.forEach(e=>h.observe(e)),window._visiblePageObserver=window._visiblePageObserver||{},window._visiblePageObserver[t]={observer:h,nodes:l,dotNetRef:e,state:u,itemState:w}}catch(o){console.error("registerVisiblePageObserver error",o)}},window.unregisterVisiblePageObserver=function(e){try{const n=window._visiblePageObserver&&window._visiblePageObserver[e];if(!n)return;try{n.state&&n.state.timer&&clearTimeout(n.state.timer)}catch(t){}try{n.observer&&n.observer.disconnect()}catch(t){}try{delete window._visiblePageObserver[e]}catch(t){}}catch(t){console.error("unregisterVisiblePageObserver error",t)}},window.tooltipHelper=window.tooltipHelper||{},function(){const e=12;window.tooltipHelper.show=function(t,n){try{const r=document.getElementById(t),o=document.getElementById(n);if(!r||!o)return void console.warn("tooltipHelper.show: element not found",{wrapperId:t,tooltipId:n});!function(t,n){const r=t.getBoundingClientRect(),o=n.getBoundingClientRect(),i=window.innerWidth,a=window.innerHeight,s=[{name:"top",x:r.left+r.width/2-o.width/2,y:r.top-o.height-e},{name:"bottom",x:r.left+r.width/2-o.width/2,y:r.bottom+e},{name:"left",x:r.left-o.width-e,y:r.top+r.height/2-o.height/2},{name:"right",x:r.right+e,y:r.top+r.height/2-o.height/2}];let c=null;for(const e of s){const t=e.x>=8&&e.x+o.width<=i-8,n=e.y>=8&&e.y+o.height<=a-8;if(t&&n){c=e;break}}c||(c=s[0]);let l=Math.max(8,Math.min(c.x,i-o.width-8)),d=Math.max(8,Math.min(c.y,a-o.height-8));n.style.left=l+"px",n.style.top=d+"px",n.setAttribute("data-placement",c.name)}(r,o),requestAnimationFrame(()=>{o.style.opacity="1",o.style.visibility="visible"})}catch(r){console.error("tooltipHelper.show error",r)}},window.tooltipHelper.hide=function(e){try{const t=document.getElementById(e);t&&(t.style.opacity="0",t.style.visibility="hidden")}catch(t){console.error("tooltipHelper.hide error",t)}}}(),window.messageBar=window.messageBar||{},function(){let e=null,t=null;const n={success:{bar:"bg-green-500",box:"bg-green-100 text-green-900 border border-green-400"},warn:{bar:"bg-yellow-400",box:"bg-yellow-100 text-yellow-900 border border-yellow-400"},error:{bar:"bg-red-500",box:"bg-red-400 text-white"}};window.messageBar.show=function(r,o="success",i=5e3){try{const a=document.getElementById("message-bar-container"),s=document.getElementById("message-bar-text"),c=document.getElementById("message-bar-box"),l=document.getElementById("message-bar-progress"),d=document.getElementById("message-bar-close");if(!(a&&s&&c&&l))return void console.warn("messageBar: required elements not found");e&&(clearTimeout(e),e=null),t&&(clearInterval(t),t=null),s.textContent=r;const w=n[o]||n.success;l.className=`h-full transition-all ${w.bar}`,c.className=`px-4 py-2 rounded-b-lg shadow transition-all duration-300 ${w.box}`,l.style.width="100%",l.style.transition="none",a.style.display="block",requestAnimationFrame(()=>{l.style.transition=`width ${i}ms linear`,l.style.width="0%"});const u=()=>{l.removeEventListener("transitionend",u),window.messageBar.hide()};l.addEventListener("transitionend",u),e=setTimeout(()=>{l.removeEventListener("transitionend",u),window.messageBar.hide(),e=null},i+100);const h=d.cloneNode(!0);d.parentNode.replaceChild(h,d),h.addEventListener("click",()=>{l.removeEventListener("transitionend",u),window.messageBar.hide()})}catch(a){console.error("messageBar.show error",a)}},window.messageBar.hide=function(){try{const n=document.getElementById("message-bar-container");n&&(n.style.display="none"),e&&(clearTimeout(e),e=null),t&&(clearInterval(t),t=null)}catch(n){console.error("messageBar.hide error",n)}}}(),window.loadingOverlay={show:function(e){const t=document.getElementById("loading-overlay"),n=document.getElementById("loading-message");t&&(t.classList.remove("hidden"),n&&e&&(n.textContent=e))},hide:function(){const e=document.getElementById("loading-overlay");e&&e.classList.add("hidden")}},window.ocrHelper={worker:null,isLibraryLoaded:!1,loadingPromise:null,currentLanguage:null,async loadLibrary(){return!!this.isLibraryLoaded||(this.loadingPromise||(this.loadingPromise=new Promise((e,t)=>{const n=document.createElement("script");n.src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js",n.async=!0,n.onload=()=>{console.log("[OCR] Tesseract.js loaded"),this.isLibraryLoaded=!0,e(!0)},n.onerror=e=>{console.error("[OCR] Failed to load Tesseract.js",e),this.loadingPromise=null,t(e)},document.head.appendChild(n)})),this.loadingPromise)},async initialize(e="eng+jpn"){try{return this.isLibraryLoaded||await this.loadLibrary(),this.worker&&this.currentLanguage!==e&&(console.log(`[OCR] Language changed from ${this.currentLanguage} to ${e}, reinitializing...`),await this.worker.terminate(),this.worker=null,this.currentLanguage=null),this.worker||(console.log("[OCR] Initializing worker with language:",e),this.worker=await Tesseract.createWorker(e,1,{logger:e=>{"recognizing text"===e.status&&console.log(`[OCR] Progress: ${(100*e.progress).toFixed(1)}%`)}}),this.currentLanguage=e,console.log("[OCR] Worker initialized successfully")),!0}catch(t){return console.error("[OCR] Initialization error:",t),this.worker=null,this.currentLanguage=null,!1}},rotateImage:async(e,t)=>new Promise((n,r)=>{const o=new Image;o.onload=()=>{try{const e=document.createElement("canvas"),r=e.getContext("2d"),i=t*Math.PI/180,a=Math.abs(Math.cos(i)),s=Math.abs(Math.sin(i));e.width=Math.ceil(o.width*a+o.height*s),e.height=Math.ceil(o.width*s+o.height*a),r.fillStyle="#FFFFFF",r.fillRect(0,0,e.width,e.height),r.translate(e.width/2,e.height/2),r.rotate(i),r.drawImage(o,-o.width/2,-o.height/2),console.log("[OCR] Image rotated:",{originalSize:`${o.width}x${o.height}`,rotatedSize:`${e.width}x${e.height}`,angle:t.toFixed(2)}),n(e.toDataURL("image/png"))}catch(e){console.error("[OCR] Rotation error:",e),r(e)}},o.onerror=()=>{console.error("[OCR] Failed to load image for rotation"),r(new Error("Failed to load image for rotation"))},o.src=e}),async recognize(e,t={}){try{if(!this.worker){if(!(await this.initialize()))throw new Error("OCR worker initialization failed")}const{PsmMode:n=3,psmMode:r=n,AutoRotate:o=!1,autoRotate:i=o,ReadingOrder:a="auto",readingOrder:s=a}=t;console.log("[OCR] Recognition options:",{language:this.currentLanguage,psmMode:r,autoRotate:i,readingOrder:s});let c=e;const l={tessedit_pageseg_mode:r};"rtl"===s?(l.textord_force_make_prop_words=0,l.textord_tabfind_find_tables=0):"ltr"===s&&(l.textord_force_make_prop_words=1),await this.worker.setParameters(l),console.log("[OCR] Starting recognition...");const d=await this.worker.recognize(c);console.log("[OCR] Recognition complete. Text length:",d.data.text.length),console.log("[OCR] Confidence:",d.data.confidence);let w=d.data.text,u=d.data.lines?.map(e=>({text:e.text,confidence:e.confidence,bbox:e.bbox}))||[];return"rtl"===s&&(u=u.map(e=>({text:e.text.split("").reverse().join(""),confidence:e.confidence,bbox:e.bbox})),w=u.map(e=>e.text).join("\n"),console.log("[OCR] Text reversed (RTL mode)")),{text:w,confidence:d.data.confidence,lines:u}}catch(n){throw console.error("[OCR] Recognition error:",n),n}},async terminate(){this.worker&&(console.log("[OCR] Terminating worker"),await this.worker.terminate(),this.worker=null,this.currentLanguage=null)},async reset(){await this.terminate()}},window.copyToClipboard=async function(e){if(navigator.clipboard&&navigator.clipboard.writeText)try{return await navigator.clipboard.writeText(e),!0}catch(t){console.error("Clipboard API error:",t)}try{const t=document.createElement("textarea");if(t.value=e,t.style.position="fixed",t.style.left="-999999px",t.style.top="-999999px",t.setAttribute("readonly",""),document.body.appendChild(t),navigator.userAgent.match(/ipad|iphone/i)){const n=document.createRange();n.selectNodeContents(t);const r=window.getSelection();r.removeAllRanges(),r.addRange(n),t.setSelectionRange(0,e.length)}else t.select();let r=!1;try{r=document.execCommand("copy")}catch(n){console.error("execCommand fallback failed:",n)}return document.body.removeChild(t),r}catch(t){return console.error("Fallback copy error:",t),!1}}}();
