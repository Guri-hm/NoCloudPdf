!function(){"use strict";async function e(){window.JSZip||await new Promise((e,t)=>{const n=document.createElement("script");n.src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js",n.onload=e,n.onerror=t,document.head.appendChild(n)})}window.getPageType=function(){return window.location.pathname.includes("/split")?"split":window.location.pathname.includes("/merge")?"merge":"unknown"},window.fadeInOnScroll={observe:function(e){if(!e)return;new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(e.target.classList.remove("opacity-0","translate-y-8"),e.target.classList.add("opacity-100","translate-y-0"))})},{threshold:.5}).observe(e)}},window.positionEditorTooltip=function(e,t){const n=document.getElementById(t);if(!n)return;n.style.display="block",n.setAttribute("aria-hidden","false"),n.style.left="-9999px",n.style.top="-9999px",n.style.visibility="hidden";const r=e.getBoundingClientRect(),o=n.getBoundingClientRect(),i=window.innerWidth||document.documentElement.clientWidth,a=window.innerHeight||document.documentElement.clientHeight,s=r.top,l=a-r.bottom,d=r.left,c=i-r.right;let w="top";s<o.height+12&&l>s&&(w="bottom"),("top"===w||"bottom"===w)&&o.width>c&&d>c&&(w="left"),("top"===w||"bottom"===w)&&o.width>d&&c>d&&(w="right");let u=0,h=0;"top"===w?(h=r.top-o.height-8,u=r.left+(r.width-o.width)/2):"bottom"===w?(h=r.bottom+8,u=r.left+(r.width-o.width)/2):"left"===w?(h=r.top+(r.height-o.height)/2,u=r.left-o.width-8):(h=r.top+(r.height-o.height)/2,u=r.right+8),u=Math.max(8,Math.min(u,i-o.width-8)),h=Math.max(8,Math.min(h,a-o.height-8)),n.style.left=Math.round(u)+"px",n.style.top=Math.round(h)+"px",n.setAttribute("data-dir",w),n.style.visibility="visible"},window.hideEditorTooltip=function(e){const t=document.getElementById(e);t&&(t.style.display="none",t.setAttribute("aria-hidden","true"))},window.registerDropArea=function(e,t){const n=document.getElementById(e);if(!n)return;n._dropHandlers&&window.unregisterDropArea(e);let r=0;n._dropHandlers={dragenter:function(e){window.isSorting||(r++,t.invokeMethodAsync("SetDragOver",!0))},dragover:function(e){window.isSorting||e.preventDefault()},dragleave:function(e){window.isSorting||(r--,r<=0&&(r=0,t.invokeMethodAsync("SetDragOver",!1)))},drop:function(e){if(!window.isSorting&&(e.preventDefault(),r=0,t.invokeMethodAsync("SetDragOver",!1),e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files.length>0)){Array.from(e.dataTransfer.files).forEach(e=>{const n=new FileReader;n.onload=function(n){t.invokeMethodAsync("OnJsFileDropped",e.name,e.type,n.target.result.split(",")[1])},n.readAsDataURL(e)})}}},n.addEventListener("dragenter",n._dropHandlers.dragenter),n.addEventListener("dragover",n._dropHandlers.dragover),n.addEventListener("dragleave",n._dropHandlers.dragleave),n.addEventListener("drop",n._dropHandlers.drop)},window.unregisterDropArea=function(e){const t=document.getElementById(e);t&&t._dropHandlers&&(t.removeEventListener("dragenter",t._dropHandlers.dragenter),t.removeEventListener("dragover",t._dropHandlers.dragover),t.removeEventListener("dragleave",t._dropHandlers.dragleave),t.removeEventListener("drop",t._dropHandlers.drop),delete t._dropHandlers)},window.registerSelectDropArea=function(e){const t=document.getElementById("select-drop-area");if(!t||!t.firstElementChild)return;window.unregisterSelectDropArea();const n=t.firstElementChild;let r=0;t.ondragenter=e=>{r++,n.classList.remove("bg-white/60"),n.classList.add("bg-blue-100/60","border-solid")},t.ondragover=e=>{e.preventDefault()},t.ondragleave=e=>{r--,r<=0&&(console.log("ondragleave"),r=0,n.classList.remove("bg-blue-100/60","border-solid"),n.classList.add("bg-white/60"))},t.ondrop=t=>{t.preventDefault(),n.classList.remove("bg-blue-100/60","border-solid"),n.classList.add("bg-white/60"),t.dataTransfer&&t.dataTransfer.files.length>0&&Array.from(t.dataTransfer.files).forEach(t=>{const n=new FileReader;n.onload=function(n){const r=n.target.result.split(",")[1];e.invokeMethodAsync("OnJsFileDropped",t.name,t.type,r)},n.readAsDataURL(t)})},t.onpaste=t=>{t.clipboardData&&t.clipboardData.files.length>0&&Array.from(t.clipboardData.files).forEach(t=>{const n=new FileReader;n.onload=function(n){const r=n.target.result.split(",")[1];e.invokeMethodAsync("OnJsFileDropped",t.name,t.type,r)},n.readAsDataURL(t)})}},window.unregisterSelectDropArea=function(){const e=document.getElementById("select-drop-area");e&&(e.ondragenter=null,e.ondragover=null,e.ondragleave=null,e.ondrop=null,e.onpaste=null)},window.getPageSourceInfo=async function(e,t,n){try{if(!n)return null;let e=n;const t=/^data:.*;base64,(.*)$/.exec(n);t&&t[1]&&(e=t[1]);const i=window.devicePixelRatio||1;try{const t=Uint8Array.from(atob(e),e=>e.charCodeAt(0)),n=await window.pdfjsLib.getDocument({data:t,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}).promise,r=(await n.getPage(1)).getViewport({scale:1});return{origW:r.width,origH:r.height,dpr:i}}catch(r){try{const e=n,t=await new Promise((t,n)=>{const r=new Image;r.onload=()=>t(r),r.onerror=n,r.src=e});return{origW:t.naturalWidth,origH:t.naturalHeight,dpr:i}}catch(o){return console.error("getPageSourceInfo: not pdf nor image",o),null}}}catch(i){return console.error("getPageSourceInfo error",i),null}},window.drawPdfPageToCanvas=async function(e,t,n=1,r){try{const i=`#pdf-canvas-${e}`,a=document.querySelector(i);if(!a||!t)return;let s=t;const l=/^data:.*;base64,(.*)$/.exec(t);let d;l&&l[1]&&(s=l[1]);try{d=Uint8Array.from(atob(s),e=>e.charCodeAt(0))}catch(o){return void console.error("drawPdfPageToCanvas: invalid base64",o)}const c=window.pdfjsLib;if(!c)return void console.error("pdfjsLib not loaded");if(window._pdfRenderTask&&window._pdfRenderTask.cancel)try{window._pdfRenderTask.cancel()}catch{}const w=c.getDocument({data:d,standardFontDataUrl:c.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:c.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:c.GlobalWorkerOptions.openjpegJsUrl}),u=await w.promise,h=await u.getPage(1),m=window.devicePixelRatio||1,g=n<1?1:m,p=n*g,f=h.getViewport({scale:p,rotation:r});a.width=Math.round(f.width),a.height=Math.round(f.height);const y=document.createElement("canvas");y.width=Math.max(1,Math.round(f.width)),y.height=Math.max(1,Math.round(f.height));const v=y.getContext("2d");v&&v.setTransform&&v.setTransform(1,0,0,1,0,0),window._pdfRenderTask=h.render({canvasContext:v,viewport:f}),await window._pdfRenderTask.promise;const b=a.getContext("2d");if(!b)return;b.setTransform(1,0,0,1,0,0),b.clearRect(0,0,a.width,a.height);const x=Math.round((a.width-y.width)/2),R=Math.round((a.height-y.height)/2);b.drawImage(y,0,0,y.width,y.height,x,R,y.width,y.height),b.setTransform&&b.setTransform(g,0,0,g,0,0)}catch(i){if(i&&"RenderingCancelledException"===i.name)return;console.error("drawPdfPageToCanvas error",i)}},window.getTagNameFromEvent=function(e){return e&&e.target&&e.target.tagName?e.target.tagName:""},window.getCanvasCoords=function(e,t,n,r,o,i){const a=document.querySelector(e);if(!a)return{x:0,y:0};const s=a.getBoundingClientRect();return{x:(t-s.left)/i,y:(n-s.top)/i}},window.triggerFileInput=e=>{e.click()},window.clearFileInput=function(e){e&&(e.value="")},window.registerGlobalMouseUp=function(e){window._blazorMouseUpHandler=function(t){e.invokeMethodAsync("OnGlobalMouseUp")},window.addEventListener("mouseup",window._blazorMouseUpHandler)},window.unregisterGlobalMouseUp=function(){window._blazorMouseUpHandler&&(window.removeEventListener("mouseup",window._blazorMouseUpHandler),window._blazorMouseUpHandler=null)},window.registerGlobalMouseMove=function(e){window._globalMouseMoveHandler=function(t){e.invokeMethodAsync("OnGlobalMouseMove",{clientX:t.clientX,clientY:t.clientY})},window.addEventListener("mousemove",window._globalMouseMoveHandler)},window.unregisterGlobalMouseMove=function(){window._globalMouseMoveHandler&&(window.removeEventListener("mousemove",window._globalMouseMoveHandler),window._globalMouseMoveHandler=null)},window.getElementRect=function(e){const t=document.querySelector(e);if(!t)return{left:0,top:0,width:0,height:0};const n=t.getBoundingClientRect();return{left:n.left,top:n.top,width:n.width,height:n.height}},window.waitForNextFrame=function(){return new Promise(e=>requestAnimationFrame(e))},window.measureMaxLineWidth=function(e,t,n){const r=(window._measureTextCanvas||(window._measureTextCanvas=document.createElement("canvas"))).getContext("2d");r.font=`${t}px ${n}`;const o=e.split("\n");let i=0;for(const a of o){const e=r.measureText(a).width;e>i&&(i=e)}return i},window.selectAllTextarea=function(e){e&&e.select()},window.autoResizeTextarea=function(e){try{const t=(e=>e?"string"==typeof e?document.getElementById(e):(HTMLElement,e):null)(e);return t&&t.style?new Promise(e=>{requestAnimationFrame(()=>{try{t.style.height="auto",t.getBoundingClientRect();const r=window.getComputedStyle(t),o=parseFloat(r.lineHeight)||parseFloat(r.fontSize)||16,i=Math.max(t.scrollHeight||0,o),a=Math.ceil(i+2);t.style.height=a+"px",t.style.overflow="hidden";let s=0;try{const e=t.closest&&t.closest(".edit-element");if(e){const t=window.getComputedStyle(e);s=(parseFloat(t.borderTopWidth)||0)+(parseFloat(t.borderBottomWidth)||0)}}catch(n){}e(a+s||0)}catch(r){console.error("autoResizeTextarea inner error",r),e(0)}})}):(console.debug("autoResizeTextarea: element not found:",e),0)}catch(t){return console.error("autoResizeTextarea error",t),0}},window.getImageSizeFromBase64=function(e){return new Promise(t=>{const n=new Image;n.onload=function(){t({width:n.width,height:n.height})},n.src=e})},window.openInsertFileDialog=function(e){const t=document.getElementById(e);t&&(t.value=null,t.click())},window.openFileDialog=function(e){const t=document.getElementById(e);t&&t.click()},window.createZipFromUrls=async function(t,n){if(await e(),!window.JSZip)throw new Error("JSZipがロードされていません。");const r=new JSZip;for(let e=0;e<t.length;e++){const o=t[e],a=n[e]||`file${e+1}.pdf`;try{const e=await fetch(o),t=await e.blob(),n=await t.arrayBuffer();r.file(a,n)}catch(i){console.error(`ファイル取得失敗: ${a}`,i)}}const o=await r.generateAsync({type:"blob"});return URL.createObjectURL(o)},window.getZipFileSize=async function(e){try{const t=await fetch(e),n=(await t.blob()).size;return n<1024?`${n} bytes`:n<1048576?`${(n/1024).toFixed(1)} KB`:`${(n/1048576).toFixed(2)} MB`}catch(t){return console.error("zipファイルサイズ取得失敗",t),""}},window.downloadAllPdfsAsPngZip=async function(t,n,r){await e();const o=window.pdfjsLib;if(!o)return void alert("PDF.jsがロードされていません");const i=new window.JSZip;for(let e=0;e<t.length;e++){const r=t[e],a=(n[e]||`file${e+1}.pdf`).replace(/\.pdf$/i,"");let s=null;try{const e=await fetch(r),t=await e.arrayBuffer();s=await o.getDocument({data:t,standardFontDataUrl:o.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:o.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:o.GlobalWorkerOptions.openjpegJsUrl}).promise;for(let n=1;n<=s.numPages;n++){const e=await s.getPage(n),t=document.createElement("canvas"),r=e.getViewport({scale:2});t.width=r.width,t.height=r.height,await e.render({canvasContext:t.getContext("2d"),viewport:r}).promise;const o=t.toDataURL("image/png");i.file(`${a}_page${n}.png`,o.split(",")[1],{base64:!0})}}catch(l){console.error(`PDF変換失敗: ${a}`,l)}finally{try{s&&"function"==typeof s.destroy&&s.destroy()}catch(l){console.warn("pdf.destroy() error",l)}}}const a=await i.generateAsync({type:"blob"}),s=document.createElement("a");s.href=URL.createObjectURL(a),s.download=r||"images.zip",document.body.appendChild(s),s.click(),document.body.removeChild(s)};let t=null;window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),t=e}),window.isInstallPromptAvailable=function(){return null!==t},window.showInstallPrompt=async function(){t&&(t.prompt(),t=null)};let n=null;function r(e){const t=e.replace(/[\r\n\s]/g,""),n=atob(t),r=n.length,o=new Uint8Array(r);for(let i=0;i<r;i++)o[i]=n.charCodeAt(i);return o}async function o(e,t,o=null){const i=window.pdfjsLib;if(!i)throw new Error("pdfjsLib not loaded for image fallback");if(o&&window._pdfLibFileRestricted)try{window._pdfLibFileRestricted.add(o)}catch(b){}const a=i.getDocument({data:e,standardFontDataUrl:i.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:i.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:i.GlobalWorkerOptions.openjpegJsUrl}),s=await a.promise,l=await s.getPage(t+1),d=n&&n.pdfSettings&&n.pdfSettings.scales&&n.pdfSettings.scales.unlock||1.5,c=l.getViewport({scale:d}),w=document.createElement("canvas");w.width=Math.max(1,Math.round(c.width)),w.height=Math.max(1,Math.round(c.height));const u=w.getContext("2d",{alpha:!1});await l.render({canvasContext:u,viewport:c}).promise;const h=r(w.toDataURL("image/png").split(",")[1]),{PDFDocument:m}=PDFLib,g=await m.create(),p=await g.embedPng(h);g.addPage([w.width,w.height]);const[f]=g.getPages();f.drawImage(p,{x:0,y:0,width:w.width,height:w.height});const y=await g.save();let v="";for(let n=0;n<y.length;n++)v+=String.fromCharCode(y[n]);return btoa(v)}async function i(){try{const{PDFDocument:e}=PDFLib,t=await e.create();t.addPage([595.28,841.89]);const n=await t.save();let r="";for(let o=0;o<n.length;o++)r+=String.fromCharCode(n[o]);return btoa(r)}catch(e){return console.error("Error creating blank page:",e),""}}window.loadConfig=async function(){if(!n){const e=await fetch("/config.json");n=await e.json()}return n},window.loadConfig(),window.embedImageAsPdf=async function(e,t){const{PDFDocument:n}=PDFLib,o=await n.create();let i;const a=r(e);if(t.endsWith(".png"))i=await o.embedPng(a);else if(t.endsWith(".jpg")||t.endsWith(".jpeg"))i=await o.embedJpg(a);else{if(!(t.endsWith(".gif")||t.endsWith(".bmp")||t.endsWith(".webp")||t.endsWith(".svg")))throw new Error("Unsupported image type");{const n=t.endsWith(".gif")?"image/gif":t.endsWith(".bmp")?"image/bmp":t.endsWith(".webp")?"image/webp":t.endsWith(".svg")?"image/svg+xml":"",{pngBase64:a,width:s,height:l}=await convertImageToPngBase64AndSize(e,n);i=await o.embedPng(r(a.split(",")[1]))}}const s=i.scale(1);o.addPage([s.width,s.height]).drawImage(i,{x:0,y:0,width:s.width,height:s.height});const l=await o.save();let d="";for(let r=0;r<l.length;r++)d+=String.fromCharCode(l[r]);return btoa(d)},window.mergePDFPages=async function(e){const{PDFDocument:t,degrees:n}=PDFLib,o=await t.create();for(let l=0;l<e.length;l++){let i,a=e[l],d=a.pageData;if("string"==typeof d)i=r(d);else if(d instanceof Uint8Array)i=d;else{if(!Array.isArray(d))throw new Error(`Unsupported pageData type at index ${l}: ${typeof d}`);i=new Uint8Array(d)}try{const e=await t.load(i),[r]=await o.copyPages(e,[0]);"object"==typeof a&&a.rotateAngle&&a.rotateAngle%360!=0&&r.setRotation(n(a.rotateAngle)),o.addPage(r)}catch(s){throw console.error(`Error at mergePDFPages index=${l}:`,s,d),s}}const i=await o.save(),a=new Blob([i],{type:"application/pdf"});return URL.createObjectURL(a)},window.renderFirstPDFPage=async function(e,t){try{let a;if(e instanceof Uint8Array)a=e;else if(Array.isArray(e))a=new Uint8Array(e);else if("string"==typeof e){const y=atob(e);a=new Uint8Array(y.length);for(let v=0;v<y.length;v++)a[v]=y.charCodeAt(v)}else a=new Uint8Array(e);if(a.length<8)throw new Error("Data too short to be valid PDF");const s=String.fromCharCode.apply(null,a.slice(0,8));if(!s.startsWith("%PDF-"))throw new Error(`Invalid PDF header: ${s}`);const l=window.pdfjsLib;if(!l)throw new Error("PDF.js library not loaded");if(a.length<1024)throw new Error("PDF file is too small to be valid");let d=!1,c=!1,w="",u="",h=null,m=null;const g=[{data:a,stopAtErrors:!1,maxImageSize:5242880,disableFontFace:!0,disableRange:!0,disableStream:!0,verbosity:1},{data:a,stopAtErrors:!1,maxImageSize:10485760,disableFontFace:!1,disableRange:!0,disableStream:!1,verbosity:1},{data:a,stopAtErrors:!1,verbosity:1}];for(let b=0;b<g.length;b++)try{const x=l.getDocument({...g[b],standardFontDataUrl:l.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:l.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:l.GlobalWorkerOptions.openjpegJsUrl,password:t||void 0});x.onPassword=function(e,t){throw t===l.PasswordResponses.NEED_PASSWORD?new Error("PasswordException"):t===l.PasswordResponses.INCORRECT_PASSWORD?(console.log("パスワードが間違っています。"),new Error("PasswordException")):new Error("PasswordException")},h=await x.promise;break}catch(r){if(m=r,r&&"PasswordException"===r.name){d=!0,w="パスワード付きPDF";break}if(b===g.length-1)throw m}if(d||!h)return{thumbnail:"",isPasswordProtected:d,isOperationRestricted:c,securityInfo:w||"パスワード付きPDF"};h&&h._pdfInfo&&h._pdfInfo.permissions&&(c=h._pdfInfo.permissions.length>0,w+=c?" 操作制限あり":"");let p=0;try{const R=await h.getPage(1);try{"function"==typeof R.getRotation?p=R.getRotation():void 0!==R.rotate&&(p=R.rotate)}catch(o){p=0}p=((Number(p)||0)%360+360)%360;const P=R.getViewport({scale:n.pdfSettings.scales.thumbnail,rotation:0}),M=document.createElement("canvas");M.width=Math.max(1,Math.round(P.width)),M.height=Math.max(1,Math.round(P.height));const A=M.getContext("2d");await R.render({canvasContext:A,viewport:P}).promise,u=M.toDataURL("image/png")}catch(i){console.error("サムネイル生成エラー:",i),u=""}let f=[];try{const L=await h.getOutline();if(L&&L.length){async function E(e){const t=[];for(const n of e){let e=null;try{let t=n.dest;if("string"==typeof t&&(t=await h.getDestination(t)),Array.isArray(t)&&t.length>0)try{e=await h.getPageIndex(t[0])}catch(o){e=null}}catch(o){}const r={title:n.title||"",pageIndex:e,items:[]};n.items&&n.items.length&&(r.items=await E(n.items)),t.push(r)}return t}try{f=await E(L)}catch(o){console.error("pdf: outline mapping failed",o),f=[]}}}catch(o){console.error("pdf: getOutline failed or no outline",o),f=[]}return{thumbnail:u,isPasswordProtected:d,isOperationRestricted:c,securityInfo:w,bookmarks:f,pageRotation:p}}catch(r){return console.error("Error in renderFirstPDFPage:",r),{thumbnail:"",isPasswordProtected:r&&"PasswordException"===r.name,isOperationRestricted:!1,securityInfo:r&&"PasswordException"===r.name?"パスワード付きPDF":"解析失敗",bookmarks:[]}}},window.generatePdfThumbnailFromFileMetaData=async function(e,t){try{let i;if(e instanceof Uint8Array)i=e;else if(Array.isArray(e))i=new Uint8Array(e);else if("string"==typeof e){const t=atob(e);i=new Uint8Array(t.length);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e)}else i=new Uint8Array(e);const a=window.pdfjsLib;if(!a)throw new Error("PDF.js library not loaded");let s=await a.getDocument({data:i,standardFontDataUrl:a.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:a.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:a.GlobalWorkerOptions.openjpegJsUrl}).promise,l="";try{const e=await s.getPage(t+1),o=e.getViewport({scale:n.pdfSettings.scales.thumbnail,rotation:0}),i=document.createElement("canvas");i.width=o.width,i.height=o.height;const a=i.getContext("2d");await e.render({canvasContext:a,viewport:o}).promise,l=i.toDataURL("image/png");try{if(window.__downloadThumbnailDirect){const e=l.split(",")[1]||"",n=atob(e),r=n.length,o=new Uint8Array(r);for(let t=0;t<r;t++)o[t]=n.charCodeAt(t);const i=new Blob([o],{type:"image/png"}),a=URL.createObjectURL(i),s=document.createElement("a");s.href=a,s.download=`thumb_page_${t+1}_rot${"undefined"!=typeof pageRotation?pageRotation:0}.png`,document.body.appendChild(s),s.click(),s.remove(),setTimeout(()=>{try{URL.revokeObjectURL(a)}catch(e){}},3e3)}}catch(r){console.debug("auto-download failed",r)}}catch(o){l=""}return{thumbnail:l,isError:!1,isPasswordProtected:!1,securityInfo:""}}catch(i){return{thumbnail:"",isError:!0,isPasswordProtected:!1,securityInfo:"解析失敗"}}},window.convertImageToPngBase64AndSize=function(e,t){return new Promise((n,r)=>{const o=new Image;o.onload=function(){const e=document.createElement("canvas");e.width=o.width||800,e.height=o.height||600;e.getContext("2d").drawImage(o,0,0);const t=e.toDataURL("image/png");n({pngBase64:t,width:o.width,height:o.height})},o.onerror=r,e.startsWith("data:")?o.src=e:o.src=t?`data:${t};base64,${e}`:`data:image/png;base64,${e}`})},window.getPDFPageCount=async function(e){try{let t;if(e instanceof Uint8Array)t=e;else if(Array.isArray(e))t=new Uint8Array(e);else if("string"==typeof e){const n=atob(e);t=new Uint8Array(n.length);for(let e=0;e<n.length;e++)t[e]=n.charCodeAt(e)}else t=new Uint8Array(e);const n=window.pdfjsLib;if(!n)throw new Error("PDF.js library not loaded");const r=n.getDocument({data:t,stopAtErrors:!1,verbosity:1,standardFontDataUrl:n.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:n.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:n.GlobalWorkerOptions.openjpegJsUrl});return(await r.promise).numPages}catch(t){throw console.error("Error in getPDFPageCount:",t),t}},window._pdfLibCache=window._pdfLibCache||new Map,window._pdfLibFileRestricted=window._pdfLibFileRestricted||new Set,window._pdfLibFileIsRestricted=function(e){try{return!!(e&&window._pdfLibFileRestricted&&window._pdfLibFileRestricted.has(e))}catch(t){return!1}},window._pdfLibCacheClear=function(){try{return window._pdfLibCache&&"function"==typeof window._pdfLibCache.clear?(window._pdfLibCache.clear(),!0):(window._pdfLibCache=new Map,!0)}catch(e){return!1}},window._pdfLibCacheDelete=function(e){try{return!!e&&(!(!window._pdfLibCache||!window._pdfLibCache.has(e))&&(window._pdfLibCache.delete(e),!0))}catch(t){return!1}},window._pdfLibFileRestrictedClear=function(){try{return window._pdfLibFileRestricted&&"function"==typeof window._pdfLibFileRestricted.clear?(window._pdfLibFileRestricted.clear(),!0):(window._pdfLibFileRestricted=new Set,!0)}catch(e){return!1}},window.extractPdfPage=async function(e,t,n=null){try{const{PDFDocument:l}=PDFLib;if(!l)throw new Error("PDF-lib library not loaded");let d;if(e instanceof Uint8Array)d=e;else if(Array.isArray(e))d=new Uint8Array(e);else if("string"==typeof e){const t=atob(e);d=new Uint8Array(t.length);for(let e=0;e<t.length;e++)d[e]=t.charCodeAt(e)}else d=new Uint8Array(e);let c=null;if(n&&window._pdfLibCache.has(n))c=window._pdfLibCache.get(n);else try{c=await l.load(d),n&&window._pdfLibCache.set(n,c)}catch(r){try{return await o(d,t,n)}catch(a){return console.error("extractPdfPage: fallback render failed, returning blank page",a),await i()}}const w=await l.create();try{if(n&&window._pdfLibFileRestricted&&window._pdfLibFileRestricted.has(n))throw new Error("file-restricted-precheck");const[e]=await w.copyPages(c,[t]);w.addPage(e)}catch(s){try{return await o(d,t,n)}catch(a){return console.error("extractPdfPage: image fallback failed",a),await i()}}const u=await w.save();let h="";for(let e=0;e<u.length;e++)h+=String.fromCharCode(u[e]);return btoa(h)}catch(l){return console.error(`Error extracting PDF page ${t}:`,l),await i()}},window.generatePdfThumbnailFromPageData=async function(e){try{const t=window.pdfjsLib,r=atob(e),o=new Uint8Array(r.length);for(let e=0;e<r.length;e++)o[e]=r.charCodeAt(e);const i=t.getDocument({data:o,standardFontDataUrl:t.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:t.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:t.GlobalWorkerOptions.openjpegJsUrl}),a=await i.promise,s=await a.getPage(1),l=s.getViewport({scale:n.pdfSettings.scales.thumbnail}),d=document.createElement("canvas");d.width=l.width,d.height=l.height;const c={canvasContext:d.getContext("2d"),viewport:l};return await s.render(c).promise,d.toDataURL("image/png")}catch(t){return console.error("Error rendering single PDF page:",t),""}},window.generatePreviewImage=async function(e,t){const r=atob(e),o=new Uint8Array(r.length);for(let n=0;n<r.length;n++)o[n]=r.charCodeAt(n);const i=pdfjsLib.getDocument({data:o,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}),a=await i.promise,s=await a.getPage(1),l=s.getViewport({scale:n.pdfSettings.scales.normal,rotation:t||0}),d=document.createElement("canvas");d.width=l.width,d.height=l.height;const c=d.getContext("2d");return await s.render({canvasContext:c,viewport:l}).promise,d.toDataURL("image/jpeg",.85)},window.getPdfFileSize=async function(e){const t=await fetch(e);return((await t.blob()).size/1048576).toFixed(2)+"MB"},window.downloadFileFromUrl=function(e,t,n){const r=document.createElement("a");r.href=e,r.download=t,r.type=n||"application/octet-stream",document.body.appendChild(r),r.click(),document.body.removeChild(r)},window.renderPdfPages=async function(e,t){if(!window.pdfjsLib)return void console.error("pdfjsLib is not loaded");const r=await pdfjsLib.getDocument({url:e,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}).promise;for(let o=0;o<t.length;o++){const e=await r.getPage(o+1),i=document.getElementById(t[o]);if(!i)continue;const a=i.getContext("2d"),s=e.getViewport({scale:n.pdfSettings.scales.normal});i.width=s.width,i.height=s.height,await e.render({canvasContext:a,viewport:s}).promise}},window.checkCanvasExists=function(e){return!!document.getElementById(e)},window._canvasRendering=window._canvasRendering||{},window.renderPdfThumbnailToCanvas=async function(e,t){if(!window.pdfjsLib)throw new Error("pdfjsLib is not loaded.");if(window._canvasRendering[t])return console.warn("render in progress, skipping:",t),!1;window._canvasRendering[t]=!0;try{const r=window.pdfjsLib.getDocument({url:e,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}),o=await r.promise,i=await o.getPage(1),a=i.getViewport({scale:n.pdfSettings.scales.thumbnail}),s=document.getElementById(t);if(!s)return console.warn("canvas not found:",t),!1;const l=s.getContext("2d");return s.width=a.width,s.height=a.height,l.clearRect(0,0,s.width,s.height),await i.render({canvasContext:l,viewport:a}).promise,!0}catch(r){return console.error("renderPdfThumbnailToCanvas error",r,e,t),!1}finally{window._canvasRendering[t]=!1}},window.drawImageToCanvas=function(e,t,n=!0){const r=document.getElementById(e);if(!r)return;const o=r.getContext("2d"),i=new window.Image;i.onload=function(){try{const e=r.getBoundingClientRect(),t=Math.max(1,e.width||r.clientWidth||96),a=Math.max(1,e.height||r.clientHeight||128),s=n&&window.devicePixelRatio||1;r.width=Math.round(t*s),r.height=Math.round(a*s),o.setTransform(s,0,0,s,0,0),o.clearRect(0,0,t,a);const l=Math.min(t/i.width,a/i.height),d=i.width*l,c=i.height*l;o.drawImage(i,(t-d)/2,(a-c)/2,d,c)}catch(e){console.debug("drawImageToCanvas error",e)}},i.onerror=function(e){console.debug("drawImageToCanvas image load error",e,t)},i.src=t},window.unlockPdf=async function(e,t){const r=window.pdfjsLib;if(!r)throw new Error("PDF.js library not loaded");let o;if("string"==typeof e){const t=atob(e);o=new Uint8Array(t.length);for(let e=0;e<t.length;e++)o[e]=t.charCodeAt(e)}else o=e;const i=r.getDocument({data:o,password:t,standardFontDataUrl:r.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:r.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:r.GlobalWorkerOptions.openjpegJsUrl}),a=await i.promise,{PDFDocument:s}=PDFLib,l=await s.create();for(let w=1;w<=a.numPages;w++){const e=await a.getPage(w),t=e.getViewport({scale:n.pdfSettings.scales.unlock}),r=document.createElement("canvas");r.width=t.width,r.height=t.height;const o=r.getContext("2d");await e.render({canvasContext:o,viewport:t}).promise;const i=r.toDataURL("image/png"),s=await l.embedPng(i);l.addPage([t.width,t.height]).drawImage(s,{x:0,y:0,width:t.width,height:t.height})}const d=await l.save();let c="";for(let n=0;n<d.length;n++)c+=String.fromCharCode(d[n]);return btoa(c)},window.editPdfPageWithElements=async function(e,t){const{PDFDocument:n,rgb:r,StandardFonts:o}=PDFLib;if(!PDFLib._fontkitRegistered){if(!window.fontkit)throw new Error("fontkitがロードされていません。");PDFLib.PDFDocument.prototype.registerFontkit(window.fontkit),PDFLib._fontkitRegistered=!0}const i=g(e),a=await n.load(i),s=a.getPage(0),l=s.getHeight();let d=[];try{d=JSON.parse(t)}catch(p){console.error("editJson parse error",p,t)}const c={notoSansReg:null,notoSansBold:null,notoSerifReg:null,notoSerifBold:null};async function w(e){const t=(n=e.Text,/[\u3000-\u30FF\u4E00-\u9FFF\uFF01-\uFF60]/.test(n||""));var n;const r=t&&!!((i=e.FontFamily)&&i.toString().toLowerCase().indexOf("notoserif")>=0);var i;const s=!!e.IsBold;try{if(t){if(r){if(s){if(!c.notoSerifBold){const e=await fetch("/fonts/NotoSerifJP-Bold.ttf").then(e=>e.arrayBuffer());c.notoSerifBold=await a.embedFont(e)}return c.notoSerifBold}if(!c.notoSerifReg){const e=await fetch("/fonts/NotoSerifJP-Regular.ttf").then(e=>e.arrayBuffer());c.notoSerifReg=await a.embedFont(e)}return c.notoSerifReg}if(s){if(!c.notoSansBold){const e=await fetch("/fonts/NotoSansJP-Bold.ttf").then(e=>e.arrayBuffer());c.notoSansBold=await a.embedFont(e)}return c.notoSansBold}if(!c.notoSansReg){const e=await fetch("/fonts/NotoSansJP-Regular.ttf").then(e=>e.arrayBuffer());c.notoSansReg=await a.embedFont(e)}return c.notoSansReg}return e.IsBold?await a.embedFont(o.HelveticaBold):await a.embedFont(o.Helvetica)}catch(l){return console.error("font embed error",l),await a.embedFont(o.Helvetica)}}for(const f of d)if(0===f.Type||"Text"===f.Type){let e=function(e,t,n,r){if(!e)return[""];const o=[],i=e.split(/(\s+)/);let a="";for(const s of i){const e=t.widthOfTextAtSize(s,n);if((a?t.widthOfTextAtSize(a,n):0)+e<=r)a+=s;else if(a&&o.push(a),e<=r)a=s;else{let e="";for(let i=0;i<s.length;i++){e+=s[i];t.widthOfTextAtSize(e,n)>r&&(e.length>1?(o.push(e.slice(0,-1)),e=e.slice(-1)):(o.push(e),e=""))}a=e}}return a&&o.push(a),o};const t=await w(f),n=PDFLib.degrees(f.Rotation||0),r=Number(f.FontSize)||16,o=(void 0!==f.LineHeight&&f.LineHeight>0?Number(f.LineHeight):null)||r,i=f.Text||"",a="number"==typeof f.X?f.X:0,d="number"==typeof f.Width&&f.Width>0?Number(f.Width):s.getWidth()-a,c=i.split("\n"),u=[];for(const s of c){const n=e(s,t,r,d);0===n.length?u.push(""):u.push(...n)}const h=l-(f.Y||0)-r;for(let l=0;l<u.length;l++)s.drawText(u[l]||"",{x:a,y:h-l*o,size:r,font:t,color:m(f.Color||"#000000"),rotate:n})}else if(1===f.Type||"Image"===f.Type)if(f.ImageUrl&&(f.ImageUrl.startsWith("data:image/png")||f.ImageUrl.startsWith("data:image/jpeg"))){let e,t=f.ImageUrl.split(",")[1]||f.ImageUrl;f.ImageUrl.startsWith("data:image/png")?e=await a.embedPng(g(t)):f.ImageUrl.startsWith("data:image/jpeg")&&(e=await a.embedJpg(g(t)));const n=PDFLib.degrees(f.Rotation||0);s.drawImage(e,{x:f.X||0,y:l-(f.Y||0)-(f.Height||e.height),width:f.Width||e.width,height:f.Height||e.height,rotate:n})}else console.warn("未対応画像形式: ",f.ImageUrl?f.ImageUrl.substring(0,30):"");const u=await a.save();let h="";for(let f=0;f<u.length;f++)h+=String.fromCharCode(u[f]);return btoa(h);function m(e){3===(e=e.replace("#","")).length&&(e=e.split("").map(e=>e+e).join(""));const t=parseInt(e,16);return r((t>>16&255)/255,(t>>8&255)/255,(255&t)/255)}function g(e){const t=atob(e.replace(/^data:.*;base64,/,"")),n=t.length,r=new Uint8Array(n);for(let o=0;o<n;o++)r[o]=t.charCodeAt(o);return r}},window.addStampsToPdf=async function(e,t){const{PDFDocument:n,rgb:o,StandardFonts:i,degrees:a}=PDFLib;let s;PDFLib._fontkitRegistered||(window.fontkit?(PDFLib.PDFDocument.prototype.registerFontkit(window.fontkit),PDFLib._fontkitRegistered=!0):console.warn("fontkitがロードされていません。日本語フォントは使用できません。")),s="string"==typeof e?r(e):e instanceof Uint8Array?e:(Array.isArray(e),new Uint8Array(e));const l=((t.length>0&&t[0].rotateAngle||0)%360+360)%360,d=await n.load(s),c=d.getPage(0),{width:w,height:u}=c.getSize();let h=null;function m(e){return/[\u3000-\u30FF\u4E00-\u9FFF\uFF01-\uFF60]/.test(e)}function g(e,t,n){const r=e+1;if(!n)return r.toString();const o=t.toString().length;return r.toString().padStart(o,"0")}function p(e,t,n,r,o,i,a,s){let l=0,d=0,c=0;const w=(r%360+360)%360;if(0===w){switch(e){case"TopLeft":l=t,d=i-n-s;break;case"Top":l=o/2-a/2,d=i-n-s;break;case"TopRight":l=o-t-a,d=i-n-s;break;case"BottomLeft":l=t,d=n;break;case"Bottom":l=o/2-a/2,d=n;break;case"BottomRight":l=o-t-a,d=n}c=0}else if(90===w){switch(e){case"TopLeft":l=n,d=t;break;case"Top":l=n,d=i/2-a/2;break;case"TopRight":l=n,d=i-t-a;break;case"BottomLeft":l=o-n,d=t;break;case"Bottom":l=o-n,d=i/2-a/2;break;case"BottomRight":l=o-n,d=i-t-a}c=90}else if(180===w){switch(e){case"TopLeft":l=o-t,d=n;break;case"Top":l=o/2-a/2,d=n;break;case"TopRight":l=t+a,d=n;break;case"BottomLeft":l=o-t,d=i-n;break;case"Bottom":l=o/2-a/2,d=i-n;break;case"BottomRight":l=t+a,d=i-n}c=180}else if(270===w){switch(e){case"TopLeft":l=o-n,d=i-t;break;case"Top":l=o-n,d=i/2-a/2;break;case"TopRight":l=o-n,d=t+a;break;case"BottomLeft":l=n,d=i-t;break;case"Bottom":l=n,d=i/2-a/2;break;case"BottomRight":l=n,d=t+a}c=-90}return{x:l,y:d,textRotation:c}}for(const r of t){let e,t=r.text||"";if(r.isSerial){const e=g(r.currentPageIndex||0,r.totalPages||1,r.isZeroPadded||!1);t=t?`${t}${e}`:e}if(m(t)){if(!h)try{const e="/fonts/NotoSansJP-Regular.ttf",t=await fetch(e).then(e=>e.arrayBuffer());h=await d.embedFont(t)}catch(f){console.warn("日本語フォント読み込み失敗:",f),e=await d.embedFont(i.Helvetica)}e=h||await d.embedFont(i.Helvetica)}else e=await d.embedFont(i.Helvetica);const n=r.fontSize||12,s=e.widthOfTextAtSize(t,n),v=p(r.corner,r.offsetX,r.offsetY,l,w,u,s,n),b=r.color?o(r.color.r||0,r.color.g||0,r.color.b||0):o(0,0,0);try{c.drawText(t,{x:v.x,y:v.y,size:n,font:e,color:b,rotate:a(v.textRotation)})}catch(y){throw console.error("スタンプ描画エラー:",y),y}}return await d.save()},window.cropPdfPageRasterized=async function(e,t,o,i,a,s=0){try{const l=atob(e),d=new Uint8Array(l.length);for(let e=0;e<l.length;e++)d[e]=l.charCodeAt(e);if(!window.pdfjsLib)throw new Error("pdfjsLib is not loaded");const c=pdfjsLib.getDocument({data:d,standardFontDataUrl:pdfjsLib.GlobalWorkerOptions.standardFontDataUrl,wasmUrl:pdfjsLib.GlobalWorkerOptions.wasmUrl,openjpegJsUrl:pdfjsLib.GlobalWorkerOptions.openjpegJsUrl}),w=await c.promise,u=await w.getPage(1),h=((Number(s)||0)%360+360)%360,m=90*Math.round(h/90)%360,g=n&&n.pdfSettings&&n.pdfSettings.scales&&n.pdfSettings.scales.unlock||1.5,p=u.getViewport({scale:g,rotation:m}),f=document.createElement("canvas");f.width=Math.max(1,Math.round(p.width)),f.height=Math.max(1,Math.round(p.height));const y=f.getContext("2d",{alpha:!1});await u.render({canvasContext:y,viewport:p}).promise;const v=Math.max(0,Math.min(f.width,Math.round(t*f.width))),b=Math.max(0,Math.min(f.height,Math.round(o*f.height))),x=Math.max(1,Math.min(f.width-v,Math.round(i*f.width))),R=Math.max(1,Math.min(f.height-b,Math.round(a*f.height))),P=document.createElement("canvas");P.width=x,P.height=R;P.getContext("2d",{alpha:!1}).drawImage(f,v,b,x,R,0,0,x,R);const M=P.toDataURL("image/png"),A=r(M.split(",")[1]),{PDFDocument:L}=PDFLib,E=await L.create(),D=await E.embedPng(A),S=x,_=R;E.addPage([S,_]).drawImage(D,{x:0,y:0,width:S,height:_});const C=await E.save();let F="";for(let e=0;e<C.length;e++)F+=String.fromCharCode(C[e]);return btoa(F)}catch(l){return console.error("cropPdfPageRasterized error",l),e||""}},window.cropPdfPageToTrimVector=async function(e,t,n,o,i,a=0){try{const s=r(e),{PDFDocument:l,PDFName:d}=PDFLib,c=await l.load(s),w=c.getPages()[0],u=w.getWidth(),h=w.getHeight(),m=Math.max(0,Math.min(1,Number(t)||0)),g=Math.max(0,Math.min(1,Number(n)||0)),p=Math.max(0,Math.min(1,Number(o)||0)),f=Math.max(0,Math.min(1,Number(i)||0)),y=((Number(a)||0)%360+360)%360,v=90*Math.round(y/90)%360;let b,x,R,P;if(0===v)b=m*u,x=h*(1-g-f),R=b+p*u,P=x+f*h;else{let e=function(e,t){const n=e-s,r=l-t;return{x:n*y-r*M+d,y:n*M+r*y+c}};const t=v%180==0?u:h,n=v%180==0?h:u,r=m*t,o=g*n,i=Math.max(1,p*t),a=Math.max(1,f*n),s=t/2,l=n/2,d=u/2,c=h/2,w=-v*Math.PI/180,y=Math.cos(w),M=Math.sin(w),A=e(r,o),L=e(r+i,o),E=e(r,o+a),D=e(r+i,o+a),S=[A.x,L.x,E.x,D.x],_=[A.y,L.y,E.y,D.y],C=Math.min(...S),F=Math.max(...S),T=Math.min(..._),z=Math.max(..._);b=C,x=T,R=F,P=z}const M=Math.max(0,Math.min(u,Math.round(b))),A=Math.max(0,Math.min(h,Math.round(x))),L=Math.max(0,Math.min(u,Math.round(R))),E=Math.max(0,Math.min(h,Math.round(P))),D=await l.create(),[S]=await D.copyPages(c,[0]);D.addPage(S),S.node.set(d.of("CropBox"),D.context.obj([Math.round(M),Math.round(A),Math.round(L),Math.round(E)]));const _=await D.save();let C="";for(let e=0;e<_.length;e++)C+=String.fromCharCode(_[e]);return btoa(C)}catch(s){return console.error("cropPdfPageToTrimVector error",s),e||""}},window.getImageSizeFromDataUrl=function(e){return new Promise(t=>{try{if(!e)return void t([0,0]);const n=new Image;n.onload=function(){t([n.naturalWidth||0,n.naturalHeight||0])},n.onerror=function(){t([0,0])},n.src=e,setTimeout(()=>{n.complete||t([0,0])},2e3)}catch(n){t([0,0])}})},window.scrollToSection=function(e){e&&e.scrollIntoView({behavior:"smooth"})};let a=null;function s(){try{if(window._trimShared&&window._trimShared.resizeHandler)return;const e=function(){try{window._trimShared.timer&&clearTimeout(window._trimShared.timer),window._trimShared.timer=setTimeout(()=>{try{Object.keys(window._simpleTrim||{}).forEach(e=>{try{const n=(window._simpleTrim||{})[e];if(n&&n.internal&&"function"==typeof n.internal.onAnyScrollOrResize)try{n.internal.onAnyScrollOrResize()}catch(t){}else if(n&&n.internal&&"function"==typeof n.internal.resize)try{n.internal.resize()}catch(t){}}catch(t){}});try{if(window._trimResize&&"function"==typeof window._trimResize.windowResizeCallback)try{window._trimResize.windowResizeCallback()}catch(e){}}catch(e){}}catch(e){}},window._trimShared.debounceMs)}catch(e){}};window._trimShared.resizeHandler=e,window.addEventListener("resize",e,{passive:!0}),window.visualViewport&&window.visualViewport.addEventListener&&(window.visualViewport.addEventListener("resize",e,{passive:!0}),window.visualViewport.addEventListener("scroll",e,{passive:!0}))}catch(e){console.error("ensureSharedTrimResizeHandler error",e)}}function l(e,t){let n=0,r=0,o=e;for(;o&&o!==t&&o!==document.body;)n+=o.offsetLeft||0,r+=o.offsetTop||0,o=o.offsetParent;return{x:n,y:r}}window.isSorting=!1,window.initializeSortable=function(){function e(){return document.getElementById("sortable-container")}function t(){const t=e();t&&(t.classList.remove("is-sorting","dragging-chosen","dragging-ghost"),t.querySelectorAll(".dragging-chosen, .dragging-ghost").forEach(e=>{e.classList.remove("dragging-chosen","dragging-ghost")})),window.isSorting=!1}window.removeEventListener("mouseup",t),window.removeEventListener("touchend",t);const n=e();n&&"none"!==window.getComputedStyle(n).display&&window.Sortable?(a&&(a.destroy(),a=null,n.classList.remove("is-sorting"),window.isSorting=!1),window.addEventListener("mouseup",t),window.addEventListener("touchend",t),a=new Sortable(n,{draggable:".sortable-item-container",handle:window.matchMedia("(min-width: 768px)").matches?".drag-handle":".touch-drag-handle",filter:".non-sortable",animation:150,ghostClass:"dragging-ghost",chosenClass:"dragging-chosen",onStart:function(e){n.classList.add("is-sorting"),window.isSorting=!0},onMove:function(e){const t=e.related,r=e.dragged;if(t&&t.classList.contains("non-sortable")){const e=t,o=e.previousElementSibling;return o&&o.classList.contains("sortable-chosen"),n.insertBefore(r,e),!1}if(t&&t.closest(".non-sortable")){const e=t.closest(".non-sortable");return n.insertBefore(r,e),!1}if(!t||t===n){const e=n.querySelector(".non-sortable");return e&&n.insertBefore(r,e),!1}return!0},onEnd:function(e){t();const r=n.querySelectorAll(".sortable-item-container:not(.non-sortable)").length;let o=e.newIndex;e.newIndex>=r&&(o=r-1),DotNet.invokeMethodAsync("NoCloudPdf","UpdateOrder",getPageType(),e.oldIndex,o)}})):a&&a.el&&(a.destroy(),a=null,t())},function(){const e="ncp_tour_ran",t="home-intro-v1";function n(){const e=["undefined"!=typeof window&&window.innerWidth<768?{id:"nav-explain",selector:"#nav-hamburger",title:"メニュー表示",text:"機能の切替メニューを表示できます。すぐに利用される方はこちらから。",position:"right",group:t}:{id:"nav-explain",selector:"#nav-main",title:"切替メニュー",text:"機能の切替メニューです。すぐに利用される方は，目的の機能をクリックしてください。",position:"right",group:t},{id:"home-tip",selector:"#home-summary-tip",title:"概要",text:"このページ下部にアプリの概要があります。",position:"top",group:t}];try{const n=document.querySelector("#install-pwa-btn");n&&function(e){try{if(!e)return!1;const t=window.getComputedStyle(e);return t&&"none"!==t.display}catch(t){return!1}}(n)&&e.push({id:"install-pwa",selector:"#install-pwa-btn",title:"インストール",text:"アプリのショートカットを作成できます。",position:"left",group:t})}catch(n){console.debug("tour: check install-pwa failed",n)}return e}function r(){try{const e=document.getElementById("ncp-tour-dontshow");e&&e.checked&&setEnabled(!1)}catch(e){}}async function o(){try{await function(e="#install-pwa-btn-flag",t=1e3,n=100){return new Promise(r=>{const o=Date.now(),i=()=>{try{const t=document.querySelector(e);if(t){const e=(t.value||"").toString().toLowerCase();if("true"===e)return r(!0);if("false"===e)return r(!1)}}catch(a){}if(Date.now()-o>=t)return r(!1);setTimeout(i,n)};i()})}("#install-pwa-btn-flag",1e3,100)}catch(a){}const o=n();!function(){try{document.querySelectorAll(".tg-backdrop, .tg-dialog").forEach(e=>{try{e.remove()}catch(a){}})}catch(a){}window._ncpTour&&(window._ncpTour.client=null)}();const i=window.tourguide?.TourGuideClient||window.TourGuideClient||window.tourguide||null;if("function"==typeof i||i&&"object"==typeof i)try{const n=o.map((e,t)=>{const n=document.querySelector(e.selector);return{title:e.title||"",content:e.text||"",target:n||e.selector,order:e.order??t+1,group:e.group??void 0}}),i={nextLabel:"次へ",prevLabel:"戻る",finishLabel:"終了",onAfterExit:r,completeOnFinish:!0},s=new tourguide.TourGuideClient({steps:n,...i});if(s){s.onFinish(async()=>{r()}),s.isFinished(t)||s.start(t);try{!function(){try{sessionStorage.setItem(e,"true")}catch(a){}}()}catch(a){}}return!0}catch(a){console.debug("tour: TourGuideClient init failed",a)}return console.debug("tour: no compatible start method found"),!1}window.startTourIfNeeded=async function(n={}){if((new tourguide.TourGuideClient).isFinished(t))return;if(!function(){const e=(document.querySelector("base")?.getAttribute("href")||"/").replace(/\/$/,""),t=location.pathname.replace(new RegExp("^"+e),"")||"/";return"/"===t||""===t}())return;if(function(){try{return"true"===sessionStorage.getItem(e)}catch(t){return!1}}())return;await o()},window._ncpTour={startTourIfNeeded:window.startTourIfNeeded}}(),window.registerPanelResize=function(e,t,n=1500){function r(e){try{const n=document.getElementById("loading-indicator");if(!n)return;try{n.__fadeTimeout&&(clearTimeout(n.__fadeTimeout),n.__fadeTimeout=null)}catch(t){}const r=220;if(n.style.transition&&-1!==n.style.transition.indexOf("opacity")||(n.style.transition=`opacity ${r}ms ease`),e)n.style.display="flex",n.style.opacity=n.style.opacity?n.style.opacity:"0",requestAnimationFrame(()=>{try{n.style.opacity="1"}catch(t){}});else{if("none"===getComputedStyle(n).display)return;requestAnimationFrame(()=>{try{n.style.opacity="0"}catch(t){}}),n.__fadeTimeout=setTimeout(()=>{try{n.style.display="none",n.style.opacity="0"}catch(t){}n.__fadeTimeout=null},r+20)}}catch(t){}}try{let i=function(){const e=window.innerWidth||document.documentElement.clientWidth,t=e<768,n=document.querySelector(".sidebar"),r=n&&!t?Math.round(n.getBoundingClientRect().width):0;return{vw:e,sidebarW:r,isMobileHeaderSidebar:t,avail:Math.max(0,e-r)}},a=function(e){return e.sidebarW||0},s=function(e){y=e;const t=Date.now();if(!p||t-p>=g){if(p=t,window._trimResize&&window._trimResize.dotNetRef&&window._trimResize.dotNetRef.invokeMethodAsync)try{window._trimResize.dotNetRef.invokeMethodAsync("OnPanelMouseMove",e).catch(()=>{})}catch(n){}}else{const e=g-(t-p);f&&clearTimeout(f),f=setTimeout(()=>{if(p=Date.now(),window._trimResize&&window._trimResize.dotNetRef&&window._trimResize.dotNetRef.invokeMethodAsync)try{window._trimResize.dotNetRef.invokeMethodAsync("OnPanelMouseMove",y).catch(()=>{})}catch(n){}f=null,y=null},e)}},l=function(e){try{const n=i().avail,r=d.getBoundingClientRect().width||8,o=Math.max(w,Math.round(n-u-r));let a=Math.max(w,Math.min(o,Math.round(e)));a=Math.min(a,o);const s=Math.max(u,Math.round(n-a-r));c&&(c.style.setProperty("--thumbnail-width",a+"px"),c.style.width=a+"px",c.style.flex=`0 0 ${a}px`);const l=document.getElementById("split-container"),h=l?l.querySelector(":scope > .flex-1"):d.nextElementSibling||null;h&&(h.style.width=s+"px",h.style.flex="0 0 auto",h.style.minWidth="0",h.style.maxWidth=s+"px"),l&&l.offsetHeight;try{window._trimResize&&window._trimResize.updateAllTrimOverlays&&window._trimResize.updateAllTrimOverlays()}catch(t){}window._trimResize.lastAppliedLeft=a,window._trimResize.lastAvail=n}catch(t){console.error("applyWidthsUsingAvail error",t)}};if(window._trimResize&&window._trimResize.cleanupForHandle){try{window._trimResize.cleanupForHandle()}catch(o){}window._trimResize.cleanupForHandle=null}window._trimResize.dotNetRef=e;const d=document.getElementById(t),c=document.getElementById("thumbnail-area");if(!d)return void console.warn("registerPanelResize: handle element not found:",t);const w=150,u=260;let h=!1,m=0;const g=Number(n)||500;let p=0,f=null,y=null;const v=function(e){try{try{r(!0)}catch(t){}try{window._trimResize.suspendFitZoom=!0}catch(t){}d.setPointerCapture?.(e.pointerId);const n=function(e){m=e.clientX,h||(h=!0,requestAnimationFrame(function(){h=!1;try{const e=i(),t=a(e),n=Math.round(m-t);l(n),s(m)}catch(e){console.error("onPointerMove error",e)}}))},o=function(e){try{if(d.releasePointerCapture?.(e.pointerId),f&&(clearTimeout(f),f=null),null!=y&&window._trimResize&&window._trimResize.dotNetRef&&window._trimResize.dotNetRef.invokeMethodAsync){try{window._trimResize.dotNetRef.invokeMethodAsync("OnPanelMouseMove",y).catch(()=>{})}catch(s){}y=null}const t=i(),n=a(t),r=d.getBoundingClientRect().width||8,o=t.avail,c=Math.max(w,Math.round(o-u-r)),h=Math.round(e.clientX-n),m=Math.max(w,Math.min(c,h));if(window._trimResize&&window._trimResize.dotNetRef&&window._trimResize.dotNetRef.invokeMethodAsync)try{window._trimResize.dotNetRef.invokeMethodAsync("CommitPanelWidth",m).catch(()=>{})}catch(s){}l(m),requestAnimationFrame(function(){window._trimResize&&window._trimResize.updateAllTrimOverlays&&window._trimResize.updateAllTrimOverlays()})}catch(c){console.error("onPointerUp error",c)}finally{try{window._trimResize.suspendFitZoom=!1}catch(t){}try{r(!1)}catch(s){}d.removeEventListener("pointermove",n),d.removeEventListener("pointerup",o)}};d.addEventListener("pointermove",n),d.addEventListener("pointerup",o)}catch(n){console.error("onPointerDown error",n)}};d.addEventListener("pointerdown",v),window._trimResize.cleanupForHandle=function(){try{d.removeEventListener("pointerdown",v)}catch(o){}window._trimResize.dotNetRef=null}}catch(o){console.error("registerPanelResize error",o)}},window.unregisterPanelResize=function(){try{window._trimResize.cleanupForHandle&&(window._trimResize.cleanupForHandle(),window._trimResize.cleanupForHandle=null),window._trimResize.dotNetRef=null}catch(e){console.error("unregisterPanelResize error",e)}},window._trimResize=window._trimResize||{dotNetRef:null,cleanupForHandle:null,windowResizeDotNetRef:null,windowResizeCallback:null,updateAllTrimOverlays:null,lastAppliedLeft:null,lastAvail:null,suspendFitZoom:!1},window.trimPreviewArea={dotNetRef:null,handlers:null,initialize:function(e){try{this.unregister&&this.unregister(),this.dotNetRef=e;const t=e=>{try{this.dotNetRef&&this.dotNetRef.invokeMethodAsync("OnPanelMouseMove",e.clientX).catch(()=>{})}catch(t){}},n=e=>{try{this.dotNetRef&&this.dotNetRef.invokeMethodAsync("OnPanelMouseUp").catch(()=>{})}catch(t){}};this.handlers={onMouseMove:t,onMouseUp:n},document.addEventListener("mousemove",t,{passive:!0}),document.addEventListener("mouseup",n,{passive:!0})}catch(t){console.error("trimPreviewArea.initialize error",t)}},unregister:function(){try{this.handlers&&(document.removeEventListener("mousemove",this.handlers.onMouseMove),document.removeEventListener("mouseup",this.handlers.onMouseUp),this.handlers=null),this.dotNetRef=null}catch(e){console.error("trimPreviewArea.unregister error",e)}},getImageDimensions:function(e){const t=document.getElementById(e);return t?[t.offsetWidth,t.offsetHeight]:[0,0]},scrollToPage:function(e){const t=document.getElementById(`preview-container-${e}`);t&&t.scrollIntoView({behavior:"smooth",block:"start"})}},window.getAvailableWidth=function(){try{const e=document.querySelector(".sidebar"),t=window.innerWidth||document.documentElement.clientWidth,n=e?Math.round(e.getBoundingClientRect().width):0;return{avail:Math.max(0,t-n),sidebarW:n,vw:t}}catch(e){return{avail:window.innerWidth||document.documentElement.clientWidth,sidebarW:0,vw:window.innerWidth||document.documentElement.clientWidth}}},window.applyThumbnailWidth=function(e){try{const t=document.getElementById("thumbnail-area"),n=document.getElementById("splitter-handle");if(!t)return;n&&n.getBoundingClientRect().width;return t.style.setProperty("--thumbnail-width",Math.round(e)+"px"),t.style.width=Math.round(e)+"px",!0}catch(t){return console.error("applyThumbnailWidth error",t),!1}},window.registerWindowResize=function(e,t=500){try{let t=function(){try{const t=window.innerWidth||document.documentElement.clientWidth,n=t<768,r=document.querySelector(".sidebar"),o=r&&!n?Math.round(r.getBoundingClientRect().width):0,i=Math.max(0,t-o);try{const t=200,n=600,r=260,a=document.getElementById("splitter-handle"),s=a&&a.getBoundingClientRect().width||8;let l=Math.round(.25*i);l=Math.max(t,Math.min(n,l)),l=Math.min(l,Math.max(t,Math.round(i-r-s)));const d=Math.max(0,Math.round(i-l-s)),c=document.getElementById("thumbnail-area");c&&(c.style.setProperty("--thumbnail-width",l+"px"),c.style.width=l+"px",c.style.flex=`0 0 ${l}px`);const w=document.getElementById("split-container"),u=w?w.querySelector(":scope > .flex-1"):document.getElementById("trim-preview-container")?.closest(".flex-1")||null;if(u&&(u.style.width="",u.style.flex="1 1 0%",u.style.minWidth="0",u.style.maxWidth=d+"px"),window._trimResize&&window._trimResize.windowResizeDotNetRef)try{window._trimResize.windowResizeDotNetRef.invokeMethodAsync("OnWindowResizedFromJs",i,o).catch(()=>{})}catch(e){}try{w&&w.offsetHeight}catch(e){}if(window._trimResize?.updateAllTrimOverlays)try{window._trimResize.updateAllTrimOverlays()}catch(e){console.error(e)}try{"function"==typeof window.computeAndApplyFitZoom&&window.computeAndApplyFitZoom()}catch(e){}}catch(e){console.error("measureAndNotify inner error",e)}}catch(e){console.error("measureAndNotify error",e)}};if(!e)return;window._trimResize.windowResizeCallback=null,window._trimResize.windowResizeDotNetRef=e,window._trimResize.windowResizeCallback=t,s();try{t()}catch(n){}window._trimResize.unregisterWindowResize=function(){try{window._trimResize&&(window._trimResize.windowResizeCallback=null,window._trimResize.windowResizeDotNetRef=null)}catch(n){}}}catch(n){console.error("registerWindowResize error",n)}},window.unregisterWindowResize=function(){try{window._trimResize&&window._trimResize.unregisterWindowResize&&(window._trimResize.unregisterWindowResize(),window._trimResize.unregisterWindowResize=null)}catch(e){console.error("unregisterWindowResize error",e)}},window._trimShared=window._trimShared||{resizeHandler:null,timer:null,debounceMs:120},window.setPreviewZoom=function(e,t="contain"){try{e=Math.max(.25,Math.min(3,Number(e)||1));const t=document.querySelector(".preview-zoom-viewport"),n=document.getElementById("preview-zoom-inner");if(!n||!t)return;const r=window._previewZoomState&&window._previewZoomState.lastZoom?window._previewZoomState.lastZoom:1,o=t.getBoundingClientRect(),i=n.getBoundingClientRect(),a=o.left+o.width/2,s=o.top+o.height/2,l=a-i.left,d=s-i.top,c=l/r,w=d/r;n.style.setProperty("--preview-zoom",String(e)),n.style.transform=`scale(${e})`,n.style.transformOrigin="0 0";const u=o.width,h=o.height,m=(n.scrollWidth||i.width)*e,g=(n.scrollHeight||i.height)*e;let p=c*e-u/2,f=w*e-h/2;p=Math.max(0,Math.min(m-u,p)),f=Math.max(0,Math.min(g-h,f)),t.scrollLeft=Math.round(p),t.scrollTop=Math.round(f),window._previewZoomState=window._previewZoomState||{},window._previewZoomState.lastZoom=e}catch(n){console.error("setPreviewZoom error",n)}},window.computeAndApplyFitZoom=function(){try{const e=document.getElementById("trim-preview-container"),t=document.getElementById("preview-zoom-inner");if(!e||!t)return;const n=e.clientWidth||1,r=window._previewZoomState&&window._previewZoomState.lastZoom?window._previewZoomState.lastZoom:1;let o=0;const i=t.querySelectorAll("canvas");if(i&&i.length>0&&i.forEach((e,t)=>{try{const t=(e.getBoundingClientRect().width||e.clientWidth||0)/r;t>o&&(o=t)}catch(n){console.warn("computeAndApplyFitZoom: canvas measurement error",n)}}),o<=0){const e=t.getBoundingClientRect();o=(t.scrollWidth||e.width||t.clientWidth||1)/r}(!o||o<=0)&&(o=1);const a=n/o,s=Math.max(.25,Math.min(3,a));"function"==typeof window.setPreviewZoom&&window.setPreviewZoom(s)}catch(e){console.error("computeAndApplyFitZoom error",e)}},window.setPreviewPanEnabled=function(e){try{const n=document.querySelector(".preview-zoom-viewport");if(!n)return;if(window._previewPan.handlers){try{const e=window._previewPan.handlers;n.removeEventListener("pointerdown",e.down),n.removeEventListener("pointermove",e.move),n.removeEventListener("pointerup",e.up),n.removeEventListener("pointercancel",e.up)}catch(t){}window._previewPan.handlers=null,window._previewPan.state=null,n.classList.remove("pan-active"),n.style.touchAction=""}if(!e)return window._previewPan.enabled=!1,void(n.style.cursor="");window._previewPan.enabled=!0,n.style.cursor="grab",n.style.touchAction="none",n.classList.add("pan-active");const r={active:!1,startX:0,startY:0,scrollLeft:0,scrollTop:0,pointerId:null};window._previewPan.state=r;const o=function(e){try{if(0!==e.button)return;r.active=!0,r.pointerId=e.pointerId,r.startX=e.clientX,r.startY=e.clientY,r.scrollLeft=n.scrollLeft,r.scrollTop=n.scrollTop,n.setPointerCapture&&n.setPointerCapture(e.pointerId),n.classList.add("panning")}catch(t){console.error("pan down error",t)}},i=function(e){try{if(!r.active||r.pointerId!==e.pointerId)return;const t=e.clientX-r.startX,o=e.clientY-r.startY;n.scrollLeft=r.scrollLeft-t,n.scrollTop=r.scrollTop-o}catch(t){}},a=function(e){try{if(r.active&&r.pointerId===e.pointerId){r.active=!1;try{n.releasePointerCapture&&n.releasePointerCapture(e.pointerId)}catch{}n.classList.remove("panning")}}catch(t){}};n.addEventListener("pointerdown",o),n.addEventListener("pointermove",i),n.addEventListener("pointerup",a),n.addEventListener("pointercancel",a),window._previewPan.handlers={down:o,move:i,up:a}}catch(t){console.error("setPreviewPanEnabled error",t)}},window._previewPan=window._previewPan||{enabled:!1,handlers:null,state:null},window.waitForCanvasReady=async function(e,t=120){try{if(!e)return!1;const n=performance.now(),r=document.getElementById(e);if(!r)return!1;const o=r.clientWidth,i=r.clientHeight;if(o>0&&i>0){await new Promise(e=>requestAnimationFrame(e));const e=r.clientWidth,t=r.clientHeight;if(o===e&&i===t)return!0}for(;performance.now()-n<(t||120);){await new Promise(e=>requestAnimationFrame(e));const e=r.clientWidth,t=r.clientHeight;if(e>0&&t>0){await new Promise(e=>requestAnimationFrame(e));const n=r.clientWidth,o=r.clientHeight;if(e===n&&t===o)return!0}}return!1}catch(n){return console.error("waitForCanvasReady error",n),!1}},window.drawTrimOverlayAsSvg=function(e,t){try{let n=function(t){try{if(g.allowMultipleRects){t>=0&&t<g.currentRectsPx.length&&g.currentRectsPx.splice(t,1),g.selectedRectIndex=-1;const n=Math.max(1,Math.round(r.clientWidth||1)),o=Math.max(1,Math.round(r.clientHeight||1)),i=(g.currentRectsPx||[]).map(e=>({X:e.x/n,Y:e.y/o,Width:e.w/n,Height:e.h/o}));window.drawTrimOverlayAsSvg&&(console.log("矩形削除:複数矩形"),window.drawTrimOverlayAsSvg(e,i)),g.dotNetRef?.invokeMethodAsync&&g.dotNetRef.invokeMethodAsync("CommitMultipleRectsFromJs",i).catch(()=>{})}else g.selected=!1,g.currentRectPx=null,g.currentRectsPx=[],g.dotNetRef?.invokeMethodAsync&&g.dotNetRef.invokeMethodAsync("ClearTrimRectFromJs").catch(()=>{}),window.drawTrimOverlayAsSvg&&(console.log("矩形削除:単一矩形"),window.drawTrimOverlayAsSvg(e,[]))}catch(n){console.error("removeRectAt error",n)}};if(!e)return!1;const r=document.getElementById(e);if(!r)return!1;const o=r.parentElement||r.closest(".tp-preview-page")||r.closest(".preview-zoom-inner")||document.body,i=e+"-overlay-svg";let a=document.getElementById(i);a||(a=document.createElement("div"),a.id=i,a.style.position="absolute",a.style.left="0px",a.style.top="0px",a.style.pointerEvents="none",a.style.zIndex="45",o.appendChild(a));const s=r.getBoundingClientRect(),d=l(r,o),c=Math.round(d.x),w=Math.round(d.y),u=Math.max(1,Math.round(r.clientWidth||s.width||0)),h=Math.max(1,Math.round(r.clientHeight||s.height||0));a.style.left=c+"px",a.style.top=w+"px",a.style.width=u+"px",a.style.height=h+"px";let m=a.querySelector("svg");for(m||(m=document.createElementNS("http://www.w3.org/2000/svg","svg"),m.setAttribute("width","100%"),m.setAttribute("height","100%"),m.setAttribute("viewBox",`0 0 ${u} ${h}`),m.setAttribute("preserveAspectRatio","none"),m.style.pointerEvents="none",a.appendChild(m));m.firstChild;)m.removeChild(m.firstChild);window._simpleTrim=window._simpleTrim||{},window._simpleTrim[e]||(window._simpleTrim[e]={});const g=window._simpleTrim[e];if(!Array.isArray(t)||0===t.length)return g.overlayDom=a,g.currentRectPx=null,g.currentRectsPx=[],a.style.pointerEvents="none",m.style.pointerEvents="none",!0;if(a.style.pointerEvents="auto",m.style.pointerEvents="auto",t.forEach((e,t)=>{console.log(`Drawing rect ${t}:`,e);const r=Number(e.X??e.x??0),o=Number(e.Y??e.y??0),i=Number(e.Width??e.width??0),a=Number(e.Height??e.height??0),s=Math.round(r*u),l=Math.round(o*h),d=Math.round(i*u),c=Math.round(a*h),w=document.createElementNS("http://www.w3.org/2000/svg","g");w.setAttribute("data-rect-index",String(t));const p=document.createElementNS("http://www.w3.org/2000/svg","rect");p.setAttribute("x","0"),p.setAttribute("y","0"),p.setAttribute("width",String(u)),p.setAttribute("height",String(h)),p.setAttribute("fill","transparent"),p.style.pointerEvents="none",w.appendChild(p);const f=document.createElementNS("http://www.w3.org/2000/svg","rect");f.setAttribute("x",String(s)),f.setAttribute("y",String(l)),f.setAttribute("width",String(Math.max(0,d))),f.setAttribute("height",String(Math.max(0,c))),f.setAttribute("fill","rgba(59,130,246,0.12)");const y=g.allowMultipleRects?g.selectedRectIndex===t:Boolean(g.selected);if(f.setAttribute("stroke",y?"rgba(37,99,235,1)":"rgba(59,130,246,0.95)"),f.setAttribute("stroke-width",y?"3":"2"),f.setAttribute("data-rect","true"),f.setAttribute("data-rect-index",String(t)),f.style.pointerEvents="auto",f.style.cursor="move",w.appendChild(f),y){const e=12,r=Math.round(e/2),o=["nw","n","ne","e","se","s","sw","w"],i={nw:"nwse-resize",se:"nwse-resize",ne:"nesw-resize",sw:"nesw-resize",n:"ns-resize",s:"ns-resize",e:"ew-resize",w:"ew-resize"};[[s,l],[s+d/2,l],[s+d,l],[s+d,l+c/2],[s+d,l+c],[s+d/2,l+c],[s,l+c],[s,l+c/2]].forEach(([n,a],s)=>{const l=document.createElementNS("http://www.w3.org/2000/svg","rect");l.setAttribute("x",String(Math.round(n-r))),l.setAttribute("y",String(Math.round(a-r))),l.setAttribute("width",String(e)),l.setAttribute("height",String(e)),l.setAttribute("fill","rgba(59,130,246,0.95)"),l.setAttribute("data-handle",String(s)),l.setAttribute("data-rect-index",String(t)),l.style.pointerEvents="auto",l.style.cursor=i[o[s]]||"default",w.appendChild(l)});let a=s+d+10,m=l-10;a=Math.min(u-12,Math.max(12,a)),m=Math.min(h-12,Math.max(12,m));const g=document.createElementNS("http://www.w3.org/2000/svg","g");g.style.pointerEvents="auto";const p=document.createElementNS("http://www.w3.org/2000/svg","circle");p.setAttribute("cx",String(a)),p.setAttribute("cy",String(m)),p.setAttribute("r","10"),p.setAttribute("fill","rgba(0,0,0,0.6)"),p.setAttribute("data-close","true"),p.setAttribute("data-rect-index",String(t)),p.style.cursor="pointer",g.appendChild(p);const f=document.createElementNS("http://www.w3.org/2000/svg","text");f.setAttribute("x",String(a)),f.setAttribute("y",String(m+4)),f.setAttribute("fill","#fff"),f.setAttribute("font-size","12"),f.setAttribute("text-anchor","middle"),f.setAttribute("data-close","true"),f.setAttribute("data-rect-index",String(t)),f.style.pointerEvents="none",f.textContent="×",g.appendChild(f),g.addEventListener("pointerdown",function(e){try{e.stopPropagation(),n(t)}catch(r){console.error(r)}},{passive:!1}),w.appendChild(g)}m.appendChild(w)}),g.active||(g.overlayDom=a,g.currentRectsPx=t.map(e=>({x:Number(e.X??e.x??0)*u,y:Number(e.Y??e.y??0)*h,w:Number(e.Width??e.width??0)*u,h:Number(e.Height??e.height??0)*h})),g.currentRectPx=g.currentRectsPx.length>0?{...g.currentRectsPx[g.currentRectsPx.length-1]}:null),g.internal||(g.internal={}),g.internal.keydown||(g.internal.keydown=function(e){"Delete"!==e.key&&"Del"!==e.key||(g.allowMultipleRects&&g.selectedRectIndex>=0?n(g.selectedRectIndex):!g.allowMultipleRects&&g.selected&&n(0))},document.addEventListener("keydown",g.internal.keydown)),g.handlers&&!a.__trimHooked){const e=(e,t)=>{try{e(t)}catch(n){}};g.internal.overlayPointerDown=t=>e(g.handlers.pointerDown,t),g.internal.overlayMove=t=>e(g.handlers.overlayMove,t),a.addEventListener("pointerdown",g.internal.overlayPointerDown,{passive:!1,capture:!0}),a.addEventListener("touchstart",g.internal.overlayPointerDown,{passive:!1,capture:!0}),a.addEventListener("pointermove",g.internal.overlayMove,{passive:!0,capture:!0}),a.__trimHooked=!0}return!0}catch(n){return console.error("drawTrimOverlayAsSvg error",n),!1}},function(){function e(e,t,n){return Math.max(t,Math.min(n,e))}function t(e){const t={removeListener(e,t,n,r){try{e&&n&&e.removeEventListener(t,n,r)}catch(o){}},removeWindowListener(e,t,n){try{t&&window.removeEventListener(e,t,n)}catch(r){}},removeDocumentListener(e,t,n){try{t&&document.removeEventListener(e,t,n)}catch(r){}},removeElement(e){try{if(!e)return;e.style&&(e.style.pointerEvents="none"),"function"==typeof e.remove&&e.remove(),void 0!==e.width&&(e.width=0,e.height=0)}catch(t){}}};try{const n=window._simpleTrim?.[e];if(!n)return;t.removeListener(n.base,"pointerdown",n.handlers?.pointerDown,{passive:!1}),t.removeListener(n.base,"touchstart",n.handlers?.touchStart,{passive:!1}),t.removeWindowListener("pointermove",n.handlers?.move,{passive:!1}),t.removeWindowListener("pointerup",n.handlers?.up,{passive:!1}),t.removeElement(n.overlay||document.getElementById(e+"-overlay"));const r=n.overlayDom||document.getElementById(e+"-overlay-svg");r&&(t.removeListener(r,"pointerdown",n.internal?.overlayPointerDown,!0),t.removeListener(r,"touchstart",n.internal?.overlayPointerDown,!0),t.removeListener(r,"pointermove",n.internal?.overlayMove,!0),t.removeElement(r)),t.removeDocumentListener("keydown",n.internal?.keydown),t.removeListener(n.host,"scroll",n.internal?.hostScroll,{passive:!0}),n.handlers&&Object.keys(n.handlers).forEach(e=>n.handlers[e]=null),n.internal&&Object.keys(n.internal).forEach(e=>n.internal[e]=null),delete window._simpleTrim[e]}catch(n){console.error("cleanupTrimEntry error",n)}}window._simpleTrim=window._simpleTrim||{},window.attachTrimListeners=function(n,r,o="single",i=!1){try{let a=function(e,t){try{const n=v.logicalWAtDown&&v.active?v.logicalWAtDown:Math.max(1,Math.round(u.clientWidth||u.getBoundingClientRect().width||1)),r=v.logicalHAtDown&&v.active?v.logicalHAtDown:Math.max(1,Math.round(u.clientHeight||u.getBoundingClientRect().height||1)),o=u.getBoundingClientRect(),i=o.width&&n?o.width/n:1,a=window._previewZoomState?.lastZoom||i||1,s=l(u,g),d=g.getBoundingClientRect(),c=d.left+s.x*a,w=d.top+s.y*a;return{x:(e-c)/a,y:(t-w)/a,cssW:n,cssH:r}}catch(n){const r=u.getBoundingClientRect(),o=Math.max(1,Math.round(u.clientWidth||r.width||1)),i=Math.max(1,Math.round(u.clientHeight||r.height||1)),a=window._previewZoomState?.lastZoom||1;return{x:(e-r.left)/a,y:(t-r.top)/a,cssW:o,cssH:i}}},s=function(t){const n=Math.max(1,Math.round(u.clientWidth||1)),r=Math.max(1,Math.round(u.clientHeight||1)),o=Number(t.x||0),i=Number(t.y||0),a=o+Number(t.w||0),s=i+Number(t.h||0),l=e(o,0,n),d=e(i,0,r),c=e(a,0,n),w=e(s,0,r);return{X:l/n,Y:d/r,Width:Math.max(0,c-l)/n,Height:Math.max(0,w-d)/r}},d=function(t){v.lastMoveEv=t,v.pendingMove||(v.pendingMove=!0,requestAnimationFrame(()=>{if(v.pendingMove=!1,!v.active)return;const t=a(v.lastMoveEv.clientX,v.lastMoveEv.clientY),{cssW:r,cssH:o}=t,i=v.currentRectPx?{...v.currentRectPx}:null;if("maybe-draw"===v.mode){const e=t.x-v.startClientLocal.x,n=t.y-v.startClientLocal.y,r=8;if(!(e*e+n*n>=r*r))return;v.mode="draw",v.currentRectPx={x:v.startClientLocal.x,y:v.startClientLocal.y,w:0,h:0}}if("draw"===v.mode){const e=Math.min(t.x,v.startClientLocal.x),n=Math.min(t.y,v.startClientLocal.y),r=Math.abs(t.x-v.startClientLocal.x),o=Math.abs(t.y-v.startClientLocal.y);v.currentRectPx={x:e,y:n,w:r,h:o};let a=e<0?0:e,s=n<0?0:n;e<0&&Math.max(0,Math.min(v.startClientLocal.x-a,r)),n<0&&Math.max(0,Math.min(v.startClientLocal.y-s,o));if(!v.didDrag&&i){(i.x!==v.currentRectPx.x||i.y!==v.currentRectPx.y||i.w!==v.currentRectPx.w||i.h!==v.currentRectPx.h)&&(v.didDrag=!0)}}else if("move"===v.mode&&v.startRectPx){const e=t.x-v.startClientLocal.x,n=t.y-v.startClientLocal.y;let i=v.startRectPx.x+e,a=v.startRectPx.y+n;i=Math.max(0,Math.min(r-v.startRectPx.w,i)),a=Math.max(0,Math.min(o-v.startRectPx.h,a)),v.currentRectPx={x:Math.round(i),y:Math.round(a),w:Math.round(v.startRectPx.w),h:Math.round(v.startRectPx.h)},v.didDrag=!0}else if("resize"===v.mode&&v.startRectPx){const n=t.x-v.startClientLocal.x,i=t.y-v.startClientLocal.y,{x:a,y:s,w:l,h:d}=v.startRectPx,c=a+l,w=s+d,u=v.resizeHandle;let h=a,m=c,g=s,p=w;["nw","w","sw"].includes(u)&&(h=e(a+n,0,r)),["ne","e","se"].includes(u)&&(m=e(c+n,0,r)),["nw","n","ne"].includes(u)&&(g=e(s+i,0,o)),["sw","s","se"].includes(u)&&(p=e(w+i,0,o));let f=Math.min(h,m),y=Math.max(h,m),b=Math.min(g,p),x=Math.max(g,p);const R=1;y-f<R&&(y=m>=h?Math.min(r,f+R):f,f=m<h?Math.max(0,y-R):f),x-b<R&&(x=p>=g?Math.min(o,b+R):b,b=p<g?Math.max(0,x-R):b),v.currentRectPx={x:Math.round(f),y:Math.round(b),w:Math.round(y-f),h:Math.round(x-b)},v.didDrag=!0}if(v.currentRectPx){if((!i||i.x!==v.currentRectPx.x||i.y!==v.currentRectPx.y||i.w!==v.currentRectPx.w||i.h!==v.currentRectPx.h)&&v.overlayDom&&window.drawTrimOverlayAsSvg)if(!v.allowMultipleRects||"move"!==v.mode&&"resize"!==v.mode&&"draw"!==v.mode){const e=s(v.currentRectPx);console.log("描画(集約):単一矩形"),window.drawTrimOverlayAsSvg(n,[e])}else if("draw"===v.mode){const e=[...v.currentRectsPx.map(e=>({X:e.x/r,Y:e.y/o,Width:e.w/r,Height:e.h/o})),{X:v.currentRectPx.x/r,Y:v.currentRectPx.y/o,Width:v.currentRectPx.w/r,Height:v.currentRectPx.h/o}];console.log("描画(集約):複数矩形"),window.drawTrimOverlayAsSvg(n,e)}else{v.selectedRectIndex>=0&&v.selectedRectIndex<v.currentRectsPx.length&&(v.currentRectsPx[v.selectedRectIndex]={...v.currentRectPx});const e=v.currentRectsPx.map(e=>({X:e.x/r,Y:e.y/o,Width:e.w/r,Height:e.h/o}));console.log("リサイズ/移動(集約):複数矩形"),window.drawTrimOverlayAsSvg(n,e)}}}))},c=function(){v.mode="maybe-draw";let e=[];if(v.allowMultipleRects){v.selectedRectIndex=-1;const t=v.logicalWAtDown||Math.max(1,Math.round(u.clientWidth||1)),n=v.logicalHAtDown||Math.max(1,Math.round(u.clientHeight||1));e=v.currentRectsPx.map(e=>({X:e.x/t,Y:e.y/n,Width:e.w/t,Height:e.h/n}))}else v.selected=!1,v.currentRectPx&&(e=[s(v.currentRectPx)]);window.drawTrimOverlayAsSvg&&(console.log("描画開始:maybe-draw"),window.drawTrimOverlayAsSvg(n,e))},w=function(){v.active?v.internal.scrollPendingWhileActive=!0:M||(M=!0,requestAnimationFrame(()=>{M=!1}))};if(!n)return!1;const u=document.getElementById(n);if(!u)return console.warn(`attachTrimListeners: canvas not found: ${n}`),!1;let h=!1;const m=window._simpleTrim[n];m?.selected&&(h=!0),t(n);const g=u.parentElement||u.closest(".tp-preview-page")||u.closest(".preview-zoom-inner")||document.body;"static"===getComputedStyle(g).position&&(g.style.position="relative");const p=n+"-overlay";let f=document.getElementById(p);f||(f=document.createElement("canvas"),f.id=p,f.style.position="absolute",f.style.pointerEvents="none",f.style.zIndex="40",g.appendChild(f));const y=document.getElementById(n+"-overlay-svg")||null,v={base:u,host:g,overlay:f,overlayDom:y,dotNetRef:r,selectionMode:"multi"===o?"multi":"single",allowMultipleRects:Boolean(i),active:!1,mode:null,pointerId:null,startClientX:0,startClientY:0,startClientLocal:null,startRectPx:null,currentRectPx:null,currentRectsPx:[],selectedRectIndex:-1,pendingMove:!1,handlers:{},internal:{},resizeHandle:null,baseRectAtDown:null,logicalWAtDown:null,logicalHAtDown:null,didDrag:!1,selected:h};v.internal.lastAttachedAt=performance.now(),window._simpleTrim[n]=v;const b=["nw","n","ne","e","se","s","sw","w"],x={nw:"nwse-resize",se:"nwse-resize",ne:"nesw-resize",sw:"nesw-resize",n:"ns-resize",s:"ns-resize",e:"ew-resize",w:"ew-resize"},R=function(e){try{if(void 0!==e.button&&0!==e.button)return;v.active=!0,v.pointerId=e.pointerId??"mouse",v.startClientX=e.clientX,v.startClientY=e.clientY,v.didDrag=!1,v.baseRectAtDown=u.getBoundingClientRect(),v.logicalWAtDown=Math.max(1,Math.round(u.clientWidth||v.baseRectAtDown.width||1)),v.logicalHAtDown=Math.max(1,Math.round(u.clientHeight||v.baseRectAtDown.height||1)),v.startClientLocal=a(e.clientX,e.clientY),u.setPointerCapture&&u.setPointerCapture(e.pointerId);const r=e.target||e.srcElement;if(r?.setPointerCapture&&r!==u)try{r.setPointerCapture(e.pointerId)}catch(t){}if(v.resizeHandle=null,v.overlayDom&&r){const e=r.getAttribute?.("data-handle"),t=r.getAttribute?.("data-rect"),o=r.getAttribute?.("data-rect-index"),i=null!==o?Number(o):-1;if(null!==e){const t=Number(e);v.resizeHandle=Number.isFinite(t)&&t>=0&&t<b.length?b[t]:null,v.mode="resize",v.allowMultipleRects&&i>=0&&i<v.currentRectsPx.length?(v.selectedRectIndex=i,v.startRectPx={...v.currentRectsPx[i]},v.currentRectPx={...v.currentRectsPx[i]}):v.startRectPx=v.currentRectPx?{...v.currentRectPx}:{x:v.startClientLocal.x,y:v.startClientLocal.y,w:0,h:0}}else if(null!==t)if(v.mode="move",v.allowMultipleRects&&i>=0&&i<v.currentRectsPx.length){v.selectedRectIndex=i,v.startRectPx={...v.currentRectsPx[i]},v.currentRectPx={...v.currentRectsPx[i]};"single"===(v.selectionMode||window._simpleTrimSettings?.selectionMode||"single")&&Object.keys(window._simpleTrim).forEach(e=>{e!==n&&window._simpleTrim[e]&&(window._simpleTrim[e].selectedRectIndex=-1,window._simpleTrim[e].selected=!1)});const e=v.currentRectsPx.map(e=>({X:e.x/v.logicalWAtDown,Y:e.y/v.logicalHAtDown,Width:e.w/v.logicalWAtDown,Height:e.h/v.logicalHAtDown}));console.log("矩形移動:複数矩形"),window.drawTrimOverlayAsSvg(n,e)}else{v.startRectPx=v.currentRectPx?{...v.currentRectPx}:{x:v.startClientLocal.x,y:v.startClientLocal.y,w:0,h:0};"single"===(v.selectionMode||window._simpleTrimSettings?.selectionMode||"single")&&Object.keys(window._simpleTrim).forEach(e=>{e!==n&&window._simpleTrim[e]?.selected&&(window._simpleTrim[e].selected=!1)}),v.selected=!0,v.overlayDom&&window.drawTrimOverlayAsSvg&&(console.log("矩形移動:単一矩形"),window.drawTrimOverlayAsSvg(n,[s(v.currentRectPx)]))}else c()}else c();v.overlayDom&&(v.resizeHandle?v.overlayDom.style.cursor=x[v.resizeHandle]||"":"draw"===v.mode?v.overlayDom.style.cursor="crosshair":"move"===v.mode?v.overlayDom.style.cursor="move":"maybe-draw"===v.mode&&(v.overlayDom.style.cursor="")),v.handlers.move=e=>d(e),v.handlers.up=function(e){if(!v.active)return;v.active=!1;try{u.releasePointerCapture&&u.releasePointerCapture(v.pointerId)}catch(t){}if(v.baseRectAtDown=null,v.logicalWAtDown=null,v.logicalHAtDown=null,v.overlayDom&&(v.overlayDom.style.cursor=""),"maybe-draw"===v.mode)return v.mode=null,v.didDrag=!1,window.removeEventListener("pointermove",v.handlers.move,{passive:!1}),void window.removeEventListener("pointerup",v.handlers.up,{passive:!1});const r=v.currentRectPx||{x:0,y:0,w:0,h:0};if(r.w>0&&r.h>0){const e=s(r);if(v.allowMultipleRects){"draw"===v.mode?(v.currentRectsPx.push(r),v.selectedRectIndex=v.currentRectsPx.length-1):"move"!==v.mode&&"resize"!==v.mode||v.selectedRectIndex>=0&&v.selectedRectIndex<v.currentRectsPx.length&&(v.currentRectsPx[v.selectedRectIndex]=r);const e=v.currentRectsPx.map(e=>({X:e.x/(u.clientWidth||1),Y:e.y/(u.clientHeight||1),Width:e.w/(u.clientWidth||1),Height:e.h/(u.clientHeight||1)}));v.dotNetRef?.invokeMethodAsync&&v.dotNetRef.invokeMethodAsync("CommitMultipleRectsFromJs",e).catch(()=>{}),v.didDrag&&(v.selectedRectIndex=-1,console.log("確定:複数矩形"),window.drawTrimOverlayAsSvg(n,e))}else v.lastRawRect=r,v.currentRectsPx=[r],v.dotNetRef?.invokeMethodAsync&&v.dotNetRef.invokeMethodAsync("CommitTrimRectFromJs",e.X,e.Y,e.Width,e.Height).catch(()=>{}),v.didDrag&&(v.selected=!1,v.overlayDom&&window.drawTrimOverlayAsSvg&&(console.log("確定:単一矩形"),window.drawTrimOverlayAsSvg(n,[s(r)])))}else v.overlayDom&&window.drawTrimOverlayAsSvg&&(console.log("大きさ0矩形:クリア"),window.drawTrimOverlayAsSvg(n,[]));window.removeEventListener("pointermove",v.handlers.move,{passive:!1}),window.removeEventListener("pointerup",v.handlers.up,{passive:!1})},window.addEventListener("pointermove",v.handlers.move,{passive:!1}),window.addEventListener("pointerup",v.handlers.up,{passive:!1}),e.preventDefault?.()}catch(t){console.error("onPointerDown error",t)}},P=function(e){try{if(!e.touches||0===e.touches.length)return;const t=e.touches[0];R({clientX:t.clientX,clientY:t.clientY,pointerId:"touch",button:0,target:t.target,preventDefault:()=>e.preventDefault()}),e.preventDefault()}catch(t){console.error("onTouchStart error",t)}};if(v.handlers.pointerDown=R,v.handlers.touchStart=P,u.addEventListener("pointerdown",R,{passive:!1}),u.addEventListener("touchstart",P,{passive:!1}),u.style&&(u.style.cursor="crosshair"),y?.style&&(y.style.cursor="crosshair"),y){y.style.pointerEvents="auto",y.addEventListener("pointerdown",R,{passive:!1,capture:!0}),y.addEventListener("touchstart",P,{passive:!1,capture:!0});const e=function(e){const t=e.target,n=t?.getAttribute?.("data-handle"),r=t?.getAttribute?.("data-rect");if(null!==n){const e=Number(n),t=Number.isFinite(e)&&e>=0&&e<b.length?b[e]:null;y.style.cursor=t&&x[t]||""}else y.style.cursor=null!==r?"move":""};v.handlers.overlayMove=e,y.addEventListener("pointermove",e,{passive:!0,capture:!0})}let M=!1;v.internal.hostScroll=w,g.addEventListener("scroll",v.internal.hostScroll,{passive:!0});const A=document.getElementById("trim-preview-container")||g.closest(".preview-zoom-viewport");return A&&(v.internal.containerScroll=w,A.addEventListener("scroll",v.internal.containerScroll,{passive:!0})),!0}catch(a){return console.error("attachTrimListeners error",a),!1}},window.detachTrimListeners=function(e){try{const n=window._simpleTrim?.[e];return n?(t(e),!0):(t(e),!1)}catch(n){return console.error("detachTrimListeners error",n),!1}}}(),window.drawImageToCanvasForPreview=function(e,t,n=!0){return new Promise(r=>{try{const o=document.getElementById(e);if(!o)return void r(!1);const i=o.getContext("2d");if(!i)return void r(!1);const a=new window.Image;a.crossOrigin="anonymous",a.onload=function(){try{const e=Math.max(1,Math.round(a.naturalWidth)),t=Math.max(1,Math.round(a.naturalHeight)),s=n&&window.devicePixelRatio||1;o.width=Math.round(e*s),o.height=Math.round(t*s),o.style.width=e+"px",o.style.height=t+"px",o.style.display="block",i.setTransform(s,0,0,s,0,0),i.clearRect(0,0,e,t),i.drawImage(a,0,0,e,t),requestAnimationFrame(()=>r(!0))}catch(e){console.error("drawImageToCanvasForPreview draw error",e),r(!1)}},a.onerror=function(e){console.error("drawImageToCanvasForPreview image load error",e,t),r(!1)},a.src=t}catch(o){console.error("drawImageToCanvasForPreview error",o),r(!1)}})},window._visiblePageObserver=window._visiblePageObserver||{},window.registerVisiblePageObserver=function(e,t,n=1e3){try{try{window.unregisterVisiblePageObserver(t)}catch(r){}const o=document.getElementById(t);if(!o)return;const i=Array.from(o.querySelectorAll('[id^="preview-container-"]'));if(!i||0===i.length)return;const a={pendingBest:-1,timer:null,lastIdx:-1,debounceMs:Number(n)||500},s=new IntersectionObserver(function(t){try{let n=-1,o=0;if(t.forEach(e=>{const t=e.intersectionRatio||0,r=e.target&&e.target.id;if(!r)return;const i=r.split("-"),a=Number(i[i.length-1]);Number.isFinite(a)&&t>o&&(o=t,n=a)}),n>=0)try{if(a.lastIdx===n)return;a.pendingBest=n,a.timer&&clearTimeout(a.timer),a.timer=setTimeout(()=>{try{a.lastIdx!==a.pendingBest&&(a.lastIdx=a.pendingBest,e.invokeMethodAsync("SetVisiblePageFromJs",a.pendingBest).catch(()=>{}))}catch(r){}a.timer=null},a.debounceMs)}catch(r){}}catch(r){}},{root:o,threshold:[0,.25,.5,.75,1]});i.forEach(e=>s.observe(e)),window._visiblePageObserver=window._visiblePageObserver||{},window._visiblePageObserver[t]={observer:s,items:i,dotNetRef:e,state:a}}catch(r){console.error("registerVisiblePageObserver error",r)}},window.unregisterVisiblePageObserver=function(e){try{const n=window._visiblePageObserver&&window._visiblePageObserver[e];if(!n)return;try{n.state&&n.state.timer&&clearTimeout(n.state.timer)}catch(t){}try{n.observer&&n.observer.disconnect()}catch(t){}try{delete window._visiblePageObserver[e]}catch(t){}}catch(t){console.error("unregisterVisiblePageObserver error",t)}}}();
