@using NoCloudPdf.Models
@inject IJSRuntime JSRuntime
@inject NoCloudPdf.Services.PdfDataService PdfDataService

<div class="tp-preview-page" style="position:relative;">
    <div class="absolute top-2 left-2 bg-gray-800 bg-opacity-70 text-white px-2 py-1 rounded text-sm">
        ページ @(!string.IsNullOrEmpty(Item?.PageInfo) ? Item.PageInfo : "")
    </div>
    <canvas id="@CanvasId" @ref="canvasRef" class="w-full h-auto bg-white"></canvas>
        <div class="tp-loading-overlay absolute inset-0 flex items-center justify-center pointer-events-none" hidden="@(!isLoading)">
        <div class="tp-ring-spinner" role="status" aria-label="Loading preview">
            <svg viewBox="0 0 50 50" class="tp-ring" aria-hidden="true">
                <circle class="tp-ring-bg" cx="25" cy="25" r="20" fill="none" stroke-width="4"/>
                <circle class="tp-ring-fg" cx="25" cy="25" r="20" fill="none" stroke-width="4"/>
            </svg>
        </div>
    </div>
</div>

@code {
    [Parameter] public DisplayItem Item { get; set; } = default!;
    [Parameter] public int Index { get; set; }

    private ElementReference canvasRef;
    private bool isLoading = true;
    private string CanvasId => $"trim-preview-canvas-{Index}";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await TryRenderAsync();
    }

    private async Task TryRenderAsync()
    {

        try
        {
            if (Item.RawData is not PageItem page) return;

            string? src = null;
            if (!string.IsNullOrEmpty(page.PageData) && !page.HasPageDataError)
            {
                // キャッシュ済みならすぐ返る想定
                var imageUrl = await PdfDataService.GetPreviewImageAsync(page.Id);
                src = imageUrl;
            }

            // プレビュー未準備なら一度だけローディング表示を出す
            if (string.IsNullOrEmpty(src))
            {
                return;
            }

            if (isLoading)
            {
                isLoading = false;
                await InvokeAsync(StateHasChanged);
                return;
            }

            await JSRuntime.InvokeVoidAsync("drawImageToCanvas", CanvasId, src);

        }
        catch (OperationCanceledException) { }
        catch (Exception ex)
        {
            Console.WriteLine($"TrimPreviewItem render error idx={Index}: {ex.Message}");
        }
    }

}