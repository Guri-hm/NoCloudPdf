<div class="relative @(FullWidth ? "w-full" : "")">
    <div class="flex @(FullWidth ? "w-full" : "")">
        <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-l-lg flex-1 transition"
            @onclick="OnPrimaryClick">
            @PrimaryLabel
        </button>
        <button
            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-2 rounded-r-lg border-l border-blue-700 flex items-center transition"
            @onclick="ToggleMenu">
            
            <CaretDownIcon />
        </button>
    </div>
    @if (ShowMenu)
    {
        <div>
            <!-- 透明カバー（最前面・全画面） -->
            <div class="fixed inset-0 z-40" @onclick="CloseMenu" style="background:transparent;"></div>
            <!-- メニュー本体 -->
            <div class="absolute right-0 mt-1 @(FullWidth ? "w-full" : "min-w-[200px]") bg-white border border-gray-300 rounded-lg shadow-lg z-50">
                @for (int i = 0; i < MenuItems.Count; i++)
                {
                    var item = MenuItems[i];
                    string roundedClass = MenuItems.Count == 1
                        ? "rounded-lg"
                        : (i == 0 ? "rounded-t-lg" : (i == MenuItems.Count - 1 ? "rounded-b-lg" : ""));
                    
                    <button class="w-full text-left px-4 py-2 hover:bg-blue-50 text-gray-800 @roundedClass"
                        @onclick="() => OnMenuItemClick(item)">
                        @item.Label
                    </button>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public string PrimaryLabel { get; set; } = "ダウンロード";
    [Parameter] public EventCallback OnPrimaryClick { get; set; }
    [Parameter] public List<MenuActionItem> MenuItems { get; set; } = new();
    [Parameter] public bool FullWidth { get; set; } = true;

    private bool ShowMenu { get; set; }

    private void ToggleMenu() => ShowMenu = !ShowMenu;
    private void CloseMenu() => ShowMenu = false;

    private async Task OnMenuItemClick(MenuActionItem item)
    {
        ShowMenu = false;
        if (item.OnClick.HasDelegate)
            await item.OnClick.InvokeAsync(null);
    }
    public class MenuActionItem
    {
        public string Label { get; set; } = "";
        public EventCallback OnClick { get; set; }
    }
}