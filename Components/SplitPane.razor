@using Microsoft.JSInterop
@implements IAsyncDisposable
@inject IJSRuntime JSRuntime

<div id="@ContainerId" class="flex-1 flex overflow-hidden">
    <!-- 左エリア: flex-shrink-0 で縮小を防ぎ、flex-basis で初期幅を設定 -->
    <div id="@LeftId" 
         class="flex-shrink-0 overflow-y-auto @LeftAreaClass"
         style="flex-basis: @(LeftWidth)px; min-width: 150px; max-width: 600px;">
        @Left
    </div>

    <!-- 仕切り線 -->
    <div id="@HandleId" 
         class="w-1 bg-gray-400 cursor-ew-resize hover:bg-blue-500 flex-shrink-0"
         style="touch-action: none;">
    </div>

    <!-- 右エリア: flex-1 で残り全体を使用 -->
    <div class="flex-1 overflow-auto min-w-[260px]">
        <div id="@RightContainerId" class="relative h-full @RightAreaClass">
            @Right
        </div>
    </div>
</div>

@code {
    [Parameter] public RenderFragment? Left { get; set; }
    [Parameter] public RenderFragment? Right { get; set; }

    // two-way left width (px)
    [Parameter] public int LeftWidth { get; set; } = 300;
    [Parameter] public EventCallback<int> LeftWidthChanged { get; set; }

    // optional CSS classes
    [Parameter] public string LeftAreaClass { get; set; } = "border-r border-gray-300 p-4";
    [Parameter] public string RightAreaClass { get; set; } = "flex flex-col gap-4";

    // ids
    [Parameter] public string ContainerId { get; set; } = "split-container";
    [Parameter] public string LeftId { get; set; } = "thumbnail-area";
    [Parameter] public string HandleId { get; set; } = "splitter-handle";
    [Parameter] public string RightContainerId { get; set; } = "trim-preview-container";

    private DotNetObjectReference<SplitPane>? _dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            try
            {
                await JSRuntime.InvokeVoidAsync("registerPanelResize", _dotNetRef, HandleId, 1500);
            }
            catch
            {
            }
        }
    }

    // JSから最終確定幅を受け取る
    [JSInvokable("CommitPanelWidth")]
    public async Task CommitPanelWidth(int width)
    {
        LeftWidth = Math.Max(150, Math.Min(600, width));
        await LeftWidthChanged.InvokeAsync(LeftWidth);
    }

    [JSInvokable("OnPanelMouseMove")]
    public Task OnPanelMouseMove(double clientX)
    {
        // optional: can be forwarded or ignored
        return Task.CompletedTask;
    }

    [JSInvokable("OnPanelMouseUp")]
    public Task OnPanelMouseUp()
    {
        // optional: can be forwarded or ignored
        return Task.CompletedTask;
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("unregisterPanelResize");
        }
        catch { }
        _dotNetRef?.Dispose();
    }
}