@using NoCloudPdf.Models
@using NoCloudPdf.Services
@using System.Text.RegularExpressions
@inject IJSRuntime JSRuntime
@inject PdfDataService PdfDataService

<HeadContent>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
</HeadContent>

@if (IsOpen)
{
    <div class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-[250] p-4 animate-in fade-in duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-[95vw] h-[90vh] overflow-hidden border border-gray-200 animate-in slide-in-from-bottom-4 duration-300 flex flex-col">
            <!-- ヘッダー -->
            <div class="text-white px-8 py-6 flex justify-between items-center flex-shrink-0" style="background-image: linear-gradient(180deg, rgb(5, 39, 103) 0%, #3a0647 70%);">
                <div class="flex items-center gap-3">
                    <div>
                        <h2 class="text-2xl font-bold">ヘッダー・フッター設定</h2>
                        <p class="text-sm text-blue-100 mt-1">左側で設定を変更すると、右側のプレビューにリアルタイム反映されます</p>
                    </div>
                </div>
                <button class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition-colors duration-200" @onclick="Close">
                    <span class="material-symbols-outlined text-xl">close</span>
                </button>
            </div>

            <!-- メインコンテンツ: 左右分割 -->
        <div class="flex flex-1 min-h-0">
            <!-- 左側: 設定エリア -->
            <div class="w-1/2 border-r border-gray-200 overflow-auto">
                <div class="p-8 space-y-6">
                    <!-- 適用ページ範囲 -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-6 shadow-sm">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="material-symbols-outlined text-blue-600">description</span>
                            適用ページ範囲
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">開始ページ</label>
                                <input type="number" 
                                       min="1" 
                                       max="@TotalPages" 
                                       value="@currentSetting.StartPage"
                                       @onchange="@(e => { currentSetting.StartPage = int.Parse(e.Value?.ToString() ?? "1"); UpdatePreview(); })"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" />
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">終了ページ</label>
                                <input type="number" 
                                       min="@currentSetting.StartPage" 
                                       max="@TotalPages" 
                                       value="@(currentSetting.EndPage == -1 ? TotalPages : currentSetting.EndPage)"
                                       @onchange="@(e => { currentSetting.EndPage = int.Parse(e.Value?.ToString() ?? TotalPages.ToString()); UpdatePreview(); })"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" />
                            </div>
                        </div>
                        <p class="text-sm text-blue-700 mt-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-base">info</span>
                            @GetPageRangeDescription()
                        </p>
                    </div>

                    <!-- スタンプ一覧 -->
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                <span class="material-symbols-outlined text-purple-600">label</span>
                                スタンプ設定
                            </h3>
                            <button class="px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all duration-200 shadow-md font-semibold text-sm flex items-center gap-2" @onclick="AddStamp">
                                <span class="material-symbols-outlined text-base">add</span>
                                スタンプを追加
                            </button>
                        </div>

                        @foreach (var (stamp, index) in currentSetting.Stamps.Select((s, i) => (s, i)))
                        {
                            <div class="bg-white border border-gray-200 rounded-xl p-6 mb-4 shadow-sm hover:shadow-md transition-shadow duration-200">
                                <div class="flex justify-between items-start mb-4">
                                    <h4 class="font-bold text-gray-800 text-base">スタンプ @(index + 1)</h4>
                                    <button class="text-red-500 hover:text-red-700 hover:bg-red-50 rounded-full p-2 transition-all duration-200" @onclick="() => RemoveStamp(index)">
                                        <span class="material-symbols-outlined text-base">delete</span>
                                    </button>
                                </div>

                                <div class="space-y-4">
                                    <!-- テキスト内容セクション -->
                                    <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                                        <h5 class="text-sm font-bold text-gray-700 flex items-center gap-1">
                                            <span class="material-symbols-outlined text-base">edit</span>
                                            テキスト内容
                                        </h5>
                                        
                                        <!-- 表示テキスト -->
                                        <div>
                                            <label for="@($"stampText-{index}")" class="flex items-center text-sm font-semibold text-gray-700 mb-2">
                                                <span id="@($"stampTextLabel-{index}")">表示テキスト</span>
                                                <Tooltip Text="日本語テキストを含む場合は自動的にNotoSansフォントが選択されます。">
                                                    <InfoIcon Class="w-5 h-5 text-blue-400 cursor-pointer" />
                                                </Tooltip>
                                            </label>
                                            <input id="@($"stampText-{index}")" aria-labelledby="@($"stampTextLabel-{index}")" type="text" 
                                                   value="@stamp.Text"
                                                   @oninput="@(e => OnStampTextInput(stamp, e))"
                                                   placeholder="例: ページ"
                                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" />
                                        </div>

                                        <!-- 連番設定 -->
                                        <div class="space-y-2">
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" 
                                                       checked="@stamp.IsSerial"
                                                       @onchange="@(e => { stamp.IsSerial = (bool)(e.Value ?? false); UpdatePreview(); })"
                                                       class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" />
                                                <span class="text-sm font-semibold text-gray-700">連番を追加</span>
                                            </label>
                                            @if (stamp.IsSerial)
                                            {
                                                <div class="ml-6 flex flex-wrap items-center gap-4">
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" 
                                                               checked="@stamp.IsZeroPadded"
                                                               @onchange="@(e => { stamp.IsZeroPadded = (bool)(e.Value ?? false); UpdatePreview(); })"
                                                               class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" />
                                                        <span class="text-sm font-semibold text-gray-700">ゼロ埋め</span>
                                                    </label>
                                                    <div class="flex items-center gap-2">
                                                        <label class="text-sm font-semibold text-gray-700">開始番号:</label>
                                                        <input type="number" 
                                                               min="1" 
                                                               value="@stamp.SerialStart"
                                                               @onchange="@(e => { stamp.SerialStart = int.Parse(e.Value?.ToString() ?? "1"); UpdatePreview(); })"
                                                               class="w-20 px-2 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm" />
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>

                                    <!-- フォント設定セクション -->
                                    <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                                        <h5 class="text-sm font-bold text-gray-700 flex items-center gap-1">
                                            <span class="material-symbols-outlined text-base">text_format</span>
                                            フォント設定
                                        </h5>
                                        
                                        <div class="grid grid-cols-2 gap-4">
                                            <!-- フォント選択 -->
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">フォント</label>
                                                <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                        @bind="stamp.FontFamily" @bind:after="UpdatePreview">
                                                    @if (ContainsJapanese(stamp.Text))
                                                    {
                                                        <optgroup label="日本語対応">
                                                            <option value="NotoSansJP">Noto Sans JP（ゴシック）</option>
                                                            <option value="NotoSerifJP">Noto Serif JP（明朝）</option>
                                                        </optgroup>
                                                    }
                                                    else
                                                    {
                                                        <optgroup label="日本語対応">
                                                            <option value="NotoSansJP">Noto Sans JP（ゴシック）</option>
                                                            <option value="NotoSerifJP">Noto Serif JP（明朝）</option>
                                                        </optgroup>
                                                        <optgroup label="システムフォント">
                                                            <option value="sans-serif">システム ゴシック</option>
                                                            <option value="serif">システム 明朝</option>
                                                            <option value="monospace">等幅（Monospace）</option>
                                                        </optgroup>
                                                        <optgroup label="欧文フォント">
                                                            <option value="Helvetica">Helvetica</option>
                                                            <option value="TimesRoman">Times Roman</option>
                                                        </optgroup>
                                                    }
                                                </select>
                                            </div>
                                            <!-- フォントサイズ -->
                                            <div>
                                                <label class="block text-sm font-semibold text-gray-700 mb-2">フォントサイズ</label>
                                                <input type="number" 
                                                       min="6" 
                                                       max="72" 
                                                       value="@stamp.FontSize"
                                                       @onchange="@(e => { stamp.FontSize = int.Parse(e.Value?.ToString() ?? "12"); UpdatePreview(); })"
                                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" />
                                            </div>
                                        </div>

                                        <div class="flex items-center gap-4">
                                            <!-- 太字 -->
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" 
                                                       checked="@stamp.IsBold"
                                                       @onchange="@(e => { stamp.IsBold = (bool)(e.Value ?? false); UpdatePreview(); })"
                                                       class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" />
                                                <span class="text-sm font-semibold text-gray-700">太字</span>
                                            </label>

                                            <!-- カラー -->
                                            <div class="flex items-center gap-2">
                                                <label class="text-sm font-semibold text-gray-700">色:</label>
                                                <input type="color" 
                                                       value="@GetColorHex(stamp.Color)"
                                                       @onchange="@(e => SetColor(stamp, e.Value?.ToString()))"
                                                       class="w-12 h-8 border border-gray-300 rounded cursor-pointer" />
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 配置設定セクション -->
                                    <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                                        <h5 class="text-sm font-bold text-gray-700 flex items-center gap-1">
                                            <span class="material-symbols-outlined text-base">open_with</span>
                                            配置設定
                                        </h5>
                                        
                                        <!-- 配置位置 -->
                                        <div>
                                            <label class="block text-sm font-semibold text-gray-700 mb-2">配置位置</label>
                                            <select value="@stamp.Corner.ToString()"
                                                    @onchange="@(e => { stamp.Corner = Enum.Parse<StampCorner>(e.Value?.ToString() ?? "TopLeft"); UpdatePreview(); })"
                                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                                <option value="TopLeft">左上</option>
                                                <option value="Top">上</option>
                                                <option value="TopRight">右上</option>
                                                <option value="BottomLeft">左下</option>
                                                <option value="Bottom">下</option>
                                                <option value="BottomRight">右下</option>
                                            </select>
                                        </div>

                                        <!-- オフセット -->
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-semibold text-gray-700 mb-2">X オフセット (px)</label>
                                                <input type="number" 
                                                       value="@stamp.OffsetX"
                                                       @onchange="@(e => { stamp.OffsetX = int.Parse(e.Value?.ToString() ?? "10"); UpdatePreview(); })"
                                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" />
                                            </div>
                                            <div>
                                                <label class="block text-sm font-semibold text-gray-700 mb-2">Y オフセット (px)</label>
                                                <input type="number" 
                                                       value="@stamp.OffsetY"
                                                       @onchange="@(e => { stamp.OffsetY = int.Parse(e.Value?.ToString() ?? "10"); UpdatePreview(); })"
                                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- 右側: プレビューエリア -->
            <div class="w-1/2 bg-gray-50 flex flex-col">
                <div class="p-6 border-b border-gray-200 bg-white flex-shrink-0">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2 mb-4">
                        <span class="material-symbols-outlined text-green-600">visibility</span>
                        プレビュー
                    </h3>
                    <div class="flex items-center gap-4">
                        <button class="px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                @onclick="PrevPreviewPage"
                                disabled="@(previewPageNumber <= 1)">
                            <span class="material-symbols-outlined">chevron_left</span>
                        </button>
                        <div class="flex items-center gap-2">
                            <input type="number" 
                                   min="1" 
                                   max="@TotalPages" 
                                   value="@previewPageNumber"
                                   @onchange="OnPreviewPageChanged"
                                   class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-blue-500" />
                            <span class="text-sm text-gray-600">/ @TotalPages</span>
                        </div>
                        <button class="px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                @onclick="NextPreviewPage"
                                disabled="@(previewPageNumber >= TotalPages)">
                            <span class="material-symbols-outlined">chevron_right</span>
                        </button>
                    </div>
                    @if (!IsPageInRange(previewPageNumber))
                    {
                        <p class="text-sm text-orange-600 mt-2 flex items-center gap-2">
                            <span class="material-symbols-outlined text-base">warning</span>
                            このページは適用範囲外です
                        </p>
                    }
                </div>

                <div class="flex-1 overflow-auto p-6">
                    @if (isLoadingPreview)
                    {
                        <div class="text-center py-12">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                            <p class="text-gray-600">プレビューを読み込み中...</p>
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(previewImageUrl))
                    {
                        <div class="relative inline-block shadow-2xl">
                            <img src="@previewImageUrl" 
                                 alt="Preview" 
                                 style="width: auto; height: auto; max-width: 100%;"
                                 class="border border-gray-300 rounded-lg" />
                            
                            @if (IsPageInRange(previewPageNumber))
                            {
                                @foreach (var stamp in currentSetting.Stamps)
                                {
                                    
                                    var previewText = GetPreviewText(stamp, previewPageNumber);
                                    // 日本語が含まれていれば強制的に Noto Sans JP（ゴシック）を使う
                                    var fontFamily = ContainsJapanese(previewText)
                                        ? "'Noto Sans JP', sans-serif"
                                        : (stamp.FontFamily == "NotoSerifJP" ? "'Noto Serif JP', serif" : "'Noto Sans JP', sans-serif");
                                    
                                    <div class="absolute text-sm pointer-events-none"
                                         style="@GetPreviewStampStyle(stamp); color: @GetColorHex(stamp.Color); font-size: @(stamp.FontSize * previewScale)px; font-weight: @(stamp.IsBold ? "bold" : "normal"); font-family: @(fontFamily); white-space: nowrap;">
                                        @GetPreviewText(stamp, previewPageNumber)
                                    </div>
                                }
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- フッター -->
        <div class="bg-gray-50 px-8 py-6 flex justify-between items-center border-t border-gray-200 flex-shrink-0">
            <div class="text-sm text-gray-600">
                <span class="inline-flex items-center gap-1">
                    <span class="material-symbols-outlined text-blue-600 text-base">info</span>
                    @GetPageRangeDescription()
                </span>
            </div>
            <div class="flex gap-3">
                <button class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-all duration-200 font-semibold flex items-center gap-2" @onclick="Close">
                    <span class="material-symbols-outlined text-lg">close</span>
                    キャンセル
                </button>
                <button class="px-8 py-3 bg-blue-600 hover:bg-blue-700 border border-gray-300 text-white rounded-xl transition-all duration-200 shadow-lg font-semibold flex items-center gap-2" @onclick="Apply">
                    <span class="material-symbols-outlined text-lg">check</span>
                    適用
                </button>
            </div>
        </div>
    </div>
</div>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback<HeaderFooterSetting> OnApply { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public int TotalPages { get; set; } = 1;

    private HeaderFooterSetting currentSetting = new();
    private int previewPageNumber = 1;
    private string? previewImageUrl = null;
    private bool isLoadingPreview = false;
    private double previewScale = 0.558;

    private void OnStampTextInput(StampPosition stamp, ChangeEventArgs e)
    {
        var text = e.Value?.ToString() ?? "";
        stamp.Text = text;

        // 日本語が含まれているなら強制的にゴシック（Noto Sans JP）に切り替える
        if (ContainsJapanese(text))
        {
            stamp.FontFamily = "NotoSansJP";
        }

        UpdatePreview();
    }
    protected override async Task OnParametersSetAsync()
    {
        if (IsOpen)
        {
            if (!currentSetting.Stamps.Any())
            {
                AddStamp();
            }

            if (currentSetting.EndPage == 0 || currentSetting.EndPage > TotalPages)
            {
                currentSetting.EndPage = TotalPages;
            }

            previewPageNumber = Math.Max(1, Math.Min(previewPageNumber, TotalPages));
            await LoadPreviewAsync();
        }
    }

    private bool ContainsJapanese(string? text)
    {
        if (string.IsNullOrEmpty(text)) return false;
        return Regex.IsMatch(text, @"[\u3000-\u30FF\u4E00-\u9FFF\uFF01-\uFF60]");
    }

    private async Task LoadPreviewAsync()
    {
        isLoadingPreview = true;
        StateHasChanged();

        try
        {
            var displayItems = PdfDataService.GetDisplayItems();
            if (displayItems.Any() && previewPageNumber > 0 && previewPageNumber <= displayItems.Count)
            {
                var item = displayItems[previewPageNumber - 1];
                if (item.RawData is PageItem page)
                {
                     previewImageUrl = await PdfDataService.GetPreviewImageAsync(page.Id);

                    PdfPageSize pdfSize = await JSRuntime.InvokeAsync<PdfPageSize>("getPdfPageSize", page.PageData);
                    double pdfWidth = (double)pdfSize.Width;
                    double containerWidth = 600.0;
                    previewScale = containerWidth / pdfWidth;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Preview load error: {ex.Message}");
        }
        finally
        {
            isLoadingPreview = false;
            StateHasChanged();
        }
    }

    private class PdfPageSize
    {
        public double Width { get; set; }
        public double Height { get; set; }
    }

    private async Task OnPreviewPageChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var pageNum))
        {
            previewPageNumber = Math.Max(1, Math.Min(pageNum, TotalPages));
            await LoadPreviewAsync();
        }
    }

    private async Task PrevPreviewPage()
    {
        if (previewPageNumber > 1)
        {
            previewPageNumber--;
            await LoadPreviewAsync();
        }
    }

    private async Task NextPreviewPage()
    {
        if (previewPageNumber < TotalPages)
        {
            previewPageNumber++;
            await LoadPreviewAsync();
        }
    }

    private void AddStamp()
    {
        currentSetting.Stamps.Add(new StampPosition
        {
            Text = "ページ",
            IsSerial = true,
            SerialStart = 1,
            Corner = StampCorner.Bottom,
            OffsetX = 30,
            OffsetY = 30,
            FontSize = 12,
            FontFamily = "NotoSansJP",
            IsBold = false,
            Color = new StampColor { R = 0, G = 0, B = 0 }
        });
        UpdatePreview();
    }

    private void RemoveStamp(int index)
    {
        if (index >= 0 && index < currentSetting.Stamps.Count)
        {
            currentSetting.Stamps.RemoveAt(index);
            UpdatePreview();
        }
    }

    private string GetColorHex(StampColor color)
    {
        return $"#{color.R:X2}{color.G:X2}{color.B:X2}";
    }

    private void SetColor(StampPosition stamp, string? hexColor)
    {
        if (string.IsNullOrEmpty(hexColor) || !hexColor.StartsWith("#"))
            return;

        try
        {
            var hex = hexColor.Substring(1);
            if (hex.Length == 6)
            {
                stamp.Color.R = Convert.ToInt32(hex.Substring(0, 2), 16);
                stamp.Color.G = Convert.ToInt32(hex.Substring(2, 2), 16);
                stamp.Color.B = Convert.ToInt32(hex.Substring(4, 2), 16);
                UpdatePreview();
            }
        }
        catch { }
    }

    private void UpdatePreview()
    {
        StateHasChanged();
    }

    private string GetPreviewStampStyle(StampPosition stamp)
    {
        var styles = new List<string>();

        switch (stamp.Corner)
        {
            case StampCorner.TopLeft:
                styles.Add($"left: {Math.Max(0, stamp.OffsetX * previewScale)}px");
                styles.Add($"top: {Math.Max(0, stamp.OffsetY * previewScale)}px");
                break;
            case StampCorner.Top:
                styles.Add("left: 50%; transform: translateX(-50%)");
                styles.Add($"top: {Math.Max(0, stamp.OffsetY * previewScale)}px");
                break;
            case StampCorner.TopRight:
                styles.Add($"right: {Math.Max(0, stamp.OffsetX * previewScale)}px");
                styles.Add($"top: {Math.Max(0, stamp.OffsetY * previewScale)}px");
                break;
            case StampCorner.BottomLeft:
                styles.Add($"left: {Math.Max(0, stamp.OffsetX * previewScale)}px");
                styles.Add($"bottom: {Math.Max(0, stamp.OffsetY * previewScale)}px");
                break;
            case StampCorner.Bottom:
                styles.Add("left: 50%; transform: translateX(-50%)");
                styles.Add($"bottom: {Math.Max(0, stamp.OffsetY * previewScale)}px");
                break;
            case StampCorner.BottomRight:
                styles.Add($"right: {Math.Max(0, stamp.OffsetX * previewScale)}px");
                styles.Add($"bottom: {Math.Max(0, stamp.OffsetY * previewScale)}px");
                break;
        }

        return string.Join("; ", styles);
    }

    private string GetPreviewText(StampPosition stamp, int pageNumber)
    {
        var text = stamp.Text;
        if (stamp.IsSerial)
        {
            var serialNumber = stamp.SerialStart + (pageNumber - currentSetting.StartPage);
            
            string serialStr;
            if (stamp.IsZeroPadded)
            {
                var maxNumber = stamp.SerialStart + (TotalPages - currentSetting.StartPage);
                var digits = maxNumber.ToString().Length;
                serialStr = serialNumber.ToString().PadLeft(digits, '0');
            }
            else
            {
                serialStr = serialNumber.ToString();
            }
            
            text = string.IsNullOrEmpty(text) ? serialStr : $"{text}{serialStr}";
        }
        return string.IsNullOrEmpty(text) ? "サンプル" : text;
    }

    private string GetPageRangeDescription()
    {
        var start = Math.Max(1, currentSetting.StartPage);
        var end = currentSetting.EndPage == -1 ? TotalPages : Math.Min(TotalPages, currentSetting.EndPage);
        
        if (start == 1 && end == TotalPages)
            return "すべてのページに適用されます";
        
        return $"ページ {start} ～ {end} に適用されます";
    }

    private bool IsPageInRange(int pageNum)
    {
        var start = Math.Max(1, currentSetting.StartPage);
        var end = currentSetting.EndPage == -1 ? TotalPages : Math.Min(TotalPages, currentSetting.EndPage);
        return pageNum >= start && pageNum <= end;
    }

    private async Task Apply()
    {
        await OnApply.InvokeAsync(currentSetting);
        await Close();
    }

    private async Task Close()
    {
        currentSetting = new();
        previewPageNumber = 1;
        previewImageUrl = null;
        await OnClose.InvokeAsync();
    }
}