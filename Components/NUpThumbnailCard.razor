@using NoCloudPdf.Models

@{
    PageItem? pageItem = Item.RawData as PageItem;
    int angle = Item.RotateAngle % 360;
    bool isRotated = (angle == 90 || angle == 270);
}

<div class="n-up-thumbnail-card" data-index="@Index">
    <div class="group rounded relative" style="@GetContainerStyle(angle)">
        <div class="relative w-full h-full flex items-center justify-center"
            @onclick="() => OnShowPreview.InvokeAsync((Index, 0))">
            @{
                string rotateClass = angle switch
                {
                    0 => "rotate-0",
                    90 => "rotate-90",
                    180 => "rotate-180",
                    270 => "rotate-270",
                    _ => "rotate-0"
                };
            }
            @if (Item.IsLoading)
            {
                <div class="page-loading w-full h-full"></div>
            }
            else if (Item.HasError)
            {
                @if (pageItem != null && pageItem.HasPageDataError)
                {
                    <div class="page-error w-full h-full flex flex-col items-center justify-center bg-gray-100 text-red-700 cursor-pointer"
                         title="クリックで再読み込み" 
                         @onclick="() => OnReloadPageItem.InvokeAsync(Item)"
                         @onclick:stopPropagation>
                        <ErrorPdfIcon Class="mb-1 w-8 h-8 text-red-600" />
                        <div class="font-bold text-xs">データなし</div>
                        <div class="flex items-center text-blue-600 text-xs mt-1 underline">
                            <RotateLeftIcon Class="w-4 h-4" />
                            再読み込み
                        </div>
                    </div>
                }
                else
                {
                    <div class="page-error w-full h-full flex flex-col items-center justify-center cursor-pointer hover:bg-red-100 transition"
                         title="クリックで再読み込み"
                         @onclick="() => OnReloadPageItem.InvokeAsync(Item)"
                         @onclick:stopPropagation>
                        <ErrorThumbnailIcon Class="mb-1 w-8 h-8 text-red-600" />
                        <div class="text-red-700 font-bold text-xs mb-1">表示失敗</div>
                        <div class="flex items-center text-blue-600 text-xs mt-1 underline">
                            <RotateLeftIcon Class="w-4 h-4" />
                            再読み込み
                        </div>
                    </div>
                }
            }
            else if (!string.IsNullOrEmpty(Item.Thumbnail))
            {
                <img id="thumb-@Item.Id"
                    src="@Item.Thumbnail"
                    alt="@Item.DisplayName"
                    class="max-w-full max-h-full object-contain border-dashed border border-gray-200 cursor-pointer @rotateClass"
                    draggable="false"
                    tabindex="-1"
                    data-item-id="@Item.Id"
                    data-rotate-angle="@angle"
                    />
            }

            @if (pageItem != null && (pageItem.IsPasswordProtected || pageItem.IsOperationRestricted))
            {
                <UnlockIcon Class="absolute top-1 left-1 w-4 h-4 text-yellow-500" />
            }

            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div class="text-blue-400/40 font-bold text-[80px] leading-none select-none">
                    @(VisualOrder)
                </div>
            </div>

            <div class="absolute top-1 right-1 bg-white shadow rounded p-1 flex flex-col gap-1 opacity-0 pointer-events-none transition-opacity duration-300 group-hover:opacity-100 group-hover:pointer-events-auto z-10"
                 @onclick:stopPropagation>
                <button type="button" 
                        class="text-purple-500 hover:text-purple-700 p-1" 
                        title="拡大プレビュー"
                        @onclick="() => OnShowPreview.InvokeAsync((Index, 0))">
                    <i class="fa-solid fa-magnifying-glass-plus text-base"></i>
                </button>
                <button type="button" 
                        class="text-green-500 hover:text-green-700 p-1" 
                        title="複製"
                        @onclick="() => OnDuplicate.InvokeAsync(Index)">
                    <i class="fa-solid fa-copy text-base"></i>
                </button>
                <button type="button" 
                        class="text-blue-500 hover:text-blue-700 p-1" 
                        title="回転"
                        @onclick="() => OnRotate.InvokeAsync(Index)">
                    <i class="fa-solid fa-rotate-right text-base"></i>
                </button>
                <button type="button" 
                        class="text-red-500 hover:text-red-700 p-1" 
                        title="削除"
                        @onclick="() => OnRemove.InvokeAsync(Index)">
                    <DeleteIcon/>
                </button>
            </div>

            <div class="absolute bottom-0.5 right-0.5 bg-black/60 text-white text-[8px] px-1 py-0.5 rounded">
                @(Index + 1)
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public DisplayItem Item { get; set; } = default!;
    [Parameter] public int Index { get; set; }
    [Parameter] public int VisualOrder { get; set; }
    [Parameter] public EventCallback<(int fileIndex, int pageIndex)> OnShowPreview { get; set; }
    [Parameter] public EventCallback<int> OnDuplicate { get; set; }
    [Parameter] public EventCallback<int> OnRotate { get; set; }
    [Parameter] public EventCallback<int> OnRemove { get; set; }
    [Parameter] public EventCallback<DisplayItem> OnReloadPageItem { get; set; }

    private string GetContainerStyle(int angle)
    {
        switch (angle)
        {
            case 90:
            case 270:
                return "width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;";
            default:
                return "width: 100%; height: 100%;";
        }
    }
}