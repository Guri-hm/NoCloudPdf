name: Deploy Blazor WASM to GitHub Pages

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
          dotnet-quality: 'ga'

      - name: Show dotnet info (debug)
        run: dotnet --info

      - name: Install WebAssembly Tools (compatible with SDK 10)
        run: dotnet workload install wasm-tools-net9

      - name: Install native dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang zlib1g-dev libunwind-dev

      - name: Restore dependencies
        run: dotnet restore

      - name: Build and publish with AOT
        run: dotnet publish NoCloudPdf.csproj -c Release -o publish -p:RunAOTCompilation=true -p:PublishTrimmed=true

      - name: Create CNAME file
        run: echo 'ncp.solopg.com' > publish/wwwroot/CNAME

      - name: Copy index.html to 404.html
        run: cp publish/wwwroot/index.html publish/wwwroot/404.html

      - name: Set JS cache-busting version
        run: |
          dt=$(date +"%Y%m%d_%H%M%S")
          echo "Setting cache-busting version: $dt"
          
          sed -i "s|js/bundle/bundle\.min\.js|js/bundle/bundle.min.js?v=$dt|g" publish/wwwroot/index.html
          sed -i "s|\"js/bundle/bundle\.min\.js\"|\"js/bundle/bundle.min.js?v=$dt\"|g" publish/wwwroot/index.html
          sed -i "s|'js/bundle/bundle\.min\.js'|'js/bundle/bundle.min.js?v=$dt'|g" publish/wwwroot/index.html
          
          echo "Modified file content:"
          grep "bundle" publish/wwwroot/index.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./publish/wwwroot